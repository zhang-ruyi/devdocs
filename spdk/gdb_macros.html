<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Content-Type" content="text/xhtml; charset=utf-8">
  <meta name="generator" content="Doxygen 1.8.20">
  <title>SPDK: GDB Macros User Guide</title>
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <script type="text/javascript" src="two.min.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,900" type="text/css">
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="tabs.css" type="text/css">
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div class="container-fluid">
  <div id="top">  <!-- do not remove this div, it is closed by doxygen! -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('gdb_macros.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">GDB Macros User Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_gdb_macros"></a> </p><h1>Introduction</h1>
<p>When debugging an spdk application using gdb we may need to view data structures in lists, e.g. information about bdevs or threads.</p>
<p>If, for example I have several bdevs, and I wish to get information on bdev by the name 'test_vols3', I will need to manually iterate over the list as follows:</p>
<div class="fragment"><div class="line">(gdb) p g_bdev_mgr-&gt;bdevs-&gt;tqh_first-&gt;name</div>
<div class="line">$5 = 0x7f7dcc0b21b0 &quot;test_vols1&quot;</div>
<div class="line">(gdb) p g_bdev_mgr-&gt;bdevs-&gt;tqh_first-&gt;internal-&gt;link-&gt;tqe_next-&gt;name</div>
<div class="line">$6 = 0x7f7dcc0b1a70 &quot;test_vols2&quot;</div>
<div class="line">(gdb) p</div>
<div class="line">g_bdev_mgr-&gt;bdevs-&gt;tqh_first-&gt;internal-&gt;link-&gt;tqe_next-&gt;internal-&gt;link-&gt;tqe_next-&gt;name</div>
<div class="line">$7 = 0x7f7dcc215a00 &quot;test_vols3&quot;</div>
<div class="line">(gdb) p</div>
<div class="line">g_bdev_mgr-&gt;bdevs-&gt;tqh_first-&gt;internal-&gt;link-&gt;tqe_next-&gt;internal-&gt;link-&gt;tqe_next</div>
<div class="line">$8 = (struct spdk_bdev *) 0x7f7dcc2c7c08</div>
</div><!-- fragment --><p>At this stage, we can start looking at the relevant fields of our bdev which now we know is in address 0x7f7dcc2c7c08.</p>
<p>This can be somewhat troublesome if there are 100 bdevs, and the one we need is 56th in the list...</p>
<p>Instead, we can use a gdb macro in order to get information about all the devices.</p>
<p>Examples:</p>
<p>Printing bdevs:</p>
<div class="fragment"><div class="line">(gdb) spdk_print_bdevs</div>
<div class="line"> </div>
<div class="line">SPDK object of type struct spdk_bdev at 0x7f7dcc1642a8</div>
<div class="line">((struct spdk_bdev*) 0x7f7dcc1642a8)</div>
<div class="line">name 0x7f7dcc0b21b0 &quot;test_vols1&quot;</div>
<div class="line"> </div>
<div class="line">---------------</div>
<div class="line"> </div>
<div class="line">SPDK object of type struct spdk_bdev at 0x7f7dcc216008</div>
<div class="line">((struct spdk_bdev*) 0x7f7dcc216008)</div>
<div class="line">name 0x7f7dcc0b1a70 &quot;test_vols2&quot;</div>
<div class="line"> </div>
<div class="line">---------------</div>
<div class="line"> </div>
<div class="line">SPDK object of type struct spdk_bdev at 0x7f7dcc2c7c08</div>
<div class="line">((struct spdk_bdev*) 0x7f7dcc2c7c08)</div>
<div class="line">name 0x7f7dcc215a00 &quot;test_vols3&quot;</div>
<div class="line"> </div>
<div class="line">---------------</div>
</div><!-- fragment --><p>Finding a bdev by name:</p>
<div class="fragment"><div class="line">(gdb) spdk_find_bdev test_vols1</div>
<div class="line">test_vols1</div>
<div class="line"> </div>
<div class="line">SPDK object of type struct spdk_bdev at 0x7f7dcc1642a8</div>
<div class="line">((struct spdk_bdev*) 0x7f7dcc1642a8)</div>
<div class="line">name 0x7f7dcc0b21b0 &quot;test_vols1&quot;</div>
</div><!-- fragment --><p>Printing spdk threads:</p>
<div class="fragment"><div class="line">(gdb) spdk_print_threads</div>
<div class="line"> </div>
<div class="line">SPDK object of type struct spdk_thread at 0x7fffd0008b50</div>
<div class="line">((struct spdk_thread*) 0x7fffd0008b50)</div>
<div class="line">name 0x7fffd00008e0 &quot;reactor_1&quot;</div>
<div class="line">IO Channels:</div>
<div class="line">        SPDK object of type struct spdk_io_channel at 0x7fffd0052610</div>
<div class="line">        ((struct spdk_io_channel*) 0x7fffd0052610)</div>
<div class="line">        name</div>
<div class="line">        ref 1</div>
<div class="line">        device 0x7fffd0008c80 (0x7fffd0008ce0 &quot;nvmf_tgt&quot;)</div>
<div class="line">        ---------------</div>
<div class="line"> </div>
<div class="line">        SPDK object of type struct spdk_io_channel at 0x7fffd0056cd0</div>
<div class="line">        ((struct spdk_io_channel*) 0x7fffd0056cd0)</div>
<div class="line">        name</div>
<div class="line">        ref 2</div>
<div class="line">        device 0x7fffd0056bf0 (0x7fffd0008e70 &quot;test_vol1&quot;)</div>
<div class="line">        ---------------</div>
<div class="line"> </div>
<div class="line">        SPDK object of type struct spdk_io_channel at 0x7fffd00582e0</div>
<div class="line">        ((struct spdk_io_channel*) 0x7fffd00582e0)</div>
<div class="line">        name</div>
<div class="line">        ref 1</div>
<div class="line">        device 0x7fffd0056c50 (0x7fffd0056cb0 &quot;bdev_test_vol1&quot;)</div>
<div class="line">        ---------------</div>
<div class="line"> </div>
<div class="line">        SPDK object of type struct spdk_io_channel at 0x7fffd00583b0</div>
<div class="line">        ((struct spdk_io_channel*) 0x7fffd00583b0)</div>
<div class="line">        name</div>
<div class="line">        ref 1</div>
<div class="line">        device 0x7fffd0005630 (0x7fffd0005690 &quot;bdev_mgr&quot;)</div>
<div class="line">        ---------------</div>
</div><!-- fragment --><p>Printing nvmf subsystems:</p>
<div class="fragment"><div class="line">(gdb) spdk_print_nvmf_subsystems</div>
<div class="line"> </div>
<div class="line">SPDK object of type struct spdk_nvmf_subsystem at 0x7fffd0008d00</div>
<div class="line">((struct spdk_nvmf_subsystem*) 0x7fffd0008d00)</div>
<div class="line">name &quot;nqn.2014-08.org.nvmexpress.discovery&quot;, &#39;\000&#39; &lt;repeats 187 times&gt;</div>
<div class="line">nqn &quot;nqn.2014-08.org.nvmexpress.discovery&quot;, &#39;\000&#39; &lt;repeats 187 times&gt;</div>
<div class="line">ID 0</div>
<div class="line"> </div>
<div class="line">---------------</div>
<div class="line"> </div>
<div class="line">SPDK object of type struct spdk_nvmf_subsystem at 0x7fffd0055760</div>
<div class="line">((struct spdk_nvmf_subsystem*) 0x7fffd0055760)</div>
<div class="line">name &quot;nqn.2016-06.io.spdk.umgmt:cnode1&quot;, &#39;\000&#39; &lt;repeats 191 times&gt;</div>
<div class="line">nqn &quot;nqn.2016-06.io.spdk.umgmt:cnode1&quot;, &#39;\000&#39; &lt;repeats 191 times&gt;</div>
<div class="line">ID 1</div>
</div><!-- fragment --><h1>Loading The gdb Macros</h1>
<p>Copy the gdb macros to the host where you are about to debug. It is best to copy the file either to somewhere within the PYTHONPATH, or to add the destination directory to the PYTHONPATH. This is not mandatory, and can be worked around, but can save a few steps when loading the module to gdb.</p>
<p>From gdb, with the application core open, invoke python and load the modules.</p>
<p>In the example below, I copied the macros to the /tmp directory which is not in the PYTHONPATH, so I had to manually add the directory to the path.</p>
<div class="fragment"><div class="line">(gdb) python</div>
<div class="line">&gt;import sys</div>
<div class="line">&gt;sys.path.append(&#39;/tmp&#39;)</div>
<div class="line">&gt;import gdb_macros</div>
<div class="line">&gt;end</div>
<div class="line">(gdb) spdk_load_macros</div>
</div><!-- fragment --><h1>Using the gdb Data Directory</h1>
<p>On most systems, the data directory is /usr/share/gdb. The python script should be copied into the python/gdb/function (or python/gdb/command) directory under the data directory, e.g. /usr/share/gdb/python/gdb/function.</p>
<p>If the python script is in there, then the only thing you need to do when starting gdb is type "spdk_load_macros".</p>
<h1>Using .gdbinit To Load The Macros</h1>
<p>.gdbinit can also be used in order to run automatically run the manual steps above prior to starting gdb.</p>
<p>Exmaple .gdbinit:</p>
<div class="fragment"><div class="line">source /opt/km/install/tools/gdb_macros/gdb_macros.py</div>
</div><!-- fragment --><p>When starting gdb you still have to call spdk_load_macros.</p>
<h1>Why Do We Need to Explicitly Call spdk_load_macros</h1>
<p>The reason is that the macros need to use globals provided by spdk in order to iterate the spdk lists and build iterable representations of the list objects. This will result in errors if these are not available which is very possible if gdb is used for reasons other than debugging spdk core dumps.</p>
<p>In the example bellow, I attempted to load the macros when the globals are not available causing gdb to fail loading the gdb_macros:</p>
<div class="fragment"><div class="line">(gdb) spdk_load_macros</div>
<div class="line">Traceback (most recent call last):</div>
<div class="line">  File &quot;/opt/km/install/tools/gdb_macros/gdb_macros.py&quot;, line 257, in invoke</div>
<div class="line">    spdk_print_threads()</div>
<div class="line">  File &quot;/opt/km/install/tools/gdb_macros/gdb_macros.py&quot;, line 241, in __init__</div>
<div class="line">    threads = SpdkThreads()</div>
<div class="line">  File &quot;/opt/km/install/tools/gdb_macros/gdb_macros.py&quot;, line 234, in __init__</div>
<div class="line">    super(SpdkThreads, self).__init__(&#39;g_threads&#39;, SpdkThread)</div>
<div class="line">  File &quot;/opt/km/install/tools/gdb_macros/gdb_macros.py&quot;, line 25, in __init__</div>
<div class="line">    [&#39;tailq&#39;])</div>
<div class="line">  File &quot;/opt/km/install/tools/gdb_macros/gdb_macros.py&quot;, line 10, in __init__</div>
<div class="line">    self.list = gdb.parse_and_eval(self.list_pointer)</div>
<div class="line">RuntimeError: No symbol table is loaded.  Use the &quot;file&quot; command.</div>
<div class="line">Error occurred in Python command: No symbol table is loaded.  Use the &quot;file&quot;</div>
<div class="line">command.</div>
</div><!-- fragment --><h1>Macros available</h1>
<ul>
<li>spdk_load_macros: load the macros (use &ndash;reload in order to reload them)</li>
<li>spdk_print_bdevs: information about bdevs</li>
<li>spdk_find_bdev: find a bdev (substring search)</li>
<li>spdk_print_io_devices: information about io devices</li>
<li>spdk_print_nvmf_subsystems: information about nvmf subsystems</li>
<li>spdk_print_threads: information about threads</li>
</ul>
<h1>Adding New Macros</h1>
<p>The list iteration macros are usually built from 3 layers:</p>
<ul>
<li>SpdkPrintCommand: inherits from gdb.Command and invokes the list iteration</li>
<li>SpdkTailqList: Performs the iteration of a tailq list according to the tailq member implementation</li>
<li>SpdkObject: Provides the <b>str</b> function so that the list iteration can print the object</li>
</ul>
<p>Other useful objects:</p>
<ul>
<li>SpdkNormalTailqList: represents a list which has 'tailq' as the tailq object</li>
<li>SpdkArr: Iteration over an array (instead of a linked list) </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
</div>
