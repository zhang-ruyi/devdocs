<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Content-Type" content="text/xhtml; charset=utf-8">
  <meta name="generator" content="Doxygen 1.8.20">
  <title>SPDK: System Configuration User Guide</title>
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <script type="text/javascript" src="two.min.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,900" type="text/css">
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="tabs.css" type="text/css">
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div class="container-fluid">
  <div id="top">  <!-- do not remove this div, it is closed by doxygen! -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('system_configuration.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">System Configuration User Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_system_configuration"></a> This system configuration guide describes how to configure a system for use with SPDK.</p>
<h1><a class="anchor" id="iommu_config"></a>
IOMMU configuration</h1>
<p>An IOMMU may be present and enabled on many platforms. When an IOMMU is present and enabled, it is recommended that SPDK applications are deployed with the <code>vfio-pci</code> kernel driver. SPDK's <code>scripts/setup.sh</code> script will automatically select <code>vfio-pci</code> in this case.</p>
<p>However, some devices do not function correctly when bound to <code>vfio-pci</code> and instead must be attached to the <code>uio_pci_generic</code> kernel driver. In that case, users should take care to disable the IOMMU or to set it into passthrough mode prior to running <code>scripts/setup.sh</code>.</p>
<p>To disable the IOMMU or place it into passthrough mode, add <code>intel_iommu=off</code> or <code>amd_iommu=off</code> or <code>intel_iommu=on iommu=pt</code> to the GRUB command line on x86_64 system, or add <code>iommu.passthrough=1</code> on arm64 systems.</p>
<p>There are also some instances where a user may not want to use <code>uio_pci_generic</code> or the kernel version they are using has a bug where <code>uio_pci_generic</code> <a href="https://github.com/spdk/spdk/issues/399">fails to bind to NVMe drives</a>. In these cases, users can build the <code>igb_uio</code> kernel module which can be found in dpdk-kmods repository. To ensure that the driver is properly bound, users should specify <code>DRIVER_OVERRIDE=/path/to/igb_uio.ko</code>.</p>
<h1><a class="anchor" id="system_configuration_nonroot"></a>
Running SPDK as non-priviledged user</h1>
<p>One of the benefits of using the <code>VFIO</code> Linux kernel driver is the ability to perform DMA operations with peripheral devices as unprivileged user. The permissions to access particular devices still need to be granted by the system administrator, but only on a one-time basis. Note that this functionality is supported with DPDK starting from version 18.11.</p>
<h2>Hugetlbfs access</h2>
<p>Make sure the target user has RW access to at least one hugepage mount. A good idea is to create a new mount specifically for SPDK:</p>
<div class="fragment"><div class="line"># mkdir /mnt/spdk_hugetlbfs</div>
<div class="line"># mount -t hugetlbfs -o uid=spdk,size=&lt;value&gt; none /mnt/spdk_hugetlbfs</div>
</div><!-- fragment --><p>Then start SPDK applications with an additional parameter <code>--huge-dir /mnt/spdk_hugetlbfs</code></p>
<p>Full guide on configuring hugepage mounts is available in the <a href="https://www.kernel.org/doc/Documentation/vm/hugetlbpage.txt">Linux Hugetlbpage Documentation</a></p>
<h2><a class="anchor" id="system_configuration_nonroot_device_access"></a>
Device access</h2>
<p><code>VFIO</code> device access is protected with sysfs file permissions and can be configured with chown/chmod.</p>
<p>Please note that the VFIO device isolation is based around IOMMU groups and it's only possible to change permissions of the entire group, which might possibly consist of more than one device. (You could also apply a custom kernel patch to further isolate those devices in the kernel, but it comes with potential risks as described on <a href="https://vfio.blogspot.com/2014/08/iommu-groups-inside-and-out.html">Alex Williamson's VFIO blog</a>, with the patch in question available here: <a href="https://lkml.org/lkml/2013/5/30/513">[PATCH] pci: Enable overrides for missing ACS capabilities</a>)</p>
<p>Let's assume we want to use PCI device <code>0000:04:00.0</code>. First of all, verify that it has an IOMMU group assigned:</p>
<div class="fragment"><div class="line">$ readlink &quot;/sys/bus/pci/devices/0000:00:04.0/iommu_group&quot;</div>
</div><!-- fragment --><p>The output should be e.g. <code>../../../kernel/iommu_groups/5</code></p>
<p>Which means that the device is a part of the IOMMU group 5. We can check if there are any other devices in that group.</p>
<div class="fragment"><div class="line">$ ls /sys/kernel/iommu_groups/5/devices/</div>
<div class="line">0000:00:04.0  0000:00:04.1  0000:00:04.2  0000:00:04.3  0000:00:04.4  0000:00:04.5  0000:00:04.6  0000:00:04.7</div>
</div><!-- fragment --><p>In this case <code>0000:04:00.0</code> is an I/OAT channel which comes with 7 different channels associated with the same IOMMU group.</p>
<p>To give the user <code>spdk</code> full access to the VFIO IOMMU group 5 and all its devices, use the following:</p>
<div class="fragment"><div class="line"># chown spdk /dev/vfio/5</div>
</div><!-- fragment --><h2><a class="anchor" id="system_configuration_nonroot_memory_constraints"></a>
Memory constraints</h2>
<p>As soon as the first device is attached to SPDK, all of SPDK memory will be mapped to the IOMMU through the VFIO APIs. VFIO will try to mlock that memory and will likely exceed user ulimit on locked memory. Besides having various SPDK errors and failures, this would also pollute the syslog with the following entries:</p>
<p><code>vfio_pin_pages: RLIMIT_MEMLOCK</code></p>
<p>The limit can be checked by running the following command as target user: (output in kilobytes)</p>
<div class="fragment"><div class="line">$ ulimit -l</div>
</div><!-- fragment --><p>On Ubuntu 18.04 this returns 16384 (16MB) by default, which is way below what SPDK needs.</p>
<p>The limit can be increased with one of the methods below. Keep in mind SPDK will try to map not only its reserved hugepages, but also all the memory that's shared by its vhost clients as described in the <a href="https://spdk.io/doc/vhost_processing.html#vhost_processing_init">Vhost processing guide</a>.</p>
<h3>Increasing the memlock limit permanently</h3>
<p>Open the <code>/etc/security/limits.conf</code> file as root and append the following:</p>
<div class="fragment"><div class="line">spdk     hard   memlock           unlimited</div>
<div class="line">spdk     soft   memlock           unlimited</div>
</div><!-- fragment --><p>Then logout from the target user account. The changes will take effect after the next login.</p>
<h3>Increasing the memlock for a specific process</h3>
<p>Linux offers a <code>prlimit</code> utility that can override limits of any given process. On Ubuntu, it is a part of the <code>util-linux</code> package.</p>
<div class="fragment"><div class="line"># prlimit --pid &lt;pid&gt; --memlock=&lt;soft&gt;:&lt;hard&gt;</div>
</div><!-- fragment --><p>Note that the above needs to be executed before the first device is attached to the SPDK application. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
</div>
