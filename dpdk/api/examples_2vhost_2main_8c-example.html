<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DPDK: examples/vhost/main.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">20.11.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">examples/vhost/main.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/* SPDX-License-Identifier: BSD-3-Clause</span></div>
<div class="line"><span class="comment"> * Copyright(c) 2010-2017 Intel Corporation</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;arpa/inet.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/if_ether.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/if_vlan.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/virtio_net.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/virtio_ring.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/eventfd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/param.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__atomic_8h.html">rte_atomic.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__cycles_8h.html">rte_cycles.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ethdev_8h.html">rte_ethdev.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__string__fns_8h.html">rte_string_fns.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__malloc_8h.html">rte_malloc.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__vhost_8h.html">rte_vhost.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ip_8h.html">rte_ip.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__tcp_8h.html">rte_tcp.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__pause_8h.html">rte_pause.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;ioat.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;main.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifndef MAX_QUEUES</span></div>
<div class="line"><span class="preprocessor">#define MAX_QUEUES 128</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* the maximum number of external ports supported */</span></div>
<div class="line"><span class="preprocessor">#define MAX_SUP_PORTS 1</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define MBUF_CACHE_SIZE 128</span></div>
<div class="line"><span class="preprocessor">#define MBUF_DATA_SIZE  RTE_MBUF_DEFAULT_BUF_SIZE</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define BURST_TX_DRAIN_US 100   </span><span class="comment">/* TX drain every ~100us */</span><span class="preprocessor"></span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define BURST_RX_WAIT_US 15 </span><span class="comment">/* Defines how long we wait between retries on RX */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define BURST_RX_RETRIES 4      </span><span class="comment">/* Number of retries on RX. */</span><span class="preprocessor"></span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define JUMBO_FRAME_MAX_SIZE    0x2600</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* State of virtio device. */</span></div>
<div class="line"><span class="preprocessor">#define DEVICE_MAC_LEARNING 0</span></div>
<div class="line"><span class="preprocessor">#define DEVICE_RX           1</span></div>
<div class="line"><span class="preprocessor">#define DEVICE_SAFE_REMOVE  2</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Configurable number of RX/TX ring descriptors */</span></div>
<div class="line"><span class="preprocessor">#define RTE_TEST_RX_DESC_DEFAULT 1024</span></div>
<div class="line"><span class="preprocessor">#define RTE_TEST_TX_DESC_DEFAULT 512</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define INVALID_PORT_ID 0xFF</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Maximum long option length for option parsing. */</span></div>
<div class="line"><span class="preprocessor">#define MAX_LONG_OPT_SZ 64</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* mask of enabled ports */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t enabled_port_mask = 0;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Promiscuous mode */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t promiscuous;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* number of devices/queues to support*/</span></div>
<div class="line"><span class="keyword">static</span> uint32_t num_queues = 0;</div>
<div class="line"><span class="keyword">static</span> uint32_t num_devices;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structrte__mempool.html">rte_mempool</a> *mbuf_pool;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> mergeable;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Enable VM2VM communications. If this is disabled then the MAC address compare is skipped. */</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line">    VM2VM_DISABLED = 0,</div>
<div class="line">    VM2VM_SOFTWARE = 1,</div>
<div class="line">    VM2VM_HARDWARE = 2,</div>
<div class="line">    VM2VM_LAST</div>
<div class="line">} vm2vm_type;</div>
<div class="line"><span class="keyword">static</span> vm2vm_type vm2vm_mode = VM2VM_SOFTWARE;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Enable stats. */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t enable_stats = 0;</div>
<div class="line"><span class="comment">/* Enable retries on RX. */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t enable_retry = 1;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Disable TX checksum offload */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t enable_tx_csum;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Disable TSO offload */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t enable_tso;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> client_mode;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> builtin_net_driver;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> async_vhost_driver;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> dma_type[MAX_LONG_OPT_SZ];</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Specify timeout (in useconds) between retries on RX. */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t burst_rx_delay_time = BURST_RX_WAIT_US;</div>
<div class="line"><span class="comment">/* Specify the number of retries on RX. */</span></div>
<div class="line"><span class="keyword">static</span> uint32_t burst_rx_retry_num = BURST_RX_RETRIES;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Socket file paths. Can be set by user */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> *socket_files;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> nb_sockets;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* empty vmdq configuration structure. Filled in programatically */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a1"></a><a class="code" href="structrte__eth__conf.html">rte_eth_conf</a> vmdq_conf_default = {</div>
<div class="line">    .<a name="a2"></a><a class="code" href="structrte__eth__conf.html#a346eef99c24f617b74c440c1aa565d01">rxmode</a> = {</div>
<div class="line">        .<a name="a3"></a><a class="code" href="structrte__eth__rxmode.html#aa0562513c4569f1aa53050f1beac6b5d">mq_mode</a>        = <a name="a4"></a><a class="code" href="rte__ethdev_8h.html#a586b8e86131b4ec0ccaf464e847ccf3ea66316d2ff53011a3209207734c124f3c">ETH_MQ_RX_VMDQ_ONLY</a>,</div>
<div class="line">        .split_hdr_size = 0,</div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * VLAN strip is necessary for 1G NIC such as I350,</span></div>
<div class="line"><span class="comment">         * this fixes bug of ipv4 forwarding in guest can&#39;t</span></div>
<div class="line"><span class="comment">         * forward pakets from one virtio dev to another virtio dev.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        .offloads = <a name="a5"></a><a class="code" href="rte__ethdev_8h.html#a544a5d22a4be048e8e5395fb965922ed">DEV_RX_OFFLOAD_VLAN_STRIP</a>,</div>
<div class="line">    },</div>
<div class="line"> </div>
<div class="line">    .txmode = {</div>
<div class="line">        .mq_mode = <a name="a6"></a><a class="code" href="rte__ethdev_8h.html#a4834f572f4dd4e46d81ad09b7d5fffd5aada568551470d5f419cd2f3d6b6bfedc">ETH_MQ_TX_NONE</a>,</div>
<div class="line">        .offloads = (DEV_TX_OFFLOAD_IPV4_CKSUM |</div>
<div class="line">                 DEV_TX_OFFLOAD_TCP_CKSUM |</div>
<div class="line">                 <a name="a7"></a><a class="code" href="rte__ethdev_8h.html#adaf0af5e228aeb2aaac39622cb6467ba">DEV_TX_OFFLOAD_VLAN_INSERT</a> |</div>
<div class="line">                 <a name="a8"></a><a class="code" href="rte__ethdev_8h.html#a35b7466d51590b9c30fc40134b043ba7">DEV_TX_OFFLOAD_MULTI_SEGS</a> |</div>
<div class="line">                 DEV_TX_OFFLOAD_TCP_TSO),</div>
<div class="line">    },</div>
<div class="line">    .rx_adv_conf = {</div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * should be overridden separately in code with</span></div>
<div class="line"><span class="comment">         * appropriate values</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        .vmdq_rx_conf = {</div>
<div class="line">            .nb_queue_pools = <a name="a9"></a><a class="code" href="rte__ethdev_8h.html#a012a874434677984af1f026ad585dd0da308323e3152afc591f57f613d2418eae">ETH_8_POOLS</a>,</div>
<div class="line">            .enable_default_pool = 0,</div>
<div class="line">            .default_pool = 0,</div>
<div class="line">            .nb_pool_maps = 0,</div>
<div class="line">            .pool_map = {{0, 0},},</div>
<div class="line">        },</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> lcore_ids[RTE_MAX_LCORE];</div>
<div class="line"><span class="keyword">static</span> uint16_t ports[RTE_MAX_ETHPORTS];</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> num_ports = 0; </div>
<div class="line"><span class="keyword">static</span> uint16_t num_pf_queues, num_vmdq_queues;</div>
<div class="line"><span class="keyword">static</span> uint16_t vmdq_pool_base, vmdq_queue_base;</div>
<div class="line"><span class="keyword">static</span> uint16_t queues_per_pool;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> uint16_t vlan_tags[] = {</div>
<div class="line">    1000, 1001, 1002, 1003, 1004, 1005, 1006, 1007,</div>
<div class="line">    1008, 1009, 1010, 1011, 1012, 1013, 1014, 1015,</div>
<div class="line">    1016, 1017, 1018, 1019, 1020, 1021, 1022, 1023,</div>
<div class="line">    1024, 1025, 1026, 1027, 1028, 1029, 1030, 1031,</div>
<div class="line">    1032, 1033, 1034, 1035, 1036, 1037, 1038, 1039,</div>
<div class="line">    1040, 1041, 1042, 1043, 1044, 1045, 1046, 1047,</div>
<div class="line">    1048, 1049, 1050, 1051, 1052, 1053, 1054, 1055,</div>
<div class="line">    1056, 1057, 1058, 1059, 1060, 1061, 1062, 1063,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* ethernet addresses of ports */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a10"></a><a class="code" href="structrte__ether__addr.html">rte_ether_addr</a> vmdq_ports_eth_addr[RTE_MAX_ETHPORTS];</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>vhost_dev_tailq_list vhost_dev_list =</div>
<div class="line">    TAILQ_HEAD_INITIALIZER(vhost_dev_list);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>lcore_info lcore_info[RTE_MAX_LCORE];</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Used for queueing bursts of TX packets. */</span></div>
<div class="line"><span class="keyword">struct </span>mbuf_table {</div>
<div class="line">    <span class="keywordtype">unsigned</span> len;</div>
<div class="line">    <span class="keywordtype">unsigned</span> txq_id;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a11"></a><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m_table[MAX_PKT_BURST];</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* TX queue for each data core. */</span></div>
<div class="line"><span class="keyword">struct </span>mbuf_table lcore_tx_queue[RTE_MAX_LCORE];</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define MBUF_TABLE_DRAIN_TSC    ((rte_get_tsc_hz() + US_PER_S - 1) \</span></div>
<div class="line"><span class="preprocessor">                 / US_PER_S * BURST_TX_DRAIN_US)</span></div>
<div class="line"><span class="preprocessor">#define VLAN_HLEN       4</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line">open_dma(<span class="keyword">const</span> <span class="keywordtype">char</span> *value)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (strncmp(dma_type, <span class="stringliteral">&quot;ioat&quot;</span>, 4) == 0)</div>
<div class="line">        <span class="keywordflow">return</span> open_ioat(value);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Builds up the correct configuration for VMDQ VLAN pool map</span></div>
<div class="line"><span class="comment"> * according to the pool &amp; queue limits.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line">get_eth_conf(<span class="keyword">struct</span> <a class="code" href="structrte__eth__conf.html">rte_eth_conf</a> *eth_conf, uint32_t num_devices)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a name="_a12"></a><a class="code" href="structrte__eth__vmdq__rx__conf.html">rte_eth_vmdq_rx_conf</a> conf;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__eth__vmdq__rx__conf.html">rte_eth_vmdq_rx_conf</a> *def_conf =</div>
<div class="line">        &amp;vmdq_conf_default.<a name="a13"></a><a class="code" href="structrte__eth__conf.html#a084e132696e8d0f59f643d822c8cedb7">rx_adv_conf</a>.<a name="a14"></a><a class="code" href="structrte__eth__conf.html#a17845d02c4ddfdc09982bd899b6df06e">vmdq_rx_conf</a>;</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line"> </div>
<div class="line">    memset(&amp;conf, 0, <span class="keyword">sizeof</span>(conf));</div>
<div class="line">    conf.nb_queue_pools = (<span class="keyword">enum</span> <a name="a15"></a><a class="code" href="rte__ethdev_8h.html#a012a874434677984af1f026ad585dd0d">rte_eth_nb_pools</a>)num_devices;</div>
<div class="line">    conf.nb_pool_maps = num_devices;</div>
<div class="line">    conf.enable_loop_back = def_conf-&gt;<a name="a16"></a><a class="code" href="structrte__eth__vmdq__rx__conf.html#afa7945c6936c8595f02f0a5408af42bd">enable_loop_back</a>;</div>
<div class="line">    conf.rx_mode = def_conf-&gt;<a name="a17"></a><a class="code" href="structrte__eth__vmdq__rx__conf.html#a25189ff51ac0748d611eabd14cb1cc6a">rx_mode</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; conf.nb_pool_maps; i++) {</div>
<div class="line">        conf.pool_map[i].vlan_id = vlan_tags[ i ];</div>
<div class="line">        conf.pool_map[i].pools = (1UL &lt;&lt; i);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    (void)(<a name="a18"></a><a class="code" href="rte__memcpy_8h.html#a09f4d8cdb1a7c25398a363906e1db8cd">rte_memcpy</a>(eth_conf, &amp;vmdq_conf_default, <span class="keyword">sizeof</span>(*eth_conf)));</div>
<div class="line">    (void)(<a class="code" href="rte__memcpy_8h.html#a09f4d8cdb1a7c25398a363906e1db8cd">rte_memcpy</a>(&amp;eth_conf-&gt;<a class="code" href="structrte__eth__conf.html#a084e132696e8d0f59f643d822c8cedb7">rx_adv_conf</a>.<a class="code" href="structrte__eth__conf.html#a17845d02c4ddfdc09982bd899b6df06e">vmdq_rx_conf</a>, &amp;conf,</div>
<div class="line">           <span class="keyword">sizeof</span>(eth_conf-&gt;<a class="code" href="structrte__eth__conf.html#a084e132696e8d0f59f643d822c8cedb7">rx_adv_conf</a>.<a class="code" href="structrte__eth__conf.html#a17845d02c4ddfdc09982bd899b6df06e">vmdq_rx_conf</a>)));</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Initialises a given port using global settings and with the rx buffers</span></div>
<div class="line"><span class="comment"> * coming from the mbuf_pool passed as parameter</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line">port_init(uint16_t port)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a name="_a19"></a><a class="code" href="structrte__eth__dev__info.html">rte_eth_dev_info</a> dev_info;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__eth__conf.html">rte_eth_conf</a> port_conf;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a20"></a><a class="code" href="structrte__eth__rxconf.html">rte_eth_rxconf</a> *rxconf;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a21"></a><a class="code" href="structrte__eth__txconf.html">rte_eth_txconf</a> *txconf;</div>
<div class="line">    int16_t rx_rings, tx_rings;</div>
<div class="line">    uint16_t rx_ring_size, tx_ring_size;</div>
<div class="line">    <span class="keywordtype">int</span> retval;</div>
<div class="line">    uint16_t q;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* The max pool number from dev_info will be used to validate the pool number specified in cmd line */</span></div>
<div class="line">    retval = <a name="a22"></a><a class="code" href="rte__ethdev_8h.html#a7593f4fff04f4ae1b1d718db7ca7dc8c">rte_eth_dev_info_get</a>(port, &amp;dev_info);</div>
<div class="line">    <span class="keywordflow">if</span> (retval != 0) {</div>
<div class="line">        <a name="a23"></a><a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_PORT,</div>
<div class="line">            <span class="stringliteral">&quot;Error during getting device (port %u) info: %s\n&quot;</span>,</div>
<div class="line">            port, strerror(-retval));</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    rxconf = &amp;dev_info.default_rxconf;</div>
<div class="line">    txconf = &amp;dev_info.default_txconf;</div>
<div class="line">    rxconf-&gt;<a name="a24"></a><a class="code" href="structrte__eth__rxconf.html#aaccf5b8238b9207f8102d69959ac3391">rx_drop_en</a> = 1;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*configure the number of supported virtio devices based on VMDQ limits */</span></div>
<div class="line">    num_devices = dev_info.max_vmdq_pools;</div>
<div class="line"> </div>
<div class="line">    rx_ring_size = RTE_TEST_RX_DESC_DEFAULT;</div>
<div class="line">    tx_ring_size = RTE_TEST_TX_DESC_DEFAULT;</div>
<div class="line"> </div>
<div class="line">    tx_rings = (uint16_t)<a name="a25"></a><a class="code" href="rte__lcore_8h.html#a1728dc7f14571ba778d3b5b41aa09283">rte_lcore_count</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Get port configuration. */</span></div>
<div class="line">    retval = get_eth_conf(&amp;port_conf, num_devices);</div>
<div class="line">    <span class="keywordflow">if</span> (retval &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line">    <span class="comment">/* NIC queues are divided into pf queues and vmdq queues.  */</span></div>
<div class="line">    num_pf_queues = dev_info.max_rx_queues - dev_info.vmdq_queue_num;</div>
<div class="line">    queues_per_pool = dev_info.vmdq_queue_num / dev_info.max_vmdq_pools;</div>
<div class="line">    num_vmdq_queues = num_devices * queues_per_pool;</div>
<div class="line">    num_queues = num_pf_queues + num_vmdq_queues;</div>
<div class="line">    vmdq_queue_base = dev_info.vmdq_queue_base;</div>
<div class="line">    vmdq_pool_base  = dev_info.vmdq_pool_base;</div>
<div class="line">    printf(<span class="stringliteral">&quot;pf queue num: %u, configured vmdq pool num: %u, each vmdq pool has %u queues\n&quot;</span>,</div>
<div class="line">        num_pf_queues, num_devices, queues_per_pool);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!<a name="a26"></a><a class="code" href="rte__ethdev_8h.html#a22dcfd3f5f2b34f657131d66132e23a7">rte_eth_dev_is_valid_port</a>(port))</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"> </div>
<div class="line">    rx_rings = (uint16_t)dev_info.max_rx_queues;</div>
<div class="line">    if (dev_info.tx_offload_capa &amp; <a name="a27"></a><a class="code" href="rte__ethdev_8h.html#ae7110b5d5dced8f42505bff5d9e3f0ea">DEV_TX_OFFLOAD_MBUF_FAST_FREE</a>)</div>
<div class="line">        port_conf.txmode.offloads |=</div>
<div class="line">            <a class="code" href="rte__ethdev_8h.html#ae7110b5d5dced8f42505bff5d9e3f0ea">DEV_TX_OFFLOAD_MBUF_FAST_FREE</a>;</div>
<div class="line">    <span class="comment">/* Configure ethernet device. */</span></div>
<div class="line">    retval = <a name="a28"></a><a class="code" href="rte__ethdev_8h.html#a1a7d3a20b102fee222541fda50fd87bd">rte_eth_dev_configure</a>(port, rx_rings, tx_rings, &amp;port_conf);</div>
<div class="line">    <span class="keywordflow">if</span> (retval != 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_PORT, <span class="stringliteral">&quot;Failed to configure port %u: %s.\n&quot;</span>,</div>
<div class="line">            port, strerror(-retval));</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    retval = <a name="a29"></a><a class="code" href="rte__ethdev_8h.html#ad31219b87a1733d5b367a7c04c7f7b48">rte_eth_dev_adjust_nb_rx_tx_desc</a>(port, &amp;rx_ring_size,</div>
<div class="line">        &amp;tx_ring_size);</div>
<div class="line">    <span class="keywordflow">if</span> (retval != 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_PORT, <span class="stringliteral">&quot;Failed to adjust number of descriptors &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;for port %u: %s.\n&quot;</span>, port, strerror(-retval));</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (rx_ring_size &gt; RTE_TEST_RX_DESC_DEFAULT) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_PORT, <span class="stringliteral">&quot;Mbuf pool has an insufficient size &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;for Rx queues on port %u.\n&quot;</span>, port);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Setup the queues. */</span></div>
<div class="line">    rxconf-&gt;<a name="a30"></a><a class="code" href="structrte__eth__rxconf.html#a6cfe3b3ee46e9a8b8c62a64294b0b564">offloads</a> = port_conf.rxmode.offloads;</div>
<div class="line">    <span class="keywordflow">for</span> (q = 0; q &lt; rx_rings; q ++) {</div>
<div class="line">        retval = <a name="a31"></a><a class="code" href="rte__ethdev_8h.html#a36ba70a5a6fce2c2c1f774828ba78f8d">rte_eth_rx_queue_setup</a>(port, q, rx_ring_size,</div>
<div class="line">                        <a name="a32"></a><a class="code" href="rte__ethdev_8h.html#ad032e25f712e6ffeb0c19eab1ec1fd2e">rte_eth_dev_socket_id</a>(port),</div>
<div class="line">                        rxconf,</div>
<div class="line">                        mbuf_pool);</div>
<div class="line">        <span class="keywordflow">if</span> (retval &lt; 0) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_PORT,</div>
<div class="line">                <span class="stringliteral">&quot;Failed to setup rx queue %u of port %u: %s.\n&quot;</span>,</div>
<div class="line">                q, port, strerror(-retval));</div>
<div class="line">            <span class="keywordflow">return</span> retval;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    txconf-&gt;<a name="a33"></a><a class="code" href="structrte__eth__txconf.html#a6cfe3b3ee46e9a8b8c62a64294b0b564">offloads</a> = port_conf.txmode.offloads;</div>
<div class="line">    <span class="keywordflow">for</span> (q = 0; q &lt; tx_rings; q ++) {</div>
<div class="line">        retval = <a name="a34"></a><a class="code" href="rte__ethdev_8h.html#a796c2f20778984c6f41b271e36bae50e">rte_eth_tx_queue_setup</a>(port, q, tx_ring_size,</div>
<div class="line">                        <a class="code" href="rte__ethdev_8h.html#ad032e25f712e6ffeb0c19eab1ec1fd2e">rte_eth_dev_socket_id</a>(port),</div>
<div class="line">                        txconf);</div>
<div class="line">        <span class="keywordflow">if</span> (retval &lt; 0) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_PORT,</div>
<div class="line">                <span class="stringliteral">&quot;Failed to setup tx queue %u of port %u: %s.\n&quot;</span>,</div>
<div class="line">                q, port, strerror(-retval));</div>
<div class="line">            <span class="keywordflow">return</span> retval;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Start the device. */</span></div>
<div class="line">    retval  = <a name="a35"></a><a class="code" href="rte__ethdev_8h.html#afdc834c1c52e9fb512301990468ca7c2">rte_eth_dev_start</a>(port);</div>
<div class="line">    <span class="keywordflow">if</span> (retval &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_PORT, <span class="stringliteral">&quot;Failed to start port %u: %s\n&quot;</span>,</div>
<div class="line">            port, strerror(-retval));</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (promiscuous) {</div>
<div class="line">        retval = <a name="a36"></a><a class="code" href="rte__ethdev_8h.html#a5dd1dedaa45f05c72bcc35495e441e91">rte_eth_promiscuous_enable</a>(port);</div>
<div class="line">        <span class="keywordflow">if</span> (retval != 0) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_PORT,</div>
<div class="line">                <span class="stringliteral">&quot;Failed to enable promiscuous mode on port %u: %s\n&quot;</span>,</div>
<div class="line">                port, <a name="a37"></a><a class="code" href="rte__errno_8h.html#a129a7eb4cfa1f5bdac5783bf49137d06">rte_strerror</a>(-retval));</div>
<div class="line">            <span class="keywordflow">return</span> retval;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    retval = <a name="a38"></a><a class="code" href="rte__ethdev_8h.html#a8a28375b279ded9125c99a46bf3956ef">rte_eth_macaddr_get</a>(port, &amp;vmdq_ports_eth_addr[port]);</div>
<div class="line">    <span class="keywordflow">if</span> (retval &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_PORT,</div>
<div class="line">            <span class="stringliteral">&quot;Failed to get MAC address on port %u: %s\n&quot;</span>,</div>
<div class="line">            port, <a class="code" href="rte__errno_8h.html#a129a7eb4cfa1f5bdac5783bf49137d06">rte_strerror</a>(-retval));</div>
<div class="line">        <span class="keywordflow">return</span> retval;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT, <span class="stringliteral">&quot;Max virtio devices supported: %u\n&quot;</span>, num_devices);</div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT, <span class="stringliteral">&quot;Port %u MAC: %02&quot;</span>PRIx8<span class="stringliteral">&quot; %02&quot;</span>PRIx8<span class="stringliteral">&quot; %02&quot;</span>PRIx8</div>
<div class="line">            <span class="stringliteral">&quot; %02&quot;</span>PRIx8<span class="stringliteral">&quot; %02&quot;</span>PRIx8<span class="stringliteral">&quot; %02&quot;</span>PRIx8<span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">            port,</div>
<div class="line">            vmdq_ports_eth_addr[port].<a name="a39"></a><a class="code" href="rte__ether_8h.html#ad6f7cb65b39d12b5250ecf82c8ffaa45">addr_bytes</a>[0],</div>
<div class="line">            vmdq_ports_eth_addr[port].<a class="code" href="rte__ether_8h.html#ad6f7cb65b39d12b5250ecf82c8ffaa45">addr_bytes</a>[1],</div>
<div class="line">            vmdq_ports_eth_addr[port].<a class="code" href="rte__ether_8h.html#ad6f7cb65b39d12b5250ecf82c8ffaa45">addr_bytes</a>[2],</div>
<div class="line">            vmdq_ports_eth_addr[port].<a class="code" href="rte__ether_8h.html#ad6f7cb65b39d12b5250ecf82c8ffaa45">addr_bytes</a>[3],</div>
<div class="line">            vmdq_ports_eth_addr[port].<a class="code" href="rte__ether_8h.html#ad6f7cb65b39d12b5250ecf82c8ffaa45">addr_bytes</a>[4],</div>
<div class="line">            vmdq_ports_eth_addr[port].<a class="code" href="rte__ether_8h.html#ad6f7cb65b39d12b5250ecf82c8ffaa45">addr_bytes</a>[5]);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Set socket file path.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">us_vhost_parse_socket_path(<span class="keyword">const</span> <span class="keywordtype">char</span> *q_arg)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *old;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* parse number string */</span></div>
<div class="line">    <span class="keywordflow">if</span> (strnlen(q_arg, PATH_MAX) == PATH_MAX)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"> </div>
<div class="line">    old = socket_files;</div>
<div class="line">    socket_files = realloc(socket_files, PATH_MAX * (nb_sockets + 1));</div>
<div class="line">    <span class="keywordflow">if</span> (socket_files == NULL) {</div>
<div class="line">        free(old);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    strlcpy(socket_files + nb_sockets * PATH_MAX, q_arg, PATH_MAX);</div>
<div class="line">    nb_sockets++;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Parse the portmask provided at run time.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_portmask(<span class="keyword">const</span> <span class="keywordtype">char</span> *portmask)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *end = NULL;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> pm;</div>
<div class="line"> </div>
<div class="line">    errno = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* parse hexadecimal string */</span></div>
<div class="line">    pm = strtoul(portmask, &amp;end, 16);</div>
<div class="line">    <span class="keywordflow">if</span> ((portmask[0] == <span class="charliteral">&#39;\0&#39;</span>) || (end == NULL) || (*end != <span class="charliteral">&#39;\0&#39;</span>) || (errno != 0))</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> pm;</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Parse num options at run time.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_num_opt(<span class="keyword">const</span> <span class="keywordtype">char</span> *q_arg, uint32_t max_valid_value)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *end = NULL;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> num;</div>
<div class="line"> </div>
<div class="line">    errno = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* parse unsigned int string */</span></div>
<div class="line">    num = strtoul(q_arg, &amp;end, 10);</div>
<div class="line">    <span class="keywordflow">if</span> ((q_arg[0] == <span class="charliteral">&#39;\0&#39;</span>) || (end == NULL) || (*end != <span class="charliteral">&#39;\0&#39;</span>) || (errno != 0))</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (num &gt; max_valid_value)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> num;</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Display usage</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">us_vhost_usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *prgname)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;%s [EAL options] -- -p PORTMASK\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --vm2vm [0|1|2]\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --rx_retry [0|1] --mergeable [0|1] --stats [0-N]\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --socket-file &lt;path&gt;\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --nb-devices ND\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       -p PORTMASK: Set mask for ports to be used by application\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --vm2vm [0|1|2]: disable/software(default)/hardware vm2vm comms\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --rx-retry [0|1]: disable/enable(default) retries on rx. Enable retry if destintation queue is full\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --rx-retry-delay [0-N]: timeout(in usecond) between retries on RX. This makes effect only if retries on rx enabled\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --rx-retry-num [0-N]: the number of retries on rx. This makes effect only if retries on rx enabled\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --mergeable [0|1]: disable(default)/enable RX mergeable buffers\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --stats [0-N]: 0: Disable stats, N: Time in seconds to print stats\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --socket-file: The path of the socket file.\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --tx-csum [0|1] disable/enable TX checksum offload.\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --tso [0|1] disable/enable TCP segment offload.\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --client register a vhost-user socket as client mode.\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --dma-type register dma type for your vhost async driver. For example \&quot;ioat\&quot; for now.\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;       --dmas register dma channel for specific vhost device.\n&quot;</span>,</div>
<div class="line">           prgname);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Parse the arguments given in the command line of the application.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">us_vhost_parse_args(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> opt, ret;</div>
<div class="line">    <span class="keywordtype">int</span> option_index;</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *prgname = argv[0];</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">struct </span>option long_option[] = {</div>
<div class="line">        {<span class="stringliteral">&quot;vm2vm&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;rx-retry&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;rx-retry-delay&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;rx-retry-num&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;mergeable&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;stats&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;socket-file&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;tx-csum&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;tso&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;client&quot;</span>, no_argument, &amp;client_mode, 1},</div>
<div class="line">        {<span class="stringliteral">&quot;builtin-net-driver&quot;</span>, no_argument, &amp;builtin_net_driver, 1},</div>
<div class="line">        {<span class="stringliteral">&quot;dma-type&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;dmas&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {NULL, 0, 0, 0},</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Parse command line */</span></div>
<div class="line">    <span class="keywordflow">while</span> ((opt = getopt_long(argc, argv, <span class="stringliteral">&quot;p:P&quot;</span>,</div>
<div class="line">            long_option, &amp;option_index)) != EOF) {</div>
<div class="line">        <span class="keywordflow">switch</span> (opt) {</div>
<div class="line">        <span class="comment">/* Portmask */</span></div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:</div>
<div class="line">            enabled_port_mask = parse_portmask(optarg);</div>
<div class="line">            <span class="keywordflow">if</span> (enabled_port_mask == 0) {</div>
<div class="line">                <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;Invalid portmask\n&quot;</span>);</div>
<div class="line">                us_vhost_usage(prgname);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;P&#39;</span>:</div>
<div class="line">            promiscuous = 1;</div>
<div class="line">            vmdq_conf_default.<a class="code" href="structrte__eth__conf.html#a084e132696e8d0f59f643d822c8cedb7">rx_adv_conf</a>.<a class="code" href="structrte__eth__conf.html#a17845d02c4ddfdc09982bd899b6df06e">vmdq_rx_conf</a>.<a class="code" href="structrte__eth__vmdq__rx__conf.html#a25189ff51ac0748d611eabd14cb1cc6a">rx_mode</a> =</div>
<div class="line">                <a name="a40"></a><a class="code" href="rte__ethdev_8h.html#a5cb1059587ee40589f8d9da60107e740">ETH_VMDQ_ACCEPT_BROADCAST</a> |</div>
<div class="line">                <a name="a41"></a><a class="code" href="rte__ethdev_8h.html#ac0109eb1974972c4fc0f964bc4de3b1a">ETH_VMDQ_ACCEPT_MULTICAST</a>;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">case</span> 0:</div>
<div class="line">            <span class="comment">/* Enable/disable vm2vm comms. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name, <span class="stringliteral">&quot;vm2vm&quot;</span>,</div>
<div class="line">                MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, (VM2VM_LAST - 1));</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                        <span class="stringliteral">&quot;Invalid argument for &quot;</span></div>
<div class="line">                        <span class="stringliteral">&quot;vm2vm [0|1|2]\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    vm2vm_mode = (vm2vm_type)ret;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="comment">/* Enable/disable retries on RX. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name, <span class="stringliteral">&quot;rx-retry&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, 1);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;Invalid argument for rx-retry [0|1]\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    enable_retry = ret;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="comment">/* Enable/disable TX checksum offload. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name, <span class="stringliteral">&quot;tx-csum&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, 1);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;Invalid argument for tx-csum [0|1]\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span></div>
<div class="line">                    enable_tx_csum = ret;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="comment">/* Enable/disable TSO offload. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name, <span class="stringliteral">&quot;tso&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, 1);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;Invalid argument for tso [0|1]\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span></div>
<div class="line">                    enable_tso = ret;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="comment">/* Specify the retries delay time (in useconds) on RX. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name, <span class="stringliteral">&quot;rx-retry-delay&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, INT32_MAX);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;Invalid argument for rx-retry-delay [0-N]\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    burst_rx_delay_time = ret;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="comment">/* Specify the retries number on RX. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name, <span class="stringliteral">&quot;rx-retry-num&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, INT32_MAX);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;Invalid argument for rx-retry-num [0-N]\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    burst_rx_retry_num = ret;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="comment">/* Enable/disable RX mergeable buffers. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name, <span class="stringliteral">&quot;mergeable&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, 1);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG, <span class="stringliteral">&quot;Invalid argument for mergeable [0|1]\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    mergeable = !!ret;</div>
<div class="line">                    <span class="keywordflow">if</span> (ret) {</div>
<div class="line">                        vmdq_conf_default.<a class="code" href="structrte__eth__conf.html#a346eef99c24f617b74c440c1aa565d01">rxmode</a>.<a name="a42"></a><a class="code" href="structrte__eth__rxmode.html#a6cfe3b3ee46e9a8b8c62a64294b0b564">offloads</a> |=</div>
<div class="line">                            DEV_RX_OFFLOAD_JUMBO_FRAME;</div>
<div class="line">                        vmdq_conf_default.<a class="code" href="structrte__eth__conf.html#a346eef99c24f617b74c440c1aa565d01">rxmode</a>.<a name="a43"></a><a class="code" href="structrte__eth__rxmode.html#a84a5d32306b86a1df884144612c70726">max_rx_pkt_len</a></div>
<div class="line">                            = JUMBO_FRAME_MAX_SIZE;</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="comment">/* Enable/disable stats. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name, <span class="stringliteral">&quot;stats&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                ret = parse_num_opt(optarg, INT32_MAX);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                        <span class="stringliteral">&quot;Invalid argument for stats [0..N]\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    enable_stats = ret;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="comment">/* Set socket file path. */</span></div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name,</div>
<div class="line">                        <span class="stringliteral">&quot;socket-file&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                <span class="keywordflow">if</span> (us_vhost_parse_socket_path(optarg) == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                    <span class="stringliteral">&quot;Invalid argument for socket name (Max %d characters)\n&quot;</span>,</div>
<div class="line">                    PATH_MAX);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name,</div>
<div class="line">                        <span class="stringliteral">&quot;dma-type&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                <span class="keywordflow">if</span> (strlen(optarg) &gt;= MAX_LONG_OPT_SZ) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                        <span class="stringliteral">&quot;Wrong DMA type\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                }</div>
<div class="line">                strcpy(dma_type, optarg);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (!strncmp(long_option[option_index].name,</div>
<div class="line">                        <span class="stringliteral">&quot;dmas&quot;</span>, MAX_LONG_OPT_SZ)) {</div>
<div class="line">                <span class="keywordflow">if</span> (open_dma(optarg) == -1) {</div>
<div class="line">                    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_CONFIG,</div>
<div class="line">                        <span class="stringliteral">&quot;Wrong DMA args\n&quot;</span>);</div>
<div class="line">                    us_vhost_usage(prgname);</div>
<div class="line">                    <span class="keywordflow">return</span> -1;</div>
<div class="line">                }</div>
<div class="line">                async_vhost_driver = 1;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">            <span class="comment">/* Invalid option - print options. */</span></div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            us_vhost_usage(prgname);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; RTE_MAX_ETHPORTS; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (enabled_port_mask &amp; (1 &lt;&lt; i))</div>
<div class="line">            ports[num_ports++] = i;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ((num_ports ==  0) || (num_ports &gt; MAX_SUP_PORTS)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT, <span class="stringliteral">&quot;Current enabled port number is %u,&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;but only %u port can be enabled\n&quot;</span>,num_ports, MAX_SUP_PORTS);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Update the global var NUM_PORTS and array PORTS according to system ports number</span></div>
<div class="line"><span class="comment"> * and return valid ports number</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> check_ports_num(<span class="keywordtype">unsigned</span> nb_ports)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> valid_num_ports = num_ports;</div>
<div class="line">    <span class="keywordtype">unsigned</span> portid;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (num_ports &gt; nb_ports) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT, <span class="stringliteral">&quot;\nSpecified port number(%u) exceeds total system port number(%u)\n&quot;</span>,</div>
<div class="line">            num_ports, nb_ports);</div>
<div class="line">        num_ports = nb_ports;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (portid = 0; portid &lt; num_ports; portid ++) {</div>
<div class="line">        <span class="keywordflow">if</span> (!<a class="code" href="rte__ethdev_8h.html#a22dcfd3f5f2b34f657131d66132e23a7">rte_eth_dev_is_valid_port</a>(ports[portid])) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT,</div>
<div class="line">                <span class="stringliteral">&quot;\nSpecified port ID(%u) is not valid\n&quot;</span>,</div>
<div class="line">                ports[portid]);</div>
<div class="line">            ports[portid] = INVALID_PORT_ID;</div>
<div class="line">            valid_num_ports--;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> valid_num_ports;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <a name="a44"></a><a class="code" href="rte__common_8h.html#af1e21922385a6cbe051e3ab70bba9f11">__rte_always_inline</a> <span class="keyword">struct </span>vhost_dev *</div>
<div class="line">find_vhost_dev(<span class="keyword">struct</span> <a class="code" href="structrte__ether__addr.html">rte_ether_addr</a> *mac)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>vhost_dev *vdev;</div>
<div class="line"> </div>
<div class="line">    TAILQ_FOREACH(vdev, &amp;vhost_dev_list, global_vdev_entry) {</div>
<div class="line">        <span class="keywordflow">if</span> (vdev-&gt;ready == DEVICE_RX &amp;&amp;</div>
<div class="line">            <a name="a45"></a><a class="code" href="rte__ether_8h.html#a2ccdf36488c3efa8d7c3afb03e11c5bc">rte_is_same_ether_addr</a>(mac, &amp;vdev-&gt;mac_address))</div>
<div class="line">            <span class="keywordflow">return</span> vdev;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function learns the MAC address of the device and registers this along with a</span></div>
<div class="line"><span class="comment"> * vlan tag to a VMDQ.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">link_vmdq(<span class="keyword">struct</span> vhost_dev *vdev, <span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a name="_a46"></a><a class="code" href="structrte__ether__hdr.html">rte_ether_hdr</a> *pkt_hdr;</div>
<div class="line">    <span class="keywordtype">int</span> i, ret;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Learn MAC address of guest device from packet */</span></div>
<div class="line">    pkt_hdr = <a name="a47"></a><a class="code" href="rte__mbuf__core_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keyword">struct</span> <a class="code" href="structrte__ether__hdr.html">rte_ether_hdr</a> *);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (find_vhost_dev(&amp;pkt_hdr-&gt;<a name="a48"></a><a class="code" href="structrte__ether__hdr.html#acce632e0fded0f728a1ee1a1ffb5c9bf">s_addr</a>)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_DATA,</div>
<div class="line">            <span class="stringliteral">&quot;(%d) device is using a registered MAC!\n&quot;</span>,</div>
<div class="line">            vdev-&gt;vid);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; <a name="a49"></a><a class="code" href="rte__ether_8h.html#a22bf3d2d6b4e7be447b5e805674e0845">RTE_ETHER_ADDR_LEN</a>; i++)</div>
<div class="line">        vdev-&gt;mac_address.addr_bytes[i] = pkt_hdr-&gt;<a class="code" href="structrte__ether__hdr.html#acce632e0fded0f728a1ee1a1ffb5c9bf">s_addr</a>.<a name="a50"></a><a class="code" href="structrte__ether__addr.html#ad6f7cb65b39d12b5250ecf82c8ffaa45">addr_bytes</a>[i];</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* vlan_tag currently uses the device_id. */</span></div>
<div class="line">    vdev-&gt;vlan_tag = vlan_tags[vdev-&gt;vid];</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Print out VMDQ registration info. */</span></div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA,</div>
<div class="line">        <span class="stringliteral">&quot;(%d) mac %02x:%02x:%02x:%02x:%02x:%02x and vlan %d registered\n&quot;</span>,</div>
<div class="line">        vdev-&gt;vid,</div>
<div class="line">        vdev-&gt;mac_address.addr_bytes[0], vdev-&gt;mac_address.addr_bytes[1],</div>
<div class="line">        vdev-&gt;mac_address.addr_bytes[2], vdev-&gt;mac_address.addr_bytes[3],</div>
<div class="line">        vdev-&gt;mac_address.addr_bytes[4], vdev-&gt;mac_address.addr_bytes[5],</div>
<div class="line">        vdev-&gt;vlan_tag);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Register the MAC address. */</span></div>
<div class="line">    ret = <a name="a51"></a><a class="code" href="rte__ethdev_8h.html#aae1a98a4ba67296647a29abb8cce1031">rte_eth_dev_mac_addr_add</a>(ports[0], &amp;vdev-&gt;mac_address,</div>
<div class="line">                (uint32_t)vdev-&gt;vid + vmdq_pool_base);</div>
<div class="line">    <span class="keywordflow">if</span> (ret)</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_DATA,</div>
<div class="line">            <span class="stringliteral">&quot;(%d) failed to add device MAC address to VMDQ\n&quot;</span>,</div>
<div class="line">            vdev-&gt;vid);</div>
<div class="line"> </div>
<div class="line">    <a name="a52"></a><a class="code" href="rte__ethdev_8h.html#a6bc1b487a103817c6d19bfa8b291b84b">rte_eth_dev_set_vlan_strip_on_queue</a>(ports[0], vdev-&gt;vmdq_rx_q, 1);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Set device as ready for RX. */</span></div>
<div class="line">    vdev-&gt;ready = DEVICE_RX;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Removes MAC address and vlan tag from VMDQ. Ensures that nothing is adding buffers to the RX</span></div>
<div class="line"><span class="comment"> * queue before disabling RX on the device.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">unlink_vmdq(<span class="keyword">struct</span> vhost_dev *vdev)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> i = 0;</div>
<div class="line">    <span class="keywordtype">unsigned</span> rx_count;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkts_burst[MAX_PKT_BURST];</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (vdev-&gt;ready == DEVICE_RX) {</div>
<div class="line">        <span class="comment">/*clear MAC and VLAN settings*/</span></div>
<div class="line">        <a name="a53"></a><a class="code" href="rte__ethdev_8h.html#ad8c7016e17fb74bbea305604b31356cc">rte_eth_dev_mac_addr_remove</a>(ports[0], &amp;vdev-&gt;mac_address);</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; 6; i++)</div>
<div class="line">            vdev-&gt;mac_address.addr_bytes[i] = 0;</div>
<div class="line"> </div>
<div class="line">        vdev-&gt;vlan_tag = 0;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/*Clear out the receive buffers*/</span></div>
<div class="line">        rx_count = <a name="a54"></a><a class="code" href="rte__ethdev_8h.html#a3e7d76a451b46348686ea97d6367f102">rte_eth_rx_burst</a>(ports[0],</div>
<div class="line">                    (uint16_t)vdev-&gt;vmdq_rx_q, pkts_burst, MAX_PKT_BURST);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">while</span> (rx_count) {</div>
<div class="line">            <span class="keywordflow">for</span> (i = 0; i &lt; rx_count; i++)</div>
<div class="line">                <a name="a55"></a><a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(pkts_burst[i]);</div>
<div class="line"> </div>
<div class="line">            rx_count = <a class="code" href="rte__ethdev_8h.html#a3e7d76a451b46348686ea97d6367f102">rte_eth_rx_burst</a>(ports[0],</div>
<div class="line">                    (uint16_t)vdev-&gt;vmdq_rx_q, pkts_burst, MAX_PKT_BURST);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        vdev-&gt;ready = DEVICE_MAC_LEARNING;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <a class="code" href="rte__common_8h.html#af1e21922385a6cbe051e3ab70bba9f11">__rte_always_inline</a> <span class="keywordtype">void</span></div>
<div class="line">virtio_xmit(<span class="keyword">struct</span> vhost_dev *dst_vdev, <span class="keyword">struct</span> vhost_dev *src_vdev,</div>
<div class="line">        <span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m)</div>
<div class="line">{</div>
<div class="line">    uint16_t ret;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m_cpl[1];</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (builtin_net_driver) {</div>
<div class="line">        ret = vs_enqueue_pkts(dst_vdev, VIRTIO_RXQ, &amp;m, 1);</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (async_vhost_driver) {</div>
<div class="line">        ret = rte_vhost_submit_enqueue_burst(dst_vdev-&gt;vid, VIRTIO_RXQ,</div>
<div class="line">                        &amp;m, 1);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a56"></a><a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(ret))</div>
<div class="line">            dst_vdev-&gt;nr_async_pkts++;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">while</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(dst_vdev-&gt;nr_async_pkts)) {</div>
<div class="line">            <span class="keywordflow">if</span> (rte_vhost_poll_enqueue_completed(dst_vdev-&gt;vid,</div>
<div class="line">                    VIRTIO_RXQ, m_cpl, 1))</div>
<div class="line">                dst_vdev-&gt;nr_async_pkts--;</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        ret = <a name="a57"></a><a class="code" href="rte__vhost_8h.html#aab322aa002dabda6b4c6c643afd89379">rte_vhost_enqueue_burst</a>(dst_vdev-&gt;vid, VIRTIO_RXQ, &amp;m, 1);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (enable_stats) {</div>
<div class="line">        <a name="a58"></a><a class="code" href="rte__atomic_8h.html#abf3427ef2605fddcc1bc1bce1071e8ec">rte_atomic64_inc</a>(&amp;dst_vdev-&gt;stats.rx_total_atomic);</div>
<div class="line">        <a name="a59"></a><a class="code" href="rte__atomic_8h.html#a12d91660e8a43da8882ae9d848d4327c">rte_atomic64_add</a>(&amp;dst_vdev-&gt;stats.rx_atomic, ret);</div>
<div class="line">        src_vdev-&gt;stats.tx_total++;</div>
<div class="line">        src_vdev-&gt;stats.tx += ret;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Check if the packet destination MAC address is for a local device. If so then put</span></div>
<div class="line"><span class="comment"> * the packet on that devices RX queue. If not then return.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="rte__common_8h.html#af1e21922385a6cbe051e3ab70bba9f11">__rte_always_inline</a> <span class="keywordtype">int</span></div>
<div class="line">virtio_tx_local(<span class="keyword">struct</span> vhost_dev *vdev, <span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__ether__hdr.html">rte_ether_hdr</a> *pkt_hdr;</div>
<div class="line">    <span class="keyword">struct </span>vhost_dev *dst_vdev;</div>
<div class="line"> </div>
<div class="line">    pkt_hdr = <a class="code" href="rte__mbuf__core_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keyword">struct</span> <a class="code" href="structrte__ether__hdr.html">rte_ether_hdr</a> *);</div>
<div class="line"> </div>
<div class="line">    dst_vdev = find_vhost_dev(&amp;pkt_hdr-&gt;<a name="a60"></a><a class="code" href="structrte__ether__hdr.html#a1d579e2782d36729c1f73608d8663124">d_addr</a>);</div>
<div class="line">    <span class="keywordflow">if</span> (!dst_vdev)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (vdev-&gt;vid == dst_vdev-&gt;vid) {</div>
<div class="line">        <a name="a61"></a><a class="code" href="rte__log_8h.html#aeed72aff1af9a59d2de85b96955e21f9">RTE_LOG_DP</a>(DEBUG, VHOST_DATA,</div>
<div class="line">            <span class="stringliteral">&quot;(%d) TX: src and dst MAC is same. Dropping packet.\n&quot;</span>,</div>
<div class="line">            vdev-&gt;vid);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="rte__log_8h.html#aeed72aff1af9a59d2de85b96955e21f9">RTE_LOG_DP</a>(DEBUG, VHOST_DATA,</div>
<div class="line">        <span class="stringliteral">&quot;(%d) TX: MAC address is local\n&quot;</span>, dst_vdev-&gt;vid);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a62"></a><a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(dst_vdev-&gt;remove)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#aeed72aff1af9a59d2de85b96955e21f9">RTE_LOG_DP</a>(DEBUG, VHOST_DATA,</div>
<div class="line">            <span class="stringliteral">&quot;(%d) device is marked for removal\n&quot;</span>, dst_vdev-&gt;vid);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    virtio_xmit(dst_vdev, vdev, m);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Check if the destination MAC of a packet is one local VM,</span></div>
<div class="line"><span class="comment"> * and get its vlan tag, and offset if it is.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="rte__common_8h.html#af1e21922385a6cbe051e3ab70bba9f11">__rte_always_inline</a> <span class="keywordtype">int</span></div>
<div class="line">find_local_dest(<span class="keyword">struct</span> vhost_dev *vdev, <span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m,</div>
<div class="line">    uint32_t *offset, uint16_t *vlan_tag)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>vhost_dev *dst_vdev;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__ether__hdr.html">rte_ether_hdr</a> *pkt_hdr =</div>
<div class="line">        <a class="code" href="rte__mbuf__core_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keyword">struct</span> <a class="code" href="structrte__ether__hdr.html">rte_ether_hdr</a> *);</div>
<div class="line"> </div>
<div class="line">    dst_vdev = find_vhost_dev(&amp;pkt_hdr-&gt;<a class="code" href="structrte__ether__hdr.html#a1d579e2782d36729c1f73608d8663124">d_addr</a>);</div>
<div class="line">    <span class="keywordflow">if</span> (!dst_vdev)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (vdev-&gt;vid == dst_vdev-&gt;vid) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#aeed72aff1af9a59d2de85b96955e21f9">RTE_LOG_DP</a>(DEBUG, VHOST_DATA,</div>
<div class="line">            <span class="stringliteral">&quot;(%d) TX: src and dst MAC is same. Dropping packet.\n&quot;</span>,</div>
<div class="line">            vdev-&gt;vid);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * HW vlan strip will reduce the packet length</span></div>
<div class="line"><span class="comment">     * by minus length of vlan tag, so need restore</span></div>
<div class="line"><span class="comment">     * the packet length by plus it.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    *offset  = VLAN_HLEN;</div>
<div class="line">    *vlan_tag = vlan_tags[vdev-&gt;vid];</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="rte__log_8h.html#aeed72aff1af9a59d2de85b96955e21f9">RTE_LOG_DP</a>(DEBUG, VHOST_DATA,</div>
<div class="line">        <span class="stringliteral">&quot;(%d) TX: pkt to local VM device id: (%d), vlan tag: %u.\n&quot;</span>,</div>
<div class="line">        vdev-&gt;vid, dst_vdev-&gt;vid, *vlan_tag);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> uint16_t</div>
<div class="line">get_psd_sum(<span class="keywordtype">void</span> *l3_hdr, uint64_t ol_flags)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (ol_flags &amp; <a name="a63"></a><a class="code" href="rte__mbuf__core_8h.html#a9d2d4eca2fab4ef35c8f8a7f3bbe9fe2">PKT_TX_IPV4</a>)</div>
<div class="line">        <span class="keywordflow">return</span> <a name="a64"></a><a class="code" href="rte__ip_8h.html#a0a713bee0681792de6b1ab4239268876">rte_ipv4_phdr_cksum</a>(l3_hdr, ol_flags);</div>
<div class="line">    <span class="keywordflow">else</span> <span class="comment">/* assume ethertype == RTE_ETHER_TYPE_IPV6 */</span></div>
<div class="line">        <span class="keywordflow">return</span> <a name="a65"></a><a class="code" href="rte__ip_8h.html#a2413fad2b706c5290bec6dee6f122877">rte_ipv6_phdr_cksum</a>(l3_hdr, ol_flags);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> virtio_tx_offload(<span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">void</span> *l3_hdr;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a66"></a><a class="code" href="structrte__ipv4__hdr.html">rte_ipv4_hdr</a> *ipv4_hdr = NULL;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a67"></a><a class="code" href="structrte__tcp__hdr.html">rte_tcp_hdr</a> *tcp_hdr = NULL;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__ether__hdr.html">rte_ether_hdr</a> *eth_hdr =</div>
<div class="line">        <a class="code" href="rte__mbuf__core_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keyword">struct</span> <a class="code" href="structrte__ether__hdr.html">rte_ether_hdr</a> *);</div>
<div class="line"> </div>
<div class="line">    l3_hdr = (<span class="keywordtype">char</span> *)eth_hdr + m-&gt;<a name="a68"></a><a class="code" href="structrte__mbuf.html#aa25a7c259438b9eba28bcedc33846620">l2_len</a>;</div>
<div class="line"> </div>
<div class="line">    if (m-&gt;<a name="a69"></a><a class="code" href="structrte__mbuf.html#a319d580a6e1ef13692631d7b0d6d5c98">ol_flags</a> &amp; <a class="code" href="rte__mbuf__core_8h.html#a9d2d4eca2fab4ef35c8f8a7f3bbe9fe2">PKT_TX_IPV4</a>) {</div>
<div class="line">        ipv4_hdr = l3_hdr;</div>
<div class="line">        ipv4_hdr-&gt;<a name="a70"></a><a class="code" href="structrte__ipv4__hdr.html#a18eefe32b805f7416152441ec67533b9">hdr_checksum</a> = 0;</div>
<div class="line">        m-&gt;<a class="code" href="structrte__mbuf.html#a319d580a6e1ef13692631d7b0d6d5c98">ol_flags</a> |= <a name="a71"></a><a class="code" href="rte__mbuf__core_8h.html#a51280725dafdf282a80b2d964418798c">PKT_TX_IP_CKSUM</a>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    tcp_hdr = (<span class="keyword">struct </span><a class="code" href="structrte__tcp__hdr.html">rte_tcp_hdr</a> *)((<span class="keywordtype">char</span> *)l3_hdr + m-&gt;<a name="a72"></a><a class="code" href="structrte__mbuf.html#a82a34cb6d5935a8c0f043f2783d6b42d">l3_len</a>);</div>
<div class="line">    tcp_hdr-&gt;<a name="a73"></a><a class="code" href="structrte__tcp__hdr.html#aba81d1981a9a665214dd2116a39e28f5">cksum</a> = get_psd_sum(l3_hdr, m-&gt;<a class="code" href="structrte__mbuf.html#a319d580a6e1ef13692631d7b0d6d5c98">ol_flags</a>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">free_pkts(<span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> **pkts, uint16_t n)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">while</span> (n--)</div>
<div class="line">        <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(pkts[n]);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <a class="code" href="rte__common_8h.html#af1e21922385a6cbe051e3ab70bba9f11">__rte_always_inline</a> <span class="keywordtype">void</span></div>
<div class="line">do_drain_mbuf_table(<span class="keyword">struct</span> mbuf_table *tx_q)</div>
<div class="line">{</div>
<div class="line">    uint16_t count;</div>
<div class="line"> </div>
<div class="line">    count = <a name="a74"></a><a class="code" href="rte__ethdev_8h.html#a83e56cabbd31637efd648e3fc010392b">rte_eth_tx_burst</a>(ports[0], tx_q-&gt;txq_id,</div>
<div class="line">                 tx_q-&gt;m_table, tx_q-&gt;len);</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(count &lt; tx_q-&gt;len))</div>
<div class="line">        free_pkts(&amp;tx_q-&gt;m_table[count], tx_q-&gt;len - count);</div>
<div class="line"> </div>
<div class="line">    tx_q-&gt;len = 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function routes the TX packet to the correct interface. This</span></div>
<div class="line"><span class="comment"> * may be a local device or the physical port.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="rte__common_8h.html#af1e21922385a6cbe051e3ab70bba9f11">__rte_always_inline</a> <span class="keywordtype">void</span></div>
<div class="line">virtio_tx_route(<span class="keyword">struct</span> vhost_dev *vdev, <span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *m, uint16_t vlan_tag)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>mbuf_table *tx_q;</div>
<div class="line">    <span class="keywordtype">unsigned</span> offset = 0;</div>
<div class="line">    <span class="keyword">const</span> uint16_t lcore_id = <a name="a75"></a><a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__ether__hdr.html">rte_ether_hdr</a> *nh;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    nh = <a class="code" href="rte__mbuf__core_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keyword">struct</span> <a class="code" href="structrte__ether__hdr.html">rte_ether_hdr</a> *);</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(<a name="a76"></a><a class="code" href="rte__ether_8h.html#afdc582d54410e8f913df5999574b4319">rte_is_broadcast_ether_addr</a>(&amp;nh-&gt;<a class="code" href="structrte__ether__hdr.html#a1d579e2782d36729c1f73608d8663124">d_addr</a>))) {</div>
<div class="line">        <span class="keyword">struct </span>vhost_dev *vdev2;</div>
<div class="line"> </div>
<div class="line">        TAILQ_FOREACH(vdev2, &amp;vhost_dev_list, global_vdev_entry) {</div>
<div class="line">            <span class="keywordflow">if</span> (vdev2 != vdev)</div>
<div class="line">                virtio_xmit(vdev2, vdev, m);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">goto</span> queue2nic;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*check if destination is local VM*/</span></div>
<div class="line">    <span class="keywordflow">if</span> ((vm2vm_mode == VM2VM_SOFTWARE) &amp;&amp; (virtio_tx_local(vdev, m) == 0)) {</div>
<div class="line">        <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(vm2vm_mode == VM2VM_HARDWARE)) {</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(find_local_dest(vdev, m, &amp;offset,</div>
<div class="line">                         &amp;vlan_tag) != 0)) {</div>
<div class="line">            <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(m);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="rte__log_8h.html#aeed72aff1af9a59d2de85b96955e21f9">RTE_LOG_DP</a>(DEBUG, VHOST_DATA,</div>
<div class="line">        <span class="stringliteral">&quot;(%d) TX: MAC address is external\n&quot;</span>, vdev-&gt;vid);</div>
<div class="line"> </div>
<div class="line">queue2nic:</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*Add packet to the port tx queue*/</span></div>
<div class="line">    tx_q = &amp;lcore_tx_queue[lcore_id];</div>
<div class="line"> </div>
<div class="line">    nh = <a class="code" href="rte__mbuf__core_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a>(m, <span class="keyword">struct</span> <a class="code" href="structrte__ether__hdr.html">rte_ether_hdr</a> *);</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(nh-&gt;<a name="a77"></a><a class="code" href="structrte__ether__hdr.html#ad6312397ccc57d322b1a037c7080d340">ether_type</a> == <a name="a78"></a><a class="code" href="rte__byteorder_8h.html#a6ec4cb000fc67785792d18728cf45563">rte_cpu_to_be_16</a>(<a name="a79"></a><a class="code" href="rte__ether_8h.html#a2099ac82c3c5a13ddb251799ec59c72c">RTE_ETHER_TYPE_VLAN</a>))) {</div>
<div class="line">        <span class="comment">/* Guest has inserted the vlan tag. */</span></div>
<div class="line">        <span class="keyword">struct </span><a name="_a80"></a><a class="code" href="structrte__vlan__hdr.html">rte_vlan_hdr</a> *vh = (<span class="keyword">struct </span><a class="code" href="structrte__vlan__hdr.html">rte_vlan_hdr</a> *) (nh + 1);</div>
<div class="line">        uint16_t vlan_tag_be = <a class="code" href="rte__byteorder_8h.html#a6ec4cb000fc67785792d18728cf45563">rte_cpu_to_be_16</a>(vlan_tag);</div>
<div class="line">        <span class="keywordflow">if</span> ((vm2vm_mode == VM2VM_HARDWARE) &amp;&amp;</div>
<div class="line">            (vh-&gt;<a name="a81"></a><a class="code" href="structrte__vlan__hdr.html#a466610c1a1f26aace575dc4dc60d81b3">vlan_tci</a> != vlan_tag_be))</div>
<div class="line">            vh-&gt;<a class="code" href="structrte__vlan__hdr.html#a466610c1a1f26aace575dc4dc60d81b3">vlan_tci</a> = vlan_tag_be;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        m-&gt;<a class="code" href="structrte__mbuf.html#a319d580a6e1ef13692631d7b0d6d5c98">ol_flags</a> |= PKT_TX_VLAN_PKT;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Find the right seg to adjust the data len when offset is</span></div>
<div class="line"><span class="comment">         * bigger than tail room size.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(vm2vm_mode == VM2VM_HARDWARE)) {</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(offset &lt;= <a name="a82"></a><a class="code" href="rte__mbuf_8h.html#a257bc8af3e8fde7eb6603bdf4ae0528e">rte_pktmbuf_tailroom</a>(m)))</div>
<div class="line">                m-&gt;<a name="a83"></a><a class="code" href="structrte__mbuf.html#ad1a572736a10ff6b282c5f43c4ea1ccf">data_len</a> += offset;</div>
<div class="line">            <span class="keywordflow">else</span> {</div>
<div class="line">                <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *seg = m;</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">while</span> ((seg-&gt;<a name="a84"></a><a class="code" href="structrte__mbuf.html#ac858fb3bb1a1d67a6efc9563d0c5a471">next</a> != NULL) &amp;&amp;</div>
<div class="line">                    (offset &gt; <a class="code" href="rte__mbuf_8h.html#a257bc8af3e8fde7eb6603bdf4ae0528e">rte_pktmbuf_tailroom</a>(seg)))</div>
<div class="line">                    seg = seg-&gt;<a class="code" href="structrte__mbuf.html#ac858fb3bb1a1d67a6efc9563d0c5a471">next</a>;</div>
<div class="line"> </div>
<div class="line">                seg-&gt;<a class="code" href="structrte__mbuf.html#ad1a572736a10ff6b282c5f43c4ea1ccf">data_len</a> += offset;</div>
<div class="line">            }</div>
<div class="line">            m-&gt;<a name="a85"></a><a class="code" href="structrte__mbuf.html#a5046af233a45d6d79ce1a5aae535b23c">pkt_len</a> += offset;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        m-&gt;<a name="a86"></a><a class="code" href="structrte__mbuf.html#a466610c1a1f26aace575dc4dc60d81b3">vlan_tci</a> = vlan_tag;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (m-&gt;<a class="code" href="structrte__mbuf.html#a319d580a6e1ef13692631d7b0d6d5c98">ol_flags</a> &amp; <a name="a87"></a><a class="code" href="rte__mbuf__core_8h.html#ad9d8db5f80d34e0a95c56df43d605c87">PKT_TX_TCP_SEG</a>)</div>
<div class="line">        virtio_tx_offload(m);</div>
<div class="line"> </div>
<div class="line">    tx_q-&gt;m_table[tx_q-&gt;len++] = m;</div>
<div class="line">    <span class="keywordflow">if</span> (enable_stats) {</div>
<div class="line">        vdev-&gt;stats.tx_total++;</div>
<div class="line">        vdev-&gt;stats.tx++;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(tx_q-&gt;len == MAX_PKT_BURST))</div>
<div class="line">        do_drain_mbuf_table(tx_q);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <a class="code" href="rte__common_8h.html#af1e21922385a6cbe051e3ab70bba9f11">__rte_always_inline</a> <span class="keywordtype">void</span></div>
<div class="line">drain_mbuf_table(<span class="keyword">struct</span> mbuf_table *tx_q)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">static</span> uint64_t prev_tsc;</div>
<div class="line">    uint64_t cur_tsc;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (tx_q-&gt;len == 0)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    cur_tsc = rte_rdtsc();</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(cur_tsc - prev_tsc &gt; MBUF_TABLE_DRAIN_TSC)) {</div>
<div class="line">        prev_tsc = cur_tsc;</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="rte__log_8h.html#aeed72aff1af9a59d2de85b96955e21f9">RTE_LOG_DP</a>(DEBUG, VHOST_DATA,</div>
<div class="line">            <span class="stringliteral">&quot;TX queue drained after timeout with burst size %u\n&quot;</span>,</div>
<div class="line">            tx_q-&gt;len);</div>
<div class="line">        do_drain_mbuf_table(tx_q);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <a class="code" href="rte__common_8h.html#af1e21922385a6cbe051e3ab70bba9f11">__rte_always_inline</a> <span class="keywordtype">void</span></div>
<div class="line">complete_async_pkts(<span class="keyword">struct</span> vhost_dev *vdev, uint16_t qid)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *p_cpl[MAX_PKT_BURST];</div>
<div class="line">    uint16_t complete_count;</div>
<div class="line"> </div>
<div class="line">    complete_count = rte_vhost_poll_enqueue_completed(vdev-&gt;vid,</div>
<div class="line">                        qid, p_cpl, MAX_PKT_BURST);</div>
<div class="line">    vdev-&gt;nr_async_pkts -= complete_count;</div>
<div class="line">    <span class="keywordflow">if</span> (complete_count)</div>
<div class="line">        free_pkts(p_cpl, complete_count);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <a class="code" href="rte__common_8h.html#af1e21922385a6cbe051e3ab70bba9f11">__rte_always_inline</a> <span class="keywordtype">void</span></div>
<div class="line">drain_eth_rx(<span class="keyword">struct</span> vhost_dev *vdev)</div>
<div class="line">{</div>
<div class="line">    uint16_t rx_count, enqueue_count;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkts[MAX_PKT_BURST];</div>
<div class="line"> </div>
<div class="line">    rx_count = <a class="code" href="rte__ethdev_8h.html#a3e7d76a451b46348686ea97d6367f102">rte_eth_rx_burst</a>(ports[0], vdev-&gt;vmdq_rx_q,</div>
<div class="line">                    pkts, MAX_PKT_BURST);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(vdev-&gt;nr_async_pkts))</div>
<div class="line">        complete_async_pkts(vdev, VIRTIO_RXQ);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!rx_count)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * When &quot;enable_retry&quot; is set, here we wait and retry when there</span></div>
<div class="line"><span class="comment">     * is no enough free slots in the queue to hold @rx_count packets,</span></div>
<div class="line"><span class="comment">     * to diminish packet loss.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">if</span> (enable_retry &amp;&amp;</div>
<div class="line">        <a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(rx_count &gt; <a name="a88"></a><a class="code" href="rte__vhost_8h.html#a4ce29baa4ace979410c756d2995fcfbc">rte_vhost_avail_entries</a>(vdev-&gt;vid,</div>
<div class="line">            VIRTIO_RXQ))) {</div>
<div class="line">        uint32_t retry;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (retry = 0; retry &lt; burst_rx_retry_num; retry++) {</div>
<div class="line">            <a name="a89"></a><a class="code" href="rte__cycles_8h.html#ab1c632a1dbe8e69c028fce82c055feb7">rte_delay_us</a>(burst_rx_delay_time);</div>
<div class="line">            <span class="keywordflow">if</span> (rx_count &lt;= <a class="code" href="rte__vhost_8h.html#a4ce29baa4ace979410c756d2995fcfbc">rte_vhost_avail_entries</a>(vdev-&gt;vid,</div>
<div class="line">                    VIRTIO_RXQ))</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (builtin_net_driver) {</div>
<div class="line">        enqueue_count = vs_enqueue_pkts(vdev, VIRTIO_RXQ,</div>
<div class="line">                        pkts, rx_count);</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (async_vhost_driver) {</div>
<div class="line">        enqueue_count = rte_vhost_submit_enqueue_burst(vdev-&gt;vid,</div>
<div class="line">                    VIRTIO_RXQ, pkts, rx_count);</div>
<div class="line">        vdev-&gt;nr_async_pkts += enqueue_count;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        enqueue_count = <a class="code" href="rte__vhost_8h.html#aab322aa002dabda6b4c6c643afd89379">rte_vhost_enqueue_burst</a>(vdev-&gt;vid, VIRTIO_RXQ,</div>
<div class="line">                        pkts, rx_count);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (enable_stats) {</div>
<div class="line">        <a class="code" href="rte__atomic_8h.html#a12d91660e8a43da8882ae9d848d4327c">rte_atomic64_add</a>(&amp;vdev-&gt;stats.rx_total_atomic, rx_count);</div>
<div class="line">        <a class="code" href="rte__atomic_8h.html#a12d91660e8a43da8882ae9d848d4327c">rte_atomic64_add</a>(&amp;vdev-&gt;stats.rx_atomic, enqueue_count);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!async_vhost_driver)</div>
<div class="line">        free_pkts(pkts, rx_count);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <a class="code" href="rte__common_8h.html#af1e21922385a6cbe051e3ab70bba9f11">__rte_always_inline</a> <span class="keywordtype">void</span></div>
<div class="line">drain_virtio_tx(<span class="keyword">struct</span> vhost_dev *vdev)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkts[MAX_PKT_BURST];</div>
<div class="line">    uint16_t count;</div>
<div class="line">    uint16_t i;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (builtin_net_driver) {</div>
<div class="line">        count = vs_dequeue_pkts(vdev, VIRTIO_TXQ, mbuf_pool,</div>
<div class="line">                    pkts, MAX_PKT_BURST);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        count = <a name="a90"></a><a class="code" href="rte__vhost_8h.html#a2da232dbf5306f4903ae3285d71a97d7">rte_vhost_dequeue_burst</a>(vdev-&gt;vid, VIRTIO_TXQ,</div>
<div class="line">                    mbuf_pool, pkts, MAX_PKT_BURST);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* setup VMDq for the first packet */</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(vdev-&gt;ready == DEVICE_MAC_LEARNING) &amp;&amp; count) {</div>
<div class="line">        <span class="keywordflow">if</span> (vdev-&gt;remove || link_vmdq(vdev, pkts[0]) == -1)</div>
<div class="line">            free_pkts(pkts, count);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; count; ++i)</div>
<div class="line">        virtio_tx_route(vdev, pkts[i], vlan_tags[vdev-&gt;vid]);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Main function of vhost-switch. It basically does:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * for each vhost device {</span></div>
<div class="line"><span class="comment"> *    - drain_eth_rx()</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *      Which drains the host eth Rx queue linked to the vhost device,</span></div>
<div class="line"><span class="comment"> *      and deliver all of them to guest virito Rx ring associated with</span></div>
<div class="line"><span class="comment"> *      this vhost device.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *    - drain_virtio_tx()</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *      Which drains the guest virtio Tx queue and deliver all of them</span></div>
<div class="line"><span class="comment"> *      to the target, which could be another vhost device, or the</span></div>
<div class="line"><span class="comment"> *      physical eth dev. The route is done in function &quot;virtio_tx_route&quot;.</span></div>
<div class="line"><span class="comment"> * }</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">switch_worker(<span class="keywordtype">void</span> *arg <a name="a91"></a><a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line">    <span class="keywordtype">unsigned</span> lcore_id = <a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>();</div>
<div class="line">    <span class="keyword">struct </span>vhost_dev *vdev;</div>
<div class="line">    <span class="keyword">struct </span>mbuf_table *tx_q;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA, <span class="stringliteral">&quot;Procesing on Core %u started\n&quot;</span>, lcore_id);</div>
<div class="line"> </div>
<div class="line">    tx_q = &amp;lcore_tx_queue[lcore_id];</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="rte__lcore_8h.html#a1728dc7f14571ba778d3b5b41aa09283">rte_lcore_count</a>(); i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (lcore_ids[i] == lcore_id) {</div>
<div class="line">            tx_q-&gt;txq_id = i;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span>(1) {</div>
<div class="line">        drain_mbuf_table(tx_q);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Inform the configuration core that we have exited the</span></div>
<div class="line"><span class="comment">         * linked list and that no devices are in use if requested.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">if</span> (lcore_info[lcore_id].dev_removal_flag == REQUEST_DEV_REMOVAL)</div>
<div class="line">            lcore_info[lcore_id].dev_removal_flag = ACK_DEV_REMOVAL;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Process vhost devices</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        TAILQ_FOREACH(vdev, &amp;lcore_info[lcore_id].vdev_list,</div>
<div class="line">                  lcore_vdev_entry) {</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(vdev-&gt;remove)) {</div>
<div class="line">                unlink_vmdq(vdev);</div>
<div class="line">                vdev-&gt;ready = DEVICE_SAFE_REMOVE;</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(vdev-&gt;ready == DEVICE_RX))</div>
<div class="line">                drain_eth_rx(vdev);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(!vdev-&gt;remove))</div>
<div class="line">                drain_virtio_tx(vdev);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Remove a device from the specific data core linked list and from the</span></div>
<div class="line"><span class="comment"> * main linked list. Synchonization  occurs through the use of the</span></div>
<div class="line"><span class="comment"> * lcore dev_removal_flag. Device is made volatile here to avoid re-ordering</span></div>
<div class="line"><span class="comment"> * of dev-&gt;remove=1 which can cause an infinite loop in the rte_pause loop.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">destroy_device(<span class="keywordtype">int</span> vid)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>vhost_dev *vdev = NULL;</div>
<div class="line">    <span class="keywordtype">int</span> lcore;</div>
<div class="line"> </div>
<div class="line">    TAILQ_FOREACH(vdev, &amp;vhost_dev_list, global_vdev_entry) {</div>
<div class="line">        <span class="keywordflow">if</span> (vdev-&gt;vid == vid)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (!vdev)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    <span class="comment">/*set the remove flag. */</span></div>
<div class="line">    vdev-&gt;remove = 1;</div>
<div class="line">    <span class="keywordflow">while</span>(vdev-&gt;ready != DEVICE_SAFE_REMOVE) {</div>
<div class="line">        <a name="a92"></a><a class="code" href="rte__pause_8h.html#ad59aa7777c93d3cfd5f10617a3acd1c5">rte_pause</a>();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (builtin_net_driver)</div>
<div class="line">        vs_vhost_net_remove(vdev);</div>
<div class="line"> </div>
<div class="line">    TAILQ_REMOVE(&amp;lcore_info[vdev-&gt;coreid].vdev_list, vdev,</div>
<div class="line">             lcore_vdev_entry);</div>
<div class="line">    TAILQ_REMOVE(&amp;vhost_dev_list, vdev, global_vdev_entry);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Set the dev_removal_flag on each lcore. */</span></div>
<div class="line">    <a name="a93"></a><a class="code" href="rte__lcore_8h.html#ac779e61584eb9d087c3e20bf2d1150c8">RTE_LCORE_FOREACH_WORKER</a>(lcore)</div>
<div class="line">        lcore_info[lcore].dev_removal_flag = REQUEST_DEV_REMOVAL;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Once each core has set the dev_removal_flag to ACK_DEV_REMOVAL</span></div>
<div class="line"><span class="comment">     * we can be sure that they can no longer access the device removed</span></div>
<div class="line"><span class="comment">     * from the linked lists and that the devices are no longer in use.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <a class="code" href="rte__lcore_8h.html#ac779e61584eb9d087c3e20bf2d1150c8">RTE_LCORE_FOREACH_WORKER</a>(lcore) {</div>
<div class="line">        <span class="keywordflow">while</span> (lcore_info[lcore].dev_removal_flag != ACK_DEV_REMOVAL)</div>
<div class="line">            <a class="code" href="rte__pause_8h.html#ad59aa7777c93d3cfd5f10617a3acd1c5">rte_pause</a>();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    lcore_info[vdev-&gt;coreid].device_num--;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA,</div>
<div class="line">        <span class="stringliteral">&quot;(%d) device has been removed from data core\n&quot;</span>,</div>
<div class="line">        vdev-&gt;vid);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (async_vhost_driver)</div>
<div class="line">        rte_vhost_async_channel_unregister(vid, VIRTIO_RXQ);</div>
<div class="line"> </div>
<div class="line">    <a name="a94"></a><a class="code" href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a>(vdev);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * A new device is added to a data core. First the device is added to the main linked list</span></div>
<div class="line"><span class="comment"> * and then allocated to a specific data core.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">new_device(<span class="keywordtype">int</span> vid)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> lcore, core_add = 0;</div>
<div class="line">    uint32_t device_num_min = num_devices;</div>
<div class="line">    <span class="keyword">struct </span>vhost_dev *vdev;</div>
<div class="line">    vdev = <a name="a95"></a><a class="code" href="rte__malloc_8h.html#aaf0f048a5fd1672688c662cdfb4536b3">rte_zmalloc</a>(<span class="stringliteral">&quot;vhost device&quot;</span>, <span class="keyword">sizeof</span>(*vdev), RTE_CACHE_LINE_SIZE);</div>
<div class="line">    <span class="keywordflow">if</span> (vdev == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA,</div>
<div class="line">            <span class="stringliteral">&quot;(%d) couldn&#39;t allocate memory for vhost dev\n&quot;</span>,</div>
<div class="line">            vid);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    vdev-&gt;vid = vid;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (builtin_net_driver)</div>
<div class="line">        vs_vhost_net_setup(vdev);</div>
<div class="line"> </div>
<div class="line">    TAILQ_INSERT_TAIL(&amp;vhost_dev_list, vdev, global_vdev_entry);</div>
<div class="line">    vdev-&gt;vmdq_rx_q = vid * queues_per_pool + vmdq_queue_base;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*reset ready flag*/</span></div>
<div class="line">    vdev-&gt;ready = DEVICE_MAC_LEARNING;</div>
<div class="line">    vdev-&gt;remove = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Find a suitable lcore to add the device. */</span></div>
<div class="line">    <a class="code" href="rte__lcore_8h.html#ac779e61584eb9d087c3e20bf2d1150c8">RTE_LCORE_FOREACH_WORKER</a>(lcore) {</div>
<div class="line">        <span class="keywordflow">if</span> (lcore_info[lcore].device_num &lt; device_num_min) {</div>
<div class="line">            device_num_min = lcore_info[lcore].device_num;</div>
<div class="line">            core_add = lcore;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    vdev-&gt;coreid = core_add;</div>
<div class="line"> </div>
<div class="line">    TAILQ_INSERT_TAIL(&amp;lcore_info[vdev-&gt;coreid].vdev_list, vdev,</div>
<div class="line">              lcore_vdev_entry);</div>
<div class="line">    lcore_info[vdev-&gt;coreid].device_num++;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Disable notifications. */</span></div>
<div class="line">    rte_vhost_enable_guest_notification(vid, VIRTIO_RXQ, 0);</div>
<div class="line">    rte_vhost_enable_guest_notification(vid, VIRTIO_TXQ, 0);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_DATA,</div>
<div class="line">        <span class="stringliteral">&quot;(%d) device has been added to data core %d\n&quot;</span>,</div>
<div class="line">        vid, vdev-&gt;coreid);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (async_vhost_driver) {</div>
<div class="line">        <span class="keyword">struct </span><a name="_a96"></a><a class="code" href="structrte__vhost__async__features.html">rte_vhost_async_features</a> f;</div>
<div class="line">        <span class="keyword">struct </span><a name="_a97"></a><a class="code" href="structrte__vhost__async__channel__ops.html">rte_vhost_async_channel_ops</a> channel_ops;</div>
<div class="line">        <span class="keywordflow">if</span> (strncmp(dma_type, <span class="stringliteral">&quot;ioat&quot;</span>, 4) == 0) {</div>
<div class="line">            channel_ops.<a name="a98"></a><a class="code" href="structrte__vhost__async__channel__ops.html#a99cbb00e83cf08d0f5cb7a901d00894d">transfer_data</a> = ioat_transfer_data_cb;</div>
<div class="line">            channel_ops.check_completed_copies =</div>
<div class="line">                ioat_check_completed_copies_cb;</div>
<div class="line">            f.async_inorder = 1;</div>
<div class="line">            f.async_threshold = 256;</div>
<div class="line">            <span class="keywordflow">return</span> rte_vhost_async_channel_register(vid, VIRTIO_RXQ,</div>
<div class="line">                f.intval, &amp;channel_ops);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * These callback allow devices to be added to the data core when configuration</span></div>
<div class="line"><span class="comment"> * has been fully complete.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a name="_a99"></a><a class="code" href="structvhost__device__ops.html">vhost_device_ops</a> virtio_net_device_ops =</div>
<div class="line">{</div>
<div class="line">    .<a name="a100"></a><a class="code" href="structvhost__device__ops.html#a4395345b85225cd12bf33d36ac089f63">new_device</a> =  <a class="code" href="structvhost__device__ops.html#a4395345b85225cd12bf33d36ac089f63">new_device</a>,</div>
<div class="line">    .destroy_device = <a name="a101"></a><a class="code" href="structvhost__device__ops.html#adbd762e64dae12b68686afcf873cd808">destroy_device</a>,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This is a thread will wake up after a period to print stats if the user has</span></div>
<div class="line"><span class="comment"> * enabled them.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line">print_stats(<a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">void</span> *arg)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>vhost_dev *vdev;</div>
<div class="line">    uint64_t tx_dropped, rx_dropped;</div>
<div class="line">    uint64_t tx, tx_total, rx, rx_total;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> clr[] = { 27, <span class="charliteral">&#39;[&#39;</span>, <span class="charliteral">&#39;2&#39;</span>, <span class="charliteral">&#39;J&#39;</span>, <span class="charliteral">&#39;\0&#39;</span> };</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> top_left[] = { 27, <span class="charliteral">&#39;[&#39;</span>, <span class="charliteral">&#39;1&#39;</span>, <span class="charliteral">&#39;;&#39;</span>, <span class="charliteral">&#39;1&#39;</span>, <span class="charliteral">&#39;H&#39;</span>,<span class="charliteral">&#39;\0&#39;</span> };</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span>(1) {</div>
<div class="line">        sleep(enable_stats);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Clear screen and move to top left */</span></div>
<div class="line">        printf(<span class="stringliteral">&quot;%s%s\n&quot;</span>, clr, top_left);</div>
<div class="line">        printf(<span class="stringliteral">&quot;Device statistics =================================\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        TAILQ_FOREACH(vdev, &amp;vhost_dev_list, global_vdev_entry) {</div>
<div class="line">            tx_total   = vdev-&gt;stats.tx_total;</div>
<div class="line">            tx         = vdev-&gt;stats.tx;</div>
<div class="line">            tx_dropped = tx_total - tx;</div>
<div class="line"> </div>
<div class="line">            rx_total   = <a name="a102"></a><a class="code" href="rte__atomic_8h.html#af5dc5024c16f1569cca1c2b758e9b5cd">rte_atomic64_read</a>(&amp;vdev-&gt;stats.rx_total_atomic);</div>
<div class="line">            rx         = <a class="code" href="rte__atomic_8h.html#af5dc5024c16f1569cca1c2b758e9b5cd">rte_atomic64_read</a>(&amp;vdev-&gt;stats.rx_atomic);</div>
<div class="line">            rx_dropped = rx_total - rx;</div>
<div class="line"> </div>
<div class="line">            printf(<span class="stringliteral">&quot;Statistics for device %d\n&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;-----------------------\n&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;TX total:              %&quot;</span> PRIu64 <span class="stringliteral">&quot;\n&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;TX dropped:            %&quot;</span> PRIu64 <span class="stringliteral">&quot;\n&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;TX successful:         %&quot;</span> PRIu64 <span class="stringliteral">&quot;\n&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;RX total:              %&quot;</span> PRIu64 <span class="stringliteral">&quot;\n&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;RX dropped:            %&quot;</span> PRIu64 <span class="stringliteral">&quot;\n&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;RX successful:         %&quot;</span> PRIu64 <span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">                vdev-&gt;vid,</div>
<div class="line">                tx_total, tx_dropped, tx,</div>
<div class="line">                rx_total, rx_dropped, rx);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        printf(<span class="stringliteral">&quot;===================================================\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        fflush(stdout);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">unregister_drivers(<span class="keywordtype">int</span> socket_num)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> i, ret;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; socket_num; i++) {</div>
<div class="line">        ret = rte_vhost_driver_unregister(socket_files + i * PATH_MAX);</div>
<div class="line">        <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VHOST_CONFIG,</div>
<div class="line">                <span class="stringliteral">&quot;Fail to unregister vhost driver for %s.\n&quot;</span>,</div>
<div class="line">                socket_files + i * PATH_MAX);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* When we receive a INT signal, unregister vhost driver */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">sigint_handler(<a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">int</span> signum)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Unregister vhost driver. */</span></div>
<div class="line">    unregister_drivers(nb_sockets);</div>
<div class="line"> </div>
<div class="line">    exit(0);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * While creating an mbuf pool, one key thing is to figure out how</span></div>
<div class="line"><span class="comment"> * many mbuf entries is enough for our use. FYI, here are some</span></div>
<div class="line"><span class="comment"> * guidelines:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * - Each rx queue would reserve @nr_rx_desc mbufs at queue setup stage</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * - For each switch core (A CPU core does the packet switch), we need</span></div>
<div class="line"><span class="comment"> *   also make some reservation for receiving the packets from virtio</span></div>
<div class="line"><span class="comment"> *   Tx queue. How many is enough depends on the usage. It&#39;s normally</span></div>
<div class="line"><span class="comment"> *   a simple calculation like following:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *       MAX_PKT_BURST * max packet size / mbuf size</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *   So, we definitely need allocate more mbufs when TSO is enabled.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * - Similarly, for each switching core, we should serve @nr_rx_desc</span></div>
<div class="line"><span class="comment"> *   mbufs for receiving the packets from physical NIC device.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * - We also need make sure, for each switch core, we have allocated</span></div>
<div class="line"><span class="comment"> *   enough mbufs to fill up the mbuf cache.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">create_mbuf_pool(uint16_t nr_port, uint32_t nr_switch_core, uint32_t mbuf_size,</div>
<div class="line">    uint32_t nr_queues, uint32_t nr_rx_desc, uint32_t nr_mbuf_cache)</div>
<div class="line">{</div>
<div class="line">    uint32_t nr_mbufs;</div>
<div class="line">    uint32_t nr_mbufs_per_core;</div>
<div class="line">    uint32_t mtu = 1500;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (mergeable)</div>
<div class="line">        mtu = 9000;</div>
<div class="line">    <span class="keywordflow">if</span> (enable_tso)</div>
<div class="line">        mtu = 64 * 1024;</div>
<div class="line"> </div>
<div class="line">    nr_mbufs_per_core  = (mtu + mbuf_size) * MAX_PKT_BURST /</div>
<div class="line">            (mbuf_size - RTE_PKTMBUF_HEADROOM);</div>
<div class="line">    nr_mbufs_per_core += nr_rx_desc;</div>
<div class="line">    nr_mbufs_per_core  = <a name="a103"></a><a class="code" href="rte__common_8h.html#a8df8b303b8ea240cf6aebf937fd21eaf">RTE_MAX</a>(nr_mbufs_per_core, nr_mbuf_cache);</div>
<div class="line"> </div>
<div class="line">    nr_mbufs  = nr_queues * nr_rx_desc;</div>
<div class="line">    nr_mbufs += nr_mbufs_per_core * nr_switch_core;</div>
<div class="line">    nr_mbufs *= nr_port;</div>
<div class="line"> </div>
<div class="line">    mbuf_pool = <a name="a104"></a><a class="code" href="rte__mbuf_8h.html#a593921f13307803b94bbb4e0932db962">rte_pktmbuf_pool_create</a>(<span class="stringliteral">&quot;MBUF_POOL&quot;</span>, nr_mbufs,</div>
<div class="line">                        nr_mbuf_cache, 0, mbuf_size,</div>
<div class="line">                        <a name="a105"></a><a class="code" href="rte__lcore_8h.html#a7c8da4664df26a64cf05dc508a4f26df">rte_socket_id</a>());</div>
<div class="line">    <span class="keywordflow">if</span> (mbuf_pool == NULL)</div>
<div class="line">        <a name="a106"></a><a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Cannot create mbuf pool\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Main function, does initialisation and calls the per-lcore functions.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> lcore_id, core_id = 0;</div>
<div class="line">    <span class="keywordtype">unsigned</span> nb_ports, valid_num_ports;</div>
<div class="line">    <span class="keywordtype">int</span> ret, i;</div>
<div class="line">    uint16_t portid;</div>
<div class="line">    <span class="keyword">static</span> pthread_t tid;</div>
<div class="line">    uint64_t flags = 0;</div>
<div class="line"> </div>
<div class="line">    signal(SIGINT, sigint_handler);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* init EAL */</span></div>
<div class="line">    ret = <a name="a107"></a><a class="code" href="rte__eal_8h.html#a5c3f4dddc25e38c5a186ecd8a69260e3">rte_eal_init</a>(argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Error with EAL initialization\n&quot;</span>);</div>
<div class="line">    argc -= ret;</div>
<div class="line">    argv += ret;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* parse app arguments */</span></div>
<div class="line">    ret = us_vhost_parse_args(argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Invalid argument\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (lcore_id = 0; lcore_id &lt; RTE_MAX_LCORE; lcore_id++) {</div>
<div class="line">        TAILQ_INIT(&amp;lcore_info[lcore_id].vdev_list);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a108"></a><a class="code" href="rte__lcore_8h.html#a5404ee6ac26cbe5a4f4ddef44d690b76">rte_lcore_is_enabled</a>(lcore_id))</div>
<div class="line">            lcore_ids[core_id++] = lcore_id;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__lcore_8h.html#a1728dc7f14571ba778d3b5b41aa09283">rte_lcore_count</a>() &gt; RTE_MAX_LCORE)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE,<span class="stringliteral">&quot;Not enough cores\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Get the number of physical ports. */</span></div>
<div class="line">    nb_ports = <a name="a109"></a><a class="code" href="rte__ethdev_8h.html#a9ab708089665bebcd65cefe5383b24f2">rte_eth_dev_count_avail</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Update the global var NUM_PORTS and global array PORTS</span></div>
<div class="line"><span class="comment">     * and get value of var VALID_NUM_PORTS according to system ports number</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    valid_num_ports = check_ports_num(nb_ports);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ((valid_num_ports ==  0) || (valid_num_ports &gt; MAX_SUP_PORTS)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT, <span class="stringliteral">&quot;Current enabled port number is %u,&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;but only %u port can be enabled\n&quot;</span>,num_ports, MAX_SUP_PORTS);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * FIXME: here we are trying to allocate mbufs big enough for</span></div>
<div class="line"><span class="comment">     * @MAX_QUEUES, but the truth is we&#39;re never going to use that</span></div>
<div class="line"><span class="comment">     * many queues here. We probably should only do allocation for</span></div>
<div class="line"><span class="comment">     * those queues we are going to use.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    create_mbuf_pool(valid_num_ports, <a class="code" href="rte__lcore_8h.html#a1728dc7f14571ba778d3b5b41aa09283">rte_lcore_count</a>() - 1, MBUF_DATA_SIZE,</div>
<div class="line">             MAX_QUEUES, RTE_TEST_RX_DESC_DEFAULT, MBUF_CACHE_SIZE);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (vm2vm_mode == VM2VM_HARDWARE) {</div>
<div class="line">        <span class="comment">/* Enable VT loop back to let L2 switch to do it. */</span></div>
<div class="line">        vmdq_conf_default.<a class="code" href="structrte__eth__conf.html#a084e132696e8d0f59f643d822c8cedb7">rx_adv_conf</a>.<a class="code" href="structrte__eth__conf.html#a17845d02c4ddfdc09982bd899b6df06e">vmdq_rx_conf</a>.<a class="code" href="structrte__eth__vmdq__rx__conf.html#afa7945c6936c8595f02f0a5408af42bd">enable_loop_back</a> = 1;</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(DEBUG, VHOST_CONFIG,</div>
<div class="line">            <span class="stringliteral">&quot;Enable loop back for L2 switch in vmdq.\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* initialize all ports */</span></div>
<div class="line">    <a name="a110"></a><a class="code" href="rte__ethdev_8h.html#ad7b46c67203d37fe3a34f11076d970d6">RTE_ETH_FOREACH_DEV</a>(portid) {</div>
<div class="line">        <span class="comment">/* skip ports that are not enabled */</span></div>
<div class="line">        <span class="keywordflow">if</span> ((enabled_port_mask &amp; (1 &lt;&lt; portid)) == 0) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, VHOST_PORT,</div>
<div class="line">                <span class="stringliteral">&quot;Skipping disabled port %d\n&quot;</span>, portid);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (port_init(portid) != 0)</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">                <span class="stringliteral">&quot;Cannot initialize network ports\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Enable stats if the user option is set. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (enable_stats) {</div>
<div class="line">        ret = <a name="a111"></a><a class="code" href="rte__lcore_8h.html#aa0bd7a4983e66d9ea893a98d25262914">rte_ctrl_thread_create</a>(&amp;tid, <span class="stringliteral">&quot;print-stats&quot;</span>, NULL,</div>
<div class="line">                    print_stats, NULL);</div>
<div class="line">        <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">                <span class="stringliteral">&quot;Cannot create print-stats thread\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Launch all data cores. */</span></div>
<div class="line">    <a class="code" href="rte__lcore_8h.html#ac779e61584eb9d087c3e20bf2d1150c8">RTE_LCORE_FOREACH_WORKER</a>(lcore_id)</div>
<div class="line">        <a name="a112"></a><a class="code" href="rte__launch_8h.html#a2bf98eda211728b3dc69aa7694758c6d">rte_eal_remote_launch</a>(switch_worker, NULL, lcore_id);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (client_mode)</div>
<div class="line">        flags |= RTE_VHOST_USER_CLIENT;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Register vhost user driver to handle vhost messages. */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; nb_sockets; i++) {</div>
<div class="line">        <span class="keywordtype">char</span> *file = socket_files + i * PATH_MAX;</div>
<div class="line">        <span class="keywordflow">if</span> (async_vhost_driver)</div>
<div class="line">            flags = flags | RTE_VHOST_USER_ASYNC_COPY;</div>
<div class="line"> </div>
<div class="line">        ret = <a name="a113"></a><a class="code" href="rte__vhost_8h.html#a8a3ce366de790a49a0b64f1d7e42eea6">rte_vhost_driver_register</a>(file, flags);</div>
<div class="line">        <span class="keywordflow">if</span> (ret != 0) {</div>
<div class="line">            unregister_drivers(i);</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">                <span class="stringliteral">&quot;vhost driver register failure.\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (builtin_net_driver)</div>
<div class="line">            <a name="a114"></a><a class="code" href="rte__vhost_8h.html#a4455350b61b2ac164c2239ab320387cd">rte_vhost_driver_set_features</a>(file, VIRTIO_NET_FEATURES);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (mergeable == 0) {</div>
<div class="line">            <a name="a115"></a><a class="code" href="rte__vhost_8h.html#afa4c6cbe7c20587979918137353a738f">rte_vhost_driver_disable_features</a>(file,</div>
<div class="line">                1ULL &lt;&lt; VIRTIO_NET_F_MRG_RXBUF);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (enable_tx_csum == 0) {</div>
<div class="line">            <a class="code" href="rte__vhost_8h.html#afa4c6cbe7c20587979918137353a738f">rte_vhost_driver_disable_features</a>(file,</div>
<div class="line">                1ULL &lt;&lt; VIRTIO_NET_F_CSUM);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (enable_tso == 0) {</div>
<div class="line">            <a class="code" href="rte__vhost_8h.html#afa4c6cbe7c20587979918137353a738f">rte_vhost_driver_disable_features</a>(file,</div>
<div class="line">                1ULL &lt;&lt; VIRTIO_NET_F_HOST_TSO4);</div>
<div class="line">            <a class="code" href="rte__vhost_8h.html#afa4c6cbe7c20587979918137353a738f">rte_vhost_driver_disable_features</a>(file,</div>
<div class="line">                1ULL &lt;&lt; VIRTIO_NET_F_HOST_TSO6);</div>
<div class="line">            <a class="code" href="rte__vhost_8h.html#afa4c6cbe7c20587979918137353a738f">rte_vhost_driver_disable_features</a>(file,</div>
<div class="line">                1ULL &lt;&lt; VIRTIO_NET_F_GUEST_TSO4);</div>
<div class="line">            <a class="code" href="rte__vhost_8h.html#afa4c6cbe7c20587979918137353a738f">rte_vhost_driver_disable_features</a>(file,</div>
<div class="line">                1ULL &lt;&lt; VIRTIO_NET_F_GUEST_TSO6);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (promiscuous) {</div>
<div class="line">            <a name="a116"></a><a class="code" href="rte__vhost_8h.html#aac49be562963c15d4cb1b6bbb75147de">rte_vhost_driver_enable_features</a>(file,</div>
<div class="line">                1ULL &lt;&lt; VIRTIO_NET_F_CTRL_RX);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        ret = rte_vhost_driver_callback_register(file,</div>
<div class="line">            &amp;virtio_net_device_ops);</div>
<div class="line">        <span class="keywordflow">if</span> (ret != 0) {</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">                <span class="stringliteral">&quot;failed to register vhost driver callbacks.\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a117"></a><a class="code" href="rte__vhost_8h.html#a794f0d9c9550fe705a9b090c72cfe7be">rte_vhost_driver_start</a>(file) &lt; 0) {</div>
<div class="line">            <a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">                <span class="stringliteral">&quot;failed to start vhost driver.\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="rte__lcore_8h.html#ac779e61584eb9d087c3e20bf2d1150c8">RTE_LCORE_FOREACH_WORKER</a>(lcore_id)</div>
<div class="line">        <a name="a118"></a><a class="code" href="rte__launch_8h.html#ae9500e1d35bd4cfb95d18c0be863cb1e">rte_eal_wait_lcore</a>(lcore_id);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line"> </div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<div class="ttc" id="arte__common_8h_html_a8df8b303b8ea240cf6aebf937fd21eaf"><div class="ttname"><a href="rte__common_8h.html#a8df8b303b8ea240cf6aebf937fd21eaf">RTE_MAX</a></div><div class="ttdeci">#define RTE_MAX(a, b)</div><div class="ttdef"><b>Definition:</b> <a href="rte__common_8h_source.html#l00583">rte_common.h:583</a></div></div>
<div class="ttc" id="astructvhost__device__ops_html_a4395345b85225cd12bf33d36ac089f63"><div class="ttname"><a href="structvhost__device__ops.html#a4395345b85225cd12bf33d36ac089f63">vhost_device_ops::new_device</a></div><div class="ttdeci">int(* new_device)(int vid)</div><div class="ttdef"><b>Definition:</b> <a href="rte__vhost_8h_source.html#l00267">rte_vhost.h:267</a></div></div>
<div class="ttc" id="astructrte__mbuf_html_ac858fb3bb1a1d67a6efc9563d0c5a471"><div class="ttname"><a href="structrte__mbuf.html#ac858fb3bb1a1d67a6efc9563d0c5a471">rte_mbuf::next</a></div><div class="ttdeci">struct rte_mbuf * next</div><div class="ttdef"><b>Definition:</b> <a href="rte__mbuf__core_8h_source.html#l00594">rte_mbuf_core.h:594</a></div></div>
<div class="ttc" id="arte__vhost_8h_html_a794f0d9c9550fe705a9b090c72cfe7be"><div class="ttname"><a href="rte__vhost_8h.html#a794f0d9c9550fe705a9b090c72cfe7be">rte_vhost_driver_start</a></div><div class="ttdeci">int rte_vhost_driver_start(const char *path)</div></div>
<div class="ttc" id="arte__ethdev_8h_html_ad31219b87a1733d5b367a7c04c7f7b48"><div class="ttname"><a href="rte__ethdev_8h.html#ad31219b87a1733d5b367a7c04c7f7b48">rte_eth_dev_adjust_nb_rx_tx_desc</a></div><div class="ttdeci">int rte_eth_dev_adjust_nb_rx_tx_desc(uint16_t port_id, uint16_t *nb_rx_desc, uint16_t *nb_tx_desc)</div></div>
<div class="ttc" id="astructrte__ether__hdr_html_acce632e0fded0f728a1ee1a1ffb5c9bf"><div class="ttname"><a href="structrte__ether__hdr.html#acce632e0fded0f728a1ee1a1ffb5c9bf">rte_ether_hdr::s_addr</a></div><div class="ttdeci">struct rte_ether_addr s_addr</div><div class="ttdef"><b>Definition:</b> <a href="rte__ether_8h_source.html#l00000">rte_ether.h:266</a></div></div>
<div class="ttc" id="arte__vhost_8h_html_a8a3ce366de790a49a0b64f1d7e42eea6"><div class="ttname"><a href="rte__vhost_8h.html#a8a3ce366de790a49a0b64f1d7e42eea6">rte_vhost_driver_register</a></div><div class="ttdeci">int rte_vhost_driver_register(const char *path, uint64_t flags)</div></div>
<div class="ttc" id="arte__pause_8h_html"><div class="ttname"><a href="rte__pause_8h.html">rte_pause.h</a></div></div>
<div class="ttc" id="arte__malloc_8h_html_aaf0f048a5fd1672688c662cdfb4536b3"><div class="ttname"><a href="rte__malloc_8h.html#aaf0f048a5fd1672688c662cdfb4536b3">rte_zmalloc</a></div><div class="ttdeci">void * rte_zmalloc(const char *type, size_t size, unsigned align) __rte_alloc_size(2)</div></div>
<div class="ttc" id="arte__vhost_8h_html"><div class="ttname"><a href="rte__vhost_8h.html">rte_vhost.h</a></div></div>
<div class="ttc" id="arte__malloc_8h_html"><div class="ttname"><a href="rte__malloc_8h.html">rte_malloc.h</a></div></div>
<div class="ttc" id="astructrte__eth__rxconf_html"><div class="ttname"><a href="structrte__eth__rxconf.html">rte_eth_rxconf</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l01032">rte_ethdev.h:1032</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_a35b7466d51590b9c30fc40134b043ba7"><div class="ttname"><a href="rte__ethdev_8h.html#a35b7466d51590b9c30fc40134b043ba7">DEV_TX_OFFLOAD_MULTI_SEGS</a></div><div class="ttdeci">#define DEV_TX_OFFLOAD_MULTI_SEGS</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l01396">rte_ethdev.h:1395</a></div></div>
<div class="ttc" id="arte__lcore_8h_html_a5404ee6ac26cbe5a4f4ddef44d690b76"><div class="ttname"><a href="rte__lcore_8h.html#a5404ee6ac26cbe5a4f4ddef44d690b76">rte_lcore_is_enabled</a></div><div class="ttdeci">int rte_lcore_is_enabled(unsigned int lcore_id)</div></div>
<div class="ttc" id="arte__byteorder_8h_html_a6ec4cb000fc67785792d18728cf45563"><div class="ttname"><a href="rte__byteorder_8h.html#a6ec4cb000fc67785792d18728cf45563">rte_cpu_to_be_16</a></div><div class="ttdeci">static rte_be16_t rte_cpu_to_be_16(uint16_t x)</div></div>
<div class="ttc" id="arte__branch__prediction_8h_html_ac6c45889010c1bd68631771b64f18101"><div class="ttname"><a href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a></div><div class="ttdeci">#define unlikely(x)</div><div class="ttdef"><b>Definition:</b> <a href="rte__branch__prediction_8h_source.html#l00038">rte_branch_prediction.h:38</a></div></div>
<div class="ttc" id="astructrte__ether__hdr_html_ad6312397ccc57d322b1a037c7080d340"><div class="ttname"><a href="structrte__ether__hdr.html#ad6312397ccc57d322b1a037c7080d340">rte_ether_hdr::ether_type</a></div><div class="ttdeci">uint16_t ether_type</div><div class="ttdef"><b>Definition:</b> <a href="rte__ether_8h_source.html#l00267">rte_ether.h:267</a></div></div>
<div class="ttc" id="arte__atomic_8h_html_af5dc5024c16f1569cca1c2b758e9b5cd"><div class="ttname"><a href="rte__atomic_8h.html#af5dc5024c16f1569cca1c2b758e9b5cd">rte_atomic64_read</a></div><div class="ttdeci">static int64_t rte_atomic64_read(rte_atomic64_t *v)</div></div>
<div class="ttc" id="astructrte__ipv4__hdr_html_a18eefe32b805f7416152441ec67533b9"><div class="ttname"><a href="structrte__ipv4__hdr.html#a18eefe32b805f7416152441ec67533b9">rte_ipv4_hdr::hdr_checksum</a></div><div class="ttdeci">rte_be16_t hdr_checksum</div><div class="ttdef"><b>Definition:</b> <a href="rte__ip_8h_source.html#l00041">rte_ip.h:41</a></div></div>
<div class="ttc" id="arte__lcore_8h_html_a7c8da4664df26a64cf05dc508a4f26df"><div class="ttname"><a href="rte__lcore_8h.html#a7c8da4664df26a64cf05dc508a4f26df">rte_socket_id</a></div><div class="ttdeci">unsigned int rte_socket_id(void)</div></div>
<div class="ttc" id="arte__ethdev_8h_html_a4834f572f4dd4e46d81ad09b7d5fffd5aada568551470d5f419cd2f3d6b6bfedc"><div class="ttname"><a href="rte__ethdev_8h.html#a4834f572f4dd4e46d81ad09b7d5fffd5aada568551470d5f419cd2f3d6b6bfedc">ETH_MQ_TX_NONE</a></div><div class="ttdeci">@ ETH_MQ_TX_NONE</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l00384">rte_ethdev.h:384</a></div></div>
<div class="ttc" id="arte__atomic_8h_html_a12d91660e8a43da8882ae9d848d4327c"><div class="ttname"><a href="rte__atomic_8h.html#a12d91660e8a43da8882ae9d848d4327c">rte_atomic64_add</a></div><div class="ttdeci">static void rte_atomic64_add(rte_atomic64_t *v, int64_t inc)</div></div>
<div class="ttc" id="astructrte__eth__vmdq__rx__conf_html_afa7945c6936c8595f02f0a5408af42bd"><div class="ttname"><a href="structrte__eth__vmdq__rx__conf.html#afa7945c6936c8595f02f0a5408af42bd">rte_eth_vmdq_rx_conf::enable_loop_back</a></div><div class="ttdeci">uint8_t enable_loop_back</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l00940">rte_ethdev.h:940</a></div></div>
<div class="ttc" id="arte__log_8h_html"><div class="ttname"><a href="rte__log_8h.html">rte_log.h</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_a796c2f20778984c6f41b271e36bae50e"><div class="ttname"><a href="rte__ethdev_8h.html#a796c2f20778984c6f41b271e36bae50e">rte_eth_tx_queue_setup</a></div><div class="ttdeci">int rte_eth_tx_queue_setup(uint16_t port_id, uint16_t tx_queue_id, uint16_t nb_tx_desc, unsigned int socket_id, const struct rte_eth_txconf *tx_conf)</div></div>
<div class="ttc" id="astructrte__eth__txconf_html"><div class="ttname"><a href="structrte__eth__txconf.html">rte_eth_txconf</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l01060">rte_ethdev.h:1060</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_adaf0af5e228aeb2aaac39622cb6467ba"><div class="ttname"><a href="rte__ethdev_8h.html#adaf0af5e228aeb2aaac39622cb6467ba">DEV_TX_OFFLOAD_VLAN_INSERT</a></div><div class="ttdeci">#define DEV_TX_OFFLOAD_VLAN_INSERT</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l01377">rte_ethdev.h:1377</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_a1a7d3a20b102fee222541fda50fd87bd"><div class="ttname"><a href="rte__ethdev_8h.html#a1a7d3a20b102fee222541fda50fd87bd">rte_eth_dev_configure</a></div><div class="ttdeci">int rte_eth_dev_configure(uint16_t port_id, uint16_t nb_rx_queue, uint16_t nb_tx_queue, const struct rte_eth_conf *eth_conf)</div></div>
<div class="ttc" id="arte__atomic_8h_html_abf3427ef2605fddcc1bc1bce1071e8ec"><div class="ttname"><a href="rte__atomic_8h.html#abf3427ef2605fddcc1bc1bce1071e8ec">rte_atomic64_inc</a></div><div class="ttdeci">static void rte_atomic64_inc(rte_atomic64_t *v)</div></div>
<div class="ttc" id="astructrte__eth__rxmode_html_a84a5d32306b86a1df884144612c70726"><div class="ttname"><a href="structrte__eth__rxmode.html#a84a5d32306b86a1df884144612c70726">rte_eth_rxmode::max_rx_pkt_len</a></div><div class="ttdeci">uint32_t max_rx_pkt_len</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l00403">rte_ethdev.h:403</a></div></div>
<div class="ttc" id="arte__errno_8h_html_a129a7eb4cfa1f5bdac5783bf49137d06"><div class="ttname"><a href="rte__errno_8h.html#a129a7eb4cfa1f5bdac5783bf49137d06">rte_strerror</a></div><div class="ttdeci">const char * rte_strerror(int errnum)</div></div>
<div class="ttc" id="arte__common_8h_html_af1e21922385a6cbe051e3ab70bba9f11"><div class="ttname"><a href="rte__common_8h.html#af1e21922385a6cbe051e3ab70bba9f11">__rte_always_inline</a></div><div class="ttdeci">#define __rte_always_inline</div><div class="ttdef"><b>Definition:</b> <a href="rte__common_8h_source.html#l00226">rte_common.h:226</a></div></div>
<div class="ttc" id="arte__string__fns_8h_html"><div class="ttname"><a href="rte__string__fns_8h.html">rte_string_fns.h</a></div></div>
<div class="ttc" id="astructrte__eth__conf_html_a346eef99c24f617b74c440c1aa565d01"><div class="ttname"><a href="structrte__eth__conf.html#a346eef99c24f617b74c440c1aa565d01">rte_eth_conf::rxmode</a></div><div class="ttdeci">struct rte_eth_rxmode rxmode</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l01294">rte_ethdev.h:1301</a></div></div>
<div class="ttc" id="astructrte__mbuf_html_ad1a572736a10ff6b282c5f43c4ea1ccf"><div class="ttname"><a href="structrte__mbuf.html#ad1a572736a10ff6b282c5f43c4ea1ccf">rte_mbuf::data_len</a></div><div class="ttdeci">uint16_t data_len</div><div class="ttdef"><b>Definition:</b> <a href="rte__mbuf__core_8h_source.html#l00546">rte_mbuf_core.h:546</a></div></div>
<div class="ttc" id="astructvhost__device__ops_html_adbd762e64dae12b68686afcf873cd808"><div class="ttname"><a href="structvhost__device__ops.html#adbd762e64dae12b68686afcf873cd808">vhost_device_ops::destroy_device</a></div><div class="ttdeci">void(* destroy_device)(int vid)</div><div class="ttdef"><b>Definition:</b> <a href="rte__vhost_8h_source.html#l00268">rte_vhost.h:268</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_ac0109eb1974972c4fc0f964bc4de3b1a"><div class="ttname"><a href="rte__ethdev_8h.html#ac0109eb1974972c4fc0f964bc4de3b1a">ETH_VMDQ_ACCEPT_MULTICAST</a></div><div class="ttdeci">#define ETH_VMDQ_ACCEPT_MULTICAST</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l00807">rte_ethdev.h:807</a></div></div>
<div class="ttc" id="arte__cycles_8h_html_ab1c632a1dbe8e69c028fce82c055feb7"><div class="ttname"><a href="rte__cycles_8h.html#ab1c632a1dbe8e69c028fce82c055feb7">rte_delay_us</a></div><div class="ttdeci">void(* rte_delay_us)(unsigned int us)</div></div>
<div class="ttc" id="arte__ethdev_8h_html_ad8c7016e17fb74bbea305604b31356cc"><div class="ttname"><a href="rte__ethdev_8h.html#ad8c7016e17fb74bbea305604b31356cc">rte_eth_dev_mac_addr_remove</a></div><div class="ttdeci">int rte_eth_dev_mac_addr_remove(uint16_t port_id, struct rte_ether_addr *mac_addr)</div></div>
<div class="ttc" id="astructrte__eth__rxmode_html_aa0562513c4569f1aa53050f1beac6b5d"><div class="ttname"><a href="structrte__eth__rxmode.html#aa0562513c4569f1aa53050f1beac6b5d">rte_eth_rxmode::mq_mode</a></div><div class="ttdeci">enum rte_eth_rx_mq_mode mq_mode</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l00336">rte_ethdev.h:402</a></div></div>
<div class="ttc" id="arte__vhost_8h_html_a2da232dbf5306f4903ae3285d71a97d7"><div class="ttname"><a href="rte__vhost_8h.html#a2da232dbf5306f4903ae3285d71a97d7">rte_vhost_dequeue_burst</a></div><div class="ttdeci">uint16_t rte_vhost_dequeue_burst(int vid, uint16_t queue_id, struct rte_mempool *mbuf_pool, struct rte_mbuf **pkts, uint16_t count)</div></div>
<div class="ttc" id="astructrte__vhost__async__features_html"><div class="ttname"><a href="structrte__vhost__async__features.html">rte_vhost_async_features</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__vhost__async_8h_source.html#l00102">rte_vhost_async.h:102</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_a3e7d76a451b46348686ea97d6367f102"><div class="ttname"><a href="rte__ethdev_8h.html#a3e7d76a451b46348686ea97d6367f102">rte_eth_rx_burst</a></div><div class="ttdeci">static uint16_t rte_eth_rx_burst(uint16_t port_id, uint16_t queue_id, struct rte_mbuf **rx_pkts, const uint16_t nb_pkts)</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l04834">rte_ethdev.h:4834</a></div></div>
<div class="ttc" id="arte__memcpy_8h_html_a09f4d8cdb1a7c25398a363906e1db8cd"><div class="ttname"><a href="rte__memcpy_8h.html#a09f4d8cdb1a7c25398a363906e1db8cd">rte_memcpy</a></div><div class="ttdeci">static void * rte_memcpy(void *dst, const void *src, size_t n)</div></div>
<div class="ttc" id="arte__ether_8h_html_ad6f7cb65b39d12b5250ecf82c8ffaa45"><div class="ttname"><a href="rte__ether_8h.html#ad6f7cb65b39d12b5250ecf82c8ffaa45">addr_bytes</a></div><div class="ttdeci">uint8_t addr_bytes[RTE_ETHER_ADDR_LEN]</div><div class="ttdef"><b>Definition:</b> <a href="rte__ether_8h_source.html#l00000">rte_ether.h:0</a></div></div>
<div class="ttc" id="arte__vhost_8h_html_a4455350b61b2ac164c2239ab320387cd"><div class="ttname"><a href="rte__vhost_8h.html#a4455350b61b2ac164c2239ab320387cd">rte_vhost_driver_set_features</a></div><div class="ttdeci">int rte_vhost_driver_set_features(const char *path, uint64_t features)</div></div>
<div class="ttc" id="astructrte__mbuf_html"><div class="ttname"><a href="structrte__mbuf.html">rte_mbuf</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__mbuf__core_8h_source.html#l00473">rte_mbuf_core.h:473</a></div></div>
<div class="ttc" id="arte__vhost_8h_html_aac49be562963c15d4cb1b6bbb75147de"><div class="ttname"><a href="rte__vhost_8h.html#aac49be562963c15d4cb1b6bbb75147de">rte_vhost_driver_enable_features</a></div><div class="ttdeci">int rte_vhost_driver_enable_features(const char *path, uint64_t features)</div></div>
<div class="ttc" id="arte__ethdev_8h_html_a7593f4fff04f4ae1b1d718db7ca7dc8c"><div class="ttname"><a href="rte__ethdev_8h.html#a7593f4fff04f4ae1b1d718db7ca7dc8c">rte_eth_dev_info_get</a></div><div class="ttdeci">int rte_eth_dev_info_get(uint16_t port_id, struct rte_eth_dev_info *dev_info)</div></div>
<div class="ttc" id="arte__pause_8h_html_ad59aa7777c93d3cfd5f10617a3acd1c5"><div class="ttname"><a href="rte__pause_8h.html#ad59aa7777c93d3cfd5f10617a3acd1c5">rte_pause</a></div><div class="ttdeci">static void rte_pause(void)</div></div>
<div class="ttc" id="arte__ethdev_8h_html_a5dd1dedaa45f05c72bcc35495e441e91"><div class="ttname"><a href="rte__ethdev_8h.html#a5dd1dedaa45f05c72bcc35495e441e91">rte_eth_promiscuous_enable</a></div><div class="ttdeci">int rte_eth_promiscuous_enable(uint16_t port_id)</div></div>
<div class="ttc" id="arte__atomic_8h_html"><div class="ttname"><a href="rte__atomic_8h.html">rte_atomic.h</a></div></div>
<div class="ttc" id="arte__ip_8h_html_a2413fad2b706c5290bec6dee6f122877"><div class="ttname"><a href="rte__ip_8h.html#a2413fad2b706c5290bec6dee6f122877">rte_ipv6_phdr_cksum</a></div><div class="ttdeci">static uint16_t rte_ipv6_phdr_cksum(const struct rte_ipv6_hdr *ipv6_hdr, uint64_t ol_flags)</div><div class="ttdef"><b>Definition:</b> <a href="rte__ip_8h_source.html#l00424">rte_ip.h:424</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_a22dcfd3f5f2b34f657131d66132e23a7"><div class="ttname"><a href="rte__ethdev_8h.html#a22dcfd3f5f2b34f657131d66132e23a7">rte_eth_dev_is_valid_port</a></div><div class="ttdeci">int rte_eth_dev_is_valid_port(uint16_t port_id)</div></div>
<div class="ttc" id="arte__ethdev_8h_html_a8a28375b279ded9125c99a46bf3956ef"><div class="ttname"><a href="rte__ethdev_8h.html#a8a28375b279ded9125c99a46bf3956ef">rte_eth_macaddr_get</a></div><div class="ttdeci">int rte_eth_macaddr_get(uint16_t port_id, struct rte_ether_addr *mac_addr)</div></div>
<div class="ttc" id="arte__common_8h_html_ac5169870c983b3463cb226bdb8a94880"><div class="ttname"><a href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a></div><div class="ttdeci">__rte_noreturn void rte_exit(int exit_code, const char *format,...) __rte_format_printf(2</div></div>
<div class="ttc" id="arte__lcore_8h_html_a1728dc7f14571ba778d3b5b41aa09283"><div class="ttname"><a href="rte__lcore_8h.html#a1728dc7f14571ba778d3b5b41aa09283">rte_lcore_count</a></div><div class="ttdeci">unsigned int rte_lcore_count(void)</div></div>
<div class="ttc" id="arte__mbuf__core_8h_html_ad9d8db5f80d34e0a95c56df43d605c87"><div class="ttname"><a href="rte__mbuf__core_8h.html#ad9d8db5f80d34e0a95c56df43d605c87">PKT_TX_TCP_SEG</a></div><div class="ttdeci">#define PKT_TX_TCP_SEG</div><div class="ttdef"><b>Definition:</b> <a href="rte__mbuf__core_8h_source.html#l00291">rte_mbuf_core.h:291</a></div></div>
<div class="ttc" id="arte__ip_8h_html"><div class="ttname"><a href="rte__ip_8h.html">rte_ip.h</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_a83e56cabbd31637efd648e3fc010392b"><div class="ttname"><a href="rte__ethdev_8h.html#a83e56cabbd31637efd648e3fc010392b">rte_eth_tx_burst</a></div><div class="ttdeci">static uint16_t rte_eth_tx_burst(uint16_t port_id, uint16_t queue_id, struct rte_mbuf **tx_pkts, uint16_t nb_pkts)</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l05112">rte_ethdev.h:5112</a></div></div>
<div class="ttc" id="arte__vhost_8h_html_aab322aa002dabda6b4c6c643afd89379"><div class="ttname"><a href="rte__vhost_8h.html#aab322aa002dabda6b4c6c643afd89379">rte_vhost_enqueue_burst</a></div><div class="ttdeci">uint16_t rte_vhost_enqueue_burst(int vid, uint16_t queue_id, struct rte_mbuf **pkts, uint16_t count)</div></div>
<div class="ttc" id="arte__lcore_8h_html_adfb2b334e7e73f534f25e8888a8a775f"><div class="ttname"><a href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a></div><div class="ttdeci">static unsigned rte_lcore_id(void)</div><div class="ttdef"><b>Definition:</b> <a href="rte__lcore_8h_source.html#l00075">rte_lcore.h:75</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_a5cb1059587ee40589f8d9da60107e740"><div class="ttname"><a href="rte__ethdev_8h.html#a5cb1059587ee40589f8d9da60107e740">ETH_VMDQ_ACCEPT_BROADCAST</a></div><div class="ttdeci">#define ETH_VMDQ_ACCEPT_BROADCAST</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l00806">rte_ethdev.h:806</a></div></div>
<div class="ttc" id="arte__cycles_8h_html"><div class="ttname"><a href="rte__cycles_8h.html">rte_cycles.h</a></div></div>
<div class="ttc" id="astructrte__vlan__hdr_html_a466610c1a1f26aace575dc4dc60d81b3"><div class="ttname"><a href="structrte__vlan__hdr.html#a466610c1a1f26aace575dc4dc60d81b3">rte_vlan_hdr::vlan_tci</a></div><div class="ttdeci">uint16_t vlan_tci</div><div class="ttdef"><b>Definition:</b> <a href="rte__ether_8h_source.html#l00276">rte_ether.h:276</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_ae7110b5d5dced8f42505bff5d9e3f0ea"><div class="ttname"><a href="rte__ethdev_8h.html#ae7110b5d5dced8f42505bff5d9e3f0ea">DEV_TX_OFFLOAD_MBUF_FAST_FREE</a></div><div class="ttdeci">#define DEV_TX_OFFLOAD_MBUF_FAST_FREE</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l01401">rte_ethdev.h:1397</a></div></div>
<div class="ttc" id="astructrte__eth__txconf_html_a6cfe3b3ee46e9a8b8c62a64294b0b564"><div class="ttname"><a href="structrte__eth__txconf.html#a6cfe3b3ee46e9a8b8c62a64294b0b564">rte_eth_txconf::offloads</a></div><div class="ttdeci">uint64_t offloads</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l01072">rte_ethdev.h:1072</a></div></div>
<div class="ttc" id="arte__ip_8h_html_a0a713bee0681792de6b1ab4239268876"><div class="ttname"><a href="rte__ip_8h.html#a0a713bee0681792de6b1ab4239268876">rte_ipv4_phdr_cksum</a></div><div class="ttdeci">static uint16_t rte_ipv4_phdr_cksum(const struct rte_ipv4_hdr *ipv4_hdr, uint64_t ol_flags)</div><div class="ttdef"><b>Definition:</b> <a href="rte__ip_8h_source.html#l00315">rte_ip.h:315</a></div></div>
<div class="ttc" id="astructrte__tcp__hdr_html_aba81d1981a9a665214dd2116a39e28f5"><div class="ttname"><a href="structrte__tcp__hdr.html#aba81d1981a9a665214dd2116a39e28f5">rte_tcp_hdr::cksum</a></div><div class="ttdeci">rte_be16_t cksum</div><div class="ttdef"><b>Definition:</b> <a href="rte__tcp_8h_source.html#l00036">rte_tcp.h:36</a></div></div>
<div class="ttc" id="astructrte__mbuf_html_aa25a7c259438b9eba28bcedc33846620"><div class="ttname"><a href="structrte__mbuf.html#aa25a7c259438b9eba28bcedc33846620">rte_mbuf::l2_len</a></div><div class="ttdeci">uint64_t l2_len</div><div class="ttdef"><b>Definition:</b> <a href="rte__mbuf__core_8h_source.html#l00602">rte_mbuf_core.h:602</a></div></div>
<div class="ttc" id="arte__ether_8h_html_afdc582d54410e8f913df5999574b4319"><div class="ttname"><a href="rte__ether_8h.html#afdc582d54410e8f913df5999574b4319">rte_is_broadcast_ether_addr</a></div><div class="ttdeci">static int rte_is_broadcast_ether_addr(const struct rte_ether_addr *ea)</div><div class="ttdef"><b>Definition:</b> <a href="rte__ether_8h_source.html#l00151">rte_ether.h:151</a></div></div>
<div class="ttc" id="arte__mbuf__core_8h_html_a2a8b10263496c7b580e9d0c7f2a1f073"><div class="ttname"><a href="rte__mbuf__core_8h.html#a2a8b10263496c7b580e9d0c7f2a1f073">rte_pktmbuf_mtod</a></div><div class="ttdeci">#define rte_pktmbuf_mtod(m, t)</div><div class="ttdef"><b>Definition:</b> <a href="rte__mbuf__core_8h_source.html#l00726">rte_mbuf_core.h:726</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_afdc834c1c52e9fb512301990468ca7c2"><div class="ttname"><a href="rte__ethdev_8h.html#afdc834c1c52e9fb512301990468ca7c2">rte_eth_dev_start</a></div><div class="ttdeci">int rte_eth_dev_start(uint16_t port_id)</div></div>
<div class="ttc" id="astructrte__eth__rxconf_html_a6cfe3b3ee46e9a8b8c62a64294b0b564"><div class="ttname"><a href="structrte__eth__rxconf.html#a6cfe3b3ee46e9a8b8c62a64294b0b564">rte_eth_rxconf::offloads</a></div><div class="ttdeci">uint64_t offloads</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l01043">rte_ethdev.h:1043</a></div></div>
<div class="ttc" id="astructrte__ether__hdr_html"><div class="ttname"><a href="structrte__ether__hdr.html">rte_ether_hdr</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__ether_8h_source.html#l00264">rte_ether.h:264</a></div></div>
<div class="ttc" id="astructrte__vhost__async__channel__ops_html_a99cbb00e83cf08d0f5cb7a901d00894d"><div class="ttname"><a href="structrte__vhost__async__channel__ops.html#a99cbb00e83cf08d0f5cb7a901d00894d">rte_vhost_async_channel_ops::transfer_data</a></div><div class="ttdeci">uint32_t(* transfer_data)(int vid, uint16_t queue_id, struct rte_vhost_async_desc *descs, struct rte_vhost_async_status *opaque_data, uint16_t count)</div><div class="ttdef"><b>Definition:</b> <a href="rte__vhost__async_8h_source.html#l00064">rte_vhost_async.h:64</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_a544a5d22a4be048e8e5395fb965922ed"><div class="ttname"><a href="rte__ethdev_8h.html#a544a5d22a4be048e8e5395fb965922ed">DEV_RX_OFFLOAD_VLAN_STRIP</a></div><div class="ttdeci">#define DEV_RX_OFFLOAD_VLAN_STRIP</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l01335">rte_ethdev.h:1335</a></div></div>
<div class="ttc" id="arte__ether_8h_html_a2ccdf36488c3efa8d7c3afb03e11c5bc"><div class="ttname"><a href="rte__ether_8h.html#a2ccdf36488c3efa8d7c3afb03e11c5bc">rte_is_same_ether_addr</a></div><div class="ttdeci">static int rte_is_same_ether_addr(const struct rte_ether_addr *ea1, const struct rte_ether_addr *ea2)</div><div class="ttdef"><b>Definition:</b> <a href="rte__ether_8h_source.html#l00085">rte_ether.h:85</a></div></div>
<div class="ttc" id="astructvhost__device__ops_html"><div class="ttname"><a href="structvhost__device__ops.html">vhost_device_ops</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__vhost_8h_source.html#l00266">rte_vhost.h:266</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_a9ab708089665bebcd65cefe5383b24f2"><div class="ttname"><a href="rte__ethdev_8h.html#a9ab708089665bebcd65cefe5383b24f2">rte_eth_dev_count_avail</a></div><div class="ttdeci">uint16_t rte_eth_dev_count_avail(void)</div></div>
<div class="ttc" id="astructrte__eth__vmdq__rx__conf_html"><div class="ttname"><a href="structrte__eth__vmdq__rx__conf.html">rte_eth_vmdq_rx_conf</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l00936">rte_ethdev.h:936</a></div></div>
<div class="ttc" id="arte__mbuf__core_8h_html_a51280725dafdf282a80b2d964418798c"><div class="ttname"><a href="rte__mbuf__core_8h.html#a51280725dafdf282a80b2d964418798c">PKT_TX_IP_CKSUM</a></div><div class="ttdeci">#define PKT_TX_IP_CKSUM</div><div class="ttdef"><b>Definition:</b> <a href="rte__mbuf__core_8h_source.html#l00324">rte_mbuf_core.h:324</a></div></div>
<div class="ttc" id="astructrte__tcp__hdr_html"><div class="ttname"><a href="structrte__tcp__hdr.html">rte_tcp_hdr</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__tcp_8h_source.html#l00028">rte_tcp.h:28</a></div></div>
<div class="ttc" id="astructrte__vlan__hdr_html"><div class="ttname"><a href="structrte__vlan__hdr.html">rte_vlan_hdr</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__ether_8h_source.html#l00275">rte_ether.h:275</a></div></div>
<div class="ttc" id="arte__launch_8h_html_a2bf98eda211728b3dc69aa7694758c6d"><div class="ttname"><a href="rte__launch_8h.html#a2bf98eda211728b3dc69aa7694758c6d">rte_eal_remote_launch</a></div><div class="ttdeci">int rte_eal_remote_launch(lcore_function_t *f, void *arg, unsigned worker_id)</div></div>
<div class="ttc" id="arte__common_8h_html_ae1a7c8799cb57669ae2ddf367b21533f"><div class="ttname"><a href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a></div><div class="ttdeci">#define __rte_unused</div><div class="ttdef"><b>Definition:</b> <a href="rte__common_8h_source.html#l00116">rte_common.h:116</a></div></div>
<div class="ttc" id="astructrte__eth__rxmode_html_a6cfe3b3ee46e9a8b8c62a64294b0b564"><div class="ttname"><a href="structrte__eth__rxmode.html#a6cfe3b3ee46e9a8b8c62a64294b0b564">rte_eth_rxmode::offloads</a></div><div class="ttdeci">uint64_t offloads</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l00412">rte_ethdev.h:412</a></div></div>
<div class="ttc" id="arte__eal_8h_html_a5c3f4dddc25e38c5a186ecd8a69260e3"><div class="ttname"><a href="rte__eal_8h.html#a5c3f4dddc25e38c5a186ecd8a69260e3">rte_eal_init</a></div><div class="ttdeci">int rte_eal_init(int argc, char **argv)</div></div>
<div class="ttc" id="astructrte__mempool_html"><div class="ttname"><a href="structrte__mempool.html">rte_mempool</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__mempool_8h_source.html#l00207">rte_mempool.h:207</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_a012a874434677984af1f026ad585dd0da308323e3152afc591f57f613d2418eae"><div class="ttname"><a href="rte__ethdev_8h.html#a012a874434677984af1f026ad585dd0da308323e3152afc591f57f613d2418eae">ETH_8_POOLS</a></div><div class="ttdeci">@ ETH_8_POOLS</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l00865">rte_ethdev.h:865</a></div></div>
<div class="ttc" id="astructrte__mbuf_html_a319d580a6e1ef13692631d7b0d6d5c98"><div class="ttname"><a href="structrte__mbuf.html#a319d580a6e1ef13692631d7b0d6d5c98">rte_mbuf::ol_flags</a></div><div class="ttdeci">uint64_t ol_flags</div><div class="ttdef"><b>Definition:</b> <a href="rte__mbuf__core_8h_source.html#l00505">rte_mbuf_core.h:505</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_a586b8e86131b4ec0ccaf464e847ccf3ea66316d2ff53011a3209207734c124f3c"><div class="ttname"><a href="rte__ethdev_8h.html#a586b8e86131b4ec0ccaf464e847ccf3ea66316d2ff53011a3209207734c124f3c">ETH_MQ_RX_VMDQ_ONLY</a></div><div class="ttdeci">@ ETH_MQ_RX_VMDQ_ONLY</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l00362">rte_ethdev.h:362</a></div></div>
<div class="ttc" id="arte__tcp_8h_html"><div class="ttname"><a href="rte__tcp_8h.html">rte_tcp.h</a></div></div>
<div class="ttc" id="arte__mbuf_8h_html_a593921f13307803b94bbb4e0932db962"><div class="ttname"><a href="rte__mbuf_8h.html#a593921f13307803b94bbb4e0932db962">rte_pktmbuf_pool_create</a></div><div class="ttdeci">struct rte_mempool * rte_pktmbuf_pool_create(const char *name, unsigned n, unsigned cache_size, uint16_t priv_size, uint16_t data_room_size, int socket_id)</div></div>
<div class="ttc" id="astructrte__ipv4__hdr_html"><div class="ttname"><a href="structrte__ipv4__hdr.html">rte_ipv4_hdr</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__ip_8h_source.html#l00033">rte_ip.h:33</a></div></div>
<div class="ttc" id="arte__lcore_8h_html_aa0bd7a4983e66d9ea893a98d25262914"><div class="ttname"><a href="rte__lcore_8h.html#aa0bd7a4983e66d9ea893a98d25262914">rte_ctrl_thread_create</a></div><div class="ttdeci">int rte_ctrl_thread_create(pthread_t *thread, const char *name, const pthread_attr_t *attr, void *(*start_routine)(void *), void *arg)</div></div>
<div class="ttc" id="astructrte__mbuf_html_a5046af233a45d6d79ce1a5aae535b23c"><div class="ttname"><a href="structrte__mbuf.html#a5046af233a45d6d79ce1a5aae535b23c">rte_mbuf::pkt_len</a></div><div class="ttdeci">uint32_t pkt_len</div><div class="ttdef"><b>Definition:</b> <a href="rte__mbuf__core_8h_source.html#l00545">rte_mbuf_core.h:545</a></div></div>
<div class="ttc" id="arte__mbuf_8h_html_a1215458932900b7cd5192326fa4a6902"><div class="ttname"><a href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a></div><div class="ttdeci">static void rte_pktmbuf_free(struct rte_mbuf *m)</div><div class="ttdef"><b>Definition:</b> <a href="rte__mbuf_8h_source.html#l01397">rte_mbuf.h:1397</a></div></div>
<div class="ttc" id="astructrte__mbuf_html_a82a34cb6d5935a8c0f043f2783d6b42d"><div class="ttname"><a href="structrte__mbuf.html#a82a34cb6d5935a8c0f043f2783d6b42d">rte_mbuf::l3_len</a></div><div class="ttdeci">uint64_t l3_len</div><div class="ttdef"><b>Definition:</b> <a href="rte__mbuf__core_8h_source.html#l00606">rte_mbuf_core.h:606</a></div></div>
<div class="ttc" id="arte__lcore_8h_html_ac779e61584eb9d087c3e20bf2d1150c8"><div class="ttname"><a href="rte__lcore_8h.html#ac779e61584eb9d087c3e20bf2d1150c8">RTE_LCORE_FOREACH_WORKER</a></div><div class="ttdeci">#define RTE_LCORE_FOREACH_WORKER(i)</div><div class="ttdef"><b>Definition:</b> <a href="rte__lcore_8h_source.html#l00239">rte_lcore.h:239</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_a36ba70a5a6fce2c2c1f774828ba78f8d"><div class="ttname"><a href="rte__ethdev_8h.html#a36ba70a5a6fce2c2c1f774828ba78f8d">rte_eth_rx_queue_setup</a></div><div class="ttdeci">int rte_eth_rx_queue_setup(uint16_t port_id, uint16_t rx_queue_id, uint16_t nb_rx_desc, unsigned int socket_id, const struct rte_eth_rxconf *rx_conf, struct rte_mempool *mb_pool)</div></div>
<div class="ttc" id="arte__branch__prediction_8h_html_a217a0bd562b98ae8c2ffce44935351e1"><div class="ttname"><a href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a></div><div class="ttdeci">#define likely(x)</div><div class="ttdef"><b>Definition:</b> <a href="rte__branch__prediction_8h_source.html#l00024">rte_branch_prediction.h:24</a></div></div>
<div class="ttc" id="astructrte__eth__conf_html_a084e132696e8d0f59f643d822c8cedb7"><div class="ttname"><a href="structrte__eth__conf.html#a084e132696e8d0f59f643d822c8cedb7">rte_eth_conf::rx_adv_conf</a></div><div class="ttdeci">struct rte_eth_conf::@153 rx_adv_conf</div></div>
<div class="ttc" id="arte__ethdev_8h_html"><div class="ttname"><a href="rte__ethdev_8h.html">rte_ethdev.h</a></div></div>
<div class="ttc" id="astructrte__eth__vmdq__rx__conf_html_a25189ff51ac0748d611eabd14cb1cc6a"><div class="ttname"><a href="structrte__eth__vmdq__rx__conf.html#a25189ff51ac0748d611eabd14cb1cc6a">rte_eth_vmdq_rx_conf::rx_mode</a></div><div class="ttdeci">uint32_t rx_mode</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l00942">rte_ethdev.h:942</a></div></div>
<div class="ttc" id="arte__log_8h_html_ac23caeb9833fd0fd0665c6c05ec806fe"><div class="ttname"><a href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a></div><div class="ttdeci">#define RTE_LOG(l, t,...)</div><div class="ttdef"><b>Definition:</b> <a href="rte__log_8h_source.html#l00331">rte_log.h:331</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_a012a874434677984af1f026ad585dd0d"><div class="ttname"><a href="rte__ethdev_8h.html#a012a874434677984af1f026ad585dd0d">rte_eth_nb_pools</a></div><div class="ttdeci">rte_eth_nb_pools</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l00864">rte_ethdev.h:864</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_aae1a98a4ba67296647a29abb8cce1031"><div class="ttname"><a href="rte__ethdev_8h.html#aae1a98a4ba67296647a29abb8cce1031">rte_eth_dev_mac_addr_add</a></div><div class="ttdeci">int rte_eth_dev_mac_addr_add(uint16_t port_id, struct rte_ether_addr *mac_addr, uint32_t pool)</div></div>
<div class="ttc" id="arte__ethdev_8h_html_a6bc1b487a103817c6d19bfa8b291b84b"><div class="ttname"><a href="rte__ethdev_8h.html#a6bc1b487a103817c6d19bfa8b291b84b">rte_eth_dev_set_vlan_strip_on_queue</a></div><div class="ttdeci">int rte_eth_dev_set_vlan_strip_on_queue(uint16_t port_id, uint16_t rx_queue_id, int on)</div></div>
<div class="ttc" id="arte__ether_8h_html_a22bf3d2d6b4e7be447b5e805674e0845"><div class="ttname"><a href="rte__ether_8h.html#a22bf3d2d6b4e7be447b5e805674e0845">RTE_ETHER_ADDR_LEN</a></div><div class="ttdeci">#define RTE_ETHER_ADDR_LEN</div><div class="ttdef"><b>Definition:</b> <a href="rte__ether_8h_source.html#l00030">rte_ether.h:30</a></div></div>
<div class="ttc" id="astructrte__mbuf_html_a466610c1a1f26aace575dc4dc60d81b3"><div class="ttname"><a href="structrte__mbuf.html#a466610c1a1f26aace575dc4dc60d81b3">rte_mbuf::vlan_tci</a></div><div class="ttdeci">uint16_t vlan_tci</div><div class="ttdef"><b>Definition:</b> <a href="rte__mbuf__core_8h_source.html#l00548">rte_mbuf_core.h:548</a></div></div>
<div class="ttc" id="arte__mbuf_8h_html_a257bc8af3e8fde7eb6603bdf4ae0528e"><div class="ttname"><a href="rte__mbuf_8h.html#a257bc8af3e8fde7eb6603bdf4ae0528e">rte_pktmbuf_tailroom</a></div><div class="ttdeci">static uint16_t rte_pktmbuf_tailroom(const struct rte_mbuf *m)</div><div class="ttdef"><b>Definition:</b> <a href="rte__mbuf_8h_source.html#l01514">rte_mbuf.h:1514</a></div></div>
<div class="ttc" id="arte__vhost_8h_html_a4ce29baa4ace979410c756d2995fcfbc"><div class="ttname"><a href="rte__vhost_8h.html#a4ce29baa4ace979410c756d2995fcfbc">rte_vhost_avail_entries</a></div><div class="ttdeci">uint16_t rte_vhost_avail_entries(int vid, uint16_t queue_id)</div></div>
<div class="ttc" id="arte__log_8h_html_aeed72aff1af9a59d2de85b96955e21f9"><div class="ttname"><a href="rte__log_8h.html#aeed72aff1af9a59d2de85b96955e21f9">RTE_LOG_DP</a></div><div class="ttdeci">#define RTE_LOG_DP(l, t,...)</div><div class="ttdef"><b>Definition:</b> <a href="rte__log_8h_source.html#l00355">rte_log.h:355</a></div></div>
<div class="ttc" id="astructrte__eth__dev__info_html"><div class="ttname"><a href="structrte__eth__dev__info.html">rte_eth_dev_info</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l01504">rte_ethdev.h:1504</a></div></div>
<div class="ttc" id="arte__vhost_8h_html_afa4c6cbe7c20587979918137353a738f"><div class="ttname"><a href="rte__vhost_8h.html#afa4c6cbe7c20587979918137353a738f">rte_vhost_driver_disable_features</a></div><div class="ttdeci">int rte_vhost_driver_disable_features(const char *path, uint64_t features)</div></div>
<div class="ttc" id="astructrte__ether__addr_html"><div class="ttname"><a href="structrte__ether__addr.html">rte_ether_addr</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__ether_8h_source.html#l00064">rte_ether.h:64</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_ad7b46c67203d37fe3a34f11076d970d6"><div class="ttname"><a href="rte__ethdev_8h.html#ad7b46c67203d37fe3a34f11076d970d6">RTE_ETH_FOREACH_DEV</a></div><div class="ttdeci">#define RTE_ETH_FOREACH_DEV(p)</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l01858">rte_ethdev.h:1858</a></div></div>
<div class="ttc" id="astructrte__eth__conf_html"><div class="ttname"><a href="structrte__eth__conf.html">rte_eth_conf</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l01293">rte_ethdev.h:1293</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_ad032e25f712e6ffeb0c19eab1ec1fd2e"><div class="ttname"><a href="rte__ethdev_8h.html#ad032e25f712e6ffeb0c19eab1ec1fd2e">rte_eth_dev_socket_id</a></div><div class="ttdeci">int rte_eth_dev_socket_id(uint16_t port_id)</div></div>
<div class="ttc" id="arte__ether_8h_html_a2099ac82c3c5a13ddb251799ec59c72c"><div class="ttname"><a href="rte__ether_8h.html#a2099ac82c3c5a13ddb251799ec59c72c">RTE_ETHER_TYPE_VLAN</a></div><div class="ttdeci">#define RTE_ETHER_TYPE_VLAN</div><div class="ttdef"><b>Definition:</b> <a href="rte__ether_8h_source.html#l00287">rte_ether.h:287</a></div></div>
<div class="ttc" id="arte__malloc_8h_html_a1fc82f67711b13aca7e05dc9d58f9dbd"><div class="ttname"><a href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a></div><div class="ttdeci">void void rte_free(void *ptr)</div></div>
<div class="ttc" id="astructrte__vhost__async__channel__ops_html"><div class="ttname"><a href="structrte__vhost__async__channel__ops.html">rte_vhost_async_channel_ops</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__vhost__async_8h_source.html#l00047">rte_vhost_async.h:47</a></div></div>
<div class="ttc" id="astructrte__ether__hdr_html_a1d579e2782d36729c1f73608d8663124"><div class="ttname"><a href="structrte__ether__hdr.html#a1d579e2782d36729c1f73608d8663124">rte_ether_hdr::d_addr</a></div><div class="ttdeci">struct rte_ether_addr d_addr</div><div class="ttdef"><b>Definition:</b> <a href="rte__ether_8h_source.html#l00000">rte_ether.h:265</a></div></div>
<div class="ttc" id="astructrte__ether__addr_html_ad6f7cb65b39d12b5250ecf82c8ffaa45"><div class="ttname"><a href="structrte__ether__addr.html#ad6f7cb65b39d12b5250ecf82c8ffaa45">rte_ether_addr::addr_bytes</a></div><div class="ttdeci">uint8_t addr_bytes[RTE_ETHER_ADDR_LEN]</div><div class="ttdef"><b>Definition:</b> <a href="rte__ether_8h_source.html#l00065">rte_ether.h:65</a></div></div>
<div class="ttc" id="arte__launch_8h_html_ae9500e1d35bd4cfb95d18c0be863cb1e"><div class="ttname"><a href="rte__launch_8h.html#ae9500e1d35bd4cfb95d18c0be863cb1e">rte_eal_wait_lcore</a></div><div class="ttdeci">int rte_eal_wait_lcore(unsigned worker_id)</div></div>
<div class="ttc" id="astructrte__eth__rxconf_html_aaccf5b8238b9207f8102d69959ac3391"><div class="ttname"><a href="structrte__eth__rxconf.html#aaccf5b8238b9207f8102d69959ac3391">rte_eth_rxconf::rx_drop_en</a></div><div class="ttdeci">uint8_t rx_drop_en</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l01035">rte_ethdev.h:1035</a></div></div>
<div class="ttc" id="arte__mbuf__core_8h_html_a9d2d4eca2fab4ef35c8f8a7f3bbe9fe2"><div class="ttname"><a href="rte__mbuf__core_8h.html#a9d2d4eca2fab4ef35c8f8a7f3bbe9fe2">PKT_TX_IPV4</a></div><div class="ttdeci">#define PKT_TX_IPV4</div><div class="ttdef"><b>Definition:</b> <a href="rte__mbuf__core_8h_source.html#l00332">rte_mbuf_core.h:332</a></div></div>
<div class="ttc" id="astructrte__eth__conf_html_a17845d02c4ddfdc09982bd899b6df06e"><div class="ttname"><a href="structrte__eth__conf.html#a17845d02c4ddfdc09982bd899b6df06e">rte_eth_conf::vmdq_rx_conf</a></div><div class="ttdeci">struct rte_eth_vmdq_rx_conf vmdq_rx_conf</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l01327">rte_ethdev.h:1314</a></div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20
</small></address>
</body>
</html>
