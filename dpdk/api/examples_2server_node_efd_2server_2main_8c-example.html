<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DPDK: examples/server_node_efd/server/main.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">20.11.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">examples/server_node_efd/server/main.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/* SPDX-License-Identifier: BSD-3-Clause</span></div>
<div class="line"><span class="comment"> * Copyright(c) 2016-2017 Intel Corporation</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdarg.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/queue.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/types.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;netinet/in.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;netinet/ip.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__common_8h.html">rte_common.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memory_8h.html">rte_memory.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__eal_8h.html">rte_eal.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__launch_8h.html">rte_launch.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__per__lcore_8h.html">rte_per_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__lcore_8h.html">rte_lcore.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__branch__prediction_8h.html">rte_branch_prediction.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__atomic_8h.html">rte_atomic.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ring_8h.html">rte_ring.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__debug_8h.html">rte_debug.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mempool_8h.html">rte_mempool.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memcpy_8h.html">rte_memcpy.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mbuf_8h.html">rte_mbuf.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ether_8h.html">rte_ether.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__interrupts_8h.html">rte_interrupts.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ethdev_8h.html">rte_ethdev.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__byteorder_8h.html">rte_byteorder.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__malloc_8h.html">rte_malloc.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__string__fns_8h.html">rte_string_fns.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__efd_8h.html">rte_efd.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ip_8h.html">rte_ip.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;common.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;args.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;init.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * When doing reads from the NIC or the node queues,</span></div>
<div class="line"><span class="comment"> * use this batch size</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define PACKET_READ_SIZE 32</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Local buffers to put packets in, used to send packets in bursts to the</span></div>
<div class="line"><span class="comment"> * nodes</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">struct </span>node_rx_buf {</div>
<div class="line">    <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *buffer[PACKET_READ_SIZE];</div>
<div class="line">    uint16_t count;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>efd_stats {</div>
<div class="line">    uint64_t distributed;</div>
<div class="line">    uint64_t drop;</div>
<div class="line">} flow_dist_stats;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* One buffer per node rx queue - dynamically allocate array */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>node_rx_buf *cl_rx_buf;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *</div>
<div class="line">get_printable_mac_addr(uint16_t port)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> err_address[] = <span class="stringliteral">&quot;00:00:00:00:00:00&quot;</span>;</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">char</span> addresses[RTE_MAX_ETHPORTS][<span class="keyword">sizeof</span>(err_address)];</div>
<div class="line">    <span class="keyword">struct </span><a name="_a1"></a><a class="code" href="structrte__ether__addr.html">rte_ether_addr</a> mac;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a2"></a><a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(port &gt;= RTE_MAX_ETHPORTS))</div>
<div class="line">        <span class="keywordflow">return</span> err_address;</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a>(addresses[port][0] == <span class="charliteral">&#39;\0&#39;</span>)) {</div>
<div class="line">        ret = <a name="a3"></a><a class="code" href="rte__ethdev_8h.html#a8a28375b279ded9125c99a46bf3956ef">rte_eth_macaddr_get</a>(port, &amp;mac);</div>
<div class="line">        <span class="keywordflow">if</span> (ret != 0) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Failed to get MAC address (port %u): %s\n&quot;</span>,</div>
<div class="line">                   port, <a name="a4"></a><a class="code" href="rte__errno_8h.html#a129a7eb4cfa1f5bdac5783bf49137d06">rte_strerror</a>(-ret));</div>
<div class="line">            <span class="keywordflow">return</span> err_address;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        snprintf(addresses[port], <span class="keyword">sizeof</span>(addresses[port]),</div>
<div class="line">                <span class="stringliteral">&quot;%02x:%02x:%02x:%02x:%02x:%02x\n&quot;</span>,</div>
<div class="line">                mac.addr_bytes[0], mac.addr_bytes[1],</div>
<div class="line">                mac.addr_bytes[2], mac.addr_bytes[3],</div>
<div class="line">                mac.addr_bytes[4], mac.addr_bytes[5]);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> addresses[port];</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function displays the recorded statistics for each port</span></div>
<div class="line"><span class="comment"> * and for each node. It uses ANSI terminal codes to clear</span></div>
<div class="line"><span class="comment"> * screen when called. It is called from a single worker</span></div>
<div class="line"><span class="comment"> * thread in the server process, when the process is run with more</span></div>
<div class="line"><span class="comment"> * than one lcore enabled.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">do_stats_display(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i, j;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> clr[] = {27, <span class="charliteral">&#39;[&#39;</span>, <span class="charliteral">&#39;2&#39;</span>, <span class="charliteral">&#39;J&#39;</span>, <span class="charliteral">&#39;\0&#39;</span>};</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> topLeft[] = {27, <span class="charliteral">&#39;[&#39;</span>, <span class="charliteral">&#39;1&#39;</span>, <span class="charliteral">&#39;;&#39;</span>, <span class="charliteral">&#39;1&#39;</span>, <span class="charliteral">&#39;H&#39;</span>, <span class="charliteral">&#39;\0&#39;</span>};</div>
<div class="line">    uint64_t port_tx[RTE_MAX_ETHPORTS], port_tx_drop[RTE_MAX_ETHPORTS];</div>
<div class="line">    uint64_t node_tx[MAX_NODES], node_tx_drop[MAX_NODES];</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* to get TX stats, we need to do some summing calculations */</span></div>
<div class="line">    memset(port_tx, 0, <span class="keyword">sizeof</span>(port_tx));</div>
<div class="line">    memset(port_tx_drop, 0, <span class="keyword">sizeof</span>(port_tx_drop));</div>
<div class="line">    memset(node_tx, 0, <span class="keyword">sizeof</span>(node_tx));</div>
<div class="line">    memset(node_tx_drop, 0, <span class="keyword">sizeof</span>(node_tx_drop));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; num_nodes; i++) {</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">struct </span>tx_stats *tx = &amp;info-&gt;tx_stats[i];</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (j = 0; j &lt; info-&gt;num_ports; j++) {</div>
<div class="line">            <span class="keyword">const</span> uint64_t tx_val = tx-&gt;tx[info-&gt;id[j]];</div>
<div class="line">            <span class="keyword">const</span> uint64_t drop_val = tx-&gt;tx_drop[info-&gt;id[j]];</div>
<div class="line"> </div>
<div class="line">            port_tx[j] += tx_val;</div>
<div class="line">            port_tx_drop[j] += drop_val;</div>
<div class="line">            node_tx[i] += tx_val;</div>
<div class="line">            node_tx_drop[i] += drop_val;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Clear screen and move to top left */</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;%s%s&quot;</span>, clr, topLeft);</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;PORTS\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;-----\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; info-&gt;num_ports; i++)</div>
<div class="line">        printf(<span class="stringliteral">&quot;Port %u: &#39;%s&#39;\t&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)info-&gt;id[i],</div>
<div class="line">                get_printable_mac_addr(info-&gt;id[i]));</div>
<div class="line">    printf(<span class="stringliteral">&quot;\n\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; info-&gt;num_ports; i++) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Port %u - rx: %9&quot;</span>PRIu64<span class="stringliteral">&quot;\t&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;tx: %9&quot;</span>PRIu64<span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">                (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)info-&gt;id[i], info-&gt;rx_stats.rx[i],</div>
<div class="line">                port_tx[i]);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;\nSERVER\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;-----\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;distributed: %9&quot;</span>PRIu64<span class="stringliteral">&quot;, drop: %9&quot;</span>PRIu64<span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">            flow_dist_stats.distributed, flow_dist_stats.drop);</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;\nNODES\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;-------\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; num_nodes; i++) {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> rx = nodes[i].stats.rx;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> rx_drop = nodes[i].stats.rx_drop;</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">struct </span>filter_stats *filter = &amp;info-&gt;filter_stats[i];</div>
<div class="line"> </div>
<div class="line">        printf(<span class="stringliteral">&quot;Node %2u - rx: %9llu, rx_drop: %9llu\n&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;            tx: %9&quot;</span>PRIu64<span class="stringliteral">&quot;, tx_drop: %9&quot;</span>PRIu64<span class="stringliteral">&quot;\n&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;            filter_passed: %9&quot;</span>PRIu64<span class="stringliteral">&quot;, &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;filter_drop: %9&quot;</span>PRIu64<span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">                i, rx, rx_drop, node_tx[i], node_tx_drop[i],</div>
<div class="line">                filter-&gt;passed, filter-&gt;drop);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * The function called from each non-main lcore used by the process.</span></div>
<div class="line"><span class="comment"> * The test_and_set function is used to randomly pick a single lcore on which</span></div>
<div class="line"><span class="comment"> * the code to display the statistics will run. Otherwise, the code just</span></div>
<div class="line"><span class="comment"> * repeatedly sleeps.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">sleep_lcore(<a name="a5"></a><a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">void</span> *dummy)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Used to pick a display thread - static, so zero-initialised */</span></div>
<div class="line">    <span class="keyword">static</span> <a name="_a6"></a><a class="code" href="structrte__atomic32__t.html">rte_atomic32_t</a> display_stats;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Only one core should display stats */</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a7"></a><a class="code" href="rte__atomic_8h.html#a82ef4eba412a27299860ac88d273a60b">rte_atomic32_test_and_set</a>(&amp;display_stats)) {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sleeptime = 1;</div>
<div class="line"> </div>
<div class="line">        printf(<span class="stringliteral">&quot;Core %u displaying statistics\n&quot;</span>, <a name="a8"></a><a class="code" href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a>());</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Longer initial pause so above printf is seen */</span></div>
<div class="line">        sleep(sleeptime * 3);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Loop forever: sleep always returns 0 or &lt;= param */</span></div>
<div class="line">        <span class="keywordflow">while</span> (sleep(sleeptime) &lt;= sleeptime)</div>
<div class="line">            do_stats_display();</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Function to set all the node statistic values to zero.</span></div>
<div class="line"><span class="comment"> * Called at program startup.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">clear_stats(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; num_nodes; i++)</div>
<div class="line">        nodes[i].stats.rx = nodes[i].stats.rx_drop = 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * send a burst of traffic to a node, assuming there are packets</span></div>
<div class="line"><span class="comment"> * available to be sent to this node</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">flush_rx_queue(uint16_t node)</div>
<div class="line">{</div>
<div class="line">    uint16_t j;</div>
<div class="line">    <span class="keyword">struct </span>node *cl;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (cl_rx_buf[node].count == 0)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    cl = &amp;nodes[node];</div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a9"></a><a class="code" href="rte__ring_8h.html#ab8debfb458e927d559e7ce750048502d">rte_ring_enqueue_bulk</a>(cl-&gt;rx_q, (<span class="keywordtype">void</span> **)cl_rx_buf[node].buffer,</div>
<div class="line">            cl_rx_buf[node].count, NULL) != cl_rx_buf[node].count){</div>
<div class="line">        <span class="keywordflow">for</span> (j = 0; j &lt; cl_rx_buf[node].count; j++)</div>
<div class="line">            <a name="a10"></a><a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(cl_rx_buf[node].buffer[j]);</div>
<div class="line">        cl-&gt;stats.rx_drop += cl_rx_buf[node].count;</div>
<div class="line">    } <span class="keywordflow">else</span></div>
<div class="line">        cl-&gt;stats.rx += cl_rx_buf[node].count;</div>
<div class="line"> </div>
<div class="line">    cl_rx_buf[node].count = 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * marks a packet down to be sent to a particular node process</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">enqueue_rx_packet(uint8_t node, <span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *buf)</div>
<div class="line">{</div>
<div class="line">    cl_rx_buf[node].buffer[cl_rx_buf[node].count++] = buf;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This function takes a group of packets and routes them</span></div>
<div class="line"><span class="comment"> * individually to the node process. Very simply round-robins the packets</span></div>
<div class="line"><span class="comment"> * without checking any of the packet contents.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">process_packets(uint32_t port_num <a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a>, <span class="keyword">struct</span> <a class="code" href="structrte__mbuf.html">rte_mbuf</a> *pkts[],</div>
<div class="line">        uint16_t rx_count, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> socket_id)</div>
<div class="line">{</div>
<div class="line">    uint16_t i;</div>
<div class="line">    uint8_t node;</div>
<div class="line">    efd_value_t data[<a name="a11"></a><a class="code" href="rte__efd_8h.html#a55598926ba76e0b92197bea26aef12bf">RTE_EFD_BURST_MAX</a>];</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">void</span> *key_ptrs[<a class="code" href="rte__efd_8h.html#a55598926ba76e0b92197bea26aef12bf">RTE_EFD_BURST_MAX</a>];</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">struct </span><a name="_a12"></a><a class="code" href="structrte__ipv4__hdr.html">rte_ipv4_hdr</a> *ipv4_hdr;</div>
<div class="line">    uint32_t ipv4_dst_ip[<a class="code" href="rte__efd_8h.html#a55598926ba76e0b92197bea26aef12bf">RTE_EFD_BURST_MAX</a>];</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; rx_count; i++) {</div>
<div class="line">        <span class="comment">/* Handle IPv4 header.*/</span></div>
<div class="line">        ipv4_hdr = <a name="a13"></a><a class="code" href="rte__mbuf__core_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a>(pkts[i],</div>
<div class="line">            <span class="keyword">struct</span> <a class="code" href="structrte__ipv4__hdr.html">rte_ipv4_hdr</a> *, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a name="_a14"></a><a class="code" href="structrte__ether__hdr.html">rte_ether_hdr</a>));</div>
<div class="line">        ipv4_dst_ip[i] = ipv4_hdr-&gt;<a name="a15"></a><a class="code" href="structrte__ipv4__hdr.html#a57cd4df77fa494510d4203ccaace0bd7">dst_addr</a>;</div>
<div class="line">        key_ptrs[i] = (<span class="keywordtype">void</span> *)&amp;ipv4_dst_ip[i];</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <a name="a16"></a><a class="code" href="rte__efd_8h.html#a41a00b79d1d38d51e899931254cdab23">rte_efd_lookup_bulk</a>(efd_table, socket_id, rx_count,</div>
<div class="line">                (<span class="keyword">const</span> <span class="keywordtype">void</span> **) key_ptrs, data);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; rx_count; i++) {</div>
<div class="line">        node = (uint8_t) ((uintptr_t)data[i]);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (node &gt;= num_nodes) {</div>
<div class="line">            <span class="comment">/*</span></div>
<div class="line"><span class="comment">             * Node is out of range, which means that</span></div>
<div class="line"><span class="comment">             * flow has not been inserted</span></div>
<div class="line"><span class="comment">             */</span></div>
<div class="line">            flow_dist_stats.drop++;</div>
<div class="line">            <a class="code" href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a>(pkts[i]);</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            flow_dist_stats.distributed++;</div>
<div class="line">            enqueue_rx_packet(node, pkts[i]);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; num_nodes; i++)</div>
<div class="line">        flush_rx_queue(i);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Function called by the main lcore of the DPDK process.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">do_packet_forwarding(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> port_num = 0; <span class="comment">/* indexes the port[] array */</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> socket_id = <a name="a17"></a><a class="code" href="rte__lcore_8h.html#a7c8da4664df26a64cf05dc508a4f26df">rte_socket_id</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keyword">struct </span><a class="code" href="structrte__mbuf.html">rte_mbuf</a> *buf[PACKET_READ_SIZE];</div>
<div class="line">        uint16_t rx_count;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* read a port */</span></div>
<div class="line">        rx_count = <a name="a18"></a><a class="code" href="rte__ethdev_8h.html#a3e7d76a451b46348686ea97d6367f102">rte_eth_rx_burst</a>(info-&gt;id[port_num], 0,</div>
<div class="line">                buf, PACKET_READ_SIZE);</div>
<div class="line">        info-&gt;rx_stats.rx[port_num] += rx_count;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Now process the NIC packets read */</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a19"></a><a class="code" href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a>(rx_count &gt; 0))</div>
<div class="line">            process_packets(port_num, buf, rx_count, socket_id);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* move to next port */</span></div>
<div class="line">        <span class="keywordflow">if</span> (++port_num == info-&gt;num_ports)</div>
<div class="line">            port_num = 0;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* initialise the system */</span></div>
<div class="line">    <span class="keywordflow">if</span> (init(argc, argv) &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    <a name="a20"></a><a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, APP, <span class="stringliteral">&quot;Finished Process Init.\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    cl_rx_buf = calloc(num_nodes, <span class="keyword">sizeof</span>(cl_rx_buf[0]));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* clear statistics */</span></div>
<div class="line">    clear_stats();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* put all other cores to sleep except main */</span></div>
<div class="line">    <a name="a21"></a><a class="code" href="rte__launch_8h.html#acc0b1cfdc31fa73329acd51dcea31210">rte_eal_mp_remote_launch</a>(sleep_lcore, NULL, <a name="a22"></a><a class="code" href="rte__launch_8h.html#a7fe96b0e5d3a6a8cf9b8d1a27cf3f159ae26b470d25055b3b60b92a53274da9b8">SKIP_MAIN</a>);</div>
<div class="line"> </div>
<div class="line">    do_packet_forwarding();</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<div class="ttc" id="astructrte__ipv4__hdr_html_a57cd4df77fa494510d4203ccaace0bd7"><div class="ttname"><a href="structrte__ipv4__hdr.html#a57cd4df77fa494510d4203ccaace0bd7">rte_ipv4_hdr::dst_addr</a></div><div class="ttdeci">rte_be32_t dst_addr</div><div class="ttdef"><b>Definition:</b> <a href="rte__ip_8h_source.html#l00043">rte_ip.h:43</a></div></div>
<div class="ttc" id="arte__malloc_8h_html"><div class="ttname"><a href="rte__malloc_8h.html">rte_malloc.h</a></div></div>
<div class="ttc" id="arte__memory_8h_html"><div class="ttname"><a href="rte__memory_8h.html">rte_memory.h</a></div></div>
<div class="ttc" id="arte__branch__prediction_8h_html_ac6c45889010c1bd68631771b64f18101"><div class="ttname"><a href="rte__branch__prediction_8h.html#ac6c45889010c1bd68631771b64f18101">unlikely</a></div><div class="ttdeci">#define unlikely(x)</div><div class="ttdef"><b>Definition:</b> <a href="rte__branch__prediction_8h_source.html#l00038">rte_branch_prediction.h:38</a></div></div>
<div class="ttc" id="arte__launch_8h_html_acc0b1cfdc31fa73329acd51dcea31210"><div class="ttname"><a href="rte__launch_8h.html#acc0b1cfdc31fa73329acd51dcea31210">rte_eal_mp_remote_launch</a></div><div class="ttdeci">int rte_eal_mp_remote_launch(lcore_function_t *f, void *arg, enum rte_rmt_call_main_t call_main)</div></div>
<div class="ttc" id="arte__lcore_8h_html"><div class="ttname"><a href="rte__lcore_8h.html">rte_lcore.h</a></div></div>
<div class="ttc" id="arte__lcore_8h_html_a7c8da4664df26a64cf05dc508a4f26df"><div class="ttname"><a href="rte__lcore_8h.html#a7c8da4664df26a64cf05dc508a4f26df">rte_socket_id</a></div><div class="ttdeci">unsigned int rte_socket_id(void)</div></div>
<div class="ttc" id="arte__log_8h_html"><div class="ttname"><a href="rte__log_8h.html">rte_log.h</a></div></div>
<div class="ttc" id="arte__errno_8h_html_a129a7eb4cfa1f5bdac5783bf49137d06"><div class="ttname"><a href="rte__errno_8h.html#a129a7eb4cfa1f5bdac5783bf49137d06">rte_strerror</a></div><div class="ttdeci">const char * rte_strerror(int errnum)</div></div>
<div class="ttc" id="arte__efd_8h_html_a55598926ba76e0b92197bea26aef12bf"><div class="ttname"><a href="rte__efd_8h.html#a55598926ba76e0b92197bea26aef12bf">RTE_EFD_BURST_MAX</a></div><div class="ttdeci">#define RTE_EFD_BURST_MAX</div><div class="ttdef"><b>Definition:</b> <a href="rte__efd_8h_source.html#l00099">rte_efd.h:99</a></div></div>
<div class="ttc" id="arte__string__fns_8h_html"><div class="ttname"><a href="rte__string__fns_8h.html">rte_string_fns.h</a></div></div>
<div class="ttc" id="arte__ring_8h_html"><div class="ttname"><a href="rte__ring_8h.html">rte_ring.h</a></div></div>
<div class="ttc" id="arte__interrupts_8h_html"><div class="ttname"><a href="rte__interrupts_8h.html">rte_interrupts.h</a></div></div>
<div class="ttc" id="arte__ring_8h_html_ab8debfb458e927d559e7ce750048502d"><div class="ttname"><a href="rte__ring_8h.html#ab8debfb458e927d559e7ce750048502d">rte_ring_enqueue_bulk</a></div><div class="ttdeci">static __rte_always_inline unsigned int rte_ring_enqueue_bulk(struct rte_ring *r, void *const *obj_table, unsigned int n, unsigned int *free_space)</div><div class="ttdef"><b>Definition:</b> <a href="rte__ring_8h_source.html#l00263">rte_ring.h:263</a></div></div>
<div class="ttc" id="arte__branch__prediction_8h_html"><div class="ttname"><a href="rte__branch__prediction_8h.html">rte_branch_prediction.h</a></div></div>
<div class="ttc" id="arte__eal_8h_html"><div class="ttname"><a href="rte__eal_8h.html">rte_eal.h</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_a3e7d76a451b46348686ea97d6367f102"><div class="ttname"><a href="rte__ethdev_8h.html#a3e7d76a451b46348686ea97d6367f102">rte_eth_rx_burst</a></div><div class="ttdeci">static uint16_t rte_eth_rx_burst(uint16_t port_id, uint16_t queue_id, struct rte_mbuf **rx_pkts, const uint16_t nb_pkts)</div><div class="ttdef"><b>Definition:</b> <a href="rte__ethdev_8h_source.html#l04834">rte_ethdev.h:4834</a></div></div>
<div class="ttc" id="arte__ether_8h_html"><div class="ttname"><a href="rte__ether_8h.html">rte_ether.h</a></div></div>
<div class="ttc" id="astructrte__mbuf_html"><div class="ttname"><a href="structrte__mbuf.html">rte_mbuf</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__mbuf__core_8h_source.html#l00473">rte_mbuf_core.h:473</a></div></div>
<div class="ttc" id="arte__atomic_8h_html"><div class="ttname"><a href="rte__atomic_8h.html">rte_atomic.h</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html_a8a28375b279ded9125c99a46bf3956ef"><div class="ttname"><a href="rte__ethdev_8h.html#a8a28375b279ded9125c99a46bf3956ef">rte_eth_macaddr_get</a></div><div class="ttdeci">int rte_eth_macaddr_get(uint16_t port_id, struct rte_ether_addr *mac_addr)</div></div>
<div class="ttc" id="arte__mbuf__core_8h_html_ad63e1de0ec54d7c7603ea984c76ca956"><div class="ttname"><a href="rte__mbuf__core_8h.html#ad63e1de0ec54d7c7603ea984c76ca956">rte_pktmbuf_mtod_offset</a></div><div class="ttdeci">#define rte_pktmbuf_mtod_offset(m, t, o)</div><div class="ttdef"><b>Definition:</b> <a href="rte__mbuf__core_8h_source.html#l00711">rte_mbuf_core.h:711</a></div></div>
<div class="ttc" id="arte__ip_8h_html"><div class="ttname"><a href="rte__ip_8h.html">rte_ip.h</a></div></div>
<div class="ttc" id="arte__lcore_8h_html_adfb2b334e7e73f534f25e8888a8a775f"><div class="ttname"><a href="rte__lcore_8h.html#adfb2b334e7e73f534f25e8888a8a775f">rte_lcore_id</a></div><div class="ttdeci">static unsigned rte_lcore_id(void)</div><div class="ttdef"><b>Definition:</b> <a href="rte__lcore_8h_source.html#l00075">rte_lcore.h:75</a></div></div>
<div class="ttc" id="astructrte__ether__hdr_html"><div class="ttname"><a href="structrte__ether__hdr.html">rte_ether_hdr</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__ether_8h_source.html#l00264">rte_ether.h:264</a></div></div>
<div class="ttc" id="arte__launch_8h_html_a7fe96b0e5d3a6a8cf9b8d1a27cf3f159ae26b470d25055b3b60b92a53274da9b8"><div class="ttname"><a href="rte__launch_8h.html#a7fe96b0e5d3a6a8cf9b8d1a27cf3f159ae26b470d25055b3b60b92a53274da9b8">SKIP_MAIN</a></div><div class="ttdeci">@ SKIP_MAIN</div><div class="ttdef"><b>Definition:</b> <a href="rte__launch_8h_source.html#l00072">rte_launch.h:72</a></div></div>
<div class="ttc" id="arte__common_8h_html"><div class="ttname"><a href="rte__common_8h.html">rte_common.h</a></div></div>
<div class="ttc" id="arte__efd_8h_html"><div class="ttname"><a href="rte__efd_8h.html">rte_efd.h</a></div></div>
<div class="ttc" id="arte__debug_8h_html"><div class="ttname"><a href="rte__debug_8h.html">rte_debug.h</a></div></div>
<div class="ttc" id="arte__common_8h_html_ae1a7c8799cb57669ae2ddf367b21533f"><div class="ttname"><a href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a></div><div class="ttdeci">#define __rte_unused</div><div class="ttdef"><b>Definition:</b> <a href="rte__common_8h_source.html#l00116">rte_common.h:116</a></div></div>
<div class="ttc" id="arte__memcpy_8h_html"><div class="ttname"><a href="rte__memcpy_8h.html">rte_memcpy.h</a></div></div>
<div class="ttc" id="astructrte__ipv4__hdr_html"><div class="ttname"><a href="structrte__ipv4__hdr.html">rte_ipv4_hdr</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__ip_8h_source.html#l00033">rte_ip.h:33</a></div></div>
<div class="ttc" id="arte__efd_8h_html_a41a00b79d1d38d51e899931254cdab23"><div class="ttname"><a href="rte__efd_8h.html#a41a00b79d1d38d51e899931254cdab23">rte_efd_lookup_bulk</a></div><div class="ttdeci">void rte_efd_lookup_bulk(const struct rte_efd_table *table, unsigned int socket_id, int num_keys, const void **key_list, efd_value_t *value_list)</div></div>
<div class="ttc" id="arte__mbuf_8h_html_a1215458932900b7cd5192326fa4a6902"><div class="ttname"><a href="rte__mbuf_8h.html#a1215458932900b7cd5192326fa4a6902">rte_pktmbuf_free</a></div><div class="ttdeci">static void rte_pktmbuf_free(struct rte_mbuf *m)</div><div class="ttdef"><b>Definition:</b> <a href="rte__mbuf_8h_source.html#l01397">rte_mbuf.h:1397</a></div></div>
<div class="ttc" id="arte__branch__prediction_8h_html_a217a0bd562b98ae8c2ffce44935351e1"><div class="ttname"><a href="rte__branch__prediction_8h.html#a217a0bd562b98ae8c2ffce44935351e1">likely</a></div><div class="ttdeci">#define likely(x)</div><div class="ttdef"><b>Definition:</b> <a href="rte__branch__prediction_8h_source.html#l00024">rte_branch_prediction.h:24</a></div></div>
<div class="ttc" id="arte__mempool_8h_html"><div class="ttname"><a href="rte__mempool_8h.html">rte_mempool.h</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html"><div class="ttname"><a href="rte__ethdev_8h.html">rte_ethdev.h</a></div></div>
<div class="ttc" id="arte__log_8h_html_ac23caeb9833fd0fd0665c6c05ec806fe"><div class="ttname"><a href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a></div><div class="ttdeci">#define RTE_LOG(l, t,...)</div><div class="ttdef"><b>Definition:</b> <a href="rte__log_8h_source.html#l00331">rte_log.h:331</a></div></div>
<div class="ttc" id="arte__mbuf_8h_html"><div class="ttname"><a href="rte__mbuf_8h.html">rte_mbuf.h</a></div></div>
<div class="ttc" id="arte__launch_8h_html"><div class="ttname"><a href="rte__launch_8h.html">rte_launch.h</a></div></div>
<div class="ttc" id="astructrte__ether__addr_html"><div class="ttname"><a href="structrte__ether__addr.html">rte_ether_addr</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__ether_8h_source.html#l00064">rte_ether.h:64</a></div></div>
<div class="ttc" id="arte__per__lcore_8h_html"><div class="ttname"><a href="rte__per__lcore_8h.html">rte_per_lcore.h</a></div></div>
<div class="ttc" id="arte__atomic_8h_html_a82ef4eba412a27299860ac88d273a60b"><div class="ttname"><a href="rte__atomic_8h.html#a82ef4eba412a27299860ac88d273a60b">rte_atomic32_test_and_set</a></div><div class="ttdeci">static int rte_atomic32_test_and_set(rte_atomic32_t *v)</div></div>
<div class="ttc" id="arte__byteorder_8h_html"><div class="ttname"><a href="rte__byteorder_8h.html">rte_byteorder.h</a></div></div>
<div class="ttc" id="astructrte__atomic32__t_html"><div class="ttname"><a href="structrte__atomic32__t.html">rte_atomic32_t</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__atomic_8h_source.html#l00472">rte_atomic.h:472</a></div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20
</small></address>
</body>
</html>
