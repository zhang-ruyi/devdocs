<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DPDK: examples/vm_power_manager/channel_manager.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">20.11.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">examples/vm_power_manager/channel_manager.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/* SPDX-License-Identifier: BSD-3-Clause</span></div>
<div class="line"><span class="comment"> * Copyright(c) 2010-2014 Intel Corporation</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fcntl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;dirent.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;sys/queue.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/types.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/stat.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/socket.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/select.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__string__fns_8h.html">rte_string_fns.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__malloc_8h.html">rte_malloc.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__memory_8h.html">rte_memory.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__mempool_8h.html">rte_mempool.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__atomic_8h.html">rte_atomic.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__spinlock_8h.html">rte_spinlock.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;libvirt/libvirt.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;channel_manager.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;channel_commands.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;channel_monitor.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;power_manager.h&quot;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define RTE_LOGTYPE_CHANNEL_MANAGER RTE_LOGTYPE_USER1</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>libvirt_vm_info lvm_info[MAX_CLIENTS];</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Global pointer to libvirt connection */</span></div>
<div class="line"><span class="keyword">static</span> virConnectPtr global_vir_conn_ptr;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *global_cpumaps;</div>
<div class="line"><span class="keyword">static</span> virVcpuInfo *global_vircpuinfo;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">size_t</span> global_maplen;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> global_n_host_cpus;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> global_hypervisor_available;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Represents a single Virtual Machine</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">struct </span>virtual_machine_info {</div>
<div class="line">    <span class="keywordtype">char</span> name[CHANNEL_MGR_MAX_NAME_LEN];</div>
<div class="line">    uint16_t pcpu_map[RTE_MAX_LCORE];</div>
<div class="line">    <span class="keyword">struct </span>channel_info *channels[RTE_MAX_LCORE];</div>
<div class="line">    <span class="keywordtype">char</span> channel_mask[RTE_MAX_LCORE];</div>
<div class="line">    uint8_t num_channels;</div>
<div class="line">    <span class="keyword">enum</span> vm_status status;</div>
<div class="line">    virDomainPtr domainPtr;</div>
<div class="line">    virDomainInfo info;</div>
<div class="line">    <a name="_a0"></a><a class="code" href="structrte__spinlock__t.html">rte_spinlock_t</a> config_spinlock;</div>
<div class="line">    <span class="keywordtype">int</span> allow_query;</div>
<div class="line">    LIST_ENTRY(virtual_machine_info) vms_info;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">LIST_HEAD(, virtual_machine_info) vm_list_head;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>virtual_machine_info *</div>
<div class="line">find_domain_by_name(<span class="keyword">const</span> <span class="keywordtype">char</span> *name)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *info;</div>
<div class="line">    LIST_FOREACH(info, &amp;vm_list_head, vms_info) {</div>
<div class="line">        <span class="keywordflow">if</span> (!strncmp(info-&gt;name, name, CHANNEL_MGR_MAX_NAME_LEN-1))</div>
<div class="line">            <span class="keywordflow">return</span> info;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">update_pcpus_mask(<span class="keyword">struct</span> virtual_machine_info *vm_info)</div>
<div class="line">{</div>
<div class="line">    virVcpuInfoPtr cpuinfo;</div>
<div class="line">    <span class="keywordtype">unsigned</span> i, j;</div>
<div class="line">    <span class="keywordtype">int</span> n_vcpus;</div>
<div class="line"> </div>
<div class="line">    memset(global_cpumaps, 0, RTE_MAX_LCORE*global_maplen);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!virDomainIsActive(vm_info-&gt;domainPtr)) {</div>
<div class="line">        n_vcpus = virDomainGetVcpuPinInfo(vm_info-&gt;domainPtr,</div>
<div class="line">                vm_info-&gt;info.nrVirtCpu, global_cpumaps, global_maplen,</div>
<div class="line">                VIR_DOMAIN_AFFECT_CONFIG);</div>
<div class="line">        <span class="keywordflow">if</span> (n_vcpus &lt; 0) {</div>
<div class="line">            <a name="a1"></a><a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error getting vCPU info for &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;in-active VM &#39;%s&#39;\n&quot;</span>, vm_info-&gt;name);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">goto</span> update_pcpus;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    memset(global_vircpuinfo, 0, <span class="keyword">sizeof</span>(*global_vircpuinfo)*</div>
<div class="line">            RTE_MAX_LCORE);</div>
<div class="line"> </div>
<div class="line">    cpuinfo = global_vircpuinfo;</div>
<div class="line"> </div>
<div class="line">    n_vcpus = virDomainGetVcpus(vm_info-&gt;domainPtr, cpuinfo,</div>
<div class="line">            RTE_MAX_LCORE, global_cpumaps, global_maplen);</div>
<div class="line">    <span class="keywordflow">if</span> (n_vcpus &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error getting vCPU info for &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;active VM &#39;%s&#39;\n&quot;</span>, vm_info-&gt;name);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">update_pcpus:</div>
<div class="line">    <span class="keywordflow">if</span> (n_vcpus &gt;= RTE_MAX_LCORE) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Number of vCPUS(%u) is out of range &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;0...%d\n&quot;</span>, n_vcpus, RTE_MAX_LCORE-1);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (n_vcpus != vm_info-&gt;info.nrVirtCpu) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, CHANNEL_MANAGER, <span class="stringliteral">&quot;Updating the number of vCPUs for VM &#39;%s&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot; from %d -&gt; %d\n&quot;</span>, vm_info-&gt;name, vm_info-&gt;info.nrVirtCpu,</div>
<div class="line">                n_vcpus);</div>
<div class="line">        vm_info-&gt;info.nrVirtCpu = n_vcpus;</div>
<div class="line">    }</div>
<div class="line">    <a name="a2"></a><a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; vm_info-&gt;info.nrVirtCpu; i++) {</div>
<div class="line">        <span class="keywordflow">for</span> (j = 0; j &lt; global_n_host_cpus; j++) {</div>
<div class="line">            <span class="keywordflow">if</span> (VIR_CPU_USABLE(global_cpumaps,</div>
<div class="line">                    global_maplen, i, j) &lt;= 0)</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            vm_info-&gt;pcpu_map[i] = j;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <a name="a3"></a><a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">set_pcpu(<span class="keywordtype">char</span> *vm_name, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> vcpu, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pcpu)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> flags = VIR_DOMAIN_AFFECT_LIVE|VIR_DOMAIN_AFFECT_CONFIG;</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (vcpu &gt;= RTE_MAX_LCORE) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;vCPU(%u) exceeds max allowable(%d)\n&quot;</span>,</div>
<div class="line">                vcpu, RTE_MAX_LCORE-1);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    vm_info = find_domain_by_name(vm_name);</div>
<div class="line">    <span class="keywordflow">if</span> (vm_info == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;VM &#39;%s&#39; not found\n&quot;</span>, vm_name);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!virDomainIsActive(vm_info-&gt;domainPtr)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to set vCPU(%u) to pCPU &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot; for VM &#39;%s&#39;, VM is not active\n&quot;</span>,</div>
<div class="line">                vcpu, vm_info-&gt;name);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (vcpu &gt;= vm_info-&gt;info.nrVirtCpu) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;vCPU(%u) exceeds the assigned number of &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;vCPUs(%u)\n&quot;</span>, vcpu, vm_info-&gt;info.nrVirtCpu);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    memset(global_cpumaps, 0, RTE_MAX_LCORE * global_maplen);</div>
<div class="line"> </div>
<div class="line">    VIR_USE_CPU(global_cpumaps, pcpu);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (pcpu &gt;= global_n_host_cpus) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;CPU(%u) exceeds the available &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;number of CPUs(%u)\n&quot;</span>,</div>
<div class="line">                pcpu, global_n_host_cpus);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (virDomainPinVcpuFlags(vm_info-&gt;domainPtr, vcpu, global_cpumaps,</div>
<div class="line">            global_maplen, flags) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to set vCPU(%u) to pCPU &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot; for VM &#39;%s&#39;\n&quot;</span>, vcpu,</div>
<div class="line">                vm_info-&gt;name);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    vm_info-&gt;pcpu_map[vcpu] = pcpu;</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">uint16_t</div>
<div class="line">get_pcpu(<span class="keyword">struct</span> channel_info *chan_info, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> vcpu)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info =</div>
<div class="line">            (<span class="keyword">struct </span>virtual_machine_info *)chan_info-&gt;priv_info;</div>
<div class="line"> </div>
<div class="line">    if (global_hypervisor_available &amp;&amp; (vm_info != NULL)) {</div>
<div class="line">        uint16_t pcpu;</div>
<div class="line">        <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">        pcpu = vm_info-&gt;pcpu_map[vcpu];</div>
<div class="line">        <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">        <span class="keywordflow">return</span> pcpu;</div>
<div class="line">    } <span class="keywordflow">else</span></div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line">channel_exists(<span class="keyword">struct</span> virtual_machine_info *vm_info, <span class="keywordtype">unsigned</span> channel_num)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    <span class="keywordflow">if</span> (vm_info-&gt;channel_mask[channel_num] == 1) {</div>
<div class="line">        <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">open_non_blocking_channel(<span class="keyword">struct</span> channel_info *info)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret, flags;</div>
<div class="line">    <span class="keyword">struct </span>sockaddr_un sock_addr;</div>
<div class="line">    fd_set soc_fd_set;</div>
<div class="line">    <span class="keyword">struct </span>timeval tv;</div>
<div class="line"> </div>
<div class="line">    info-&gt;fd = socket(AF_UNIX, SOCK_STREAM, 0);</div>
<div class="line">    <span class="keywordflow">if</span> (info-&gt;fd &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error(%s) creating socket for &#39;%s&#39;\n&quot;</span>,</div>
<div class="line">                strerror(errno),</div>
<div class="line">                info-&gt;channel_path);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    sock_addr.sun_family = AF_UNIX;</div>
<div class="line">    memcpy(&amp;sock_addr.sun_path, info-&gt;channel_path,</div>
<div class="line">            strlen(info-&gt;channel_path)+1);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Get current flags */</span></div>
<div class="line">    flags = fcntl(info-&gt;fd, F_GETFL, 0);</div>
<div class="line">    <span class="keywordflow">if</span> (flags &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(WARNING, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error(%s) fcntl get flags socket for&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;&#39;%s&#39;\n&quot;</span>, strerror(errno), info-&gt;channel_path);</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* Set to Non Blocking */</span></div>
<div class="line">    flags |= O_NONBLOCK;</div>
<div class="line">    <span class="keywordflow">if</span> (fcntl(info-&gt;fd, F_SETFL, flags) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(WARNING, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error(%s) setting non-blocking &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;socket for &#39;%s&#39;\n&quot;</span>, strerror(errno), info-&gt;channel_path);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    ret = connect(info-&gt;fd, (<span class="keyword">struct</span> sockaddr *)&amp;sock_addr,</div>
<div class="line">            <span class="keyword">sizeof</span>(sock_addr));</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">        <span class="comment">/* ECONNREFUSED error is given when VM is not active */</span></div>
<div class="line">        <span class="keywordflow">if</span> (errno == ECONNREFUSED) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(WARNING, CHANNEL_MANAGER, <span class="stringliteral">&quot;VM is not active or has not &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;activated its endpoint to channel %s\n&quot;</span>,</div>
<div class="line">                    info-&gt;channel_path);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">/* Wait for tv_sec if in progress */</span></div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (errno == EINPROGRESS) {</div>
<div class="line">            tv.tv_sec = 2;</div>
<div class="line">            tv.tv_usec = 0;</div>
<div class="line">            FD_ZERO(&amp;soc_fd_set);</div>
<div class="line">            FD_SET(info-&gt;fd, &amp;soc_fd_set);</div>
<div class="line">            <span class="keywordflow">if</span> (select(info-&gt;fd+1, NULL, &amp;soc_fd_set, NULL, &amp;tv) &gt; 0) {</div>
<div class="line">                <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(WARNING, CHANNEL_MANAGER, <span class="stringliteral">&quot;Timeout or error on channel &quot;</span></div>
<div class="line">                        <span class="stringliteral">&quot;&#39;%s&#39;\n&quot;</span>, info-&gt;channel_path);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            <span class="comment">/* Any other error */</span></div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(WARNING, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error(%s) connecting socket&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot; for &#39;%s&#39;\n&quot;</span>, strerror(errno), info-&gt;channel_path);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">open_host_channel(<span class="keyword">struct</span> channel_info *info)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> flags;</div>
<div class="line"> </div>
<div class="line">    info-&gt;fd = open(info-&gt;channel_path, O_RDWR | O_RSYNC);</div>
<div class="line">    <span class="keywordflow">if</span> (info-&gt;fd &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error(%s) opening fifo for &#39;%s&#39;\n&quot;</span>,</div>
<div class="line">                strerror(errno),</div>
<div class="line">                info-&gt;channel_path);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Get current flags */</span></div>
<div class="line">    flags = fcntl(info-&gt;fd, F_GETFL, 0);</div>
<div class="line">    <span class="keywordflow">if</span> (flags &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(WARNING, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error(%s) fcntl get flags socket for&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;&#39;%s&#39;\n&quot;</span>, strerror(errno), info-&gt;channel_path);</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* Set to Non Blocking */</span></div>
<div class="line">    flags |= O_NONBLOCK;</div>
<div class="line">    <span class="keywordflow">if</span> (fcntl(info-&gt;fd, F_SETFL, flags) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(WARNING, CHANNEL_MANAGER,</div>
<div class="line">                <span class="stringliteral">&quot;Error(%s) setting non-blocking &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;socket for &#39;%s&#39;\n&quot;</span>,</div>
<div class="line">                strerror(errno), info-&gt;channel_path);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">setup_channel_info(<span class="keyword">struct</span> virtual_machine_info **vm_info_dptr,</div>
<div class="line">        <span class="keyword">struct</span> channel_info **chan_info_dptr, <span class="keywordtype">unsigned</span> channel_num)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>channel_info *chan_info = *chan_info_dptr;</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info = *vm_info_dptr;</div>
<div class="line"> </div>
<div class="line">    chan_info-&gt;channel_num = channel_num;</div>
<div class="line">    chan_info-&gt;priv_info = (<span class="keywordtype">void</span> *)vm_info;</div>
<div class="line">    chan_info-&gt;status = CHANNEL_MGR_CHANNEL_DISCONNECTED;</div>
<div class="line">    chan_info-&gt;type = CHANNEL_TYPE_BINARY;</div>
<div class="line">    <span class="keywordflow">if</span> (open_non_blocking_channel(chan_info) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Could not open channel: &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;&#39;%s&#39; for VM &#39;%s&#39;\n&quot;</span>,</div>
<div class="line">                chan_info-&gt;channel_path, vm_info-&gt;name);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (add_channel_to_monitor(&amp;chan_info) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Could add channel: &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;&#39;%s&#39; to epoll ctl for VM &#39;%s&#39;\n&quot;</span>,</div>
<div class="line">                chan_info-&gt;channel_path, vm_info-&gt;name);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"> </div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    vm_info-&gt;num_channels++;</div>
<div class="line">    vm_info-&gt;channel_mask[channel_num] = 1;</div>
<div class="line">    vm_info-&gt;channels[channel_num] = chan_info;</div>
<div class="line">    chan_info-&gt;status = CHANNEL_MGR_CHANNEL_CONNECTED;</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">fifo_path(<span class="keywordtype">char</span> *dst, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> len, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="keywordtype">id</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> cnt;</div>
<div class="line"> </div>
<div class="line">    cnt = snprintf(dst, len, <span class="stringliteral">&quot;%s%s%d&quot;</span>, CHANNEL_MGR_SOCKET_PATH,</div>
<div class="line">            CHANNEL_MGR_FIFO_PATTERN_NAME, <span class="keywordtype">id</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ((cnt &lt; 0) || (cnt &gt; (<span class="keywordtype">int</span>)len - 1)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Could not create proper &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;string for fifo path\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">setup_host_channel_info(<span class="keyword">struct</span> channel_info **chan_info_dptr,</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> channel_num)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>channel_info *chan_info = *chan_info_dptr;</div>
<div class="line"> </div>
<div class="line">    chan_info-&gt;channel_num = channel_num;</div>
<div class="line">    chan_info-&gt;priv_info = (<span class="keywordtype">void</span> *)NULL;</div>
<div class="line">    chan_info-&gt;status = CHANNEL_MGR_CHANNEL_DISCONNECTED;</div>
<div class="line">    chan_info-&gt;type = CHANNEL_TYPE_JSON;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (open_host_channel(chan_info) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Could not open host channel: &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;&#39;%s&#39;\n&quot;</span>,</div>
<div class="line">                chan_info-&gt;channel_path);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (add_channel_to_monitor(&amp;chan_info) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Could add channel: &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;&#39;%s&#39; to epoll ctl\n&quot;</span>,</div>
<div class="line">                chan_info-&gt;channel_path);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"> </div>
<div class="line">    }</div>
<div class="line">    chan_info-&gt;status = CHANNEL_MGR_CHANNEL_CONNECTED;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">add_all_channels(<span class="keyword">const</span> <span class="keywordtype">char</span> *vm_name)</div>
<div class="line">{</div>
<div class="line">    DIR *d;</div>
<div class="line">    <span class="keyword">struct </span>dirent *dir;</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info;</div>
<div class="line">    <span class="keyword">struct </span>channel_info *chan_info;</div>
<div class="line">    <span class="keywordtype">char</span> *token, *remaining, *tail_ptr;</div>
<div class="line">    <span class="keywordtype">char</span> socket_name[PATH_MAX];</div>
<div class="line">    <span class="keywordtype">unsigned</span> channel_num;</div>
<div class="line">    <span class="keywordtype">int</span> num_channels_enabled = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* verify VM exists */</span></div>
<div class="line">    vm_info = find_domain_by_name(vm_name);</div>
<div class="line">    <span class="keywordflow">if</span> (vm_info == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;VM: &#39;%s&#39; not found&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot; during channel discovery\n&quot;</span>, vm_name);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (!virDomainIsActive(vm_info-&gt;domainPtr)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;VM: &#39;%s&#39; is not active\n&quot;</span>, vm_name);</div>
<div class="line">        vm_info-&gt;status = CHANNEL_MGR_VM_INACTIVE;</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    d = opendir(CHANNEL_MGR_SOCKET_PATH);</div>
<div class="line">    <span class="keywordflow">if</span> (d == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error opening directory &#39;%s&#39;: %s\n&quot;</span>,</div>
<div class="line">                CHANNEL_MGR_SOCKET_PATH, strerror(errno));</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">while</span> ((dir = readdir(d)) != NULL) {</div>
<div class="line">        <span class="keywordflow">if</span> (!strncmp(dir-&gt;d_name, <span class="stringliteral">&quot;.&quot;</span>, 1) ||</div>
<div class="line">                !strncmp(dir-&gt;d_name, <span class="stringliteral">&quot;..&quot;</span>, 2))</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"> </div>
<div class="line">        strlcpy(socket_name, dir-&gt;d_name, <span class="keyword">sizeof</span>(socket_name));</div>
<div class="line">        remaining = socket_name;</div>
<div class="line">        <span class="comment">/* Extract vm_name from &quot;&lt;vm_name&gt;.&lt;channel_num&gt;&quot; */</span></div>
<div class="line">        token = strsep(&amp;remaining, <span class="stringliteral">&quot;.&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (remaining == NULL)</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (strncmp(vm_name, token, CHANNEL_MGR_MAX_NAME_LEN))</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* remaining should contain only &lt;channel_num&gt; */</span></div>
<div class="line">        errno = 0;</div>
<div class="line">        channel_num = (unsigned)strtol(remaining, &amp;tail_ptr, 0);</div>
<div class="line">        <span class="keywordflow">if</span> ((errno != 0) || (remaining[0] == <span class="charliteral">&#39;\0&#39;</span>) ||</div>
<div class="line">                tail_ptr == NULL || (*tail_ptr != <span class="charliteral">&#39;\0&#39;</span>)) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(WARNING, CHANNEL_MANAGER, <span class="stringliteral">&quot;Malformed channel name&quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;&#39;%s&#39; found it should be in the form of &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;&#39;&lt;guest_name&gt;.&lt;channel_num&gt;(decimal)&#39;\n&quot;</span>,</div>
<div class="line">                    dir-&gt;d_name);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (channel_num &gt;= RTE_MAX_LCORE) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(WARNING, CHANNEL_MANAGER, <span class="stringliteral">&quot;Channel number(%u) is &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;greater than max allowable: %d, skipping &#39;%s%s&#39;\n&quot;</span>,</div>
<div class="line">                    channel_num, RTE_MAX_LCORE-1,</div>
<div class="line">                    CHANNEL_MGR_SOCKET_PATH, dir-&gt;d_name);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">/* if channel has not been added previously */</span></div>
<div class="line">        <span class="keywordflow">if</span> (channel_exists(vm_info, channel_num))</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"> </div>
<div class="line">        chan_info = <a name="a4"></a><a class="code" href="rte__malloc_8h.html#a247c99e8d36300c52729c9ee58c2b489">rte_malloc</a>(NULL, <span class="keyword">sizeof</span>(*chan_info),</div>
<div class="line">                RTE_CACHE_LINE_SIZE);</div>
<div class="line">        <span class="keywordflow">if</span> (chan_info == NULL) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error allocating memory for &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;channel &#39;%s%s&#39;\n&quot;</span>, CHANNEL_MGR_SOCKET_PATH, dir-&gt;d_name);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> ((<span class="keywordtype">size_t</span>)snprintf(chan_info-&gt;channel_path,</div>
<div class="line">                <span class="keyword">sizeof</span>(chan_info-&gt;channel_path), <span class="stringliteral">&quot;%s%s&quot;</span>,</div>
<div class="line">                CHANNEL_MGR_SOCKET_PATH, dir-&gt;d_name)</div>
<div class="line">                    &gt;= <span class="keyword">sizeof</span>(chan_info-&gt;channel_path)) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Pathname too long for channel &#39;%s%s&#39;\n&quot;</span>,</div>
<div class="line">                    CHANNEL_MGR_SOCKET_PATH, dir-&gt;d_name);</div>
<div class="line">            <a name="a5"></a><a class="code" href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a>(chan_info);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (setup_channel_info(&amp;vm_info, &amp;chan_info, channel_num) &lt; 0) {</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a>(chan_info);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        num_channels_enabled++;</div>
<div class="line">    }</div>
<div class="line">    closedir(d);</div>
<div class="line">    <span class="keywordflow">return</span> num_channels_enabled;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">add_channels(<span class="keyword">const</span> <span class="keywordtype">char</span> *vm_name, <span class="keywordtype">unsigned</span> *channel_list,</div>
<div class="line">        <span class="keywordtype">unsigned</span> len_channel_list)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info;</div>
<div class="line">    <span class="keyword">struct </span>channel_info *chan_info;</div>
<div class="line">    <span class="keywordtype">char</span> socket_path[PATH_MAX];</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line">    <span class="keywordtype">int</span> num_channels_enabled = 0;</div>
<div class="line"> </div>
<div class="line">    vm_info = find_domain_by_name(vm_name);</div>
<div class="line">    <span class="keywordflow">if</span> (vm_info == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to add channels: VM &#39;%s&#39; &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;not found\n&quot;</span>, vm_name);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!virDomainIsActive(vm_info-&gt;domainPtr)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;VM: &#39;%s&#39; is not active\n&quot;</span>, vm_name);</div>
<div class="line">        vm_info-&gt;status = CHANNEL_MGR_VM_INACTIVE;</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; len_channel_list; i++) {</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (channel_list[i] &gt;= RTE_MAX_LCORE) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, CHANNEL_MANAGER, <span class="stringliteral">&quot;Channel(%u) is out of range &quot;</span></div>
<div class="line">                            <span class="stringliteral">&quot;0...%d\n&quot;</span>, channel_list[i],</div>
<div class="line">                            RTE_MAX_LCORE-1);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (channel_exists(vm_info, channel_list[i])) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, CHANNEL_MANAGER, <span class="stringliteral">&quot;Channel already exists, skipping  &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;&#39;%s.%u&#39;\n&quot;</span>, vm_name, i);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        snprintf(socket_path, <span class="keyword">sizeof</span>(socket_path), <span class="stringliteral">&quot;%s%s.%u&quot;</span>,</div>
<div class="line">                CHANNEL_MGR_SOCKET_PATH, vm_name, channel_list[i]);</div>
<div class="line">        errno = 0;</div>
<div class="line">        <span class="keywordflow">if</span> (access(socket_path, F_OK) &lt; 0) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Channel path &#39;%s&#39; error: &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;%s\n&quot;</span>, socket_path, strerror(errno));</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        chan_info = <a class="code" href="rte__malloc_8h.html#a247c99e8d36300c52729c9ee58c2b489">rte_malloc</a>(NULL, <span class="keyword">sizeof</span>(*chan_info),</div>
<div class="line">                RTE_CACHE_LINE_SIZE);</div>
<div class="line">        <span class="keywordflow">if</span> (chan_info == NULL) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error allocating memory for &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;channel &#39;%s&#39;\n&quot;</span>, socket_path);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        snprintf(chan_info-&gt;channel_path,</div>
<div class="line">                <span class="keyword">sizeof</span>(chan_info-&gt;channel_path), <span class="stringliteral">&quot;%s%s.%u&quot;</span>,</div>
<div class="line">                CHANNEL_MGR_SOCKET_PATH, vm_name, channel_list[i]);</div>
<div class="line">        <span class="keywordflow">if</span> (setup_channel_info(&amp;vm_info, &amp;chan_info, channel_list[i]) &lt; 0) {</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a>(chan_info);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        num_channels_enabled++;</div>
<div class="line"> </div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> num_channels_enabled;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">add_host_channels(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>channel_info *chan_info;</div>
<div class="line">    <span class="keywordtype">char</span> socket_path[PATH_MAX];</div>
<div class="line">    <span class="keywordtype">int</span> num_channels_enabled = 0;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    <span class="keyword">struct </span>core_info *ci;</div>
<div class="line">    <span class="keyword">struct </span>channel_info *chan_infos[RTE_MAX_LCORE];</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; RTE_MAX_LCORE; i++)</div>
<div class="line">        chan_infos[i] = NULL;</div>
<div class="line"> </div>
<div class="line">    ci = get_core_info();</div>
<div class="line">    <span class="keywordflow">if</span> (ci == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Cannot allocate memory for core_info\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; ci-&gt;core_count; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (ci-&gt;cd[i].global_enabled_cpus == 0)</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"> </div>
<div class="line">        ret = fifo_path(socket_path, <span class="keyword">sizeof</span>(socket_path), i);</div>
<div class="line">        <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">            <span class="keywordflow">goto</span> error;</div>
<div class="line"> </div>
<div class="line">        ret = mkfifo(socket_path, 0660);</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(DEBUG, CHANNEL_MANAGER, <span class="stringliteral">&quot;TRY CREATE fifo &#39;%s&#39;\n&quot;</span>,</div>
<div class="line">            socket_path);</div>
<div class="line">        <span class="keywordflow">if</span> ((errno != EEXIST) &amp;&amp; (ret &lt; 0)) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Cannot create fifo &#39;%s&#39; error: &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;%s\n&quot;</span>, socket_path, strerror(errno));</div>
<div class="line">            <span class="keywordflow">goto</span> error;</div>
<div class="line">        }</div>
<div class="line">        chan_info = <a class="code" href="rte__malloc_8h.html#a247c99e8d36300c52729c9ee58c2b489">rte_malloc</a>(NULL, <span class="keyword">sizeof</span>(*chan_info), 0);</div>
<div class="line">        <span class="keywordflow">if</span> (chan_info == NULL) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error allocating memory for &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;channel &#39;%s&#39;\n&quot;</span>, socket_path);</div>
<div class="line">            <span class="keywordflow">goto</span> error;</div>
<div class="line">        }</div>
<div class="line">        chan_infos[i] = chan_info;</div>
<div class="line">        strlcpy(chan_info-&gt;channel_path, socket_path,</div>
<div class="line">                <span class="keyword">sizeof</span>(chan_info-&gt;channel_path));</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (setup_host_channel_info(&amp;chan_info, i) &lt; 0) {</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a>(chan_info);</div>
<div class="line">            chan_infos[i] = NULL;</div>
<div class="line">            <span class="keywordflow">goto</span> error;</div>
<div class="line">        }</div>
<div class="line">        num_channels_enabled++;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> num_channels_enabled;</div>
<div class="line">error:</div>
<div class="line">    <span class="comment">/* Clean up the channels opened before we hit an error. */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; ci-&gt;core_count; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (chan_infos[i] != NULL) {</div>
<div class="line">            remove_channel_from_monitor(chan_infos[i]);</div>
<div class="line">            close(chan_infos[i]-&gt;fd);</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a>(chan_infos[i]);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">remove_channel(<span class="keyword">struct</span> channel_info **chan_info_dptr)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info;</div>
<div class="line">    <span class="keyword">struct </span>channel_info *chan_info = *chan_info_dptr;</div>
<div class="line"> </div>
<div class="line">    close(chan_info-&gt;fd);</div>
<div class="line"> </div>
<div class="line">    vm_info = (<span class="keyword">struct </span>virtual_machine_info *)chan_info-&gt;priv_info;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    vm_info-&gt;channel_mask[chan_info-&gt;channel_num] = 0;</div>
<div class="line">    vm_info-&gt;num_channels--;</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a>(chan_info);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">set_channel_status_all(<span class="keyword">const</span> <span class="keywordtype">char</span> *vm_name, <span class="keyword">enum</span> channel_status status)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info;</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line">    <span class="keywordtype">char</span> mask[RTE_MAX_LCORE];</div>
<div class="line">    <span class="keywordtype">int</span> num_channels_changed = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!(status == CHANNEL_MGR_CHANNEL_CONNECTED ||</div>
<div class="line">            status == CHANNEL_MGR_CHANNEL_DISABLED)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Channels can only be enabled or &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;disabled: Unable to change status for VM &#39;%s&#39;\n&quot;</span>, vm_name);</div>
<div class="line">    }</div>
<div class="line">    vm_info = find_domain_by_name(vm_name);</div>
<div class="line">    <span class="keywordflow">if</span> (vm_info == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to disable channels: VM &#39;%s&#39; &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;not found\n&quot;</span>, vm_name);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    memcpy(mask, (<span class="keywordtype">char</span> *)vm_info-&gt;channel_mask, RTE_MAX_LCORE);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; RTE_MAX_LCORE; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (mask[i] != 1)</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        vm_info-&gt;channels[i]-&gt;status = status;</div>
<div class="line">        num_channels_changed++;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    <span class="keywordflow">return</span> num_channels_changed;</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">set_channel_status(<span class="keyword">const</span> <span class="keywordtype">char</span> *vm_name, <span class="keywordtype">unsigned</span> *channel_list,</div>
<div class="line">        <span class="keywordtype">unsigned</span> len_channel_list, <span class="keyword">enum</span> channel_status status)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info;</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line">    <span class="keywordtype">int</span> num_channels_changed = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!(status == CHANNEL_MGR_CHANNEL_CONNECTED ||</div>
<div class="line">            status == CHANNEL_MGR_CHANNEL_DISABLED)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Channels can only be enabled or &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;disabled: Unable to change status for VM &#39;%s&#39;\n&quot;</span>, vm_name);</div>
<div class="line">    }</div>
<div class="line">    vm_info = find_domain_by_name(vm_name);</div>
<div class="line">    <span class="keywordflow">if</span> (vm_info == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to add channels: VM &#39;%s&#39; &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;not found\n&quot;</span>, vm_name);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; len_channel_list; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (channel_exists(vm_info, channel_list[i])) {</div>
<div class="line">            <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">            vm_info-&gt;channels[channel_list[i]]-&gt;status = status;</div>
<div class="line">            <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">            num_channels_changed++;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> num_channels_changed;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">get_all_vm(<span class="keywordtype">int</span> *num_vm, <span class="keywordtype">int</span> *num_vcpu)</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line">    virNodeInfo node_info;</div>
<div class="line">    virDomainPtr *domptr;</div>
<div class="line">    <span class="keywordtype">int</span> i, ii, numVcpus[MAX_VCPUS], n_vcpus;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> jj;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *vm_name;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> domain_flags = VIR_CONNECT_LIST_DOMAINS_RUNNING |</div>
<div class="line">                VIR_CONNECT_LIST_DOMAINS_PERSISTENT;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> domain_flag = VIR_DOMAIN_VCPU_CONFIG;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!global_hypervisor_available)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    memset(global_cpumaps, 0, RTE_MAX_LCORE*global_maplen);</div>
<div class="line">    <span class="keywordflow">if</span> (virNodeGetInfo(global_vir_conn_ptr, &amp;node_info)) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to retrieve node Info\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Returns number of pcpus */</span></div>
<div class="line">    global_n_host_cpus = (<span class="keywordtype">unsigned</span> int)node_info.cpus;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Returns number of active domains */</span></div>
<div class="line">    *num_vm = virConnectListAllDomains(global_vir_conn_ptr, &amp;domptr,</div>
<div class="line">                    domain_flags);</div>
<div class="line">    <span class="keywordflow">if</span> (*num_vm &lt;= 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;No Active Domains Running\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; *num_vm; i++) {</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Get Domain Names */</span></div>
<div class="line">        vm_name = virDomainGetName(domptr[i]);</div>
<div class="line">        lvm_info[i].vm_name = vm_name;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Get Number of Vcpus */</span></div>
<div class="line">        numVcpus[i] = virDomainGetVcpusFlags(domptr[i], domain_flag);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Get Number of VCpus &amp; VcpuPinInfo */</span></div>
<div class="line">        n_vcpus = virDomainGetVcpuPinInfo(domptr[i],</div>
<div class="line">                numVcpus[i], global_cpumaps,</div>
<div class="line">                global_maplen, domain_flag);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)n_vcpus &gt; 0) {</div>
<div class="line">            *num_vcpu = n_vcpus;</div>
<div class="line">            lvm_info[i].num_cpus = n_vcpus;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Save pcpu in use by libvirt VMs */</span></div>
<div class="line">        <span class="keywordflow">for</span> (ii = 0; ii &lt; n_vcpus; ii++) {</div>
<div class="line">            <span class="keywordflow">for</span> (jj = 0; jj &lt; global_n_host_cpus; jj++) {</div>
<div class="line">                <span class="keywordflow">if</span> (VIR_CPU_USABLE(global_cpumaps,</div>
<div class="line">                        global_maplen, ii, jj) &gt; 0) {</div>
<div class="line">                    lvm_info[i].pcpus[ii] = jj;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">get_info_vm(<span class="keyword">const</span> <span class="keywordtype">char</span> *vm_name, <span class="keyword">struct</span> vm_info *info)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info;</div>
<div class="line">    <span class="keywordtype">unsigned</span> i, channel_num = 0;</div>
<div class="line">    <span class="keywordtype">char</span> mask[RTE_MAX_LCORE];</div>
<div class="line"> </div>
<div class="line">    vm_info = find_domain_by_name(vm_name);</div>
<div class="line">    <span class="keywordflow">if</span> (vm_info == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;VM &#39;%s&#39; not found\n&quot;</span>, vm_name);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    info-&gt;status = CHANNEL_MGR_VM_ACTIVE;</div>
<div class="line">    <span class="keywordflow">if</span> (!virDomainIsActive(vm_info-&gt;domainPtr))</div>
<div class="line">        info-&gt;status = CHANNEL_MGR_VM_INACTIVE;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line"> </div>
<div class="line">    memcpy(mask, (<span class="keywordtype">char</span> *)vm_info-&gt;channel_mask, RTE_MAX_LCORE);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; RTE_MAX_LCORE; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (mask[i] != 1)</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        info-&gt;channels[channel_num].channel_num = i;</div>
<div class="line">        memcpy(info-&gt;channels[channel_num].channel_path,</div>
<div class="line">                vm_info-&gt;channels[i]-&gt;channel_path,</div>
<div class="line">                UNIX_PATH_MAX);</div>
<div class="line">        info-&gt;channels[channel_num].status =</div>
<div class="line">                vm_info-&gt;channels[i]-&gt;status;</div>
<div class="line">        info-&gt;channels[channel_num].fd =</div>
<div class="line">                vm_info-&gt;channels[i]-&gt;fd;</div>
<div class="line">        channel_num++;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    info-&gt;allow_query = vm_info-&gt;allow_query;</div>
<div class="line">    info-&gt;num_channels = channel_num;</div>
<div class="line">    info-&gt;num_vcpus = vm_info-&gt;info.nrVirtCpu;</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line"> </div>
<div class="line">    memcpy(info-&gt;name, vm_info-&gt;name, <span class="keyword">sizeof</span>(vm_info-&gt;name));</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; info-&gt;num_vcpus; i++) {</div>
<div class="line">        info-&gt;pcpu_map[i] = vm_info-&gt;pcpu_map[i];</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">add_vm(<span class="keyword">const</span> <span class="keywordtype">char</span> *vm_name)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *new_domain;</div>
<div class="line">    virDomainPtr dom_ptr;</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (find_domain_by_name(vm_name) != NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to add VM: VM &#39;%s&#39; &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;already exists\n&quot;</span>, vm_name);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (global_vir_conn_ptr == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;No connection to hypervisor exists\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    dom_ptr = virDomainLookupByName(global_vir_conn_ptr, vm_name);</div>
<div class="line">    <span class="keywordflow">if</span> (dom_ptr == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error on VM lookup with libvirt: &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;VM &#39;%s&#39; not found\n&quot;</span>, vm_name);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    new_domain = <a class="code" href="rte__malloc_8h.html#a247c99e8d36300c52729c9ee58c2b489">rte_malloc</a>(<span class="stringliteral">&quot;virtual_machine_info&quot;</span>, <span class="keyword">sizeof</span>(*new_domain),</div>
<div class="line">            RTE_CACHE_LINE_SIZE);</div>
<div class="line">    <span class="keywordflow">if</span> (new_domain == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to allocate memory for VM &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;info\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    new_domain-&gt;domainPtr = dom_ptr;</div>
<div class="line">    <span class="keywordflow">if</span> (virDomainGetInfo(new_domain-&gt;domainPtr, &amp;new_domain-&gt;info) != 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to get libvirt VM info\n&quot;</span>);</div>
<div class="line">        <a class="code" href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a>(new_domain);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (new_domain-&gt;info.nrVirtCpu &gt; RTE_MAX_LCORE) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error the number of virtual CPUs(%u) is &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;greater than allowable(%d)\n&quot;</span>, new_domain-&gt;info.nrVirtCpu,</div>
<div class="line">                RTE_MAX_LCORE);</div>
<div class="line">        <a class="code" href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a>(new_domain);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; RTE_MAX_LCORE; i++)</div>
<div class="line">        new_domain-&gt;pcpu_map[i] = 0;</div>
<div class="line"> </div>
<div class="line">    if (update_pcpus_mask(new_domain) &lt; 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error getting physical CPU pinning\n&quot;</span>);</div>
<div class="line">        <a class="code" href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a>(new_domain);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    strncpy(new_domain-&gt;name, vm_name, <span class="keyword">sizeof</span>(new_domain-&gt;name));</div>
<div class="line">    new_domain-&gt;name[<span class="keyword">sizeof</span>(new_domain-&gt;name) - 1] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line">    memset(new_domain-&gt;channel_mask, 0, RTE_MAX_LCORE);</div>
<div class="line">    new_domain-&gt;num_channels = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!virDomainIsActive(dom_ptr))</div>
<div class="line">        new_domain-&gt;status = CHANNEL_MGR_VM_INACTIVE;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        new_domain-&gt;status = CHANNEL_MGR_VM_ACTIVE;</div>
<div class="line"> </div>
<div class="line">    new_domain-&gt;allow_query = 0;</div>
<div class="line">    <a name="a6"></a><a class="code" href="rte__spinlock_8h.html#af3ff11ac862ee94491533486fc0d959c">rte_spinlock_init</a>(&amp;(new_domain-&gt;config_spinlock));</div>
<div class="line">    LIST_INSERT_HEAD(&amp;vm_list_head, new_domain, vms_info);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">remove_vm(<span class="keyword">const</span> <span class="keywordtype">char</span> *vm_name)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info = find_domain_by_name(vm_name);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (vm_info == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to remove VM: VM &#39;%s&#39; &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;not found\n&quot;</span>, vm_name);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;vm_info-&gt;config_spinlock);</div>
<div class="line">    <span class="keywordflow">if</span> (vm_info-&gt;num_channels != 0) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to remove VM &#39;%s&#39;, there are &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;%&quot;</span>PRId8<span class="stringliteral">&quot; channels still active\n&quot;</span>,</div>
<div class="line">                vm_name, vm_info-&gt;num_channels);</div>
<div class="line">        <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;vm_info-&gt;config_spinlock);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    LIST_REMOVE(vm_info, vms_info);</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;vm_info-&gt;config_spinlock);</div>
<div class="line">    <a class="code" href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a>(vm_info);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">set_query_status(<span class="keywordtype">char</span> *vm_name,</div>
<div class="line">        <span class="keywordtype">bool</span> allow_query)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info;</div>
<div class="line"> </div>
<div class="line">    vm_info = find_domain_by_name(vm_name);</div>
<div class="line">    <span class="keywordflow">if</span> (vm_info == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;VM &#39;%s&#39; not found\n&quot;</span>, vm_name);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    vm_info-&gt;allow_query = allow_query ? 1 : 0;</div>
<div class="line">    <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">disconnect_hypervisor(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (global_vir_conn_ptr != NULL) {</div>
<div class="line">        virConnectClose(global_vir_conn_ptr);</div>
<div class="line">        global_vir_conn_ptr = NULL;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">connect_hypervisor(<span class="keyword">const</span> <span class="keywordtype">char</span> *path)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (global_vir_conn_ptr != NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error connecting to %s, connection &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;already established\n&quot;</span>, path);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    global_vir_conn_ptr = virConnectOpen(path);</div>
<div class="line">    <span class="keywordflow">if</span> (global_vir_conn_ptr == NULL) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error failed to open connection to &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;Hypervisor &#39;%s&#39;\n&quot;</span>, path);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">channel_manager_init(<span class="keyword">const</span> <span class="keywordtype">char</span> *path <a name="a7"></a><a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a>)</div>
<div class="line">{</div>
<div class="line">    virNodeInfo info;</div>
<div class="line"> </div>
<div class="line">    LIST_INIT(&amp;vm_list_head);</div>
<div class="line">    <span class="keywordflow">if</span> (connect_hypervisor(path) &lt; 0) {</div>
<div class="line">        global_n_host_cpus = 64;</div>
<div class="line">        global_hypervisor_available = 0;</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(INFO, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to initialize channel manager\n&quot;</span>);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        global_hypervisor_available = 1;</div>
<div class="line"> </div>
<div class="line">        global_maplen = VIR_CPU_MAPLEN(RTE_MAX_LCORE);</div>
<div class="line"> </div>
<div class="line">        global_vircpuinfo = <a name="a8"></a><a class="code" href="rte__malloc_8h.html#aaf0f048a5fd1672688c662cdfb4536b3">rte_zmalloc</a>(NULL,</div>
<div class="line">                <span class="keyword">sizeof</span>(*global_vircpuinfo) *</div>
<div class="line">                RTE_MAX_LCORE, RTE_CACHE_LINE_SIZE);</div>
<div class="line">        <span class="keywordflow">if</span> (global_vircpuinfo == NULL) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Error allocating memory for CPU Info\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">goto</span> error;</div>
<div class="line">        }</div>
<div class="line">        global_cpumaps = <a class="code" href="rte__malloc_8h.html#aaf0f048a5fd1672688c662cdfb4536b3">rte_zmalloc</a>(NULL,</div>
<div class="line">                RTE_MAX_LCORE * global_maplen,</div>
<div class="line">                RTE_CACHE_LINE_SIZE);</div>
<div class="line">        <span class="keywordflow">if</span> (global_cpumaps == NULL)</div>
<div class="line">            <span class="keywordflow">goto</span> error;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (virNodeGetInfo(global_vir_conn_ptr, &amp;info)) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, CHANNEL_MANAGER, <span class="stringliteral">&quot;Unable to retrieve node Info\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">goto</span> error;</div>
<div class="line">        }</div>
<div class="line">        global_n_host_cpus = (<span class="keywordtype">unsigned</span> int)info.cpus;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (global_n_host_cpus &gt; RTE_MAX_LCORE) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(WARNING, CHANNEL_MANAGER, <span class="stringliteral">&quot;The number of host CPUs(%u) exceeds the &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;maximum of %u. No cores over %u should be used.\n&quot;</span>,</div>
<div class="line">                global_n_host_cpus, RTE_MAX_LCORE,</div>
<div class="line">                RTE_MAX_LCORE - 1);</div>
<div class="line">        global_n_host_cpus = RTE_MAX_LCORE;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">error:</div>
<div class="line">    <span class="keywordflow">if</span> (global_hypervisor_available)</div>
<div class="line">        disconnect_hypervisor();</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">channel_manager_exit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> i;</div>
<div class="line">    <span class="keywordtype">char</span> mask[RTE_MAX_LCORE];</div>
<div class="line">    <span class="keyword">struct </span>virtual_machine_info *vm_info;</div>
<div class="line"> </div>
<div class="line">    LIST_FOREACH(vm_info, &amp;vm_list_head, vms_info) {</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line"> </div>
<div class="line">        memcpy(mask, (<span class="keywordtype">char</span> *)vm_info-&gt;channel_mask, RTE_MAX_LCORE);</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; RTE_MAX_LCORE; i++) {</div>
<div class="line">            <span class="keywordflow">if</span> (mask[i] != 1)</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            remove_channel_from_monitor(</div>
<div class="line">                    vm_info-&gt;channels[i]);</div>
<div class="line">            close(vm_info-&gt;channels[i]-&gt;fd);</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a>(vm_info-&gt;channels[i]);</div>
<div class="line">        }</div>
<div class="line">        <a class="code" href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a>(&amp;(vm_info-&gt;config_spinlock));</div>
<div class="line"> </div>
<div class="line">        LIST_REMOVE(vm_info, vms_info);</div>
<div class="line">        <a class="code" href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a>(vm_info);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (global_hypervisor_available) {</div>
<div class="line">        <span class="comment">/* Only needed if hypervisor available */</span></div>
<div class="line">        <a class="code" href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a>(global_cpumaps);</div>
<div class="line">        <a class="code" href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a>(global_vircpuinfo);</div>
<div class="line">        disconnect_hypervisor();</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<div class="ttc" id="arte__malloc_8h_html_aaf0f048a5fd1672688c662cdfb4536b3"><div class="ttname"><a href="rte__malloc_8h.html#aaf0f048a5fd1672688c662cdfb4536b3">rte_zmalloc</a></div><div class="ttdeci">void * rte_zmalloc(const char *type, size_t size, unsigned align) __rte_alloc_size(2)</div></div>
<div class="ttc" id="arte__spinlock_8h_html_a9f1f7a431c1012f0276fa5f7d859f9f2"><div class="ttname"><a href="rte__spinlock_8h.html#a9f1f7a431c1012f0276fa5f7d859f9f2">rte_spinlock_lock</a></div><div class="ttdeci">static void rte_spinlock_lock(rte_spinlock_t *sl)</div></div>
<div class="ttc" id="arte__malloc_8h_html"><div class="ttname"><a href="rte__malloc_8h.html">rte_malloc.h</a></div></div>
<div class="ttc" id="arte__memory_8h_html"><div class="ttname"><a href="rte__memory_8h.html">rte_memory.h</a></div></div>
<div class="ttc" id="arte__log_8h_html"><div class="ttname"><a href="rte__log_8h.html">rte_log.h</a></div></div>
<div class="ttc" id="arte__string__fns_8h_html"><div class="ttname"><a href="rte__string__fns_8h.html">rte_string_fns.h</a></div></div>
<div class="ttc" id="arte__spinlock_8h_html_a5fa3ccaf4263c07a99bea375384f21d8"><div class="ttname"><a href="rte__spinlock_8h.html#a5fa3ccaf4263c07a99bea375384f21d8">rte_spinlock_unlock</a></div><div class="ttdeci">static void rte_spinlock_unlock(rte_spinlock_t *sl)</div></div>
<div class="ttc" id="arte__atomic_8h_html"><div class="ttname"><a href="rte__atomic_8h.html">rte_atomic.h</a></div></div>
<div class="ttc" id="arte__malloc_8h_html_a247c99e8d36300c52729c9ee58c2b489"><div class="ttname"><a href="rte__malloc_8h.html#a247c99e8d36300c52729c9ee58c2b489">rte_malloc</a></div><div class="ttdeci">void * rte_malloc(const char *type, size_t size, unsigned align) __rte_alloc_size(2)</div></div>
<div class="ttc" id="astructrte__spinlock__t_html"><div class="ttname"><a href="structrte__spinlock__t.html">rte_spinlock_t</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__spinlock_8h_source.html#l00030">rte_spinlock.h:30</a></div></div>
<div class="ttc" id="arte__spinlock_8h_html_af3ff11ac862ee94491533486fc0d959c"><div class="ttname"><a href="rte__spinlock_8h.html#af3ff11ac862ee94491533486fc0d959c">rte_spinlock_init</a></div><div class="ttdeci">static void rte_spinlock_init(rte_spinlock_t *sl)</div><div class="ttdef"><b>Definition:</b> <a href="rte__spinlock_8h_source.html#l00046">rte_spinlock.h:46</a></div></div>
<div class="ttc" id="arte__spinlock_8h_html"><div class="ttname"><a href="rte__spinlock_8h.html">rte_spinlock.h</a></div></div>
<div class="ttc" id="arte__common_8h_html_ae1a7c8799cb57669ae2ddf367b21533f"><div class="ttname"><a href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a></div><div class="ttdeci">#define __rte_unused</div><div class="ttdef"><b>Definition:</b> <a href="rte__common_8h_source.html#l00116">rte_common.h:116</a></div></div>
<div class="ttc" id="arte__mempool_8h_html"><div class="ttname"><a href="rte__mempool_8h.html">rte_mempool.h</a></div></div>
<div class="ttc" id="arte__log_8h_html_ac23caeb9833fd0fd0665c6c05ec806fe"><div class="ttname"><a href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a></div><div class="ttdeci">#define RTE_LOG(l, t,...)</div><div class="ttdef"><b>Definition:</b> <a href="rte__log_8h_source.html#l00331">rte_log.h:331</a></div></div>
<div class="ttc" id="arte__malloc_8h_html_a1fc82f67711b13aca7e05dc9d58f9dbd"><div class="ttname"><a href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a></div><div class="ttdeci">void void rte_free(void *ptr)</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20
</small></address>
</body>
</html>
