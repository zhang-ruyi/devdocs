<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DPDK: examples/ipsec-secgw/sp6.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">20.11.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">examples/ipsec-secgw/sp6.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/* SPDX-License-Identifier: BSD-3-Clause</span></div>
<div class="line"><span class="comment"> * Copyright(c) 2016 Intel Corporation</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Security Policies</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/types.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;netinet/in.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;netinet/ip6.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__acl_8h.html">rte_acl.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ip_8h.html">rte_ip.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;ipsec.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;parser.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define INIT_ACL_RULE_NUM   128</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define IPV6_FROM_SP(acr, fidx_low, fidx_high) \</span></div>
<div class="line"><span class="preprocessor">        (((uint64_t)(acr).field[(fidx_high)].value.u32 &lt;&lt; 32) | \</span></div>
<div class="line"><span class="preprocessor">        (acr).field[(fidx_low)].value.u32)</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define IPV6_DST_FROM_SP(addr, acr) do {\</span></div>
<div class="line"><span class="preprocessor">        (addr).ip.ip6.ip6[0] = rte_cpu_to_be_64(IPV6_FROM_SP((acr), \</span></div>
<div class="line"><span class="preprocessor">                        IP6_DST1, IP6_DST0));\</span></div>
<div class="line"><span class="preprocessor">        (addr).ip.ip6.ip6[1] = rte_cpu_to_be_64(IPV6_FROM_SP((acr), \</span></div>
<div class="line"><span class="preprocessor">                        IP6_DST3, IP6_DST2));\</span></div>
<div class="line"><span class="preprocessor">        } while (0)</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define IPV6_SRC_FROM_SP(addr, acr) do {\</span></div>
<div class="line"><span class="preprocessor">        (addr).ip.ip6.ip6[0] = rte_cpu_to_be_64(IPV6_FROM_SP((acr), \</span></div>
<div class="line"><span class="preprocessor">                            IP6_SRC1, IP6_SRC0));\</span></div>
<div class="line"><span class="preprocessor">        (addr).ip.ip6.ip6[1] = rte_cpu_to_be_64(IPV6_FROM_SP((acr), \</span></div>
<div class="line"><span class="preprocessor">                            IP6_SRC3, IP6_SRC2));\</span></div>
<div class="line"><span class="preprocessor">        } while (0)</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define IPV6_DST_MASK_FROM_SP(mask, acr) \</span></div>
<div class="line"><span class="preprocessor">        ((mask) = (acr).field[IP6_DST0].mask_range.u32 + \</span></div>
<div class="line"><span class="preprocessor">            (acr).field[IP6_DST1].mask_range.u32 + \</span></div>
<div class="line"><span class="preprocessor">            (acr).field[IP6_DST2].mask_range.u32 + \</span></div>
<div class="line"><span class="preprocessor">            (acr).field[IP6_DST3].mask_range.u32)</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define IPV6_SRC_MASK_FROM_SP(mask, acr) \</span></div>
<div class="line"><span class="preprocessor">        ((mask) = (acr).field[IP6_SRC0].mask_range.u32 + \</span></div>
<div class="line"><span class="preprocessor">            (acr).field[IP6_SRC1].mask_range.u32 + \</span></div>
<div class="line"><span class="preprocessor">            (acr).field[IP6_SRC2].mask_range.u32 + \</span></div>
<div class="line"><span class="preprocessor">            (acr).field[IP6_SRC3].mask_range.u32)</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">enum</span> {</div>
<div class="line">    IP6_PROTO,</div>
<div class="line">    IP6_SRC0,</div>
<div class="line">    IP6_SRC1,</div>
<div class="line">    IP6_SRC2,</div>
<div class="line">    IP6_SRC3,</div>
<div class="line">    IP6_DST0,</div>
<div class="line">    IP6_DST1,</div>
<div class="line">    IP6_DST2,</div>
<div class="line">    IP6_DST3,</div>
<div class="line">    IP6_SRCP,</div>
<div class="line">    IP6_DSTP,</div>
<div class="line">    IP6_NUM</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define IP6_ADDR_SIZE 16</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structrte__acl__field__def.html">rte_acl_field_def</a> ip6_defs[IP6_NUM] = {</div>
<div class="line">    {</div>
<div class="line">    .<a name="a1"></a><a class="code" href="structrte__acl__field__def.html#a1d127017fb298b889f4ba24752d08b8e">type</a> = RTE_ACL_FIELD_TYPE_BITMASK,</div>
<div class="line">    .size = <span class="keyword">sizeof</span>(uint8_t),</div>
<div class="line">    .<a name="a2"></a><a class="code" href="structrte__acl__field__def.html#aa63bd1fe49046f2c9ef0478a050b7c3a">field_index</a> = IP6_PROTO,</div>
<div class="line">    .<a name="a3"></a><a class="code" href="structrte__acl__field__def.html#a92f339699e74f468bf5355e4d76f6a79">input_index</a> = IP6_PROTO,</div>
<div class="line">    .<a name="a4"></a><a class="code" href="structrte__acl__field__def.html#a894bdfa2d603d8343f8ef01dda6fcd23">offset</a> = 0,</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">    .type = RTE_ACL_FIELD_TYPE_MASK,</div>
<div class="line">    .size = 4,</div>
<div class="line">    .field_index = IP6_SRC0,</div>
<div class="line">    .input_index = IP6_SRC0,</div>
<div class="line">    .offset = 2</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">    .type = RTE_ACL_FIELD_TYPE_MASK,</div>
<div class="line">    .size = 4,</div>
<div class="line">    .field_index = IP6_SRC1,</div>
<div class="line">    .input_index = IP6_SRC1,</div>
<div class="line">    .offset = 6</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">    .type = RTE_ACL_FIELD_TYPE_MASK,</div>
<div class="line">    .size = 4,</div>
<div class="line">    .field_index = IP6_SRC2,</div>
<div class="line">    .input_index = IP6_SRC2,</div>
<div class="line">    .offset = 10</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">    .type = RTE_ACL_FIELD_TYPE_MASK,</div>
<div class="line">    .size = 4,</div>
<div class="line">    .field_index = IP6_SRC3,</div>
<div class="line">    .input_index = IP6_SRC3,</div>
<div class="line">    .offset = 14</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">    .type = RTE_ACL_FIELD_TYPE_MASK,</div>
<div class="line">    .size = 4,</div>
<div class="line">    .field_index = IP6_DST0,</div>
<div class="line">    .input_index = IP6_DST0,</div>
<div class="line">    .offset = 18</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">    .type = RTE_ACL_FIELD_TYPE_MASK,</div>
<div class="line">    .size = 4,</div>
<div class="line">    .field_index = IP6_DST1,</div>
<div class="line">    .input_index = IP6_DST1,</div>
<div class="line">    .offset = 22</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">    .type = RTE_ACL_FIELD_TYPE_MASK,</div>
<div class="line">    .size = 4,</div>
<div class="line">    .field_index = IP6_DST2,</div>
<div class="line">    .input_index = IP6_DST2,</div>
<div class="line">    .offset = 26</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">    .type = RTE_ACL_FIELD_TYPE_MASK,</div>
<div class="line">    .size = 4,</div>
<div class="line">    .field_index = IP6_DST3,</div>
<div class="line">    .input_index = IP6_DST3,</div>
<div class="line">    .offset = 30</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">    .type = RTE_ACL_FIELD_TYPE_RANGE,</div>
<div class="line">    .size = <span class="keyword">sizeof</span>(uint16_t),</div>
<div class="line">    .<a class="code" href="structrte__acl__field__def.html#aa63bd1fe49046f2c9ef0478a050b7c3a">field_index</a> = IP6_SRCP,</div>
<div class="line">    .<a class="code" href="structrte__acl__field__def.html#a92f339699e74f468bf5355e4d76f6a79">input_index</a> = IP6_SRCP,</div>
<div class="line">    .<a class="code" href="structrte__acl__field__def.html#a894bdfa2d603d8343f8ef01dda6fcd23">offset</a> = 34</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">    .type = RTE_ACL_FIELD_TYPE_RANGE,</div>
<div class="line">    .size = <span class="keyword">sizeof</span>(uint16_t),</div>
<div class="line">    .<a class="code" href="structrte__acl__field__def.html#aa63bd1fe49046f2c9ef0478a050b7c3a">field_index</a> = IP6_DSTP,</div>
<div class="line">    .<a class="code" href="structrte__acl__field__def.html#a92f339699e74f468bf5355e4d76f6a79">input_index</a> = IP6_SRCP,</div>
<div class="line">    .<a class="code" href="structrte__acl__field__def.html#a894bdfa2d603d8343f8ef01dda6fcd23">offset</a> = 36</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><a name="a5"></a><a class="code" href="rte__acl_8h.html#ae5ab707258c6c9fbe28832902cbacf1c">RTE_ACL_RULE_DEF</a>(acl6_rules, <a name="a6"></a><a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(ip6_defs));</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>acl6_rules *acl6_rules_out;</div>
<div class="line"><span class="keyword">static</span> uint32_t nb_acl6_rules_out;</div>
<div class="line"><span class="keyword">static</span> uint32_t sp_out_sz;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>acl6_rules *acl6_rules_in;</div>
<div class="line"><span class="keyword">static</span> uint32_t nb_acl6_rules_in;</div>
<div class="line"><span class="keyword">static</span> uint32_t sp_in_sz;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">extend_sp_arr(<span class="keyword">struct</span> acl6_rules **sp_tbl, uint32_t cur_cnt, uint32_t *cur_sz)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (*sp_tbl == NULL) {</div>
<div class="line">        *sp_tbl = calloc(INIT_ACL_RULE_NUM, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> acl6_rules));</div>
<div class="line">        <span class="keywordflow">if</span> (*sp_tbl == NULL)</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        *cur_sz = INIT_ACL_RULE_NUM;</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (cur_cnt &gt;= *cur_sz) {</div>
<div class="line">        *sp_tbl = realloc(*sp_tbl,</div>
<div class="line">            *cur_sz * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> acl6_rules) * 2);</div>
<div class="line">        <span class="keywordflow">if</span> (*sp_tbl == NULL)</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        <span class="comment">/* clean reallocated extra space */</span></div>
<div class="line">        memset(&amp;(*sp_tbl)[*cur_sz], 0,</div>
<div class="line">            *cur_sz * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> acl6_rules));</div>
<div class="line">        *cur_sz *= 2;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">parse_sp6_tokens(<span class="keywordtype">char</span> **tokens, uint32_t n_tokens,</div>
<div class="line">    <span class="keyword">struct</span> parse_status *status)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>acl6_rules *rule_ipv6 = NULL;</div>
<div class="line"> </div>
<div class="line">    uint32_t *ri = NULL; <span class="comment">/* rule index */</span></div>
<div class="line">    uint32_t ti = 0; <span class="comment">/* token index */</span></div>
<div class="line">    uint32_t tv;</div>
<div class="line"> </div>
<div class="line">    uint32_t esp_p = 0;</div>
<div class="line">    uint32_t protect_p = 0;</div>
<div class="line">    uint32_t bypass_p = 0;</div>
<div class="line">    uint32_t discard_p = 0;</div>
<div class="line">    uint32_t pri_p = 0;</div>
<div class="line">    uint32_t src_p = 0;</div>
<div class="line">    uint32_t dst_p = 0;</div>
<div class="line">    uint32_t proto_p = 0;</div>
<div class="line">    uint32_t sport_p = 0;</div>
<div class="line">    uint32_t dport_p = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (strcmp(tokens[1], <span class="stringliteral">&quot;in&quot;</span>) == 0) {</div>
<div class="line">        ri = &amp;nb_acl6_rules_in;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (extend_sp_arr(&amp;acl6_rules_in, nb_acl6_rules_in,</div>
<div class="line">                &amp;sp_in_sz) &lt; 0)</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">        rule_ipv6 = &amp;acl6_rules_in[*ri];</div>
<div class="line"> </div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(tokens[1], <span class="stringliteral">&quot;out&quot;</span>) == 0) {</div>
<div class="line">        ri = &amp;nb_acl6_rules_out;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (extend_sp_arr(&amp;acl6_rules_out, nb_acl6_rules_out,</div>
<div class="line">                &amp;sp_out_sz) &lt; 0)</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">        rule_ipv6 = &amp;acl6_rules_out[*ri];</div>
<div class="line"> </div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        APP_CHECK(0, status, <span class="stringliteral">&quot;unrecognized input \&quot;%s\&quot;, expect&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot; \&quot;in\&quot; or \&quot;out\&quot;\n&quot;</span>, tokens[ti]);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    rule_ipv6-&gt;data.category_mask = 1;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (ti = 2; ti &lt; n_tokens; ti++) {</div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(tokens[ti], <span class="stringliteral">&quot;esp&quot;</span>) == 0) {</div>
<div class="line">            <span class="comment">/* currently do nothing */</span></div>
<div class="line">            APP_CHECK_PRESENCE(esp_p, tokens[ti], status);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            esp_p = 1;</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(tokens[ti], <span class="stringliteral">&quot;protect&quot;</span>) == 0) {</div>
<div class="line">            APP_CHECK_PRESENCE(protect_p, tokens[ti], status);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            APP_CHECK(bypass_p == 0, status, <span class="stringliteral">&quot;conflict item &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;between \&quot;%s\&quot; and \&quot;%s\&quot;&quot;</span>, tokens[ti],</div>
<div class="line">                <span class="stringliteral">&quot;bypass&quot;</span>);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            APP_CHECK(discard_p == 0, status, <span class="stringliteral">&quot;conflict item &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;between \&quot;%s\&quot; and \&quot;%s\&quot;&quot;</span>, tokens[ti],</div>
<div class="line">                <span class="stringliteral">&quot;discard&quot;</span>);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            INCREMENT_TOKEN_INDEX(ti, n_tokens, status);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            APP_CHECK_TOKEN_IS_NUM(tokens, ti, status);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">            tv = atoi(tokens[ti]);</div>
<div class="line">            APP_CHECK(tv != DISCARD &amp;&amp; tv != BYPASS, status,</div>
<div class="line">                <span class="stringliteral">&quot;invalid SPI: %s&quot;</span>, tokens[ti]);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            rule_ipv6-&gt;data.userdata = tv;</div>
<div class="line"> </div>
<div class="line">            protect_p = 1;</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(tokens[ti], <span class="stringliteral">&quot;bypass&quot;</span>) == 0) {</div>
<div class="line">            APP_CHECK_PRESENCE(bypass_p, tokens[ti], status);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            APP_CHECK(protect_p == 0, status, <span class="stringliteral">&quot;conflict item &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;between \&quot;%s\&quot; and \&quot;%s\&quot;&quot;</span>, tokens[ti],</div>
<div class="line">                <span class="stringliteral">&quot;protect&quot;</span>);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            APP_CHECK(discard_p == 0, status, <span class="stringliteral">&quot;conflict item &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;between \&quot;%s\&quot; and \&quot;%s\&quot;&quot;</span>, tokens[ti],</div>
<div class="line">                <span class="stringliteral">&quot;discard&quot;</span>);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">            rule_ipv6-&gt;data.userdata = BYPASS;</div>
<div class="line"> </div>
<div class="line">            bypass_p = 1;</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(tokens[ti], <span class="stringliteral">&quot;discard&quot;</span>) == 0) {</div>
<div class="line">            APP_CHECK_PRESENCE(discard_p, tokens[ti], status);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            APP_CHECK(protect_p == 0, status, <span class="stringliteral">&quot;conflict item &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;between \&quot;%s\&quot; and \&quot;%s\&quot;&quot;</span>, tokens[ti],</div>
<div class="line">                <span class="stringliteral">&quot;protect&quot;</span>);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            APP_CHECK(bypass_p == 0, status, <span class="stringliteral">&quot;conflict item &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;between \&quot;%s\&quot; and \&quot;%s\&quot;&quot;</span>, tokens[ti],</div>
<div class="line">                <span class="stringliteral">&quot;discard&quot;</span>);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">            rule_ipv6-&gt;data.userdata = DISCARD;</div>
<div class="line"> </div>
<div class="line">            discard_p = 1;</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(tokens[ti], <span class="stringliteral">&quot;pri&quot;</span>) == 0) {</div>
<div class="line">            APP_CHECK_PRESENCE(pri_p, tokens[ti], status);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            INCREMENT_TOKEN_INDEX(ti, n_tokens, status);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            APP_CHECK_TOKEN_IS_NUM(tokens, ti, status);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">            rule_ipv6-&gt;data.priority = atoi(tokens[ti]);</div>
<div class="line"> </div>
<div class="line">            pri_p = 1;</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(tokens[ti], <span class="stringliteral">&quot;src&quot;</span>) == 0) {</div>
<div class="line">            <span class="keyword">struct </span>in6_addr ip;</div>
<div class="line">            uint32_t depth;</div>
<div class="line"> </div>
<div class="line">            APP_CHECK_PRESENCE(src_p, tokens[ti], status);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            INCREMENT_TOKEN_INDEX(ti, n_tokens, status);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">            APP_CHECK(parse_ipv6_addr(tokens[ti], &amp;ip,</div>
<div class="line">                &amp;depth) == 0, status, <span class="stringliteral">&quot;unrecognized &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;input \&quot;%s\&quot;, expect valid ipv6 &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;addr&quot;</span>, tokens[ti]);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">            rule_ipv6-&gt;field[1].value.u32 =</div>
<div class="line">                (uint32_t)ip.s6_addr[0] &lt;&lt; 24 |</div>
<div class="line">                (uint32_t)ip.s6_addr[1] &lt;&lt; 16 |</div>
<div class="line">                (uint32_t)ip.s6_addr[2] &lt;&lt; 8 |</div>
<div class="line">                (uint32_t)ip.s6_addr[3];</div>
<div class="line">            rule_ipv6-&gt;field[1].mask_range.u32 =</div>
<div class="line">                (depth &gt; 32) ? 32 : depth;</div>
<div class="line">            depth = (depth &gt; 32) ? (depth - 32) : 0;</div>
<div class="line">            rule_ipv6-&gt;field[2].value.u32 =</div>
<div class="line">                (uint32_t)ip.s6_addr[4] &lt;&lt; 24 |</div>
<div class="line">                (uint32_t)ip.s6_addr[5] &lt;&lt; 16 |</div>
<div class="line">                (uint32_t)ip.s6_addr[6] &lt;&lt; 8 |</div>
<div class="line">                (uint32_t)ip.s6_addr[7];</div>
<div class="line">            rule_ipv6-&gt;field[2].mask_range.u32 =</div>
<div class="line">                (depth &gt; 32) ? 32 : depth;</div>
<div class="line">            depth = (depth &gt; 32) ? (depth - 32) : 0;</div>
<div class="line">            rule_ipv6-&gt;field[3].value.u32 =</div>
<div class="line">                (uint32_t)ip.s6_addr[8] &lt;&lt; 24 |</div>
<div class="line">                (uint32_t)ip.s6_addr[9] &lt;&lt; 16 |</div>
<div class="line">                (uint32_t)ip.s6_addr[10] &lt;&lt; 8 |</div>
<div class="line">                (uint32_t)ip.s6_addr[11];</div>
<div class="line">            rule_ipv6-&gt;field[3].mask_range.u32 =</div>
<div class="line">                (depth &gt; 32) ? 32 : depth;</div>
<div class="line">            depth = (depth &gt; 32) ? (depth - 32) : 0;</div>
<div class="line">            rule_ipv6-&gt;field[4].value.u32 =</div>
<div class="line">                (uint32_t)ip.s6_addr[12] &lt;&lt; 24 |</div>
<div class="line">                (uint32_t)ip.s6_addr[13] &lt;&lt; 16 |</div>
<div class="line">                (uint32_t)ip.s6_addr[14] &lt;&lt; 8 |</div>
<div class="line">                (uint32_t)ip.s6_addr[15];</div>
<div class="line">            rule_ipv6-&gt;field[4].mask_range.u32 =</div>
<div class="line">                (depth &gt; 32) ? 32 : depth;</div>
<div class="line"> </div>
<div class="line">            src_p = 1;</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(tokens[ti], <span class="stringliteral">&quot;dst&quot;</span>) == 0) {</div>
<div class="line">            <span class="keyword">struct </span>in6_addr ip;</div>
<div class="line">            uint32_t depth;</div>
<div class="line"> </div>
<div class="line">            APP_CHECK_PRESENCE(dst_p, tokens[ti], status);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            INCREMENT_TOKEN_INDEX(ti, n_tokens, status);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">            APP_CHECK(parse_ipv6_addr(tokens[ti], &amp;ip,</div>
<div class="line">                &amp;depth) == 0, status, <span class="stringliteral">&quot;unrecognized &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;input \&quot;%s\&quot;, expect valid ipv6 &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;addr&quot;</span>, tokens[ti]);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">            rule_ipv6-&gt;field[5].value.u32 =</div>
<div class="line">                (uint32_t)ip.s6_addr[0] &lt;&lt; 24 |</div>
<div class="line">                (uint32_t)ip.s6_addr[1] &lt;&lt; 16 |</div>
<div class="line">                (uint32_t)ip.s6_addr[2] &lt;&lt; 8 |</div>
<div class="line">                (uint32_t)ip.s6_addr[3];</div>
<div class="line">            rule_ipv6-&gt;field[5].mask_range.u32 =</div>
<div class="line">                (depth &gt; 32) ? 32 : depth;</div>
<div class="line">            depth = (depth &gt; 32) ? (depth - 32) : 0;</div>
<div class="line">            rule_ipv6-&gt;field[6].value.u32 =</div>
<div class="line">                (uint32_t)ip.s6_addr[4] &lt;&lt; 24 |</div>
<div class="line">                (uint32_t)ip.s6_addr[5] &lt;&lt; 16 |</div>
<div class="line">                (uint32_t)ip.s6_addr[6] &lt;&lt; 8 |</div>
<div class="line">                (uint32_t)ip.s6_addr[7];</div>
<div class="line">            rule_ipv6-&gt;field[6].mask_range.u32 =</div>
<div class="line">                (depth &gt; 32) ? 32 : depth;</div>
<div class="line">            depth = (depth &gt; 32) ? (depth - 32) : 0;</div>
<div class="line">            rule_ipv6-&gt;field[7].value.u32 =</div>
<div class="line">                (uint32_t)ip.s6_addr[8] &lt;&lt; 24 |</div>
<div class="line">                (uint32_t)ip.s6_addr[9] &lt;&lt; 16 |</div>
<div class="line">                (uint32_t)ip.s6_addr[10] &lt;&lt; 8 |</div>
<div class="line">                (uint32_t)ip.s6_addr[11];</div>
<div class="line">            rule_ipv6-&gt;field[7].mask_range.u32 =</div>
<div class="line">                (depth &gt; 32) ? 32 : depth;</div>
<div class="line">            depth = (depth &gt; 32) ? (depth - 32) : 0;</div>
<div class="line">            rule_ipv6-&gt;field[8].value.u32 =</div>
<div class="line">                (uint32_t)ip.s6_addr[12] &lt;&lt; 24 |</div>
<div class="line">                (uint32_t)ip.s6_addr[13] &lt;&lt; 16 |</div>
<div class="line">                (uint32_t)ip.s6_addr[14] &lt;&lt; 8 |</div>
<div class="line">                (uint32_t)ip.s6_addr[15];</div>
<div class="line">            rule_ipv6-&gt;field[8].mask_range.u32 =</div>
<div class="line">                (depth &gt; 32) ? 32 : depth;</div>
<div class="line"> </div>
<div class="line">            dst_p = 1;</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(tokens[ti], <span class="stringliteral">&quot;proto&quot;</span>) == 0) {</div>
<div class="line">            uint16_t low, high;</div>
<div class="line"> </div>
<div class="line">            APP_CHECK_PRESENCE(proto_p, tokens[ti], status);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            INCREMENT_TOKEN_INDEX(ti, n_tokens, status);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">            APP_CHECK(parse_range(tokens[ti], &amp;low, &amp;high)</div>
<div class="line">                == 0, status, <span class="stringliteral">&quot;unrecognized input \&quot;%s\&quot;&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;, expect \&quot;from:to\&quot;&quot;</span>, tokens[ti]);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            APP_CHECK(low &lt;= 0xff, status, <span class="stringliteral">&quot;proto low &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;over-limit&quot;</span>);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            APP_CHECK(high &lt;= 0xff, status, <span class="stringliteral">&quot;proto high &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;over-limit&quot;</span>);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">            rule_ipv6-&gt;field[0].value.u8 = (uint8_t)low;</div>
<div class="line">            rule_ipv6-&gt;field[0].mask_range.u8 = (uint8_t)high;</div>
<div class="line"> </div>
<div class="line">            proto_p = 1;</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(tokens[ti], <span class="stringliteral">&quot;sport&quot;</span>) == 0) {</div>
<div class="line">            uint16_t port_low, port_high;</div>
<div class="line"> </div>
<div class="line">            APP_CHECK_PRESENCE(sport_p, tokens[ti], status);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            INCREMENT_TOKEN_INDEX(ti, n_tokens, status);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">            APP_CHECK(parse_range(tokens[ti], &amp;port_low,</div>
<div class="line">                &amp;port_high) == 0, status, <span class="stringliteral">&quot;unrecognized &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;input \&quot;%s\&quot;, expect \&quot;port_from:&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;port_to\&quot;&quot;</span>, tokens[ti]);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">            rule_ipv6-&gt;field[9].value.u16 = port_low;</div>
<div class="line">            rule_ipv6-&gt;field[9].mask_range.u16 = port_high;</div>
<div class="line"> </div>
<div class="line">            sport_p = 1;</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(tokens[ti], <span class="stringliteral">&quot;dport&quot;</span>) == 0) {</div>
<div class="line">            uint16_t port_low, port_high;</div>
<div class="line"> </div>
<div class="line">            APP_CHECK_PRESENCE(dport_p, tokens[ti], status);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            INCREMENT_TOKEN_INDEX(ti, n_tokens, status);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">            APP_CHECK(parse_range(tokens[ti], &amp;port_low,</div>
<div class="line">                &amp;port_high) == 0, status, <span class="stringliteral">&quot;unrecognized &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;input \&quot;%s\&quot;, expect \&quot;port_from:&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;port_to\&quot;&quot;</span>, tokens[ti]);</div>
<div class="line">            <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">            rule_ipv6-&gt;field[10].value.u16 = port_low;</div>
<div class="line">            rule_ipv6-&gt;field[10].mask_range.u16 = port_high;</div>
<div class="line"> </div>
<div class="line">            dport_p = 1;</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* unrecognizeable input */</span></div>
<div class="line">        APP_CHECK(0, status, <span class="stringliteral">&quot;unrecognized input \&quot;%s\&quot;&quot;</span>,</div>
<div class="line">            tokens[ti]);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* check if argument(s) are missing */</span></div>
<div class="line">    APP_CHECK(esp_p == 1, status, <span class="stringliteral">&quot;missing argument \&quot;esp\&quot;&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    APP_CHECK(protect_p | bypass_p | discard_p, status, <span class="stringliteral">&quot;missing &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;argument \&quot;protect\&quot;, \&quot;bypass\&quot;, or \&quot;discard\&quot;&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    *ri = *ri + 1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">print_one_ip6_rule(<span class="keyword">const</span> <span class="keyword">struct</span> acl6_rules *rule, int32_t extra)</div>
<div class="line">{</div>
<div class="line">    uint8_t a, b, c, d;</div>
<div class="line"> </div>
<div class="line">    uint32_t_to_char(rule-&gt;field[IP6_SRC0].value.u32,</div>
<div class="line">        &amp;a, &amp;b, &amp;c, &amp;d);</div>
<div class="line">    printf(<span class="stringliteral">&quot;%.2x%.2x:%.2x%.2x&quot;</span>, a, b, c, d);</div>
<div class="line">    uint32_t_to_char(rule-&gt;field[IP6_SRC1].value.u32,</div>
<div class="line">        &amp;a, &amp;b, &amp;c, &amp;d);</div>
<div class="line">    printf(<span class="stringliteral">&quot;:%.2x%.2x:%.2x%.2x&quot;</span>, a, b, c, d);</div>
<div class="line">    uint32_t_to_char(rule-&gt;field[IP6_SRC2].value.u32,</div>
<div class="line">        &amp;a, &amp;b, &amp;c, &amp;d);</div>
<div class="line">    printf(<span class="stringliteral">&quot;:%.2x%.2x:%.2x%.2x&quot;</span>, a, b, c, d);</div>
<div class="line">    uint32_t_to_char(rule-&gt;field[IP6_SRC3].value.u32,</div>
<div class="line">        &amp;a, &amp;b, &amp;c, &amp;d);</div>
<div class="line">    printf(<span class="stringliteral">&quot;:%.2x%.2x:%.2x%.2x/%u &quot;</span>, a, b, c, d,</div>
<div class="line">            rule-&gt;field[IP6_SRC0].mask_range.u32</div>
<div class="line">            + rule-&gt;field[IP6_SRC1].mask_range.u32</div>
<div class="line">            + rule-&gt;field[IP6_SRC2].mask_range.u32</div>
<div class="line">            + rule-&gt;field[IP6_SRC3].mask_range.u32);</div>
<div class="line"> </div>
<div class="line">    uint32_t_to_char(rule-&gt;field[IP6_DST0].value.u32,</div>
<div class="line">        &amp;a, &amp;b, &amp;c, &amp;d);</div>
<div class="line">    printf(<span class="stringliteral">&quot;%.2x%.2x:%.2x%.2x&quot;</span>, a, b, c, d);</div>
<div class="line">    uint32_t_to_char(rule-&gt;field[IP6_DST1].value.u32,</div>
<div class="line">        &amp;a, &amp;b, &amp;c, &amp;d);</div>
<div class="line">    printf(<span class="stringliteral">&quot;:%.2x%.2x:%.2x%.2x&quot;</span>, a, b, c, d);</div>
<div class="line">    uint32_t_to_char(rule-&gt;field[IP6_DST2].value.u32,</div>
<div class="line">        &amp;a, &amp;b, &amp;c, &amp;d);</div>
<div class="line">    printf(<span class="stringliteral">&quot;:%.2x%.2x:%.2x%.2x&quot;</span>, a, b, c, d);</div>
<div class="line">    uint32_t_to_char(rule-&gt;field[IP6_DST3].value.u32,</div>
<div class="line">        &amp;a, &amp;b, &amp;c, &amp;d);</div>
<div class="line">    printf(<span class="stringliteral">&quot;:%.2x%.2x:%.2x%.2x/%u &quot;</span>, a, b, c, d,</div>
<div class="line">            rule-&gt;field[IP6_DST0].mask_range.u32</div>
<div class="line">            + rule-&gt;field[IP6_DST1].mask_range.u32</div>
<div class="line">            + rule-&gt;field[IP6_DST2].mask_range.u32</div>
<div class="line">            + rule-&gt;field[IP6_DST3].mask_range.u32);</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;%hu : %hu %hu : %hu 0x%hhx/0x%hhx &quot;</span>,</div>
<div class="line">        rule-&gt;field[IP6_SRCP].value.u16,</div>
<div class="line">        rule-&gt;field[IP6_SRCP].mask_range.u16,</div>
<div class="line">        rule-&gt;field[IP6_DSTP].value.u16,</div>
<div class="line">        rule-&gt;field[IP6_DSTP].mask_range.u16,</div>
<div class="line">        rule-&gt;field[IP6_PROTO].value.u8,</div>
<div class="line">        rule-&gt;field[IP6_PROTO].mask_range.u8);</div>
<div class="line">    <span class="keywordflow">if</span> (extra)</div>
<div class="line">        printf(<span class="stringliteral">&quot;0x%x-0x%x-0x%x &quot;</span>,</div>
<div class="line">            rule-&gt;data.category_mask,</div>
<div class="line">            rule-&gt;data.priority,</div>
<div class="line">            rule-&gt;data.userdata);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line">dump_ip6_rules(<span class="keyword">const</span> <span class="keyword">struct</span> acl6_rules *rule, int32_t num, int32_t extra)</div>
<div class="line">{</div>
<div class="line">    int32_t i;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; num; i++, rule++) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;\t%d:&quot;</span>, i + 1);</div>
<div class="line">        print_one_ip6_rule(rule, extra);</div>
<div class="line">        printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>rte_acl_ctx *</div>
<div class="line">acl6_init(<span class="keyword">const</span> <span class="keywordtype">char</span> *name, int32_t socketid, <span class="keyword">const</span> <span class="keyword">struct</span> acl6_rules *rules,</div>
<div class="line">        uint32_t rules_nb)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> s[PATH_MAX];</div>
<div class="line">    <span class="keyword">struct </span><a name="_a7"></a><a class="code" href="structrte__acl__param.html">rte_acl_param</a> acl_param;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a8"></a><a class="code" href="structrte__acl__config.html">rte_acl_config</a> acl_build_param;</div>
<div class="line">    <span class="keyword">struct </span>rte_acl_ctx *ctx;</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;Creating SP context with %u rules\n&quot;</span>, rules_nb);</div>
<div class="line"> </div>
<div class="line">    memset(&amp;acl_param, 0, <span class="keyword">sizeof</span>(acl_param));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Create ACL contexts */</span></div>
<div class="line">    snprintf(s, <span class="keyword">sizeof</span>(s), <span class="stringliteral">&quot;%s_%d&quot;</span>, name, socketid);</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;IPv4 %s entries [%u]:\n&quot;</span>, s, rules_nb);</div>
<div class="line">    dump_ip6_rules(rules, rules_nb, 1);</div>
<div class="line"> </div>
<div class="line">    acl_param.name = s;</div>
<div class="line">    acl_param.socket_id = socketid;</div>
<div class="line">    acl_param.rule_size = RTE_ACL_RULE_SZ(<a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(ip6_defs));</div>
<div class="line">    acl_param.max_rule_num = rules_nb;</div>
<div class="line"> </div>
<div class="line">    ctx = <a name="a9"></a><a class="code" href="rte__acl_8h.html#af230a8bd56f72b86af5e99375fb75313">rte_acl_create</a>(&amp;acl_param);</div>
<div class="line">    <span class="keywordflow">if</span> (ctx == NULL)</div>
<div class="line">        <a name="a10"></a><a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Failed to create ACL context\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a11"></a><a class="code" href="rte__acl_8h.html#a54c0f9c8f982c2c41896e09f435b4f23">rte_acl_add_rules</a>(ctx, (<span class="keyword">const</span> <span class="keyword">struct</span> rte_acl_rule *)rules,</div>
<div class="line">                rules_nb) &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;add rules failed\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Perform builds */</span></div>
<div class="line">    memset(&amp;acl_build_param, 0, <span class="keyword">sizeof</span>(acl_build_param));</div>
<div class="line"> </div>
<div class="line">    acl_build_param.num_categories = DEFAULT_MAX_CATEGORIES;</div>
<div class="line">    acl_build_param.num_fields = <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(ip6_defs);</div>
<div class="line">    memcpy(&amp;acl_build_param.defs, ip6_defs, <span class="keyword">sizeof</span>(ip6_defs));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a12"></a><a class="code" href="rte__acl_8h.html#aecb4409451df7950758380aee7c43479">rte_acl_build</a>(ctx, &amp;acl_build_param) != 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Failed to build ACL trie\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <a name="a13"></a><a class="code" href="rte__acl_8h.html#a33b5b259f43c5eb3c55e13e548b4998c">rte_acl_dump</a>(ctx);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> ctx;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * check that for each rule it&#39;s SPI has a correspondent entry in SAD</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">check_spi_value(<span class="keyword">struct</span> sa_ctx *sa_ctx, <span class="keywordtype">int</span> inbound)</div>
<div class="line">{</div>
<div class="line">    uint32_t i, num, spi;</div>
<div class="line">    int32_t spi_idx;</div>
<div class="line">    <span class="keyword">struct </span>acl6_rules *acr;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (inbound != 0) {</div>
<div class="line">        acr = acl6_rules_in;</div>
<div class="line">        num = nb_acl6_rules_in;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        acr = acl6_rules_out;</div>
<div class="line">        num = nb_acl6_rules_out;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i != num; i++) {</div>
<div class="line">        spi = acr[i].data.userdata;</div>
<div class="line">        <span class="keywordflow">if</span> (spi != DISCARD &amp;&amp; spi != BYPASS) {</div>
<div class="line">            spi_idx = sa_spi_present(sa_ctx, spi, inbound);</div>
<div class="line">            <span class="keywordflow">if</span> (spi_idx &lt; 0) {</div>
<div class="line">                <a name="a14"></a><a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, IPSEC,</div>
<div class="line">                    <span class="stringliteral">&quot;SPI %u is not present in SAD\n&quot;</span>,</div>
<div class="line">                    spi);</div>
<div class="line">                <span class="keywordflow">return</span> -ENOENT;</div>
<div class="line">            }</div>
<div class="line">            <span class="comment">/* Update userdata with spi index */</span></div>
<div class="line">            acr[i].data.userdata = spi_idx + 1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">sp6_init(<span class="keyword">struct</span> socket_ctx *ctx, int32_t socket_id)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *name;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (ctx == NULL)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;NULL context.\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (ctx-&gt;sp_ip6_in != NULL)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Inbound IPv6 SP DB for socket %u &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;already initialized\n&quot;</span>, socket_id);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (ctx-&gt;sp_ip6_out != NULL)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Outbound IPv6 SP DB for socket %u &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;already initialized\n&quot;</span>, socket_id);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (check_spi_value(ctx-&gt;sa_in, 1) &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">            <span class="stringliteral">&quot;Inbound IPv6 SP DB has unmatched in SAD SPIs\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (check_spi_value(ctx-&gt;sa_out, 0) &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">            <span class="stringliteral">&quot;Outbound IPv6 SP DB has unmatched in SAD SPIs\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (nb_acl6_rules_in &gt; 0) {</div>
<div class="line">        name = <span class="stringliteral">&quot;sp_ip6_in&quot;</span>;</div>
<div class="line">        ctx-&gt;sp_ip6_in = (<span class="keyword">struct </span>sp_ctx *)acl6_init(name,</div>
<div class="line">            socket_id, acl6_rules_in, nb_acl6_rules_in);</div>
<div class="line">    } <span class="keywordflow">else</span></div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(WARNING, IPSEC, <span class="stringliteral">&quot;No IPv6 SP Inbound rule &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;specified\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (nb_acl6_rules_out &gt; 0) {</div>
<div class="line">        name = <span class="stringliteral">&quot;sp_ip6_out&quot;</span>;</div>
<div class="line">        ctx-&gt;sp_ip6_out = (<span class="keyword">struct </span>sp_ctx *)acl6_init(name,</div>
<div class="line">            socket_id, acl6_rules_out, nb_acl6_rules_out);</div>
<div class="line">    } <span class="keywordflow">else</span></div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(WARNING, IPSEC, <span class="stringliteral">&quot;No IPv6 SP Outbound rule &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;specified\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">sp_cmp(<span class="keyword">const</span> <span class="keywordtype">void</span> *p, <span class="keyword">const</span> <span class="keywordtype">void</span> *q)</div>
<div class="line">{</div>
<div class="line">    uint32_t spi1 = ((<span class="keyword">const</span> <span class="keyword">struct </span>acl6_rules *)p)-&gt;data.userdata;</div>
<div class="line">    uint32_t spi2 = ((<span class="keyword">const</span> <span class="keyword">struct </span>acl6_rules *)q)-&gt;data.userdata;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)(spi1 - spi2);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Search though SP rules for given SPI.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">sp6_spi_present(uint32_t spi, <span class="keywordtype">int</span> inbound, <span class="keyword">struct</span> ip_addr ip_addr[2],</div>
<div class="line">            uint32_t mask[2])</div>
<div class="line">{</div>
<div class="line">    uint32_t num;</div>
<div class="line">    <span class="keyword">struct </span>acl6_rules *rule;</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">struct </span>acl6_rules *acr;</div>
<div class="line">    <span class="keyword">struct </span>acl6_rules tmpl;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (inbound != 0) {</div>
<div class="line">        acr = acl6_rules_in;</div>
<div class="line">        num = nb_acl6_rules_in;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        acr = acl6_rules_out;</div>
<div class="line">        num = nb_acl6_rules_out;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    tmpl.data.userdata = spi;</div>
<div class="line"> </div>
<div class="line">    rule = bsearch(&amp;tmpl, acr, num, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> acl6_rules), sp_cmp);</div>
<div class="line">    <span class="keywordflow">if</span> (rule != NULL) {</div>
<div class="line">        <span class="keywordflow">if</span> (NULL != ip_addr &amp;&amp; NULL != mask) {</div>
<div class="line">            IPV6_SRC_FROM_SP(ip_addr[0], *rule);</div>
<div class="line">            IPV6_DST_FROM_SP(ip_addr[1], *rule);</div>
<div class="line">            IPV6_SRC_MASK_FROM_SP(mask[0], *rule);</div>
<div class="line">            IPV6_DST_MASK_FROM_SP(mask[1], *rule);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span> <a name="a15"></a><a class="code" href="rte__common_8h.html#a59dd2418e7278f66471590e1fc8aa3cf">RTE_PTR_DIFF</a>(rule, acr) / <span class="keyword">sizeof</span>(<span class="keyword">struct </span>acl6_rules);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> -ENOENT;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">sp6_sort_arr(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    qsort(acl6_rules_in, nb_acl6_rules_in, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> acl6_rules),</div>
<div class="line">        sp_cmp);</div>
<div class="line">    qsort(acl6_rules_out, nb_acl6_rules_out, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> acl6_rules),</div>
<div class="line">        sp_cmp);</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<div class="ttc" id="arte__acl_8h_html_a54c0f9c8f982c2c41896e09f435b4f23"><div class="ttname"><a href="rte__acl_8h.html#a54c0f9c8f982c2c41896e09f435b4f23">rte_acl_add_rules</a></div><div class="ttdeci">int rte_acl_add_rules(struct rte_acl_ctx *ctx, const struct rte_acl_rule *rules, uint32_t num)</div></div>
<div class="ttc" id="astructrte__acl__field__def_html"><div class="ttname"><a href="structrte__acl__field__def.html">rte_acl_field_def</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__acl_8h_source.html#l00051">rte_acl.h:51</a></div></div>
<div class="ttc" id="astructrte__acl__field__def_html_a894bdfa2d603d8343f8ef01dda6fcd23"><div class="ttname"><a href="structrte__acl__field__def.html#a894bdfa2d603d8343f8ef01dda6fcd23">rte_acl_field_def::offset</a></div><div class="ttdeci">uint32_t offset</div><div class="ttdef"><b>Definition:</b> <a href="rte__acl_8h_source.html#l00056">rte_acl.h:56</a></div></div>
<div class="ttc" id="arte__acl_8h_html"><div class="ttname"><a href="rte__acl_8h.html">rte_acl.h</a></div></div>
<div class="ttc" id="arte__acl_8h_html_ae5ab707258c6c9fbe28832902cbacf1c"><div class="ttname"><a href="rte__acl_8h.html#ae5ab707258c6c9fbe28832902cbacf1c">RTE_ACL_RULE_DEF</a></div><div class="ttdeci">#define RTE_ACL_RULE_DEF(name, fld_num)</div><div class="ttdef"><b>Definition:</b> <a href="rte__acl_8h_source.html#l00111">rte_acl.h:111</a></div></div>
<div class="ttc" id="astructrte__acl__field__def_html_a1d127017fb298b889f4ba24752d08b8e"><div class="ttname"><a href="structrte__acl__field__def.html#a1d127017fb298b889f4ba24752d08b8e">rte_acl_field_def::type</a></div><div class="ttdeci">uint8_t type</div><div class="ttdef"><b>Definition:</b> <a href="rte__acl_8h_source.html#l00052">rte_acl.h:52</a></div></div>
<div class="ttc" id="astructrte__acl__field__def_html_a92f339699e74f468bf5355e4d76f6a79"><div class="ttname"><a href="structrte__acl__field__def.html#a92f339699e74f468bf5355e4d76f6a79">rte_acl_field_def::input_index</a></div><div class="ttdeci">uint8_t input_index</div><div class="ttdef"><b>Definition:</b> <a href="rte__acl_8h_source.html#l00055">rte_acl.h:55</a></div></div>
<div class="ttc" id="arte__common_8h_html_ac5169870c983b3463cb226bdb8a94880"><div class="ttname"><a href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a></div><div class="ttdeci">__rte_noreturn void rte_exit(int exit_code, const char *format,...) __rte_format_printf(2</div></div>
<div class="ttc" id="arte__ip_8h_html"><div class="ttname"><a href="rte__ip_8h.html">rte_ip.h</a></div></div>
<div class="ttc" id="astructrte__acl__param_html"><div class="ttname"><a href="structrte__acl__param.html">rte_acl_param</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__acl_8h_source.html#l00128">rte_acl.h:128</a></div></div>
<div class="ttc" id="arte__common_8h_html_ac963da91b35efa4700b73a1f4eb1d8a6"><div class="ttname"><a href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a></div><div class="ttdeci">#define RTE_DIM(a)</div><div class="ttdef"><b>Definition:</b> <a href="rte__common_8h_source.html#l00809">rte_common.h:809</a></div></div>
<div class="ttc" id="arte__common_8h_html_a59dd2418e7278f66471590e1fc8aa3cf"><div class="ttname"><a href="rte__common_8h.html#a59dd2418e7278f66471590e1fc8aa3cf">RTE_PTR_DIFF</a></div><div class="ttdeci">#define RTE_PTR_DIFF(ptr1, ptr2)</div><div class="ttdef"><b>Definition:</b> <a href="rte__common_8h_source.html#l00260">rte_common.h:260</a></div></div>
<div class="ttc" id="arte__acl_8h_html_a33b5b259f43c5eb3c55e13e548b4998c"><div class="ttname"><a href="rte__acl_8h.html#a33b5b259f43c5eb3c55e13e548b4998c">rte_acl_dump</a></div><div class="ttdeci">void rte_acl_dump(const struct rte_acl_ctx *ctx)</div></div>
<div class="ttc" id="astructrte__acl__config_html"><div class="ttname"><a href="structrte__acl__config.html">rte_acl_config</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__acl_8h_source.html#l00063">rte_acl.h:63</a></div></div>
<div class="ttc" id="arte__log_8h_html_ac23caeb9833fd0fd0665c6c05ec806fe"><div class="ttname"><a href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a></div><div class="ttdeci">#define RTE_LOG(l, t,...)</div><div class="ttdef"><b>Definition:</b> <a href="rte__log_8h_source.html#l00331">rte_log.h:331</a></div></div>
<div class="ttc" id="arte__acl_8h_html_af230a8bd56f72b86af5e99375fb75313"><div class="ttname"><a href="rte__acl_8h.html#af230a8bd56f72b86af5e99375fb75313">rte_acl_create</a></div><div class="ttdeci">struct rte_acl_ctx * rte_acl_create(const struct rte_acl_param *param)</div></div>
<div class="ttc" id="astructrte__acl__field__def_html_aa63bd1fe49046f2c9ef0478a050b7c3a"><div class="ttname"><a href="structrte__acl__field__def.html#aa63bd1fe49046f2c9ef0478a050b7c3a">rte_acl_field_def::field_index</a></div><div class="ttdeci">uint8_t field_index</div><div class="ttdef"><b>Definition:</b> <a href="rte__acl_8h_source.html#l00054">rte_acl.h:54</a></div></div>
<div class="ttc" id="arte__acl_8h_html_aecb4409451df7950758380aee7c43479"><div class="ttname"><a href="rte__acl_8h.html#aecb4409451df7950758380aee7c43479">rte_acl_build</a></div><div class="ttdeci">int rte_acl_build(struct rte_acl_ctx *ctx, const struct rte_acl_config *cfg)</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20
</small></address>
</body>
</html>
