<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DPDK: examples/vhost_blk/vhost_blk.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">20.11.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">examples/vhost_blk/vhost_blk.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/* SPDX-License-Identifier: BSD-3-Clause</span></div>
<div class="line"><span class="comment"> * Copyright(c) 2010-2019 Intel Corporation</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifndef _GNU_SOURCE</span></div>
<div class="line"><span class="preprocessor">#define _GNU_SOURCE</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#include &lt;pthread.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sched.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdbool.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;assert.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;semaphore.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/virtio_blk.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;linux/virtio_ring.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__atomic_8h.html">rte_atomic.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__cycles_8h.html">rte_cycles.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__log_8h.html">rte_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__malloc_8h.html">rte_malloc.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__vhost_8h.html">rte_vhost.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;vhost_blk.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;blk_spec.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define VIRTQ_DESC_F_NEXT   1</span></div>
<div class="line"><span class="preprocessor">#define VIRTQ_DESC_F_AVAIL  (1 &lt;&lt; 7)</span></div>
<div class="line"><span class="preprocessor">#define VIRTQ_DESC_F_USED   (1 &lt;&lt; 15)</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define MAX_TASK        12</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define VHOST_BLK_FEATURES ((1ULL &lt;&lt; VIRTIO_F_RING_PACKED) | \</span></div>
<div class="line"><span class="preprocessor">                (1ULL &lt;&lt; VIRTIO_F_VERSION_1) |\</span></div>
<div class="line"><span class="preprocessor">                (1ULL &lt;&lt; VIRTIO_F_NOTIFY_ON_EMPTY) | \</span></div>
<div class="line"><span class="preprocessor">                (1ULL &lt;&lt; VHOST_USER_F_PROTOCOL_FEATURES))</span></div>
<div class="line"><span class="preprocessor">#define CTRLR_NAME      &quot;vhost.socket&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">enum</span> CTRLR_WORKER_STATUS {</div>
<div class="line">    WORKER_STATE_START = 0,</div>
<div class="line">    WORKER_STATE_STOP,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>vhost_blk_ctrlr *g_vhost_ctrlr;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Path to folder where character device will be created. Can be set by user. */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> dev_pathname[PATH_MAX] = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"><span class="keyword">static</span> sem_t exit_sem;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">enum</span> CTRLR_WORKER_STATUS worker_thread_status;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>vhost_blk_ctrlr *</div>
<div class="line">vhost_blk_ctrlr_find(<span class="keyword">const</span> <span class="keywordtype">char</span> *ctrlr_name)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (ctrlr_name == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* currently we only support 1 socket file fd */</span></div>
<div class="line">    <span class="keywordflow">return</span> g_vhost_ctrlr;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> uint64_t</div>
<div class="line">gpa_to_vva(<span class="keyword">struct</span> vhost_blk_ctrlr *ctrlr, uint64_t gpa, uint64_t *len)</div>
<div class="line">{</div>
<div class="line">    assert(ctrlr-&gt;mem != NULL);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <a name="a0"></a><a class="code" href="rte__vhost_8h.html#a2deb7d5116b92a1cc150c11e306fad98">rte_vhost_va_from_guest_pa</a>(ctrlr-&gt;mem, gpa, len);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">enqueue_task(<span class="keyword">struct</span> vhost_blk_task *task)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>vhost_blk_queue *vq = task-&gt;vq;</div>
<div class="line">    <span class="keyword">struct </span>vring_used *used = vq-&gt;vring.used;</div>
<div class="line"> </div>
<div class="line">    <a name="a1"></a><a class="code" href="rte__vhost_8h.html#a6b3d18ab95a9baf4a9412c2f442777f2">rte_vhost_set_last_inflight_io_split</a>(task-&gt;ctrlr-&gt;vid,</div>
<div class="line">        vq-&gt;id, task-&gt;req_idx);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Fill out the next entry in the &quot;used&quot; ring.  id = the</span></div>
<div class="line"><span class="comment">     * index of the descriptor that contained the blk request.</span></div>
<div class="line"><span class="comment">     * len = the total amount of data transferred for the blk</span></div>
<div class="line"><span class="comment">     * request. We must report the correct len, for variable</span></div>
<div class="line"><span class="comment">     * length blk CDBs, where we may return less data than</span></div>
<div class="line"><span class="comment">     * allocated by the guest VM.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    used-&gt;ring[used-&gt;idx &amp; (vq-&gt;vring.size - 1)].<span class="keywordtype">id</span> = task-&gt;req_idx;</div>
<div class="line">    used-&gt;ring[used-&gt;idx &amp; (vq-&gt;vring.size - 1)].len = task-&gt;data_len;</div>
<div class="line">    <a name="a2"></a><a class="code" href="rte__atomic_8h.html#a4873ae3c74d0834a07022261b849b058">rte_smp_mb</a>();</div>
<div class="line">    used-&gt;idx++;</div>
<div class="line">    <a class="code" href="rte__atomic_8h.html#a4873ae3c74d0834a07022261b849b058">rte_smp_mb</a>();</div>
<div class="line"> </div>
<div class="line">    <a name="a3"></a><a class="code" href="rte__vhost_8h.html#adbbd575a762c2c82eea09f718427d45f">rte_vhost_clr_inflight_desc_split</a>(task-&gt;ctrlr-&gt;vid,</div>
<div class="line">        vq-&gt;id, used-&gt;idx, task-&gt;req_idx);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Send an interrupt back to the guest VM so that it knows</span></div>
<div class="line"><span class="comment">     * a completion is ready to be processed.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <a name="a4"></a><a class="code" href="rte__vhost_8h.html#aa2e00d8df9ee6d508aea6f807d0c09f3">rte_vhost_vring_call</a>(task-&gt;ctrlr-&gt;vid, vq-&gt;id);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">enqueue_task_packed(<span class="keyword">struct</span> vhost_blk_task *task)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>vhost_blk_queue *vq = task-&gt;vq;</div>
<div class="line">    <span class="keyword">struct </span>vring_packed_desc *desc;</div>
<div class="line"> </div>
<div class="line">    <a name="a5"></a><a class="code" href="rte__vhost_8h.html#a33071190516d5aca5eaa61638b5697cf">rte_vhost_set_last_inflight_io_packed</a>(task-&gt;ctrlr-&gt;vid, vq-&gt;id,</div>
<div class="line">                        task-&gt;inflight_idx);</div>
<div class="line"> </div>
<div class="line">    desc = &amp;vq-&gt;vring.desc_packed[vq-&gt;last_used_idx];</div>
<div class="line">    desc-&gt;id = task-&gt;buffer_id;</div>
<div class="line">    desc-&gt;addr = 0;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="rte__atomic_8h.html#a4873ae3c74d0834a07022261b849b058">rte_smp_mb</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (vq-&gt;used_wrap_counter)</div>
<div class="line">        desc-&gt;flags |= VIRTQ_DESC_F_AVAIL | VIRTQ_DESC_F_USED;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        desc-&gt;flags &amp;= ~(VIRTQ_DESC_F_AVAIL | VIRTQ_DESC_F_USED);</div>
<div class="line">    <a class="code" href="rte__atomic_8h.html#a4873ae3c74d0834a07022261b849b058">rte_smp_mb</a>();</div>
<div class="line"> </div>
<div class="line">    <a name="a6"></a><a class="code" href="rte__vhost_8h.html#adce528fcfffa73ab4cbc4e3f5473ff97">rte_vhost_clr_inflight_desc_packed</a>(task-&gt;ctrlr-&gt;vid, vq-&gt;id,</div>
<div class="line">                       task-&gt;inflight_idx);</div>
<div class="line"> </div>
<div class="line">    vq-&gt;last_used_idx += task-&gt;chain_num;</div>
<div class="line">    <span class="keywordflow">if</span> (vq-&gt;last_used_idx &gt;= vq-&gt;vring.size) {</div>
<div class="line">        vq-&gt;last_used_idx -= vq-&gt;vring.size;</div>
<div class="line">        vq-&gt;used_wrap_counter = !vq-&gt;used_wrap_counter;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Send an interrupt back to the guest VM so that it knows</span></div>
<div class="line"><span class="comment">     * a completion is ready to be processed.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <a class="code" href="rte__vhost_8h.html#aa2e00d8df9ee6d508aea6f807d0c09f3">rte_vhost_vring_call</a>(task-&gt;ctrlr-&gt;vid, vq-&gt;id);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span></div>
<div class="line">descriptor_has_next_packed(<span class="keyword">struct</span> vring_packed_desc *cur_desc)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> !!(cur_desc-&gt;flags &amp; VRING_DESC_F_NEXT);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span></div>
<div class="line">descriptor_has_next_split(<span class="keyword">struct</span> vring_desc *cur_desc)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> !!(cur_desc-&gt;flags &amp; VRING_DESC_F_NEXT);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">desc_payload_to_iovs(<span class="keyword">struct</span> vhost_blk_ctrlr *ctrlr, <span class="keyword">struct</span> iovec *iovs,</div>
<div class="line">             uint32_t *iov_index, uintptr_t payload, uint64_t remaining)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">void</span> *vva;</div>
<div class="line">    uint64_t len;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">do</span> {</div>
<div class="line">        <span class="keywordflow">if</span> (*iov_index &gt;= VHOST_BLK_MAX_IOVS) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;VHOST_BLK_MAX_IOVS reached\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">        len = remaining;</div>
<div class="line">        vva = (<span class="keywordtype">void</span> *)(uintptr_t)gpa_to_vva(ctrlr,</div>
<div class="line">                 payload, &amp;len);</div>
<div class="line">        <span class="keywordflow">if</span> (!vva || !len) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;failed to translate desc address.\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        iovs[*iov_index].iov_base = vva;</div>
<div class="line">        iovs[*iov_index].iov_len = len;</div>
<div class="line">        payload += len;</div>
<div class="line">        remaining -= len;</div>
<div class="line">        (*iov_index)++;</div>
<div class="line">    } <span class="keywordflow">while</span> (remaining);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>vring_desc *</div>
<div class="line">vring_get_next_desc(<span class="keyword">struct</span> vhost_blk_queue *vq, <span class="keyword">struct</span> vring_desc *desc)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (descriptor_has_next_split(desc))</div>
<div class="line">        <span class="keywordflow">return</span> &amp;vq-&gt;vring.desc[desc-&gt;next];</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>vring_packed_desc *</div>
<div class="line">vring_get_next_desc_packed(<span class="keyword">struct</span> vhost_blk_queue *vq, uint16_t *req_idx)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (descriptor_has_next_packed(&amp;vq-&gt;vring.desc_packed[*req_idx])) {</div>
<div class="line">        *req_idx = (*req_idx + 1) % vq-&gt;vring.size;</div>
<div class="line">        <span class="keywordflow">return</span> &amp;vq-&gt;vring.desc_packed[*req_idx];</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>rte_vhost_inflight_desc_packed *</div>
<div class="line">vring_get_next_inflight_desc(<span class="keyword">struct</span> vhost_blk_queue *vq,</div>
<div class="line">            <span class="keyword">struct</span> rte_vhost_inflight_desc_packed *desc)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!!(desc-&gt;flags &amp; VRING_DESC_F_NEXT))</div>
<div class="line">        <span class="keywordflow">return</span> &amp;vq-&gt;inflight_ring.inflight_packed-&gt;desc[desc-&gt;next];</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">setup_iovs_from_descs_split(<span class="keyword">struct</span> vhost_blk_ctrlr *ctrlr,</div>
<div class="line">                <span class="keyword">struct</span> vhost_blk_queue *vq, uint16_t req_idx,</div>
<div class="line">                <span class="keyword">struct</span> iovec *iovs, uint32_t *iovs_idx,</div>
<div class="line">                uint32_t *payload)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>vring_desc *desc = &amp;vq-&gt;vring.desc[req_idx];</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">do</span> {</div>
<div class="line">        <span class="comment">/* does not support indirect descriptors */</span></div>
<div class="line">        assert((desc-&gt;flags &amp; VRING_DESC_F_INDIRECT) == 0);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (*iovs_idx &gt;= VHOST_BLK_MAX_IOVS) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Reach VHOST_BLK_MAX_IOVS\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (desc_payload_to_iovs(ctrlr, iovs, iovs_idx,</div>
<div class="line">            desc-&gt;addr, desc-&gt;len) != 0) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Failed to convert desc payload to iovs\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        *payload += desc-&gt;len;</div>
<div class="line"> </div>
<div class="line">        desc = vring_get_next_desc(vq, desc);</div>
<div class="line">    } <span class="keywordflow">while</span> (desc != NULL);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">setup_iovs_from_descs_packed(<span class="keyword">struct</span> vhost_blk_ctrlr *ctrlr,</div>
<div class="line">                 <span class="keyword">struct</span> vhost_blk_queue *vq, uint16_t req_idx,</div>
<div class="line">                 <span class="keyword">struct</span> iovec *iovs, uint32_t *iovs_idx,</div>
<div class="line">                 uint32_t *payload)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>vring_packed_desc *desc = &amp;vq-&gt;vring.desc_packed[req_idx];</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">do</span> {</div>
<div class="line">        <span class="comment">/* does not support indirect descriptors */</span></div>
<div class="line">        assert((desc-&gt;flags &amp; VRING_DESC_F_INDIRECT) == 0);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (*iovs_idx &gt;= VHOST_BLK_MAX_IOVS) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Reach VHOST_BLK_MAX_IOVS\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (desc_payload_to_iovs(ctrlr, iovs, iovs_idx,</div>
<div class="line">            desc-&gt;addr, desc-&gt;len) != 0) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Failed to convert desc payload to iovs\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        *payload += desc-&gt;len;</div>
<div class="line"> </div>
<div class="line">        desc = vring_get_next_desc_packed(vq, &amp;req_idx);</div>
<div class="line">    } <span class="keywordflow">while</span> (desc != NULL);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">setup_iovs_from_inflight_desc(<span class="keyword">struct</span> vhost_blk_ctrlr *ctrlr,</div>
<div class="line">                  <span class="keyword">struct</span> vhost_blk_queue *vq, uint16_t req_idx,</div>
<div class="line">                  <span class="keyword">struct</span> iovec *iovs, uint32_t *iovs_idx,</div>
<div class="line">                  uint32_t *payload)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>rte_vhost_ring_inflight *inflight_vq;</div>
<div class="line">    <span class="keyword">struct </span>rte_vhost_inflight_desc_packed *desc;</div>
<div class="line"> </div>
<div class="line">    inflight_vq = &amp;vq-&gt;inflight_ring;</div>
<div class="line">    desc = &amp;inflight_vq-&gt;inflight_packed-&gt;desc[req_idx];</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">do</span> {</div>
<div class="line">        <span class="comment">/* does not support indirect descriptors */</span></div>
<div class="line">        assert((desc-&gt;flags &amp; VRING_DESC_F_INDIRECT) == 0);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (*iovs_idx &gt;= VHOST_BLK_MAX_IOVS) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Reach VHOST_BLK_MAX_IOVS\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (desc_payload_to_iovs(ctrlr, iovs, iovs_idx,</div>
<div class="line">            desc-&gt;addr, desc-&gt;len) != 0) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Failed to convert desc payload to iovs\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        *payload += desc-&gt;len;</div>
<div class="line"> </div>
<div class="line">        desc = vring_get_next_inflight_desc(vq, desc);</div>
<div class="line">    } <span class="keywordflow">while</span> (desc != NULL);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">process_blk_task(<span class="keyword">struct</span> vhost_blk_task *task)</div>
<div class="line">{</div>
<div class="line">    uint32_t payload = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (task-&gt;vq-&gt;packed_ring) {</div>
<div class="line">        <span class="keyword">struct </span>rte_vhost_ring_inflight *inflight_ring;</div>
<div class="line">        <span class="keyword">struct </span>rte_vhost_resubmit_info *resubmit_inflight;</div>
<div class="line"> </div>
<div class="line">        inflight_ring = &amp;task-&gt;vq-&gt;inflight_ring;</div>
<div class="line">        resubmit_inflight = inflight_ring-&gt;resubmit_inflight;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (resubmit_inflight != NULL &amp;&amp;</div>
<div class="line">            resubmit_inflight-&gt;resubmit_list != NULL) {</div>
<div class="line">            <span class="keywordflow">if</span> (setup_iovs_from_inflight_desc(task-&gt;ctrlr, task-&gt;vq,</div>
<div class="line">                task-&gt;req_idx, task-&gt;iovs, &amp;task-&gt;iovs_cnt,</div>
<div class="line">                &amp;payload)) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;Failed to setup iovs\n&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            <span class="keywordflow">if</span> (setup_iovs_from_descs_packed(task-&gt;ctrlr, task-&gt;vq,</div>
<div class="line">                task-&gt;req_idx, task-&gt;iovs, &amp;task-&gt;iovs_cnt,</div>
<div class="line">                &amp;payload)) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;Failed to setup iovs\n&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="keywordflow">if</span> (setup_iovs_from_descs_split(task-&gt;ctrlr, task-&gt;vq,</div>
<div class="line">            task-&gt;req_idx, task-&gt;iovs, &amp;task-&gt;iovs_cnt, &amp;payload)) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Failed to setup iovs\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* First IOV must be the req head. */</span></div>
<div class="line">    task-&gt;req = (<span class="keyword">struct </span>virtio_blk_outhdr *)task-&gt;iovs[0].iov_base;</div>
<div class="line">    assert(<span class="keyword">sizeof</span>(*task-&gt;req) == task-&gt;iovs[0].iov_len);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Last IOV must be the status tail. */</span></div>
<div class="line">    task-&gt;status = (uint8_t *)task-&gt;iovs[task-&gt;iovs_cnt - 1].iov_base;</div>
<div class="line">    assert(<span class="keyword">sizeof</span>(*task-&gt;status) == task-&gt;iovs[task-&gt;iovs_cnt - 1].iov_len);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Transport data len */</span></div>
<div class="line">    task-&gt;data_len = payload - task-&gt;iovs[0].iov_len -</div>
<div class="line">        task-&gt;iovs[task-&gt;iovs_cnt - 1].iov_len;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (vhost_bdev_process_blk_commands(task-&gt;ctrlr-&gt;bdev, task))</div>
<div class="line">        <span class="comment">/* invalid response */</span></div>
<div class="line">        *task-&gt;status = VIRTIO_BLK_S_IOERR;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <span class="comment">/* successfully */</span></div>
<div class="line">        *task-&gt;status = VIRTIO_BLK_S_OK;</div>
<div class="line"> </div>
<div class="line">    if (task-&gt;vq-&gt;packed_ring)</div>
<div class="line">        enqueue_task_packed(task);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        enqueue_task(task);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">blk_task_init(<span class="keyword">struct</span> vhost_blk_task *task)</div>
<div class="line">{</div>
<div class="line">    task-&gt;iovs_cnt = 0;</div>
<div class="line">    task-&gt;data_len = 0;</div>
<div class="line">    task-&gt;req = NULL;</div>
<div class="line">    task-&gt;status = NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">submit_inflight_vq(<span class="keyword">struct</span> vhost_blk_queue *vq)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>rte_vhost_ring_inflight *inflight_ring;</div>
<div class="line">    <span class="keyword">struct </span>rte_vhost_resubmit_info *resubmit_inflight;</div>
<div class="line">    <span class="keyword">struct </span>vhost_blk_task *task;</div>
<div class="line"> </div>
<div class="line">    inflight_ring = &amp;vq-&gt;inflight_ring;</div>
<div class="line">    resubmit_inflight = inflight_ring-&gt;resubmit_inflight;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (resubmit_inflight == NULL ||</div>
<div class="line">        resubmit_inflight-&gt;resubmit_num == 0)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    fprintf(stdout, <span class="stringliteral">&quot;Resubmit inflight num is %d\n&quot;</span>,</div>
<div class="line">        resubmit_inflight-&gt;resubmit_num);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (resubmit_inflight-&gt;resubmit_num-- &gt; 0) {</div>
<div class="line">        uint16_t desc_idx;</div>
<div class="line"> </div>
<div class="line">        desc_idx = resubmit_inflight-&gt;resubmit_list[</div>
<div class="line">                    resubmit_inflight-&gt;resubmit_num].index;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (vq-&gt;packed_ring) {</div>
<div class="line">            uint16_t task_idx;</div>
<div class="line">            <span class="keyword">struct </span>rte_vhost_inflight_desc_packed *desc;</div>
<div class="line"> </div>
<div class="line">            desc = inflight_ring-&gt;inflight_packed-&gt;desc;</div>
<div class="line">            task_idx = desc[desc[desc_idx].last].id;</div>
<div class="line">            task = &amp;vq-&gt;tasks[task_idx];</div>
<div class="line"> </div>
<div class="line">            task-&gt;req_idx = desc_idx;</div>
<div class="line">            task-&gt;chain_num = desc[desc_idx].num;</div>
<div class="line">            task-&gt;buffer_id = task_idx;</div>
<div class="line">            task-&gt;inflight_idx = desc_idx;</div>
<div class="line"> </div>
<div class="line">            vq-&gt;last_avail_idx += desc[desc_idx].num;</div>
<div class="line">            <span class="keywordflow">if</span> (vq-&gt;last_avail_idx &gt;= vq-&gt;vring.size) {</div>
<div class="line">                vq-&gt;last_avail_idx -= vq-&gt;vring.size;</div>
<div class="line">                vq-&gt;avail_wrap_counter =</div>
<div class="line">                    !vq-&gt;avail_wrap_counter;</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span></div>
<div class="line">            <span class="comment">/* In split ring, the desc_idx is the req_id</span></div>
<div class="line"><span class="comment">             * which was initialized when allocated the task pool.</span></div>
<div class="line"><span class="comment">             */</span></div>
<div class="line">            task = &amp;vq-&gt;tasks[desc_idx];</div>
<div class="line"> </div>
<div class="line">        blk_task_init(task);</div>
<div class="line">        process_blk_task(task);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    free(resubmit_inflight-&gt;resubmit_list);</div>
<div class="line">    resubmit_inflight-&gt;resubmit_list = NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Use the buffer_id as the task_idx */</span></div>
<div class="line"><span class="keyword">static</span> uint16_t</div>
<div class="line">vhost_blk_vq_get_desc_chain_buffer_id(<span class="keyword">struct</span> vhost_blk_queue *vq,</div>
<div class="line">                      uint16_t *req_head, uint16_t *num)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>vring_packed_desc *desc = &amp;vq-&gt;vring.desc_packed[</div>
<div class="line">                        vq-&gt;last_avail_idx];</div>
<div class="line"> </div>
<div class="line">    *req_head = vq-&gt;last_avail_idx;</div>
<div class="line">    *num = 1;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (descriptor_has_next_packed(desc)) {</div>
<div class="line">        vq-&gt;last_avail_idx = (vq-&gt;last_avail_idx + 1) % vq-&gt;vring.size;</div>
<div class="line">        desc = &amp;vq-&gt;vring.desc_packed[vq-&gt;last_avail_idx];</div>
<div class="line">        *num += 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Point to next desc */</span></div>
<div class="line">    vq-&gt;last_avail_idx = (vq-&gt;last_avail_idx + 1) % vq-&gt;vring.size;</div>
<div class="line">    if (vq-&gt;last_avail_idx &lt; *req_head)</div>
<div class="line">        vq-&gt;avail_wrap_counter = !vq-&gt;avail_wrap_counter;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> desc-&gt;id;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> uint16_t</div>
<div class="line">vq_get_desc_idx(<span class="keyword">struct</span> vhost_blk_queue *vq)</div>
<div class="line">{</div>
<div class="line">    uint16_t desc_idx;</div>
<div class="line">    uint16_t last_avail_idx;</div>
<div class="line"> </div>
<div class="line">    last_avail_idx = vq-&gt;last_avail_idx &amp; (vq-&gt;vring.size - 1);</div>
<div class="line">    desc_idx = vq-&gt;vring.avail-&gt;ring[last_avail_idx];</div>
<div class="line">    vq-&gt;last_avail_idx++;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> desc_idx;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">vhost_blk_vq_is_avail(<span class="keyword">struct</span> vhost_blk_queue *vq)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (vq-&gt;packed_ring) {</div>
<div class="line">        uint16_t flags = vq-&gt;vring.desc_packed[</div>
<div class="line">                    vq-&gt;last_avail_idx].flags;</div>
<div class="line">        <span class="keywordtype">bool</span> avail_wrap_counter = vq-&gt;avail_wrap_counter;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> (!!(flags &amp; VIRTQ_DESC_F_AVAIL) == avail_wrap_counter &amp;&amp;</div>
<div class="line">            !!(flags &amp; VIRTQ_DESC_F_USED) != avail_wrap_counter);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="keywordflow">if</span> (vq-&gt;vring.avail-&gt;idx != vq-&gt;last_avail_idx)</div>
<div class="line">            <span class="keywordflow">return</span> 1;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">process_vq(<span class="keyword">struct</span> vhost_blk_queue *vq)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>vhost_blk_task *task;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (vq-&gt;packed_ring) {</div>
<div class="line">        <span class="keywordflow">while</span> (vhost_blk_vq_is_avail(vq)) {</div>
<div class="line">            uint16_t task_idx, req_idx, last_idx, chain_num;</div>
<div class="line"> </div>
<div class="line">            task_idx = vhost_blk_vq_get_desc_chain_buffer_id(vq,</div>
<div class="line">                    &amp;req_idx, &amp;chain_num);</div>
<div class="line">            task = &amp;vq-&gt;tasks[task_idx];</div>
<div class="line"> </div>
<div class="line">            blk_task_init(task);</div>
<div class="line">            task-&gt;req_idx = req_idx;</div>
<div class="line">            task-&gt;chain_num = chain_num;</div>
<div class="line">            task-&gt;buffer_id = task_idx;</div>
<div class="line">            last_idx = (req_idx + chain_num - 1) % vq-&gt;vring.size;</div>
<div class="line"> </div>
<div class="line">            <a name="a7"></a><a class="code" href="rte__vhost_8h.html#a155457616d06ca66e9be9095fe366d65">rte_vhost_set_inflight_desc_packed</a>(task-&gt;ctrlr-&gt;vid,</div>
<div class="line">                               vq-&gt;id,</div>
<div class="line">                               task-&gt;req_idx,</div>
<div class="line">                               last_idx,</div>
<div class="line">                               &amp;task-&gt;inflight_idx);</div>
<div class="line"> </div>
<div class="line">            process_blk_task(task);</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="keywordflow">while</span> (vhost_blk_vq_is_avail(vq)) {</div>
<div class="line">            uint16_t desc_idx;</div>
<div class="line"> </div>
<div class="line">            desc_idx = vq_get_desc_idx(vq);</div>
<div class="line">            task = &amp;vq-&gt;tasks[desc_idx];</div>
<div class="line"> </div>
<div class="line">            blk_task_init(task);</div>
<div class="line">            <a name="a8"></a><a class="code" href="rte__vhost_8h.html#a54c0b385ce21f33a84c447fdac4076d9">rte_vhost_set_inflight_desc_split</a>(task-&gt;ctrlr-&gt;vid,</div>
<div class="line">                              vq-&gt;id,</div>
<div class="line">                              task-&gt;req_idx);</div>
<div class="line">            process_blk_task(task);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line">ctrlr_worker(<span class="keywordtype">void</span> *arg)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>vhost_blk_ctrlr *ctrlr = (<span class="keyword">struct </span>vhost_blk_ctrlr *)arg;</div>
<div class="line">    cpu_set_t cpuset;</div>
<div class="line">    pthread_t thread;</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line"> </div>
<div class="line">    fprintf(stdout, <span class="stringliteral">&quot;Ctrlr Worker Thread start\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (ctrlr == NULL || ctrlr-&gt;bdev == NULL) {</div>
<div class="line">        fprintf(stderr,</div>
<div class="line">            <span class="stringliteral">&quot;%s: Error, invalid argument passed to worker thread\n&quot;</span>,</div>
<div class="line">            __func__);</div>
<div class="line">        exit(0);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    thread = pthread_self();</div>
<div class="line">    CPU_ZERO(&amp;cpuset);</div>
<div class="line">    CPU_SET(0, &amp;cpuset);</div>
<div class="line">    pthread_setaffinity_np(thread, <span class="keyword">sizeof</span>(cpu_set_t), &amp;cpuset);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; NUM_OF_BLK_QUEUES; i++)</div>
<div class="line">        submit_inflight_vq(&amp;ctrlr-&gt;queues[i]);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (worker_thread_status != WORKER_STATE_STOP)</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; NUM_OF_BLK_QUEUES; i++)</div>
<div class="line">            process_vq(&amp;ctrlr-&gt;queues[i]);</div>
<div class="line"> </div>
<div class="line">    fprintf(stdout, <span class="stringliteral">&quot;Ctrlr Worker Thread Exiting\n&quot;</span>);</div>
<div class="line">    sem_post(&amp;exit_sem);</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">alloc_task_pool(<span class="keyword">struct</span> vhost_blk_ctrlr *ctrlr)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>vhost_blk_queue *vq;</div>
<div class="line">    <span class="keywordtype">int</span> i, j;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; NUM_OF_BLK_QUEUES; i++) {</div>
<div class="line">        vq = &amp;ctrlr-&gt;queues[i];</div>
<div class="line"> </div>
<div class="line">        vq-&gt;tasks = <a name="a9"></a><a class="code" href="rte__malloc_8h.html#aaf0f048a5fd1672688c662cdfb4536b3">rte_zmalloc</a>(NULL,</div>
<div class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> vhost_blk_task) * vq-&gt;vring.size, 0);</div>
<div class="line">        <span class="keywordflow">if</span> (!vq-&gt;tasks) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Failed to allocate task memory\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (j = 0; j &lt; vq-&gt;vring.size; j++) {</div>
<div class="line">            vq-&gt;tasks[j].req_idx = j;</div>
<div class="line">            vq-&gt;tasks[j].ctrlr = ctrlr;</div>
<div class="line">            vq-&gt;tasks[j].vq = vq;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">free_task_pool(<span class="keyword">struct</span> vhost_blk_ctrlr *ctrlr)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; NUM_OF_BLK_QUEUES; i++)</div>
<div class="line">        <a name="a10"></a><a class="code" href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a>(ctrlr-&gt;queues[i].tasks);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">new_device(<span class="keywordtype">int</span> vid)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>vhost_blk_ctrlr *ctrlr;</div>
<div class="line">    <span class="keyword">struct </span>vhost_blk_queue *vq;</div>
<div class="line">    <span class="keywordtype">char</span> path[PATH_MAX];</div>
<div class="line">    uint64_t features;</div>
<div class="line">    pthread_t tid;</div>
<div class="line">    <span class="keywordtype">int</span> i, ret;</div>
<div class="line">    <span class="keywordtype">bool</span> packed_ring;</div>
<div class="line"> </div>
<div class="line">    ret = <a name="a11"></a><a class="code" href="rte__vhost_8h.html#a16848dac4304c973b24ced868ac3add8">rte_vhost_get_ifname</a>(vid, path, PATH_MAX);</div>
<div class="line">    <span class="keywordflow">if</span> (ret) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Failed to get the socket path\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    ctrlr = vhost_blk_ctrlr_find(path);</div>
<div class="line">    <span class="keywordflow">if</span> (!ctrlr) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Failed to find controller\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (ctrlr-&gt;started)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"> </div>
<div class="line">    ctrlr-&gt;vid = vid;</div>
<div class="line">    ret = <a name="a12"></a><a class="code" href="rte__vhost_8h.html#a1c1fbdab537b4021941bab15e26b21f9">rte_vhost_get_negotiated_features</a>(vid, &amp;features);</div>
<div class="line">    <span class="keywordflow">if</span> (ret) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Failed to get the negotiated features\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    packed_ring = !!(features &amp; (1ULL &lt;&lt; VIRTIO_F_RING_PACKED));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Disable Notifications and init last idx */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; NUM_OF_BLK_QUEUES; i++) {</div>
<div class="line">        vq = &amp;ctrlr-&gt;queues[i];</div>
<div class="line">        vq-&gt;id = i;</div>
<div class="line"> </div>
<div class="line">        assert(<a name="a13"></a><a class="code" href="rte__vhost_8h.html#a5891bd49d76cbe72ecfe2c87fc1fe853">rte_vhost_get_vhost_vring</a>(ctrlr-&gt;vid, i,</div>
<div class="line">                         &amp;vq-&gt;vring) == 0);</div>
<div class="line">        assert(<a name="a14"></a><a class="code" href="rte__vhost_8h.html#a43208ebb5b4b4fad1a7a93333250cf83">rte_vhost_get_vring_base</a>(ctrlr-&gt;vid, i,</div>
<div class="line">                           &amp;vq-&gt;last_avail_idx,</div>
<div class="line">                           &amp;vq-&gt;last_used_idx) == 0);</div>
<div class="line">        assert(<a name="a15"></a><a class="code" href="rte__vhost_8h.html#af2b7b19139cd804f6747ec374475fba3">rte_vhost_get_vhost_ring_inflight</a>(ctrlr-&gt;vid, i,</div>
<div class="line">                        &amp;vq-&gt;inflight_ring) == 0);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (packed_ring) {</div>
<div class="line">            <span class="comment">/* for the reconnection */</span></div>
<div class="line">            assert(<a name="a16"></a><a class="code" href="rte__vhost_8h.html#a44ae1a415495b7e47c27886a40f617f0">rte_vhost_get_vring_base_from_inflight</a>(</div>
<div class="line">                ctrlr-&gt;vid, i,</div>
<div class="line">                &amp;vq-&gt;last_avail_idx,</div>
<div class="line">                &amp;vq-&gt;last_used_idx) == 0);</div>
<div class="line"> </div>
<div class="line">            vq-&gt;avail_wrap_counter = vq-&gt;last_avail_idx &amp;</div>
<div class="line">                (1 &lt;&lt; 15);</div>
<div class="line">            vq-&gt;last_avail_idx = vq-&gt;last_avail_idx &amp;</div>
<div class="line">                0x7fff;</div>
<div class="line">            vq-&gt;used_wrap_counter = vq-&gt;last_used_idx &amp;</div>
<div class="line">                (1 &lt;&lt; 15);</div>
<div class="line">            vq-&gt;last_used_idx = vq-&gt;last_used_idx &amp;</div>
<div class="line">                0x7fff;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        vq-&gt;packed_ring = packed_ring;</div>
<div class="line">        rte_vhost_enable_guest_notification(vid, i, 0);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    assert(<a name="a17"></a><a class="code" href="rte__vhost_8h.html#a398c60c6b04e6eeaa72359b527661bc2">rte_vhost_get_mem_table</a>(vid, &amp;ctrlr-&gt;mem) == 0);</div>
<div class="line">    assert(ctrlr-&gt;mem != NULL);</div>
<div class="line">    assert(alloc_task_pool(ctrlr) == 0);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* start polling vring */</span></div>
<div class="line">    worker_thread_status = WORKER_STATE_START;</div>
<div class="line">    fprintf(stdout, <span class="stringliteral">&quot;New Device %s, Device ID %d\n&quot;</span>, path, vid);</div>
<div class="line">    <span class="keywordflow">if</span> (pthread_create(&amp;tid, NULL, &amp;ctrlr_worker, ctrlr) &lt; 0) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Worker Thread Started Failed\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* device has been started */</span></div>
<div class="line">    ctrlr-&gt;started = 1;</div>
<div class="line">    pthread_detach(tid);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">destroy_device(<span class="keywordtype">int</span> vid)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> path[PATH_MAX];</div>
<div class="line">    <span class="keyword">struct </span>vhost_blk_ctrlr *ctrlr;</div>
<div class="line">    <span class="keyword">struct </span>vhost_blk_queue *vq;</div>
<div class="line">    <span class="keywordtype">int</span> i, ret;</div>
<div class="line"> </div>
<div class="line">    ret = <a class="code" href="rte__vhost_8h.html#a16848dac4304c973b24ced868ac3add8">rte_vhost_get_ifname</a>(vid, path, PATH_MAX);</div>
<div class="line">    <span class="keywordflow">if</span> (ret) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Destroy Ctrlr Failed\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    fprintf(stdout, <span class="stringliteral">&quot;Destroy %s Device ID %d\n&quot;</span>, path, vid);</div>
<div class="line">    ctrlr = vhost_blk_ctrlr_find(path);</div>
<div class="line">    <span class="keywordflow">if</span> (!ctrlr) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Destroy Ctrlr Failed\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!ctrlr-&gt;started)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    worker_thread_status = WORKER_STATE_STOP;</div>
<div class="line">    sem_wait(&amp;exit_sem);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; NUM_OF_BLK_QUEUES; i++) {</div>
<div class="line">        vq = &amp;ctrlr-&gt;queues[i];</div>
<div class="line">        <span class="keywordflow">if</span> (vq-&gt;packed_ring) {</div>
<div class="line">            vq-&gt;last_avail_idx |= (vq-&gt;avail_wrap_counter &lt;&lt;</div>
<div class="line">                15);</div>
<div class="line">            vq-&gt;last_used_idx |= (vq-&gt;used_wrap_counter &lt;&lt;</div>
<div class="line">                15);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <a name="a18"></a><a class="code" href="rte__vhost_8h.html#a8c0070bd8fd96beb8c57e4308226498d">rte_vhost_set_vring_base</a>(ctrlr-&gt;vid, i,</div>
<div class="line">                     vq-&gt;last_avail_idx,</div>
<div class="line">                     vq-&gt;last_used_idx);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    free_task_pool(ctrlr);</div>
<div class="line">    free(ctrlr-&gt;mem);</div>
<div class="line"> </div>
<div class="line">    ctrlr-&gt;started = 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">new_connection(<span class="keywordtype">int</span> vid)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* extend the proper features for block device */</span></div>
<div class="line">    vhost_session_install_rte_compat_hooks(vid);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span><a name="_a19"></a><a class="code" href="structvhost__device__ops.html">vhost_device_ops</a> vhost_blk_device_ops = {</div>
<div class="line">    .<a name="a20"></a><a class="code" href="structvhost__device__ops.html#a4395345b85225cd12bf33d36ac089f63">new_device</a> =  <a class="code" href="structvhost__device__ops.html#a4395345b85225cd12bf33d36ac089f63">new_device</a>,</div>
<div class="line">    .destroy_device = <a name="a21"></a><a class="code" href="structvhost__device__ops.html#adbd762e64dae12b68686afcf873cd808">destroy_device</a>,</div>
<div class="line">    .new_connection = new_connection,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>vhost_block_dev *</div>
<div class="line">vhost_blk_bdev_construct(<span class="keyword">const</span> <span class="keywordtype">char</span> *bdev_name,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *bdev_serial, uint32_t blk_size, uint64_t blk_cnt,</div>
<div class="line">    <span class="keywordtype">bool</span> wce_enable)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>vhost_block_dev *bdev;</div>
<div class="line"> </div>
<div class="line">    bdev = <a class="code" href="rte__malloc_8h.html#aaf0f048a5fd1672688c662cdfb4536b3">rte_zmalloc</a>(NULL, <span class="keyword">sizeof</span>(*bdev), RTE_CACHE_LINE_SIZE);</div>
<div class="line">    <span class="keywordflow">if</span> (!bdev)</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line"> </div>
<div class="line">    snprintf(bdev-&gt;name, <span class="keyword">sizeof</span>(bdev-&gt;name), <span class="stringliteral">&quot;%s&quot;</span>, bdev_name);</div>
<div class="line">    snprintf(bdev-&gt;product_name, <span class="keyword">sizeof</span>(bdev-&gt;product_name), <span class="stringliteral">&quot;%s&quot;</span>,</div>
<div class="line">         bdev_serial);</div>
<div class="line">    bdev-&gt;blocklen = blk_size;</div>
<div class="line">    bdev-&gt;blockcnt = blk_cnt;</div>
<div class="line">    bdev-&gt;write_cache = wce_enable;</div>
<div class="line"> </div>
<div class="line">    fprintf(stdout, <span class="stringliteral">&quot;Blocklen=%d, blockcnt=%&quot;</span>PRIx64<span class="stringliteral">&quot;\n&quot;</span>, bdev-&gt;blocklen,</div>
<div class="line">        bdev-&gt;blockcnt);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* use memory as disk storage space */</span></div>
<div class="line">    bdev-&gt;data = <a class="code" href="rte__malloc_8h.html#aaf0f048a5fd1672688c662cdfb4536b3">rte_zmalloc</a>(NULL, blk_cnt * blk_size, 0);</div>
<div class="line">    <span class="keywordflow">if</span> (!bdev-&gt;data) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;No enough reserved huge memory for disk\n&quot;</span>);</div>
<div class="line">        free(bdev);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> bdev;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>vhost_blk_ctrlr *</div>
<div class="line">vhost_blk_ctrlr_construct(<span class="keyword">const</span> <span class="keywordtype">char</span> *ctrlr_name)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    <span class="keyword">struct </span>vhost_blk_ctrlr *ctrlr;</div>
<div class="line">    <span class="keywordtype">char</span> *path;</div>
<div class="line">    <span class="keywordtype">char</span> cwd[PATH_MAX];</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* always use current directory */</span></div>
<div class="line">    path = getcwd(cwd, PATH_MAX);</div>
<div class="line">    <span class="keywordflow">if</span> (!path) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Cannot get current working directory\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line">    snprintf(dev_pathname, <span class="keyword">sizeof</span>(dev_pathname), <span class="stringliteral">&quot;%s/%s&quot;</span>, path, ctrlr_name);</div>
<div class="line"> </div>
<div class="line">    unlink(dev_pathname);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a22"></a><a class="code" href="rte__vhost_8h.html#a8a3ce366de790a49a0b64f1d7e42eea6">rte_vhost_driver_register</a>(dev_pathname, 0) != 0) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Socket %s already exists\n&quot;</span>, dev_pathname);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    ret = <a name="a23"></a><a class="code" href="rte__vhost_8h.html#a4455350b61b2ac164c2239ab320387cd">rte_vhost_driver_set_features</a>(dev_pathname, VHOST_BLK_FEATURES);</div>
<div class="line">    <span class="keywordflow">if</span> (ret != 0) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Set vhost driver features failed\n&quot;</span>);</div>
<div class="line">        rte_vhost_driver_unregister(dev_pathname);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* set vhost user protocol features */</span></div>
<div class="line">    vhost_dev_install_rte_compat_hooks(dev_pathname);</div>
<div class="line"> </div>
<div class="line">    ctrlr = <a class="code" href="rte__malloc_8h.html#aaf0f048a5fd1672688c662cdfb4536b3">rte_zmalloc</a>(NULL, <span class="keyword">sizeof</span>(*ctrlr), RTE_CACHE_LINE_SIZE);</div>
<div class="line">    <span class="keywordflow">if</span> (!ctrlr) {</div>
<div class="line">        rte_vhost_driver_unregister(dev_pathname);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* hardcoded block device information with 128MiB */</span></div>
<div class="line">    ctrlr-&gt;bdev = vhost_blk_bdev_construct(<span class="stringliteral">&quot;malloc0&quot;</span>, <span class="stringliteral">&quot;vhost_blk_malloc0&quot;</span>,</div>
<div class="line">                        4096, 32768, 0);</div>
<div class="line">    <span class="keywordflow">if</span> (!ctrlr-&gt;bdev) {</div>
<div class="line">        <a class="code" href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a>(ctrlr);</div>
<div class="line">        rte_vhost_driver_unregister(dev_pathname);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    rte_vhost_driver_callback_register(dev_pathname,</div>
<div class="line">                       &amp;vhost_blk_device_ops);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> ctrlr;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">vhost_blk_ctrlr_destroy(<span class="keyword">struct</span> vhost_blk_ctrlr *ctrlr)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (ctrlr-&gt;bdev != NULL) {</div>
<div class="line">        <span class="keywordflow">if</span> (ctrlr-&gt;bdev-&gt;data != NULL)</div>
<div class="line">            <a class="code" href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a>(ctrlr-&gt;bdev-&gt;data);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a>(ctrlr-&gt;bdev);</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a>(ctrlr);</div>
<div class="line"> </div>
<div class="line">    rte_vhost_driver_unregister(dev_pathname);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">signal_handler(<a name="a24"></a><a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">int</span> signum)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>vhost_blk_ctrlr *ctrlr;</div>
<div class="line"> </div>
<div class="line">    ctrlr = vhost_blk_ctrlr_find(dev_pathname);</div>
<div class="line">    <span class="keywordflow">if</span> (ctrlr == NULL)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (ctrlr-&gt;started)</div>
<div class="line">        destroy_device(ctrlr-&gt;vid);</div>
<div class="line"> </div>
<div class="line">    vhost_blk_ctrlr_destroy(ctrlr);</div>
<div class="line">    exit(0);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* init EAL */</span></div>
<div class="line">    ret = <a name="a25"></a><a class="code" href="rte__eal_8h.html#a5c3f4dddc25e38c5a186ecd8a69260e3">rte_eal_init</a>(argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a name="a26"></a><a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;Error with EAL initialization\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    g_vhost_ctrlr = vhost_blk_ctrlr_construct(CTRLR_NAME);</div>
<div class="line">    <span class="keywordflow">if</span> (g_vhost_ctrlr == NULL) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Construct vhost blk controller failed\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (sem_init(&amp;exit_sem, 0, 0) &lt; 0) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Error init exit_sem\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    signal(SIGINT, signal_handler);</div>
<div class="line"> </div>
<div class="line">    ret = <a name="a27"></a><a class="code" href="rte__vhost_8h.html#a794f0d9c9550fe705a9b090c72cfe7be">rte_vhost_driver_start</a>(dev_pathname);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Failed to start vhost driver.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* loop for exit the application */</span></div>
<div class="line">    <span class="keywordflow">while</span> (1)</div>
<div class="line">        sleep(1);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<div class="ttc" id="astructvhost__device__ops_html_a4395345b85225cd12bf33d36ac089f63"><div class="ttname"><a href="structvhost__device__ops.html#a4395345b85225cd12bf33d36ac089f63">vhost_device_ops::new_device</a></div><div class="ttdeci">int(* new_device)(int vid)</div><div class="ttdef"><b>Definition:</b> <a href="rte__vhost_8h_source.html#l00267">rte_vhost.h:267</a></div></div>
<div class="ttc" id="arte__vhost_8h_html_a794f0d9c9550fe705a9b090c72cfe7be"><div class="ttname"><a href="rte__vhost_8h.html#a794f0d9c9550fe705a9b090c72cfe7be">rte_vhost_driver_start</a></div><div class="ttdeci">int rte_vhost_driver_start(const char *path)</div></div>
<div class="ttc" id="arte__vhost_8h_html_a8a3ce366de790a49a0b64f1d7e42eea6"><div class="ttname"><a href="rte__vhost_8h.html#a8a3ce366de790a49a0b64f1d7e42eea6">rte_vhost_driver_register</a></div><div class="ttdeci">int rte_vhost_driver_register(const char *path, uint64_t flags)</div></div>
<div class="ttc" id="arte__malloc_8h_html_aaf0f048a5fd1672688c662cdfb4536b3"><div class="ttname"><a href="rte__malloc_8h.html#aaf0f048a5fd1672688c662cdfb4536b3">rte_zmalloc</a></div><div class="ttdeci">void * rte_zmalloc(const char *type, size_t size, unsigned align) __rte_alloc_size(2)</div></div>
<div class="ttc" id="arte__vhost_8h_html"><div class="ttname"><a href="rte__vhost_8h.html">rte_vhost.h</a></div></div>
<div class="ttc" id="arte__malloc_8h_html"><div class="ttname"><a href="rte__malloc_8h.html">rte_malloc.h</a></div></div>
<div class="ttc" id="arte__vhost_8h_html_adbbd575a762c2c82eea09f718427d45f"><div class="ttname"><a href="rte__vhost_8h.html#adbbd575a762c2c82eea09f718427d45f">rte_vhost_clr_inflight_desc_split</a></div><div class="ttdeci">__rte_experimental int rte_vhost_clr_inflight_desc_split(int vid, uint16_t vring_idx, uint16_t last_used_idx, uint16_t idx)</div></div>
<div class="ttc" id="arte__log_8h_html"><div class="ttname"><a href="rte__log_8h.html">rte_log.h</a></div></div>
<div class="ttc" id="arte__vhost_8h_html_a8c0070bd8fd96beb8c57e4308226498d"><div class="ttname"><a href="rte__vhost_8h.html#a8c0070bd8fd96beb8c57e4308226498d">rte_vhost_set_vring_base</a></div><div class="ttdeci">int rte_vhost_set_vring_base(int vid, uint16_t queue_id, uint16_t last_avail_idx, uint16_t last_used_idx)</div></div>
<div class="ttc" id="arte__atomic_8h_html_a4873ae3c74d0834a07022261b849b058"><div class="ttname"><a href="rte__atomic_8h.html#a4873ae3c74d0834a07022261b849b058">rte_smp_mb</a></div><div class="ttdeci">static void rte_smp_mb(void)</div></div>
<div class="ttc" id="astructvhost__device__ops_html_adbd762e64dae12b68686afcf873cd808"><div class="ttname"><a href="structvhost__device__ops.html#adbd762e64dae12b68686afcf873cd808">vhost_device_ops::destroy_device</a></div><div class="ttdeci">void(* destroy_device)(int vid)</div><div class="ttdef"><b>Definition:</b> <a href="rte__vhost_8h_source.html#l00268">rte_vhost.h:268</a></div></div>
<div class="ttc" id="arte__vhost_8h_html_a44ae1a415495b7e47c27886a40f617f0"><div class="ttname"><a href="rte__vhost_8h.html#a44ae1a415495b7e47c27886a40f617f0">rte_vhost_get_vring_base_from_inflight</a></div><div class="ttdeci">__rte_experimental int rte_vhost_get_vring_base_from_inflight(int vid, uint16_t queue_id, uint16_t *last_avail_idx, uint16_t *last_used_idx)</div></div>
<div class="ttc" id="arte__vhost_8h_html_a33071190516d5aca5eaa61638b5697cf"><div class="ttname"><a href="rte__vhost_8h.html#a33071190516d5aca5eaa61638b5697cf">rte_vhost_set_last_inflight_io_packed</a></div><div class="ttdeci">__rte_experimental int rte_vhost_set_last_inflight_io_packed(int vid, uint16_t vring_idx, uint16_t head)</div></div>
<div class="ttc" id="arte__vhost_8h_html_a4455350b61b2ac164c2239ab320387cd"><div class="ttname"><a href="rte__vhost_8h.html#a4455350b61b2ac164c2239ab320387cd">rte_vhost_driver_set_features</a></div><div class="ttdeci">int rte_vhost_driver_set_features(const char *path, uint64_t features)</div></div>
<div class="ttc" id="arte__atomic_8h_html"><div class="ttname"><a href="rte__atomic_8h.html">rte_atomic.h</a></div></div>
<div class="ttc" id="arte__vhost_8h_html_a6b3d18ab95a9baf4a9412c2f442777f2"><div class="ttname"><a href="rte__vhost_8h.html#a6b3d18ab95a9baf4a9412c2f442777f2">rte_vhost_set_last_inflight_io_split</a></div><div class="ttdeci">__rte_experimental int rte_vhost_set_last_inflight_io_split(int vid, uint16_t vring_idx, uint16_t idx)</div></div>
<div class="ttc" id="arte__common_8h_html_ac5169870c983b3463cb226bdb8a94880"><div class="ttname"><a href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a></div><div class="ttdeci">__rte_noreturn void rte_exit(int exit_code, const char *format,...) __rte_format_printf(2</div></div>
<div class="ttc" id="arte__vhost_8h_html_a16848dac4304c973b24ced868ac3add8"><div class="ttname"><a href="rte__vhost_8h.html#a16848dac4304c973b24ced868ac3add8">rte_vhost_get_ifname</a></div><div class="ttdeci">int rte_vhost_get_ifname(int vid, char *buf, size_t len)</div></div>
<div class="ttc" id="arte__cycles_8h_html"><div class="ttname"><a href="rte__cycles_8h.html">rte_cycles.h</a></div></div>
<div class="ttc" id="arte__vhost_8h_html_af2b7b19139cd804f6747ec374475fba3"><div class="ttname"><a href="rte__vhost_8h.html#af2b7b19139cd804f6747ec374475fba3">rte_vhost_get_vhost_ring_inflight</a></div><div class="ttdeci">__rte_experimental int rte_vhost_get_vhost_ring_inflight(int vid, uint16_t vring_idx, struct rte_vhost_ring_inflight *vring)</div></div>
<div class="ttc" id="arte__vhost_8h_html_a43208ebb5b4b4fad1a7a93333250cf83"><div class="ttname"><a href="rte__vhost_8h.html#a43208ebb5b4b4fad1a7a93333250cf83">rte_vhost_get_vring_base</a></div><div class="ttdeci">int rte_vhost_get_vring_base(int vid, uint16_t queue_id, uint16_t *last_avail_idx, uint16_t *last_used_idx)</div></div>
<div class="ttc" id="astructvhost__device__ops_html"><div class="ttname"><a href="structvhost__device__ops.html">vhost_device_ops</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__vhost_8h_source.html#l00266">rte_vhost.h:266</a></div></div>
<div class="ttc" id="arte__vhost_8h_html_aa2e00d8df9ee6d508aea6f807d0c09f3"><div class="ttname"><a href="rte__vhost_8h.html#aa2e00d8df9ee6d508aea6f807d0c09f3">rte_vhost_vring_call</a></div><div class="ttdeci">int rte_vhost_vring_call(int vid, uint16_t vring_idx)</div></div>
<div class="ttc" id="arte__common_8h_html_ae1a7c8799cb57669ae2ddf367b21533f"><div class="ttname"><a href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a></div><div class="ttdeci">#define __rte_unused</div><div class="ttdef"><b>Definition:</b> <a href="rte__common_8h_source.html#l00116">rte_common.h:116</a></div></div>
<div class="ttc" id="arte__vhost_8h_html_a155457616d06ca66e9be9095fe366d65"><div class="ttname"><a href="rte__vhost_8h.html#a155457616d06ca66e9be9095fe366d65">rte_vhost_set_inflight_desc_packed</a></div><div class="ttdeci">__rte_experimental int rte_vhost_set_inflight_desc_packed(int vid, uint16_t vring_idx, uint16_t head, uint16_t last, uint16_t *inflight_entry)</div></div>
<div class="ttc" id="arte__eal_8h_html_a5c3f4dddc25e38c5a186ecd8a69260e3"><div class="ttname"><a href="rte__eal_8h.html#a5c3f4dddc25e38c5a186ecd8a69260e3">rte_eal_init</a></div><div class="ttdeci">int rte_eal_init(int argc, char **argv)</div></div>
<div class="ttc" id="arte__vhost_8h_html_a398c60c6b04e6eeaa72359b527661bc2"><div class="ttname"><a href="rte__vhost_8h.html#a398c60c6b04e6eeaa72359b527661bc2">rte_vhost_get_mem_table</a></div><div class="ttdeci">int rte_vhost_get_mem_table(int vid, struct rte_vhost_memory **mem)</div></div>
<div class="ttc" id="arte__vhost_8h_html_a2deb7d5116b92a1cc150c11e306fad98"><div class="ttname"><a href="rte__vhost_8h.html#a2deb7d5116b92a1cc150c11e306fad98">rte_vhost_va_from_guest_pa</a></div><div class="ttdeci">static __rte_experimental __rte_always_inline uint64_t rte_vhost_va_from_guest_pa(struct rte_vhost_memory *mem, uint64_t gpa, uint64_t *len)</div><div class="ttdef"><b>Definition:</b> <a href="rte__vhost_8h_source.html#l00346">rte_vhost.h:346</a></div></div>
<div class="ttc" id="arte__vhost_8h_html_adce528fcfffa73ab4cbc4e3f5473ff97"><div class="ttname"><a href="rte__vhost_8h.html#adce528fcfffa73ab4cbc4e3f5473ff97">rte_vhost_clr_inflight_desc_packed</a></div><div class="ttdeci">__rte_experimental int rte_vhost_clr_inflight_desc_packed(int vid, uint16_t vring_idx, uint16_t head)</div></div>
<div class="ttc" id="arte__malloc_8h_html_a1fc82f67711b13aca7e05dc9d58f9dbd"><div class="ttname"><a href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a></div><div class="ttdeci">void void rte_free(void *ptr)</div></div>
<div class="ttc" id="arte__vhost_8h_html_a54c0b385ce21f33a84c447fdac4076d9"><div class="ttname"><a href="rte__vhost_8h.html#a54c0b385ce21f33a84c447fdac4076d9">rte_vhost_set_inflight_desc_split</a></div><div class="ttdeci">__rte_experimental int rte_vhost_set_inflight_desc_split(int vid, uint16_t vring_idx, uint16_t idx)</div></div>
<div class="ttc" id="arte__vhost_8h_html_a1c1fbdab537b4021941bab15e26b21f9"><div class="ttname"><a href="rte__vhost_8h.html#a1c1fbdab537b4021941bab15e26b21f9">rte_vhost_get_negotiated_features</a></div><div class="ttdeci">int rte_vhost_get_negotiated_features(int vid, uint64_t *features)</div></div>
<div class="ttc" id="arte__vhost_8h_html_a5891bd49d76cbe72ecfe2c87fc1fe853"><div class="ttname"><a href="rte__vhost_8h.html#a5891bd49d76cbe72ecfe2c87fc1fe853">rte_vhost_get_vhost_vring</a></div><div class="ttdeci">int rte_vhost_get_vhost_vring(int vid, uint16_t vring_idx, struct rte_vhost_vring *vring)</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20
</small></address>
</body>
</html>
