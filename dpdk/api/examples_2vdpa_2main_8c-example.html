<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DPDK: examples/vdpa/main.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">20.11.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">examples/vdpa/main.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/* SPDX-License-Identifier: BSD-3-Clause</span></div>
<div class="line"><span class="comment"> * Copyright(c) 2018 Intel Corporation</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__ethdev_8h.html">rte_ethdev.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__malloc_8h.html">rte_malloc.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__vhost_8h.html">rte_vhost.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__vdpa_8h.html">rte_vdpa.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__pci_8h.html">rte_pci.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__string__fns_8h.html">rte_string_fns.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;cmdline_parse.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cmdline_socket.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cmdline_parse_string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cmdline_parse_num.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cmdline_8h.html">cmdline.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define MAX_PATH_LEN 128</span></div>
<div class="line"><span class="preprocessor">#define MAX_VDPA_SAMPLE_PORTS 1024</span></div>
<div class="line"><span class="preprocessor">#define RTE_LOGTYPE_VDPA RTE_LOGTYPE_USER1</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>vdpa_port {</div>
<div class="line">    <span class="keywordtype">char</span> ifname[MAX_PATH_LEN];</div>
<div class="line">    <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structrte__vdpa__device.html">rte_vdpa_device</a> *dev;</div>
<div class="line">    <span class="keywordtype">int</span> vid;</div>
<div class="line">    uint64_t flags;</div>
<div class="line">    <span class="keywordtype">int</span> stats_n;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a1"></a><a class="code" href="structrte__vdpa__stat__name.html">rte_vdpa_stat_name</a> *stats_names;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a2"></a><a class="code" href="structrte__vdpa__stat.html">rte_vdpa_stat</a> *stats;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>vdpa_port vports[MAX_VDPA_SAMPLE_PORTS];</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> iface[MAX_PATH_LEN];</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> devcnt;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> interactive;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> client_mode;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* display usage */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">vdpa_usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *prgname)</div>
<div class="line">{</div>
<div class="line">    printf(<span class="stringliteral">&quot;Usage: %s [EAL options] -- &quot;</span></div>
<div class="line">                 <span class="stringliteral">&quot;  --interactive|-i: run in interactive mode.\n&quot;</span></div>
<div class="line">                 <span class="stringliteral">&quot;  --iface &lt;path&gt;: specify the path prefix of the socket files, e.g. /tmp/vhost-user-.\n&quot;</span></div>
<div class="line">                 <span class="stringliteral">&quot;  --client: register a vhost-user socket as client mode.\n&quot;</span>,</div>
<div class="line">                 prgname);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_args(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *short_option = <span class="stringliteral">&quot;i&quot;</span>;</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">struct </span>option long_option[] = {</div>
<div class="line">        {<span class="stringliteral">&quot;iface&quot;</span>, required_argument, NULL, 0},</div>
<div class="line">        {<span class="stringliteral">&quot;interactive&quot;</span>, no_argument, &amp;interactive, 1},</div>
<div class="line">        {<span class="stringliteral">&quot;client&quot;</span>, no_argument, &amp;client_mode, 1},</div>
<div class="line">        {NULL, 0, 0, 0},</div>
<div class="line">    };</div>
<div class="line">    <span class="keywordtype">int</span> opt, idx;</div>
<div class="line">    <span class="keywordtype">char</span> *prgname = argv[0];</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> ((opt = getopt_long(argc, argv, short_option, long_option, &amp;idx))</div>
<div class="line">            != EOF) {</div>
<div class="line">        <span class="keywordflow">switch</span> (opt) {</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;i&#39;</span>:</div>
<div class="line">            printf(<span class="stringliteral">&quot;Interactive-mode selected\n&quot;</span>);</div>
<div class="line">            interactive = 1;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="comment">/* long options */</span></div>
<div class="line">        <span class="keywordflow">case</span> 0:</div>
<div class="line">            <span class="keywordflow">if</span> (strncmp(long_option[idx].name, <span class="stringliteral">&quot;iface&quot;</span>,</div>
<div class="line">                        MAX_PATH_LEN) == 0) {</div>
<div class="line">                <a name="a3"></a><a class="code" href="rte__string__fns_8h.html#ab58c1aa83cc80f72e57b88d590f95b8b">rte_strscpy</a>(iface, optarg, MAX_PATH_LEN);</div>
<div class="line">                printf(<span class="stringliteral">&quot;iface %s\n&quot;</span>, iface);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (!strcmp(long_option[idx].name, <span class="stringliteral">&quot;interactive&quot;</span>)) {</div>
<div class="line">                printf(<span class="stringliteral">&quot;Interactive-mode selected\n&quot;</span>);</div>
<div class="line">                interactive = 1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            vdpa_usage(prgname);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (iface[0] == <span class="charliteral">&#39;\0&#39;</span> &amp;&amp; interactive == 0) {</div>
<div class="line">        vdpa_usage(prgname);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">new_device(<span class="keywordtype">int</span> vid)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> ifname[MAX_PATH_LEN];</div>
<div class="line">    <span class="keyword">struct </span><a name="_a4"></a><a class="code" href="structrte__device.html">rte_device</a> *dev;</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line"> </div>
<div class="line">    <a name="a5"></a><a class="code" href="rte__vhost_8h.html#a16848dac4304c973b24ced868ac3add8">rte_vhost_get_ifname</a>(vid, ifname, <span class="keyword">sizeof</span>(ifname));</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; MAX_VDPA_SAMPLE_PORTS; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (strncmp(ifname, vports[i].ifname, MAX_PATH_LEN))</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"> </div>
<div class="line">        dev = <a name="a6"></a><a class="code" href="rte__vdpa_8h.html#acb952a4ce37a1196994cca301b35d4d2">rte_vdpa_get_rte_device</a>(vports[i].dev);</div>
<div class="line">        <span class="keywordflow">if</span> (!dev) {</div>
<div class="line">            <a name="a7"></a><a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VDPA,</div>
<div class="line">                <span class="stringliteral">&quot;Failed to get generic device for port %d\n&quot;</span>, i);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        printf(<span class="stringliteral">&quot;\nnew port %s, device : %s\n&quot;</span>, ifname, dev-&gt;<a name="a8"></a><a class="code" href="structrte__device.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);</div>
<div class="line">        vports[i].vid = vid;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (i &gt;= MAX_VDPA_SAMPLE_PORTS)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">destroy_device(<span class="keywordtype">int</span> vid)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__device.html">rte_device</a> *dev;</div>
<div class="line">    <span class="keywordtype">char</span> ifname[MAX_PATH_LEN];</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="rte__vhost_8h.html#a16848dac4304c973b24ced868ac3add8">rte_vhost_get_ifname</a>(vid, ifname, <span class="keyword">sizeof</span>(ifname));</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; MAX_VDPA_SAMPLE_PORTS; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (strncmp(ifname, vports[i].ifname, MAX_PATH_LEN))</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"> </div>
<div class="line">        dev = <a class="code" href="rte__vdpa_8h.html#acb952a4ce37a1196994cca301b35d4d2">rte_vdpa_get_rte_device</a>(vports[i].dev);</div>
<div class="line">        <span class="keywordflow">if</span> (!dev) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VDPA,</div>
<div class="line">                <span class="stringliteral">&quot;Failed to get generic device for port %d\n&quot;</span>, i);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        printf(<span class="stringliteral">&quot;\ndestroy port %s, device: %s\n&quot;</span>, ifname, dev-&gt;<a class="code" href="structrte__device.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a name="_a9"></a><a class="code" href="structvhost__device__ops.html">vhost_device_ops</a> vdpa_sample_devops = {</div>
<div class="line">    .<a name="a10"></a><a class="code" href="structvhost__device__ops.html#a4395345b85225cd12bf33d36ac089f63">new_device</a> = <a class="code" href="structvhost__device__ops.html#a4395345b85225cd12bf33d36ac089f63">new_device</a>,</div>
<div class="line">    .destroy_device = <a name="a11"></a><a class="code" href="structvhost__device__ops.html#adbd762e64dae12b68686afcf873cd808">destroy_device</a>,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">start_vdpa(<span class="keyword">struct</span> vdpa_port *vport)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    <span class="keywordtype">char</span> *socket_path = vport-&gt;ifname;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (client_mode)</div>
<div class="line">        vport-&gt;flags |= RTE_VHOST_USER_CLIENT;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (access(socket_path, F_OK) != -1 &amp;&amp; !client_mode) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VDPA,</div>
<div class="line">            <span class="stringliteral">&quot;%s exists, please remove it or specify another file and try again.\n&quot;</span>,</div>
<div class="line">            socket_path);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    ret = <a name="a12"></a><a class="code" href="rte__vhost_8h.html#a8a3ce366de790a49a0b64f1d7e42eea6">rte_vhost_driver_register</a>(socket_path, vport-&gt;flags);</div>
<div class="line">    <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">        <a name="a13"></a><a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">            <span class="stringliteral">&quot;register driver failed: %s\n&quot;</span>,</div>
<div class="line">            socket_path);</div>
<div class="line"> </div>
<div class="line">    ret = rte_vhost_driver_callback_register(socket_path,</div>
<div class="line">            &amp;vdpa_sample_devops);</div>
<div class="line">    <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">            <span class="stringliteral">&quot;register driver ops failed: %s\n&quot;</span>,</div>
<div class="line">            socket_path);</div>
<div class="line"> </div>
<div class="line">    ret = <a name="a14"></a><a class="code" href="rte__vhost_8h.html#a626b366c380069fcc0bc437a14d612aa">rte_vhost_driver_attach_vdpa_device</a>(socket_path, vport-&gt;dev);</div>
<div class="line">    <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">            <span class="stringliteral">&quot;attach vdpa device failed: %s\n&quot;</span>,</div>
<div class="line">            socket_path);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a15"></a><a class="code" href="rte__vhost_8h.html#a794f0d9c9550fe705a9b090c72cfe7be">rte_vhost_driver_start</a>(socket_path) &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE,</div>
<div class="line">            <span class="stringliteral">&quot;start vhost driver failed: %s\n&quot;</span>,</div>
<div class="line">            socket_path);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">close_vdpa(<span class="keyword">struct</span> vdpa_port *vport)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    <span class="keywordtype">char</span> *socket_path = vport-&gt;ifname;</div>
<div class="line"> </div>
<div class="line">    ret = <a name="a16"></a><a class="code" href="rte__vhost_8h.html#aeac1c327c1179055fd1b505bf9c486e2">rte_vhost_driver_detach_vdpa_device</a>(socket_path);</div>
<div class="line">    <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VDPA,</div>
<div class="line">                <span class="stringliteral">&quot;detach vdpa device failed: %s\n&quot;</span>,</div>
<div class="line">                socket_path);</div>
<div class="line"> </div>
<div class="line">    ret = rte_vhost_driver_unregister(socket_path);</div>
<div class="line">    <span class="keywordflow">if</span> (ret != 0)</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VDPA,</div>
<div class="line">                <span class="stringliteral">&quot;Fail to unregister vhost driver for %s.\n&quot;</span>,</div>
<div class="line">                socket_path);</div>
<div class="line">    <span class="keywordflow">if</span> (vport-&gt;stats_names) {</div>
<div class="line">        <a name="a17"></a><a class="code" href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a>(vport-&gt;stats_names);</div>
<div class="line">        vport-&gt;stats_names = NULL;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">vdpa_sample_quit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; <a name="a18"></a><a class="code" href="rte__common_8h.html#a4c7571cbcdbfe9b63431036af811bee9">RTE_MIN</a>(MAX_VDPA_SAMPLE_PORTS, devcnt); i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (vports[i].ifname[0] != <span class="charliteral">&#39;\0&#39;</span>)</div>
<div class="line">            close_vdpa(&amp;vports[i]);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">signal_handler(<span class="keywordtype">int</span> signum)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (signum == SIGINT || signum == SIGTERM) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;\nSignal %d received, preparing to exit...\n&quot;</span>, signum);</div>
<div class="line">        vdpa_sample_quit();</div>
<div class="line">        exit(0);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* interactive cmds */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* *** Help command with introduction. *** */</span></div>
<div class="line"><span class="keyword">struct </span>cmd_help_result {</div>
<div class="line">    cmdline_fixed_string_t help;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> cmd_help_parsed(<a name="a19"></a><a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">void</span> *parsed_result,</div>
<div class="line">        <span class="keyword">struct</span> cmdline *cl,</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">void</span> *data)</div>
<div class="line">{</div>
<div class="line">    cmdline_printf(</div>
<div class="line">        cl,</div>
<div class="line">        <span class="stringliteral">&quot;\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;The following commands are currently available:\n\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;Control:\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;    help                                      : Show interactive instructions.\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;    list                                      : list all available vdpa devices.\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;    create &lt;socket file&gt; &lt;vdev addr&gt;          : create a new vdpa port.\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;    stats &lt;device ID&gt; &lt;virtio queue ID&gt;       : show statistics of virtio queue, 0xffff for all.\n&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;    quit                                      : exit vdpa sample app.\n&quot;</span></div>
<div class="line">    );</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">cmdline_parse_token_string_t cmd_help_help =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cmd_help_result, help, <span class="stringliteral">&quot;help&quot;</span>);</div>
<div class="line"> </div>
<div class="line">cmdline_parse_inst_t cmd_help = {</div>
<div class="line">    .f = cmd_help_parsed,</div>
<div class="line">    .data = NULL,</div>
<div class="line">    .help_str = <span class="stringliteral">&quot;show help&quot;</span>,</div>
<div class="line">    .tokens = {</div>
<div class="line">        (<span class="keywordtype">void</span> *)&amp;cmd_help_help,</div>
<div class="line">        NULL,</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* *** List all available vdpa devices *** */</span></div>
<div class="line"><span class="keyword">struct </span>cmd_list_result {</div>
<div class="line">    cmdline_fixed_string_t action;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> cmd_list_vdpa_devices_parsed(</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">void</span> *parsed_result,</div>
<div class="line">        <span class="keyword">struct</span> cmdline *cl,</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">void</span> *data)</div>
<div class="line">{</div>
<div class="line">    uint32_t queue_num;</div>
<div class="line">    uint64_t features;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__vdpa__device.html">rte_vdpa_device</a> *vdev;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__device.html">rte_device</a> *dev;</div>
<div class="line">    <span class="keyword">struct </span><a name="_a20"></a><a class="code" href="structrte__dev__iterator.html">rte_dev_iterator</a> dev_iter;</div>
<div class="line"> </div>
<div class="line">    cmdline_printf(cl, <span class="stringliteral">&quot;device name\tqueue num\tsupported features\n&quot;</span>);</div>
<div class="line">    RTE_DEV_FOREACH(dev, <span class="stringliteral">&quot;class=vdpa&quot;</span>, &amp;dev_iter) {</div>
<div class="line">        vdev = <a name="a21"></a><a class="code" href="rte__vdpa_8h.html#ad67302329133e95629ab8368a59b65a9">rte_vdpa_find_device_by_name</a>(dev-&gt;<a class="code" href="structrte__device.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);</div>
<div class="line">        <span class="keywordflow">if</span> (!vdev)</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a22"></a><a class="code" href="rte__vdpa_8h.html#a3afe5a5916b5fb995f2c6580846f3b97">rte_vdpa_get_queue_num</a>(vdev, &amp;queue_num) &lt; 0) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VDPA,</div>
<div class="line">                <span class="stringliteral">&quot;failed to get vdpa queue number &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;for device %s.\n&quot;</span>, dev-&gt;<a class="code" href="structrte__device.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a23"></a><a class="code" href="rte__vdpa_8h.html#a9fddb2ba1019bdad9626c34c719faef9">rte_vdpa_get_features</a>(vdev, &amp;features) &lt; 0) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VDPA,</div>
<div class="line">                <span class="stringliteral">&quot;failed to get vdpa features &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;for device %s.\n&quot;</span>, dev-&gt;<a class="code" href="structrte__device.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        cmdline_printf(cl, <span class="stringliteral">&quot;%s\t\t%&quot;</span> PRIu32 <span class="stringliteral">&quot;\t\t0x%&quot;</span> PRIx64 <span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">            dev-&gt;<a class="code" href="structrte__device.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, queue_num, features);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">cmdline_parse_token_string_t cmd_action_list =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cmd_list_result, action, <span class="stringliteral">&quot;list&quot;</span>);</div>
<div class="line"> </div>
<div class="line">cmdline_parse_inst_t cmd_list_vdpa_devices = {</div>
<div class="line">    .f = cmd_list_vdpa_devices_parsed,</div>
<div class="line">    .data = NULL,</div>
<div class="line">    .help_str = <span class="stringliteral">&quot;list all available vdpa devices&quot;</span>,</div>
<div class="line">    .tokens = {</div>
<div class="line">        (<span class="keywordtype">void</span> *)&amp;cmd_action_list,</div>
<div class="line">        NULL,</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* *** Create new vdpa port *** */</span></div>
<div class="line"><span class="keyword">struct </span>cmd_create_result {</div>
<div class="line">    cmdline_fixed_string_t action;</div>
<div class="line">    cmdline_fixed_string_t socket_path;</div>
<div class="line">    cmdline_fixed_string_t bdf;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> cmd_create_vdpa_port_parsed(<span class="keywordtype">void</span> *parsed_result,</div>
<div class="line">        <span class="keyword">struct</span> cmdline *cl,</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">void</span> *data)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__vdpa__device.html">rte_vdpa_device</a> *dev;</div>
<div class="line">    <span class="keyword">struct </span>cmd_create_result *res = parsed_result;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="rte__string__fns_8h.html#ab58c1aa83cc80f72e57b88d590f95b8b">rte_strscpy</a>(vports[devcnt].ifname, res-&gt;socket_path, MAX_PATH_LEN);</div>
<div class="line">    dev = <a class="code" href="rte__vdpa_8h.html#ad67302329133e95629ab8368a59b65a9">rte_vdpa_find_device_by_name</a>(res-&gt;bdf);</div>
<div class="line">    <span class="keywordflow">if</span> (dev == NULL) {</div>
<div class="line">        cmdline_printf(cl, <span class="stringliteral">&quot;Unable to find vdpa device id for %s.\n&quot;</span>,</div>
<div class="line">                res-&gt;bdf);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    vports[devcnt].dev = dev;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (start_vdpa(&amp;vports[devcnt]) == 0)</div>
<div class="line">        devcnt++;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">cmdline_parse_token_string_t cmd_action_create =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cmd_create_result, action, <span class="stringliteral">&quot;create&quot;</span>);</div>
<div class="line">cmdline_parse_token_string_t cmd_socket_path =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cmd_create_result, socket_path, NULL);</div>
<div class="line">cmdline_parse_token_string_t cmd_bdf =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cmd_create_result, bdf, NULL);</div>
<div class="line"> </div>
<div class="line">cmdline_parse_inst_t cmd_create_vdpa_port = {</div>
<div class="line">    .f = cmd_create_vdpa_port_parsed,</div>
<div class="line">    .data = NULL,</div>
<div class="line">    .help_str = <span class="stringliteral">&quot;create a new vdpa port&quot;</span>,</div>
<div class="line">    .tokens = {</div>
<div class="line">        (<span class="keywordtype">void</span> *)&amp;cmd_action_create,</div>
<div class="line">        (<span class="keywordtype">void</span> *)&amp;cmd_socket_path,</div>
<div class="line">        (<span class="keywordtype">void</span> *)&amp;cmd_bdf,</div>
<div class="line">        NULL,</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* *** STATS *** */</span></div>
<div class="line"><span class="keyword">struct </span>cmd_stats_result {</div>
<div class="line">    cmdline_fixed_string_t stats;</div>
<div class="line">    cmdline_fixed_string_t bdf;</div>
<div class="line">    uint16_t qid;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> cmd_device_stats_parsed(<span class="keywordtype">void</span> *parsed_result, <span class="keyword">struct</span> cmdline *cl,</div>
<div class="line">                    <a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">void</span> *data)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>cmd_stats_result *res = parsed_result;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__vdpa__device.html">rte_vdpa_device</a> *vdev = <a class="code" href="rte__vdpa_8h.html#ad67302329133e95629ab8368a59b65a9">rte_vdpa_find_device_by_name</a>(res-&gt;bdf);</div>
<div class="line">    <span class="keyword">struct </span>vdpa_port *vport = NULL;</div>
<div class="line">    uint32_t first, last;</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!vdev) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VDPA, <span class="stringliteral">&quot;Invalid device: %s.\n&quot;</span>,</div>
<div class="line">            res-&gt;bdf);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="rte__common_8h.html#a4c7571cbcdbfe9b63431036af811bee9">RTE_MIN</a>(MAX_VDPA_SAMPLE_PORTS, devcnt); i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (vports[i].dev == vdev) {</div>
<div class="line">            vport = &amp;vports[i];</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (!vport) {</div>
<div class="line">        <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VDPA, <span class="stringliteral">&quot;Device %s was not created.\n&quot;</span>, res-&gt;bdf);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (res-&gt;qid == 0xFFFF) {</div>
<div class="line">        first = 0;</div>
<div class="line">        last = <a name="a24"></a><a class="code" href="rte__vhost_8h.html#a07fe188216c6544b0b62baf911622c99">rte_vhost_get_vring_num</a>(vport-&gt;vid);</div>
<div class="line">        <span class="keywordflow">if</span> (last == 0) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VDPA, <span class="stringliteral">&quot;Failed to get num of actual virtqs&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot; for device %s.\n&quot;</span>, res-&gt;bdf);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        last--;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        first = res-&gt;qid;</div>
<div class="line">        last = res-&gt;qid;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (!vport-&gt;stats_names) {</div>
<div class="line">        vport-&gt;stats_n = <a name="a25"></a><a class="code" href="rte__vdpa_8h.html#adeb12929ea9c70d6216fa848275b69c7">rte_vdpa_get_stats_names</a>(vport-&gt;dev, NULL, 0);</div>
<div class="line">        <span class="keywordflow">if</span> (vport-&gt;stats_n &lt;= 0) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VDPA, <span class="stringliteral">&quot;Failed to get names number of &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;device %s stats.\n&quot;</span>, res-&gt;bdf);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        vport-&gt;stats_names = <a name="a26"></a><a class="code" href="rte__malloc_8h.html#aaf0f048a5fd1672688c662cdfb4536b3">rte_zmalloc</a>(NULL,</div>
<div class="line">            (<span class="keyword">sizeof</span>(*vport-&gt;stats_names) + <span class="keyword">sizeof</span>(*vport-&gt;stats)) *</div>
<div class="line">                            vport-&gt;stats_n, 0);</div>
<div class="line">        <span class="keywordflow">if</span> (!vport-&gt;stats_names) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VDPA, <span class="stringliteral">&quot;Failed to allocate memory for stat&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot; names of device %s.\n&quot;</span>, res-&gt;bdf);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        i = <a class="code" href="rte__vdpa_8h.html#adeb12929ea9c70d6216fa848275b69c7">rte_vdpa_get_stats_names</a>(vport-&gt;dev, vport-&gt;stats_names,</div>
<div class="line">                        vport-&gt;stats_n);</div>
<div class="line">        <span class="keywordflow">if</span> (vport-&gt;stats_n != i) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VDPA, <span class="stringliteral">&quot;Failed to get names of device %s &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;stats.\n&quot;</span>, res-&gt;bdf);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        vport-&gt;stats = (<span class="keyword">struct </span><a class="code" href="structrte__vdpa__stat.html">rte_vdpa_stat</a> *)</div>
<div class="line">                    (vport-&gt;stats_names + vport-&gt;stats_n);</div>
<div class="line">    }</div>
<div class="line">    cmdline_printf(cl, <span class="stringliteral">&quot;\nDevice %s:\n&quot;</span>, res-&gt;bdf);</div>
<div class="line">    <span class="keywordflow">for</span> (; first &lt;= last; first++) {</div>
<div class="line">        memset(vport-&gt;stats, 0, <span class="keyword">sizeof</span>(*vport-&gt;stats) * vport-&gt;stats_n);</div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a27"></a><a class="code" href="rte__vdpa_8h.html#a6649eeec1ee3abc8701f4d1d9514259a">rte_vdpa_get_stats</a>(vport-&gt;dev, (<span class="keywordtype">int</span>)first, vport-&gt;stats,</div>
<div class="line">                    vport-&gt;stats_n) &lt;= 0) {</div>
<div class="line">            <a class="code" href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a>(ERR, VDPA, <span class="stringliteral">&quot;Failed to get vdpa queue statistics&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot; for device %s qid %d.\n&quot;</span>, res-&gt;bdf,</div>
<div class="line">                (<span class="keywordtype">int</span>)first);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line">        cmdline_printf(cl, <span class="stringliteral">&quot;\tVirtq %&quot;</span> PRIu32 <span class="stringliteral">&quot;:\n&quot;</span>, first);</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; vport-&gt;stats_n; ++i) {</div>
<div class="line">            cmdline_printf(cl, <span class="stringliteral">&quot;\t\t%-*s %-16&quot;</span> PRIu64 <span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">                <a name="a28"></a><a class="code" href="rte__vdpa_8h.html#afb9e92ae7797667239c02bdfa78068cf">RTE_VDPA_STATS_NAME_SIZE</a>,</div>
<div class="line">                vport-&gt;stats_names[vport-&gt;stats[i].id].name,</div>
<div class="line">                vport-&gt;stats[i].value);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">cmdline_parse_token_string_t cmd_device_stats_ =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cmd_stats_result, stats, <span class="stringliteral">&quot;stats&quot;</span>);</div>
<div class="line">cmdline_parse_token_string_t cmd_device_bdf =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cmd_stats_result, bdf, NULL);</div>
<div class="line">cmdline_parse_token_num_t cmd_queue_id =</div>
<div class="line">    TOKEN_NUM_INITIALIZER(<span class="keyword">struct</span> cmd_stats_result, qid, RTE_UINT32);</div>
<div class="line"> </div>
<div class="line">cmdline_parse_inst_t cmd_device_stats = {</div>
<div class="line">    .f = cmd_device_stats_parsed,</div>
<div class="line">    .data = NULL,</div>
<div class="line">    .help_str = <span class="stringliteral">&quot;stats: show device statistics&quot;</span>,</div>
<div class="line">    .tokens = {</div>
<div class="line">        (<span class="keywordtype">void</span> *)&amp;cmd_device_stats_,</div>
<div class="line">        (<span class="keywordtype">void</span> *)&amp;cmd_device_bdf,</div>
<div class="line">        (<span class="keywordtype">void</span> *)&amp;cmd_queue_id,</div>
<div class="line">        NULL,</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* *** QUIT *** */</span></div>
<div class="line"><span class="keyword">struct </span>cmd_quit_result {</div>
<div class="line">    cmdline_fixed_string_t quit;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> cmd_quit_parsed(<a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">void</span> *parsed_result,</div>
<div class="line">        <span class="keyword">struct</span> cmdline *cl,</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keywordtype">void</span> *data)</div>
<div class="line">{</div>
<div class="line">    vdpa_sample_quit();</div>
<div class="line">    cmdline_quit(cl);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">cmdline_parse_token_string_t cmd_quit_quit =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cmd_quit_result, quit, <span class="stringliteral">&quot;quit&quot;</span>);</div>
<div class="line"> </div>
<div class="line">cmdline_parse_inst_t cmd_quit = {</div>
<div class="line">    .f = cmd_quit_parsed,</div>
<div class="line">    .data = NULL,</div>
<div class="line">    .help_str = <span class="stringliteral">&quot;quit: exit application&quot;</span>,</div>
<div class="line">    .tokens = {</div>
<div class="line">        (<span class="keywordtype">void</span> *)&amp;cmd_quit_quit,</div>
<div class="line">        NULL,</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line">cmdline_parse_ctx_t main_ctx[] = {</div>
<div class="line">    (cmdline_parse_inst_t *)&amp;cmd_help,</div>
<div class="line">    (cmdline_parse_inst_t *)&amp;cmd_list_vdpa_devices,</div>
<div class="line">    (cmdline_parse_inst_t *)&amp;cmd_create_vdpa_port,</div>
<div class="line">    (cmdline_parse_inst_t *)&amp;cmd_device_stats,</div>
<div class="line">    (cmdline_parse_inst_t *)&amp;cmd_quit,</div>
<div class="line">    NULL,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> ch;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line">    <span class="keyword">struct </span>cmdline *cl;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__vdpa__device.html">rte_vdpa_device</a> *vdev;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__device.html">rte_device</a> *dev;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__dev__iterator.html">rte_dev_iterator</a> dev_iter;</div>
<div class="line"> </div>
<div class="line">    ret = <a name="a29"></a><a class="code" href="rte__eal_8h.html#a5c3f4dddc25e38c5a186ecd8a69260e3">rte_eal_init</a>(argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;eal init failed\n&quot;</span>);</div>
<div class="line">    argc -= ret;</div>
<div class="line">    argv += ret;</div>
<div class="line"> </div>
<div class="line">    signal(SIGINT, signal_handler);</div>
<div class="line">    signal(SIGTERM, signal_handler);</div>
<div class="line"> </div>
<div class="line">    ret = parse_args(argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">        <a class="code" href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a>(EXIT_FAILURE, <span class="stringliteral">&quot;invalid argument\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (interactive == 1) {</div>
<div class="line">        cl = cmdline_stdin_new(main_ctx, <span class="stringliteral">&quot;vdpa&gt; &quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (cl == NULL)</div>
<div class="line">            <a name="a30"></a><a class="code" href="rte__debug_8h.html#a9fcab5683ce1c1164c52c17579cc2b5f">rte_panic</a>(<span class="stringliteral">&quot;Cannot create cmdline instance\n&quot;</span>);</div>
<div class="line">        cmdline_interact(cl);</div>
<div class="line">        cmdline_stdin_exit(cl);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        RTE_DEV_FOREACH(dev, <span class="stringliteral">&quot;class=vdpa&quot;</span>, &amp;dev_iter) {</div>
<div class="line">            vdev = <a class="code" href="rte__vdpa_8h.html#ad67302329133e95629ab8368a59b65a9">rte_vdpa_find_device_by_name</a>(dev-&gt;<a class="code" href="structrte__device.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);</div>
<div class="line">            <span class="keywordflow">if</span> (vdev == NULL) {</div>
<div class="line">                <a class="code" href="rte__debug_8h.html#a9fcab5683ce1c1164c52c17579cc2b5f">rte_panic</a>(<span class="stringliteral">&quot;Failed to find vDPA dev for %s\n&quot;</span>,</div>
<div class="line">                        dev-&gt;<a class="code" href="structrte__device.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);</div>
<div class="line">            }</div>
<div class="line">            vports[devcnt].dev = vdev;</div>
<div class="line">            snprintf(vports[devcnt].ifname, MAX_PATH_LEN, <span class="stringliteral">&quot;%s%d&quot;</span>,</div>
<div class="line">                    iface, devcnt);</div>
<div class="line"> </div>
<div class="line">            start_vdpa(&amp;vports[devcnt]);</div>
<div class="line">            devcnt++;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        printf(<span class="stringliteral">&quot;enter \&#39;q\&#39; to quit\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">while</span> (scanf(<span class="stringliteral">&quot;%c&quot;</span>, &amp;ch)) {</div>
<div class="line">            <span class="keywordflow">if</span> (ch == <span class="charliteral">&#39;q&#39;</span>)</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">while</span> (ch != <span class="charliteral">&#39;\n&#39;</span>) {</div>
<div class="line">                <span class="keywordflow">if</span> (scanf(<span class="stringliteral">&quot;%c&quot;</span>, &amp;ch))</div>
<div class="line">                    printf(<span class="stringliteral">&quot;%c&quot;</span>, ch);</div>
<div class="line">            }</div>
<div class="line">            printf(<span class="stringliteral">&quot;enter \&#39;q\&#39; to quit\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        vdpa_sample_quit();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<div class="ttc" id="astructvhost__device__ops_html_a4395345b85225cd12bf33d36ac089f63"><div class="ttname"><a href="structvhost__device__ops.html#a4395345b85225cd12bf33d36ac089f63">vhost_device_ops::new_device</a></div><div class="ttdeci">int(* new_device)(int vid)</div><div class="ttdef"><b>Definition:</b> <a href="rte__vhost_8h_source.html#l00267">rte_vhost.h:267</a></div></div>
<div class="ttc" id="arte__vhost_8h_html_a794f0d9c9550fe705a9b090c72cfe7be"><div class="ttname"><a href="rte__vhost_8h.html#a794f0d9c9550fe705a9b090c72cfe7be">rte_vhost_driver_start</a></div><div class="ttdeci">int rte_vhost_driver_start(const char *path)</div></div>
<div class="ttc" id="arte__vhost_8h_html_a8a3ce366de790a49a0b64f1d7e42eea6"><div class="ttname"><a href="rte__vhost_8h.html#a8a3ce366de790a49a0b64f1d7e42eea6">rte_vhost_driver_register</a></div><div class="ttdeci">int rte_vhost_driver_register(const char *path, uint64_t flags)</div></div>
<div class="ttc" id="arte__malloc_8h_html_aaf0f048a5fd1672688c662cdfb4536b3"><div class="ttname"><a href="rte__malloc_8h.html#aaf0f048a5fd1672688c662cdfb4536b3">rte_zmalloc</a></div><div class="ttdeci">void * rte_zmalloc(const char *type, size_t size, unsigned align) __rte_alloc_size(2)</div></div>
<div class="ttc" id="arte__vhost_8h_html"><div class="ttname"><a href="rte__vhost_8h.html">rte_vhost.h</a></div></div>
<div class="ttc" id="arte__malloc_8h_html"><div class="ttname"><a href="rte__malloc_8h.html">rte_malloc.h</a></div></div>
<div class="ttc" id="arte__string__fns_8h_html_ab58c1aa83cc80f72e57b88d590f95b8b"><div class="ttname"><a href="rte__string__fns_8h.html#ab58c1aa83cc80f72e57b88d590f95b8b">rte_strscpy</a></div><div class="ttdeci">ssize_t rte_strscpy(char *dst, const char *src, size_t dsize)</div></div>
<div class="ttc" id="arte__string__fns_8h_html"><div class="ttname"><a href="rte__string__fns_8h.html">rte_string_fns.h</a></div></div>
<div class="ttc" id="arte__vdpa_8h_html_a3afe5a5916b5fb995f2c6580846f3b97"><div class="ttname"><a href="rte__vdpa_8h.html#a3afe5a5916b5fb995f2c6580846f3b97">rte_vdpa_get_queue_num</a></div><div class="ttdeci">int rte_vdpa_get_queue_num(struct rte_vdpa_device *dev, uint32_t *queue_num)</div></div>
<div class="ttc" id="astructvhost__device__ops_html_adbd762e64dae12b68686afcf873cd808"><div class="ttname"><a href="structvhost__device__ops.html#adbd762e64dae12b68686afcf873cd808">vhost_device_ops::destroy_device</a></div><div class="ttdeci">void(* destroy_device)(int vid)</div><div class="ttdef"><b>Definition:</b> <a href="rte__vhost_8h_source.html#l00268">rte_vhost.h:268</a></div></div>
<div class="ttc" id="arte__vdpa_8h_html_a9fddb2ba1019bdad9626c34c719faef9"><div class="ttname"><a href="rte__vdpa_8h.html#a9fddb2ba1019bdad9626c34c719faef9">rte_vdpa_get_features</a></div><div class="ttdeci">int rte_vdpa_get_features(struct rte_vdpa_device *dev, uint64_t *features)</div></div>
<div class="ttc" id="arte__vdpa_8h_html_afb9e92ae7797667239c02bdfa78068cf"><div class="ttname"><a href="rte__vdpa_8h.html#afb9e92ae7797667239c02bdfa78068cf">RTE_VDPA_STATS_NAME_SIZE</a></div><div class="ttdeci">#define RTE_VDPA_STATS_NAME_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="rte__vdpa_8h_source.html#l00015">rte_vdpa.h:15</a></div></div>
<div class="ttc" id="arte__vdpa_8h_html_adeb12929ea9c70d6216fa848275b69c7"><div class="ttname"><a href="rte__vdpa_8h.html#adeb12929ea9c70d6216fa848275b69c7">rte_vdpa_get_stats_names</a></div><div class="ttdeci">int rte_vdpa_get_stats_names(struct rte_vdpa_device *dev, struct rte_vdpa_stat_name *stats_names, unsigned int size)</div></div>
<div class="ttc" id="astructrte__dev__iterator_html"><div class="ttname"><a href="structrte__dev__iterator.html">rte_dev_iterator</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__dev_8h_source.html#l00238">rte_dev.h:238</a></div></div>
<div class="ttc" id="arte__common_8h_html_ac5169870c983b3463cb226bdb8a94880"><div class="ttname"><a href="rte__common_8h.html#ac5169870c983b3463cb226bdb8a94880">rte_exit</a></div><div class="ttdeci">__rte_noreturn void rte_exit(int exit_code, const char *format,...) __rte_format_printf(2</div></div>
<div class="ttc" id="arte__vhost_8h_html_a16848dac4304c973b24ced868ac3add8"><div class="ttname"><a href="rte__vhost_8h.html#a16848dac4304c973b24ced868ac3add8">rte_vhost_get_ifname</a></div><div class="ttdeci">int rte_vhost_get_ifname(int vid, char *buf, size_t len)</div></div>
<div class="ttc" id="arte__common_8h_html_a4c7571cbcdbfe9b63431036af811bee9"><div class="ttname"><a href="rte__common_8h.html#a4c7571cbcdbfe9b63431036af811bee9">RTE_MIN</a></div><div class="ttdeci">#define RTE_MIN(a, b)</div><div class="ttdef"><b>Definition:</b> <a href="rte__common_8h_source.html#l00573">rte_common.h:573</a></div></div>
<div class="ttc" id="arte__vdpa_8h_html_ad67302329133e95629ab8368a59b65a9"><div class="ttname"><a href="rte__vdpa_8h.html#ad67302329133e95629ab8368a59b65a9">rte_vdpa_find_device_by_name</a></div><div class="ttdeci">struct rte_vdpa_device * rte_vdpa_find_device_by_name(const char *name)</div></div>
<div class="ttc" id="arte__vhost_8h_html_aeac1c327c1179055fd1b505bf9c486e2"><div class="ttname"><a href="rte__vhost_8h.html#aeac1c327c1179055fd1b505bf9c486e2">rte_vhost_driver_detach_vdpa_device</a></div><div class="ttdeci">int rte_vhost_driver_detach_vdpa_device(const char *path)</div></div>
<div class="ttc" id="arte__vhost_8h_html_a07fe188216c6544b0b62baf911622c99"><div class="ttname"><a href="rte__vhost_8h.html#a07fe188216c6544b0b62baf911622c99">rte_vhost_get_vring_num</a></div><div class="ttdeci">uint16_t rte_vhost_get_vring_num(int vid)</div></div>
<div class="ttc" id="arte__debug_8h_html_a9fcab5683ce1c1164c52c17579cc2b5f"><div class="ttname"><a href="rte__debug_8h.html#a9fcab5683ce1c1164c52c17579cc2b5f">rte_panic</a></div><div class="ttdeci">#define rte_panic(...)</div><div class="ttdef"><b>Definition:</b> <a href="rte__debug_8h_source.html#l00043">rte_debug.h:43</a></div></div>
<div class="ttc" id="astructvhost__device__ops_html"><div class="ttname"><a href="structvhost__device__ops.html">vhost_device_ops</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__vhost_8h_source.html#l00266">rte_vhost.h:266</a></div></div>
<div class="ttc" id="astructrte__device_html_a8f8f80d37794cde9472343e4487ba3eb"><div class="ttname"><a href="structrte__device.html#a8f8f80d37794cde9472343e4487ba3eb">rte_device::name</a></div><div class="ttdeci">const char * name</div><div class="ttdef"><b>Definition:</b> <a href="rte__dev_8h_source.html#l00094">rte_dev.h:94</a></div></div>
<div class="ttc" id="arte__pci_8h_html"><div class="ttname"><a href="rte__pci_8h.html">rte_pci.h</a></div></div>
<div class="ttc" id="arte__common_8h_html_ae1a7c8799cb57669ae2ddf367b21533f"><div class="ttname"><a href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a></div><div class="ttdeci">#define __rte_unused</div><div class="ttdef"><b>Definition:</b> <a href="rte__common_8h_source.html#l00116">rte_common.h:116</a></div></div>
<div class="ttc" id="arte__eal_8h_html_a5c3f4dddc25e38c5a186ecd8a69260e3"><div class="ttname"><a href="rte__eal_8h.html#a5c3f4dddc25e38c5a186ecd8a69260e3">rte_eal_init</a></div><div class="ttdeci">int rte_eal_init(int argc, char **argv)</div></div>
<div class="ttc" id="astructrte__vdpa__stat__name_html"><div class="ttname"><a href="structrte__vdpa__stat__name.html">rte_vdpa_stat_name</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__vdpa_8h_source.html#l00040">rte_vdpa.h:40</a></div></div>
<div class="ttc" id="arte__vdpa_8h_html"><div class="ttname"><a href="rte__vdpa_8h.html">rte_vdpa.h</a></div></div>
<div class="ttc" id="arte__ethdev_8h_html"><div class="ttname"><a href="rte__ethdev_8h.html">rte_ethdev.h</a></div></div>
<div class="ttc" id="arte__vdpa_8h_html_acb952a4ce37a1196994cca301b35d4d2"><div class="ttname"><a href="rte__vdpa_8h.html#acb952a4ce37a1196994cca301b35d4d2">rte_vdpa_get_rte_device</a></div><div class="ttdeci">struct rte_device * rte_vdpa_get_rte_device(struct rte_vdpa_device *vdpa_dev)</div></div>
<div class="ttc" id="acmdline_8h_html"><div class="ttname"><a href="cmdline_8h.html">cmdline.h</a></div></div>
<div class="ttc" id="arte__vhost_8h_html_a626b366c380069fcc0bc437a14d612aa"><div class="ttname"><a href="rte__vhost_8h.html#a626b366c380069fcc0bc437a14d612aa">rte_vhost_driver_attach_vdpa_device</a></div><div class="ttdeci">int rte_vhost_driver_attach_vdpa_device(const char *path, struct rte_vdpa_device *dev)</div></div>
<div class="ttc" id="arte__log_8h_html_ac23caeb9833fd0fd0665c6c05ec806fe"><div class="ttname"><a href="rte__log_8h.html#ac23caeb9833fd0fd0665c6c05ec806fe">RTE_LOG</a></div><div class="ttdeci">#define RTE_LOG(l, t,...)</div><div class="ttdef"><b>Definition:</b> <a href="rte__log_8h_source.html#l00331">rte_log.h:331</a></div></div>
<div class="ttc" id="arte__vdpa_8h_html_a6649eeec1ee3abc8701f4d1d9514259a"><div class="ttname"><a href="rte__vdpa_8h.html#a6649eeec1ee3abc8701f4d1d9514259a">rte_vdpa_get_stats</a></div><div class="ttdeci">int rte_vdpa_get_stats(struct rte_vdpa_device *dev, uint16_t qid, struct rte_vdpa_stat *stats, unsigned int n)</div></div>
<div class="ttc" id="astructrte__vdpa__stat_html"><div class="ttname"><a href="structrte__vdpa__stat.html">rte_vdpa_stat</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__vdpa_8h_source.html#l00028">rte_vdpa.h:28</a></div></div>
<div class="ttc" id="astructrte__vdpa__device_html"><div class="ttname"><a href="structrte__vdpa__device.html">rte_vdpa_device</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__vdpa__dev_8h_source.html#l00072">rte_vdpa_dev.h:72</a></div></div>
<div class="ttc" id="astructrte__device_html"><div class="ttname"><a href="structrte__device.html">rte_device</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__dev_8h_source.html#l00092">rte_dev.h:92</a></div></div>
<div class="ttc" id="arte__malloc_8h_html_a1fc82f67711b13aca7e05dc9d58f9dbd"><div class="ttname"><a href="rte__malloc_8h.html#a1fc82f67711b13aca7e05dc9d58f9dbd">rte_free</a></div><div class="ttdeci">void void rte_free(void *ptr)</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20
</small></address>
</body>
</html>
