<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DPDK: examples/ipsec-secgw/parser.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DPDK
   &#160;<span id="projectnumber">20.11.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">examples/ipsec-secgw/parser.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/* SPDX-License-Identifier: BSD-3-Clause</span></div>
<div class="line"><span class="comment"> * Copyright(c) 2016 Intel Corporation</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#include &lt;arpa/inet.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/socket.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__common_8h.html">rte_common.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__crypto_8h.html">rte_crypto.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rte__string__fns_8h.html">rte_string_fns.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;cmdline_parse_string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cmdline_parse_num.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cmdline_parse_ipaddr.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cmdline_socket.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cmdline_8h.html">cmdline.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;flow.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ipsec.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;parser.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define PARSE_DELIMITER     &quot; \f\n\r\t\v&quot;</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_tokenize_string(<span class="keywordtype">char</span> *<span class="keywordtype">string</span>, <span class="keywordtype">char</span> *tokens[], uint32_t *n_tokens)</div>
<div class="line">{</div>
<div class="line">    uint32_t i;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ((<span class="keywordtype">string</span> == NULL) ||</div>
<div class="line">        (tokens == NULL) ||</div>
<div class="line">        (*n_tokens &lt; 1))</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; *n_tokens; i++) {</div>
<div class="line">        tokens[i] = strtok_r(<span class="keywordtype">string</span>, PARSE_DELIMITER, &amp;<span class="keywordtype">string</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (tokens[i] == NULL)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ((i == *n_tokens) &amp;&amp;</div>
<div class="line">        (NULL != strtok_r(<span class="keywordtype">string</span>, PARSE_DELIMITER, &amp;<span class="keywordtype">string</span>)))</div>
<div class="line">        <span class="keywordflow">return</span> -E2BIG;</div>
<div class="line"> </div>
<div class="line">    *n_tokens = i;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">parse_ipv4_addr(<span class="keyword">const</span> <span class="keywordtype">char</span> *token, <span class="keyword">struct</span> in_addr *ipv4, uint32_t *mask)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> ip_str[INET_ADDRSTRLEN] = {0};</div>
<div class="line">    <span class="keywordtype">char</span> *pch;</div>
<div class="line"> </div>
<div class="line">    pch = strchr(token, <span class="charliteral">&#39;/&#39;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (pch != NULL) {</div>
<div class="line">        strlcpy(ip_str, token,</div>
<div class="line">            <a name="a0"></a><a class="code" href="rte__common_8h.html#a4c7571cbcdbfe9b63431036af811bee9">RTE_MIN</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="keywordtype">long</span>)(pch - token + 1),</div>
<div class="line">            <span class="keyword">sizeof</span>(ip_str)));</div>
<div class="line">        pch += 1;</div>
<div class="line">        <span class="keywordflow">if</span> (is_str_num(pch) != 0)</div>
<div class="line">            <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line">        <span class="keywordflow">if</span> (mask)</div>
<div class="line">            *mask = atoi(pch);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        strlcpy(ip_str, token, <span class="keyword">sizeof</span>(ip_str));</div>
<div class="line">        <span class="keywordflow">if</span> (mask)</div>
<div class="line">            *mask = 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (strlen(ip_str) &gt;= INET_ADDRSTRLEN)</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (inet_pton(AF_INET, ip_str, ipv4) != 1)</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">parse_ipv6_addr(<span class="keyword">const</span> <span class="keywordtype">char</span> *token, <span class="keyword">struct</span> in6_addr *ipv6, uint32_t *mask)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> ip_str[256] = {0};</div>
<div class="line">    <span class="keywordtype">char</span> *pch;</div>
<div class="line"> </div>
<div class="line">    pch = strchr(token, <span class="charliteral">&#39;/&#39;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (pch != NULL) {</div>
<div class="line">        strlcpy(ip_str, token,</div>
<div class="line">            <a class="code" href="rte__common_8h.html#a4c7571cbcdbfe9b63431036af811bee9">RTE_MIN</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="keywordtype">long</span>)(pch - token + 1),</div>
<div class="line">                    <span class="keyword">sizeof</span>(ip_str)));</div>
<div class="line">        pch += 1;</div>
<div class="line">        <span class="keywordflow">if</span> (is_str_num(pch) != 0)</div>
<div class="line">            <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line">        <span class="keywordflow">if</span> (mask)</div>
<div class="line">            *mask = atoi(pch);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        strlcpy(ip_str, token, <span class="keyword">sizeof</span>(ip_str));</div>
<div class="line">        <span class="keywordflow">if</span> (mask)</div>
<div class="line">            *mask = 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (strlen(ip_str) &gt;= INET6_ADDRSTRLEN)</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (inet_pton(AF_INET6, ip_str, ipv6) != 1)</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">parse_range(<span class="keyword">const</span> <span class="keywordtype">char</span> *token, uint16_t *low, uint16_t *high)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> ch;</div>
<div class="line">    <span class="keywordtype">char</span> num_str[20];</div>
<div class="line">    uint32_t pos;</div>
<div class="line">    <span class="keywordtype">int</span> range_low = -1;</div>
<div class="line">    <span class="keywordtype">int</span> range_high = -1;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!low || !high)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"> </div>
<div class="line">    memset(num_str, 0, 20);</div>
<div class="line">    pos = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> ((ch = *token++) != <span class="charliteral">&#39;\0&#39;</span>) {</div>
<div class="line">        <span class="keywordflow">if</span> (isdigit(ch)) {</div>
<div class="line">            <span class="keywordflow">if</span> (pos &gt;= 19)</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            num_str[pos++] = ch;</div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch == <span class="charliteral">&#39;:&#39;</span>) {</div>
<div class="line">            <span class="keywordflow">if</span> (range_low != -1)</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            range_low = atoi(num_str);</div>
<div class="line">            memset(num_str, 0, 20);</div>
<div class="line">            pos = 0;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (strlen(num_str) == 0)</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line"> </div>
<div class="line">    range_high = atoi(num_str);</div>
<div class="line"> </div>
<div class="line">    *low = (uint16_t)range_low;</div>
<div class="line">    *high = (uint16_t)range_high;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * helper function for parse_mac, parse one section of the ether addr.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *</div>
<div class="line">parse_uint8x16(<span class="keyword">const</span> <span class="keywordtype">char</span> *s, uint8_t *v, uint8_t ls)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *end;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> t;</div>
<div class="line"> </div>
<div class="line">    errno = 0;</div>
<div class="line">    t = strtoul(s, &amp;end, 16);</div>
<div class="line">    <span class="keywordflow">if</span> (errno != 0 || end[0] != ls || t &gt; UINT8_MAX)</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    v[0] = t;</div>
<div class="line">    <span class="keywordflow">return</span> end + 1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_mac(<span class="keyword">const</span> <span class="keywordtype">char</span> *str, <span class="keyword">struct</span> <a name="_a1"></a><a class="code" href="structrte__ether__addr.html">rte_ether_addr</a> *addr)</div>
<div class="line">{</div>
<div class="line">    uint32_t i;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> uint8_t stop_sym[<a name="a2"></a><a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(addr-&gt;<a name="a3"></a><a class="code" href="structrte__ether__addr.html#ad6f7cb65b39d12b5250ecf82c8ffaa45">addr_bytes</a>)] = {</div>
<div class="line">        [0] = <span class="charliteral">&#39;:&#39;</span>,</div>
<div class="line">        [1] = <span class="charliteral">&#39;:&#39;</span>,</div>
<div class="line">        [2] = <span class="charliteral">&#39;:&#39;</span>,</div>
<div class="line">        [3] = <span class="charliteral">&#39;:&#39;</span>,</div>
<div class="line">        [4] = <span class="charliteral">&#39;:&#39;</span>,</div>
<div class="line">        [5] = 0,</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i != <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(addr-&gt;<a class="code" href="structrte__ether__addr.html#ad6f7cb65b39d12b5250ecf82c8ffaa45">addr_bytes</a>); i++) {</div>
<div class="line">        str = parse_uint8x16(str, addr-&gt;<a class="code" href="structrte__ether__addr.html#ad6f7cb65b39d12b5250ecf82c8ffaa45">addr_bytes</a> + i, stop_sym[i]);</div>
<div class="line">        <span class="keywordflow">if</span> (str == NULL)</div>
<div class="line">            <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>cfg_sp_add_cfg_item {</div>
<div class="line">    cmdline_fixed_string_t sp_keyword;</div>
<div class="line">    cmdline_multi_string_t multi_string;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">cfg_sp_add_cfg_item_parsed(<span class="keywordtype">void</span> *parsed_result,</div>
<div class="line">    <a name="a4"></a><a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keyword">struct</span> cmdline *cl, <span class="keywordtype">void</span> *data)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>cfg_sp_add_cfg_item *params = parsed_result;</div>
<div class="line">    <span class="keywordtype">char</span> *tokens[32];</div>
<div class="line">    uint32_t n_tokens = <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(tokens);</div>
<div class="line">    <span class="keyword">struct </span>parse_status *status = (<span class="keyword">struct </span>parse_status *)data;</div>
<div class="line"> </div>
<div class="line">    APP_CHECK((parse_tokenize_string(params-&gt;multi_string, tokens,</div>
<div class="line">        &amp;n_tokens) == 0), status, <span class="stringliteral">&quot;too many arguments&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (strcmp(tokens[0], <span class="stringliteral">&quot;ipv4&quot;</span>) == 0) {</div>
<div class="line">        parse_sp4_tokens(tokens, n_tokens, status);</div>
<div class="line">        <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(tokens[0], <span class="stringliteral">&quot;ipv6&quot;</span>) == 0) {</div>
<div class="line">        parse_sp6_tokens(tokens, n_tokens, status);</div>
<div class="line">        <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        APP_CHECK(0, status, <span class="stringliteral">&quot;unrecognizable input %s\n&quot;</span>,</div>
<div class="line">            tokens[0]);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> cmdline_parse_token_string_t cfg_sp_add_sp_str =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cfg_sp_add_cfg_item,</div>
<div class="line">        sp_keyword, <span class="stringliteral">&quot;sp&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> cmdline_parse_token_string_t cfg_sp_add_multi_str =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cfg_sp_add_cfg_item, multi_string,</div>
<div class="line">        TOKEN_STRING_MULTI);</div>
<div class="line"> </div>
<div class="line">cmdline_parse_inst_t cfg_sp_add_rule = {</div>
<div class="line">    .f = cfg_sp_add_cfg_item_parsed,</div>
<div class="line">    .data = NULL,</div>
<div class="line">    .help_str = <span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">    .tokens = {</div>
<div class="line">        (<span class="keywordtype">void</span> *) &amp;cfg_sp_add_sp_str,</div>
<div class="line">        (<span class="keywordtype">void</span> *) &amp;cfg_sp_add_multi_str,</div>
<div class="line">        NULL,</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* sa add parse */</span></div>
<div class="line"><span class="keyword">struct </span>cfg_sa_add_cfg_item {</div>
<div class="line">    cmdline_fixed_string_t sa_keyword;</div>
<div class="line">    cmdline_multi_string_t multi_string;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">cfg_sa_add_cfg_item_parsed(<span class="keywordtype">void</span> *parsed_result,</div>
<div class="line">    <a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keyword">struct</span> cmdline *cl, <span class="keywordtype">void</span> *data)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>cfg_sa_add_cfg_item *params = parsed_result;</div>
<div class="line">    <span class="keywordtype">char</span> *tokens[32];</div>
<div class="line">    uint32_t n_tokens = <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(tokens);</div>
<div class="line">    <span class="keyword">struct </span>parse_status *status = (<span class="keyword">struct </span>parse_status *)data;</div>
<div class="line"> </div>
<div class="line">    APP_CHECK(parse_tokenize_string(params-&gt;multi_string, tokens,</div>
<div class="line">        &amp;n_tokens) == 0, status, <span class="stringliteral">&quot;too many arguments\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    parse_sa_tokens(tokens, n_tokens, status);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> cmdline_parse_token_string_t cfg_sa_add_sa_str =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cfg_sa_add_cfg_item,</div>
<div class="line">        sa_keyword, <span class="stringliteral">&quot;sa&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> cmdline_parse_token_string_t cfg_sa_add_multi_str =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cfg_sa_add_cfg_item, multi_string,</div>
<div class="line">        TOKEN_STRING_MULTI);</div>
<div class="line"> </div>
<div class="line">cmdline_parse_inst_t cfg_sa_add_rule = {</div>
<div class="line">    .f = cfg_sa_add_cfg_item_parsed,</div>
<div class="line">    .data = NULL,</div>
<div class="line">    .help_str = <span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">    .tokens = {</div>
<div class="line">        (<span class="keywordtype">void</span> *) &amp;cfg_sa_add_sa_str,</div>
<div class="line">        (<span class="keywordtype">void</span> *) &amp;cfg_sa_add_multi_str,</div>
<div class="line">        NULL,</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* rt add parse */</span></div>
<div class="line"><span class="keyword">struct </span>cfg_rt_add_cfg_item {</div>
<div class="line">    cmdline_fixed_string_t rt_keyword;</div>
<div class="line">    cmdline_multi_string_t multi_string;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">cfg_rt_add_cfg_item_parsed(<span class="keywordtype">void</span> *parsed_result,</div>
<div class="line">    <a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keyword">struct</span> cmdline *cl, <span class="keywordtype">void</span> *data)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>cfg_rt_add_cfg_item *params = parsed_result;</div>
<div class="line">    <span class="keywordtype">char</span> *tokens[32];</div>
<div class="line">    uint32_t n_tokens = <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(tokens);</div>
<div class="line">    <span class="keyword">struct </span>parse_status *status = (<span class="keyword">struct </span>parse_status *)data;</div>
<div class="line"> </div>
<div class="line">    APP_CHECK(parse_tokenize_string(</div>
<div class="line">        params-&gt;multi_string, tokens, &amp;n_tokens) == 0,</div>
<div class="line">        status, <span class="stringliteral">&quot;too many arguments\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    parse_rt_tokens(tokens, n_tokens, status);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> cmdline_parse_token_string_t cfg_rt_add_rt_str =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cfg_rt_add_cfg_item,</div>
<div class="line">        rt_keyword, <span class="stringliteral">&quot;rt&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> cmdline_parse_token_string_t cfg_rt_add_multi_str =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cfg_rt_add_cfg_item, multi_string,</div>
<div class="line">        TOKEN_STRING_MULTI);</div>
<div class="line"> </div>
<div class="line">cmdline_parse_inst_t cfg_rt_add_rule = {</div>
<div class="line">    .f = cfg_rt_add_cfg_item_parsed,</div>
<div class="line">    .data = NULL,</div>
<div class="line">    .help_str = <span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">    .tokens = {</div>
<div class="line">        (<span class="keywordtype">void</span> *) &amp;cfg_rt_add_rt_str,</div>
<div class="line">        (<span class="keywordtype">void</span> *) &amp;cfg_rt_add_multi_str,</div>
<div class="line">        NULL,</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* flow add parse */</span></div>
<div class="line"><span class="keyword">struct </span>cfg_flow_add_cfg_item {</div>
<div class="line">    cmdline_fixed_string_t flow_keyword;</div>
<div class="line">    cmdline_multi_string_t multi_string;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">cfg_flow_add_cfg_item_parsed(<span class="keywordtype">void</span> *parsed_result,</div>
<div class="line">    <a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keyword">struct</span> cmdline *cl, <span class="keywordtype">void</span> *data)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>cfg_flow_add_cfg_item *params = parsed_result;</div>
<div class="line">    <span class="keywordtype">char</span> *tokens[32];</div>
<div class="line">    uint32_t n_tokens = <a class="code" href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a>(tokens);</div>
<div class="line">    <span class="keyword">struct </span>parse_status *status = (<span class="keyword">struct </span>parse_status *)data;</div>
<div class="line"> </div>
<div class="line">    APP_CHECK(parse_tokenize_string(</div>
<div class="line">        params-&gt;multi_string, tokens, &amp;n_tokens) == 0,</div>
<div class="line">        status, <span class="stringliteral">&quot;too many arguments\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (status-&gt;status &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    parse_flow_tokens(tokens, n_tokens, status);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> cmdline_parse_token_string_t cfg_flow_add_flow_str =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cfg_flow_add_cfg_item,</div>
<div class="line">        flow_keyword, <span class="stringliteral">&quot;flow&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> cmdline_parse_token_string_t cfg_flow_add_multi_str =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cfg_flow_add_cfg_item, multi_string,</div>
<div class="line">        TOKEN_STRING_MULTI);</div>
<div class="line"> </div>
<div class="line">cmdline_parse_inst_t cfg_flow_add_rule = {</div>
<div class="line">    .f = cfg_flow_add_cfg_item_parsed,</div>
<div class="line">    .data = NULL,</div>
<div class="line">    .help_str = <span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">    .tokens = {</div>
<div class="line">        (<span class="keywordtype">void</span> *) &amp;cfg_flow_add_flow_str,</div>
<div class="line">        (<span class="keywordtype">void</span> *) &amp;cfg_flow_add_multi_str,</div>
<div class="line">        NULL,</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* neigh add parse */</span></div>
<div class="line"><span class="keyword">struct </span>cfg_neigh_add_item {</div>
<div class="line">    cmdline_fixed_string_t neigh;</div>
<div class="line">    cmdline_fixed_string_t pstr;</div>
<div class="line">    uint16_t port;</div>
<div class="line">    cmdline_fixed_string_t mac;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">cfg_parse_neigh(<span class="keywordtype">void</span> *parsed_result, <a class="code" href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a> <span class="keyword">struct</span> cmdline *cl,</div>
<div class="line">    <span class="keywordtype">void</span> *data)</div>
<div class="line">{</div>
<div class="line">    int32_t rc;</div>
<div class="line">    <span class="keyword">struct </span>cfg_neigh_add_item *res;</div>
<div class="line">    <span class="keyword">struct </span>parse_status *st;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structrte__ether__addr.html">rte_ether_addr</a> mac;</div>
<div class="line"> </div>
<div class="line">    st = data;</div>
<div class="line">    res = parsed_result;</div>
<div class="line">    rc = parse_mac(res-&gt;mac, &amp;mac);</div>
<div class="line">    APP_CHECK(rc == 0, st, <span class="stringliteral">&quot;invalid ether addr:%s&quot;</span>, res-&gt;mac);</div>
<div class="line">    rc = add_dst_ethaddr(res-&gt;port, &amp;mac);</div>
<div class="line">    APP_CHECK(rc == 0, st, <span class="stringliteral">&quot;invalid port numer:%hu&quot;</span>, res-&gt;port);</div>
<div class="line">    <span class="keywordflow">if</span> (st-&gt;status &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">cmdline_parse_token_string_t cfg_add_neigh_start =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cfg_neigh_add_item, neigh, <span class="stringliteral">&quot;neigh&quot;</span>);</div>
<div class="line">cmdline_parse_token_string_t cfg_add_neigh_pstr =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cfg_neigh_add_item, pstr, <span class="stringliteral">&quot;port&quot;</span>);</div>
<div class="line">cmdline_parse_token_num_t cfg_add_neigh_port =</div>
<div class="line">    TOKEN_NUM_INITIALIZER(<span class="keyword">struct</span> cfg_neigh_add_item, port, RTE_UINT16);</div>
<div class="line">cmdline_parse_token_string_t cfg_add_neigh_mac =</div>
<div class="line">    TOKEN_STRING_INITIALIZER(<span class="keyword">struct</span> cfg_neigh_add_item, mac, NULL);</div>
<div class="line"> </div>
<div class="line">cmdline_parse_inst_t cfg_neigh_add_rule = {</div>
<div class="line">    .f = cfg_parse_neigh,</div>
<div class="line">    .data = NULL,</div>
<div class="line">    .help_str = <span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">    .tokens = {</div>
<div class="line">        (<span class="keywordtype">void</span> *)&amp;cfg_add_neigh_start,</div>
<div class="line">        (<span class="keywordtype">void</span> *)&amp;cfg_add_neigh_pstr,</div>
<div class="line">        (<span class="keywordtype">void</span> *)&amp;cfg_add_neigh_port,</div>
<div class="line">        (<span class="keywordtype">void</span> *)&amp;cfg_add_neigh_mac,</div>
<div class="line">        NULL,</div>
<div class="line">    },</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">cmdline_parse_ctx_t ipsec_ctx[] = {</div>
<div class="line">    (cmdline_parse_inst_t *)&amp;cfg_sp_add_rule,</div>
<div class="line">    (cmdline_parse_inst_t *)&amp;cfg_sa_add_rule,</div>
<div class="line">    (cmdline_parse_inst_t *)&amp;cfg_rt_add_rule,</div>
<div class="line">    (cmdline_parse_inst_t *)&amp;cfg_flow_add_rule,</div>
<div class="line">    (cmdline_parse_inst_t *)&amp;cfg_neigh_add_rule,</div>
<div class="line">    NULL,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">parse_cfg_file(<span class="keyword">const</span> <span class="keywordtype">char</span> *cfg_filename)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>cmdline *cl = cmdline_stdin_new(ipsec_ctx, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">    FILE *f = fopen(cfg_filename, <span class="stringliteral">&quot;r&quot;</span>);</div>
<div class="line">    <span class="keywordtype">char</span> str[1024] = {0}, *get_s = NULL;</div>
<div class="line">    uint32_t line_num = 0;</div>
<div class="line">    <span class="keyword">struct </span>parse_status status = {0};</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (f == NULL) {</div>
<div class="line">        <a name="a5"></a><a class="code" href="rte__debug_8h.html#a9fcab5683ce1c1164c52c17579cc2b5f">rte_panic</a>(<span class="stringliteral">&quot;Error: invalid file descriptor %s\n&quot;</span>, cfg_filename);</div>
<div class="line">        <span class="keywordflow">goto</span> error_exit;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (cl == NULL) {</div>
<div class="line">        <a class="code" href="rte__debug_8h.html#a9fcab5683ce1c1164c52c17579cc2b5f">rte_panic</a>(<span class="stringliteral">&quot;Error: cannot create cmdline instance\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">goto</span> error_exit;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    cfg_sp_add_rule.data = &amp;status;</div>
<div class="line">    cfg_sa_add_rule.data = &amp;status;</div>
<div class="line">    cfg_rt_add_rule.data = &amp;status;</div>
<div class="line">    cfg_flow_add_rule.data = &amp;status;</div>
<div class="line">    cfg_neigh_add_rule.data = &amp;status;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">do</span> {</div>
<div class="line">        <span class="keywordtype">char</span> oneline[1024];</div>
<div class="line">        <span class="keywordtype">char</span> *pos;</div>
<div class="line">        get_s = fgets(oneline, 1024, f);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (!get_s)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        line_num++;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (strlen(oneline) &gt; 1022) {</div>
<div class="line">            <a class="code" href="rte__debug_8h.html#a9fcab5683ce1c1164c52c17579cc2b5f">rte_panic</a>(<span class="stringliteral">&quot;%s:%u: error: &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;the line contains more characters the parser can handle\n&quot;</span>,</div>
<div class="line">                cfg_filename, line_num);</div>
<div class="line">            <span class="keywordflow">goto</span> error_exit;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* process comment char &#39;#&#39; */</span></div>
<div class="line">        <span class="keywordflow">if</span> (oneline[0] == <span class="charliteral">&#39;#&#39;</span>)</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"> </div>
<div class="line">        pos = strchr(oneline, <span class="charliteral">&#39;#&#39;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (pos != NULL)</div>
<div class="line">            *pos = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* process line concatenator &#39;\&#39; */</span></div>
<div class="line">        pos = strchr(oneline, 92);</div>
<div class="line">        <span class="keywordflow">if</span> (pos != NULL) {</div>
<div class="line">            <span class="keywordflow">if</span> (pos != oneline+strlen(oneline) - 2) {</div>
<div class="line">                <a class="code" href="rte__debug_8h.html#a9fcab5683ce1c1164c52c17579cc2b5f">rte_panic</a>(<span class="stringliteral">&quot;%s:%u: error: &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;no character should exist after &#39;\\&#39;\n&quot;</span>,</div>
<div class="line">                    cfg_filename, line_num);</div>
<div class="line">                <span class="keywordflow">goto</span> error_exit;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            *pos = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (strlen(oneline) + strlen(str) &gt; 1022) {</div>
<div class="line">                <a class="code" href="rte__debug_8h.html#a9fcab5683ce1c1164c52c17579cc2b5f">rte_panic</a>(<span class="stringliteral">&quot;%s:%u: error: &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;the concatenated line contains more characters the parser can handle\n&quot;</span>,</div>
<div class="line">                    cfg_filename, line_num);</div>
<div class="line">                <span class="keywordflow">goto</span> error_exit;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            strcpy(str + strlen(str), oneline);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* copy the line to str and process */</span></div>
<div class="line">        <span class="keywordflow">if</span> (strlen(oneline) + strlen(str) &gt; 1022) {</div>
<div class="line">            <a class="code" href="rte__debug_8h.html#a9fcab5683ce1c1164c52c17579cc2b5f">rte_panic</a>(<span class="stringliteral">&quot;%s:%u: error: &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;the line contains more characters the parser can handle\n&quot;</span>,</div>
<div class="line">                cfg_filename, line_num);</div>
<div class="line">            <span class="keywordflow">goto</span> error_exit;</div>
<div class="line">        }</div>
<div class="line">        strcpy(str + strlen(str), oneline);</div>
<div class="line"> </div>
<div class="line">        str[strlen(str)] = <span class="charliteral">&#39;\n&#39;</span>;</div>
<div class="line">        <span class="keywordflow">if</span> (cmdline_parse(cl, str) &lt; 0) {</div>
<div class="line">            <a class="code" href="rte__debug_8h.html#a9fcab5683ce1c1164c52c17579cc2b5f">rte_panic</a>(<span class="stringliteral">&quot;%s:%u: error: parsing \&quot;%s\&quot; failed\n&quot;</span>,</div>
<div class="line">                cfg_filename, line_num, str);</div>
<div class="line">            <span class="keywordflow">goto</span> error_exit;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (status.status &lt; 0) {</div>
<div class="line">            <a class="code" href="rte__debug_8h.html#a9fcab5683ce1c1164c52c17579cc2b5f">rte_panic</a>(<span class="stringliteral">&quot;%s:%u: error: %s&quot;</span>, cfg_filename,</div>
<div class="line">                line_num, status.parse_msg);</div>
<div class="line">            <span class="keywordflow">goto</span> error_exit;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        memset(str, 0, 1024);</div>
<div class="line">    } <span class="keywordflow">while</span> (1);</div>
<div class="line"> </div>
<div class="line">    cmdline_stdin_exit(cl);</div>
<div class="line">    fclose(f);</div>
<div class="line"> </div>
<div class="line">    sa_sort_arr();</div>
<div class="line">    sp4_sort_arr();</div>
<div class="line">    sp6_sort_arr();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line"> </div>
<div class="line">error_exit:</div>
<div class="line">    <span class="keywordflow">if</span> (cl)</div>
<div class="line">        cmdline_stdin_exit(cl);</div>
<div class="line">    <span class="keywordflow">if</span> (f)</div>
<div class="line">        fclose(f);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<div class="ttc" id="arte__crypto_8h_html"><div class="ttname"><a href="rte__crypto_8h.html">rte_crypto.h</a></div></div>
<div class="ttc" id="arte__string__fns_8h_html"><div class="ttname"><a href="rte__string__fns_8h.html">rte_string_fns.h</a></div></div>
<div class="ttc" id="arte__common_8h_html_ac963da91b35efa4700b73a1f4eb1d8a6"><div class="ttname"><a href="rte__common_8h.html#ac963da91b35efa4700b73a1f4eb1d8a6">RTE_DIM</a></div><div class="ttdeci">#define RTE_DIM(a)</div><div class="ttdef"><b>Definition:</b> <a href="rte__common_8h_source.html#l00809">rte_common.h:809</a></div></div>
<div class="ttc" id="arte__common_8h_html_a4c7571cbcdbfe9b63431036af811bee9"><div class="ttname"><a href="rte__common_8h.html#a4c7571cbcdbfe9b63431036af811bee9">RTE_MIN</a></div><div class="ttdeci">#define RTE_MIN(a, b)</div><div class="ttdef"><b>Definition:</b> <a href="rte__common_8h_source.html#l00573">rte_common.h:573</a></div></div>
<div class="ttc" id="arte__common_8h_html"><div class="ttname"><a href="rte__common_8h.html">rte_common.h</a></div></div>
<div class="ttc" id="arte__debug_8h_html_a9fcab5683ce1c1164c52c17579cc2b5f"><div class="ttname"><a href="rte__debug_8h.html#a9fcab5683ce1c1164c52c17579cc2b5f">rte_panic</a></div><div class="ttdeci">#define rte_panic(...)</div><div class="ttdef"><b>Definition:</b> <a href="rte__debug_8h_source.html#l00043">rte_debug.h:43</a></div></div>
<div class="ttc" id="arte__common_8h_html_ae1a7c8799cb57669ae2ddf367b21533f"><div class="ttname"><a href="rte__common_8h.html#ae1a7c8799cb57669ae2ddf367b21533f">__rte_unused</a></div><div class="ttdeci">#define __rte_unused</div><div class="ttdef"><b>Definition:</b> <a href="rte__common_8h_source.html#l00116">rte_common.h:116</a></div></div>
<div class="ttc" id="acmdline_8h_html"><div class="ttname"><a href="cmdline_8h.html">cmdline.h</a></div></div>
<div class="ttc" id="astructrte__ether__addr_html"><div class="ttname"><a href="structrte__ether__addr.html">rte_ether_addr</a></div><div class="ttdef"><b>Definition:</b> <a href="rte__ether_8h_source.html#l00064">rte_ether.h:64</a></div></div>
<div class="ttc" id="astructrte__ether__addr_html_ad6f7cb65b39d12b5250ecf82c8ffaa45"><div class="ttname"><a href="structrte__ether__addr.html#ad6f7cb65b39d12b5250ecf82c8ffaa45">rte_ether_addr::addr_bytes</a></div><div class="ttdeci">uint8_t addr_bytes[RTE_ETHER_ADDR_LEN]</div><div class="ttdef"><b>Definition:</b> <a href="rte__ether_8h_source.html#l00065">rte_ether.h:65</a></div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20
</small></address>
</body>
</html>
