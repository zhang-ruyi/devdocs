

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>44. Virtual Machine Power Management Application &mdash; Data Plane Development Kit 20.11.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="45. PTP Client Sample Application" href="ptpclient.html" />
    <link rel="prev" title="43. Distributor Sample Application" href="dist_app.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Data Plane Development Kit
          

          
            
            <img src="../_static/DPDK_logo_vertical_rev_small.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                20.11.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../linux_gsg/index.html">Getting Started Guide for Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../freebsd_gsg/index.html">Getting Started Guide for FreeBSD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../windows_gsg/index.html">Getting Started Guide for Windows</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Sample Applications User Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">1. Introduction to the DPDK Sample Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="compiling.html">2. Compiling the Sample Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="cmd_line.html">3. Command Line Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="ethtool.html">4. Ethtool Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world.html">5. Hello World Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="skeleton.html">6. Basic Forwarding Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="rxtx_callbacks.html">7. RX/TX Callbacks Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="flow_classify.html">8. Flow Classify Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="flow_filtering.html">9. Basic RTE Flow Filtering Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="ip_frag.html">10. IP Fragmentation Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipv4_multicast.html">11. IPv4 Multicast Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="ip_reassembly.html">12. IP Reassembly Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="kernel_nic_interface.html">13. Kernel NIC Interface Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="keep_alive.html">14. Keep Alive Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="ioat.html">15. Packet copying using IntelÂ® QuickData Technology</a></li>
<li class="toctree-l2"><a class="reference internal" href="l2_forward_crypto.html">16. L2 Forwarding with Crypto Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="l2_forward_job_stats.html">17. L2 Forwarding Sample Application (in Real and Virtualized Environments) with core load statistics.</a></li>
<li class="toctree-l2"><a class="reference internal" href="l2_forward_real_virtual.html">18. L2 Forwarding Sample Application (in Real and Virtualized Environments)</a></li>
<li class="toctree-l2"><a class="reference internal" href="l2_forward_event.html">19. L2 Forwarding Eventdev Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="l2_forward_cat.html">20. L2 Forwarding Sample Application with Cache Allocation Technology (CAT)</a></li>
<li class="toctree-l2"><a class="reference internal" href="l3_forward.html">21. L3 Forwarding Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="l3_forward_graph.html">22. L3 Forwarding Graph Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="l3_forward_power_man.html">23. L3 Forwarding with Power Management Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="l3_forward_access_ctrl.html">24. L3 Forwarding with Access Control Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_status_intr.html">25. Link Status Interrupt Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="server_node_efd.html">26. Server-Node EFD Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="service_cores.html">27. Service Cores Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi_process.html">28. Multi-process Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="qos_metering.html">29. QoS Metering Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="qos_scheduler.html">30. QoS Scheduler Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="timer.html">31. Timer Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="packet_ordering.html">32. Packet Ordering Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="vmdq_dcb_forwarding.html">33. VMDQ and DCB Forwarding Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="vmdq_forwarding.html">34. VMDq Forwarding Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="vhost.html">35. Vhost Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="vhost_blk.html">36. Vhost_blk Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="vhost_crypto.html">37. Vhost_Crypto Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="vdpa.html">38. Vdpa Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="ip_pipeline.html">39. Internet Protocol (IP) Pipeline Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="test_pipeline.html">40. Test Pipeline Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="pipeline.html">41. Pipeline Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="eventdev_pipeline.html">42. Eventdev Pipeline Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="dist_app.html">43. Distributor Sample Application</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">44. Virtual Machine Power Management Application</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sample-application-architecture-overview">44.1. Sample Application Architecture Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#performance-considerations">44.1.1. Performance Considerations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#configuration">44.2. Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#bios">44.2.1. BIOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#host-operating-system">44.2.2. Host Operating System</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hypervisor-channel-configuration">44.2.3. Hypervisor Channel Configuration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#compiling-and-running-the-host-application">44.3. Compiling and Running the Host Application</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#compiling-the-host-application">44.3.1. Compiling the Host Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-the-host-application">44.3.2. Running the Host Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#command-line-options-for-enabling-out-of-band-branch-ratio-monitoring">44.3.3. Command Line Options for Enabling Out-of-band Branch Ratio Monitoring</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#compiling-and-running-the-guest-applications">44.4. Compiling and Running the Guest Applications</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#compiling-the-guest-application">44.4.1. Compiling the Guest Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-the-guest-application">44.4.2. Running the Guest Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#command-line-options-available-when-sending-a-policy-to-the-host">44.4.3. Command Line Options Available When Sending a Policy to the Host</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#json-interface-for-power-management-requests-and-policies">44.5. JSON Interface for Power Management Requests and Policies</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#json-interface-examples">44.5.1. JSON Interface Examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="#json-name-value-pairs">44.5.2. JSON Name-value Pairs</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="ptpclient.html">45. PTP Client Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="performance_thread.html">46. Performance Thread Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="fips_validation.html">47. Federal Information Processing Standards (FIPS) CryptoDev Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipsec_secgw.html">48. IPsec Security Gateway Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="bbdev_app.html">49. Loop-back Sample Application using Baseband Device (bbdev)</a></li>
<li class="toctree-l2"><a class="reference internal" href="ntb.html">50. NTB Sample Application</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../prog_guide/index.html">Programmerâs Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../howto/index.html">HowTo Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">DPDK Tools User Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testpmd_app_ug/index.html">Testpmd Application User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nics/index.html">Network Interface Controller Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bbdevs/index.html">Baseband Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cryptodevs/index.html">Crypto Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compressdevs/index.html">Compression Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vdpadevs/index.html">vDPA Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../regexdevs/index.html">REGEX Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../eventdevs/index.html">Event Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rawdevs/index.html">Rawdev Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mempool/index.html">Mempool Device Driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../platform/index.html">Platform Specific Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Contributorâs Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rel_notes/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">FAQ</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Data Plane Development Kit</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Sample Applications User Guides</a> &raquo;</li>
        
      <li><span class="section-number">44. </span>Virtual Machine Power Management Application</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/sample_app_ug/vm_power_management.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="virtual-machine-power-management-application">
<h1><span class="section-number">44. </span>Virtual Machine Power Management Application</h1>
<p>Applications running in virtual environments have an abstract view of
the underlying hardware on the host. Specifically, applications cannot
see the binding of virtual components to physical hardware. When looking
at CPU resourcing, the pinning of Virtual CPUs (vCPUs) to Physical CPUs
(pCPUs) on the host is not apparent to an application and this pinning
may change over time. In addition, operating systems on Virtual Machines
(VMs) do not have the ability to govern their own power policy. The
Machine Specific Registers (MSRs) for enabling P-state transitions are
not exposed to the operating systems running on the VMs.</p>
<p>The solution demonstrated in this sample application shows an example of
how a DPDK application can indicate its processing requirements using
VM-local only information (vCPU/lcore, and so on) to a host resident VM
Power Manager. The VM Power Manager is responsible for:</p>
<ul class="simple">
<li><p><strong>Accepting requests for frequency changes for a vCPU</strong></p></li>
<li><p><strong>Translating the vCPU to a pCPU using libvirt</strong></p></li>
<li><p><strong>Performing the change in frequency</strong></p></li>
</ul>
<p>This application demonstrates the following features:</p>
<ul>
<li><p><strong>The handling of VM application requests to change frequency.</strong>
VM applications can request frequency changes for a vCPU. The VM
Power Management Application uses libvirt to translate that
virtual CPU (vCPU) request to a physical CPU (pCPU) request and
performs the frequency change.</p></li>
<li><p><strong>The acceptance of power management policies from VM applications.</strong>
A VM application can send a policy to the host application. The
policy contains rules that define the power management behaviour
of the VM. The host application then applies the rules of the
policy independent of the VM application. For example, the
policy can contain time-of-day information for busy/quiet
periods, and the host application can scale up/down the relevant
cores when required. See <a class="reference internal" href="#sending-policy"><span class="std std-ref">Command Line Options Available When Sending a Policy to the Host</span></a> for information on
setting policy values.</p></li>
<li><p><strong>Out-of-band monitoring of workloads using core hardware event counters.</strong>
The host application can manage power for an application by looking
at the event counters of the cores and taking action based on the
branch miss/hit ratio. See <a class="reference internal" href="#enabling-out-of-band"><span class="std std-ref">Command Line Options for Enabling Out-of-band Branch Ratio Monitoring</span></a>.</p>
<p><strong>Note</strong>: This functionality also applies in non-virtualised environments.</p>
</li>
</ul>
<p>In addition to the <code class="docutils literal notranslate"><span class="pre">librte_power</span></code> library used on the host, the
application uses a special version of <code class="docutils literal notranslate"><span class="pre">librte_power</span></code> on each VM, which
directs frequency changes and policies to the host monitor rather than
the APCI <code class="docutils literal notranslate"><span class="pre">cpufreq</span></code> <code class="docutils literal notranslate"><span class="pre">sysfs</span></code> interface used on the host in non-virtualised
environments.</p>
<div class="figure align-default" id="id1">
<span id="figure-vm-power-mgr-highlevel"></span><img alt="../_images/vm_power_mgr_highlevel.svg" src="../_images/vm_power_mgr_highlevel.svg" /><p class="caption"><span class="caption-number">Fig. 44.1 </span><span class="caption-text">Highlevel Solution</span></p>
</div>
<p>In the above diagram, the DPDK Applications are shown running in
virtual machines, and the VM Power Monitor application is shown running
in the host.</p>
<p><strong>DPDK VM Application</strong></p>
<ul class="simple">
<li><p>Reuse <code class="docutils literal notranslate"><span class="pre">librte_power</span></code> interface, but uses an implementation that
forwards frequency requests to the host using a <code class="docutils literal notranslate"><span class="pre">virtio-serial</span></code> channel</p></li>
<li><p>Each lcore has exclusive access to a single channel</p></li>
<li><p>Sample application reuses <code class="docutils literal notranslate"><span class="pre">l3fwd_power</span></code></p></li>
<li><p>A CLI for changing frequency from within a VM is also included</p></li>
</ul>
<p><strong>VM Power Monitor</strong></p>
<ul class="simple">
<li><p>Accepts VM commands over <code class="docutils literal notranslate"><span class="pre">virtio-serial</span></code> endpoints, monitored
using <code class="docutils literal notranslate"><span class="pre">epoll</span></code></p></li>
<li><p>Commands include the virtual core to be modified, using <code class="docutils literal notranslate"><span class="pre">libvirt</span></code> to get
the physical core mapping</p></li>
<li><p>Uses <code class="docutils literal notranslate"><span class="pre">librte_power</span></code> to affect frequency changes using Linux userspace
power governor (<code class="docutils literal notranslate"><span class="pre">acpi_cpufreq</span></code> OR <code class="docutils literal notranslate"><span class="pre">intel_pstate</span></code> driver)</p></li>
<li><p>CLI: For adding VM channels to monitor, inspecting and changing channel
state, manually altering CPU frequency. Also allows for the changings
of vCPU to pCPU pinning</p></li>
</ul>
<div class="section" id="sample-application-architecture-overview">
<h2><span class="section-number">44.1. </span>Sample Application Architecture Overview</h2>
<p>The VM power management solution employs <code class="docutils literal notranslate"><span class="pre">qemu-kvm</span></code> to provide
communications channels between the host and VMs in the form of a
<code class="docutils literal notranslate"><span class="pre">virtio-serial</span></code> connection that appears as a para-virtualised serial
device on a VM and can be configured to use various backends on the
host. For this example, the configuration of each <code class="docutils literal notranslate"><span class="pre">virtio-serial</span></code> endpoint
on the host as an <code class="docutils literal notranslate"><span class="pre">AF_UNIX</span></code> file socket, supporting poll/select and
<code class="docutils literal notranslate"><span class="pre">epoll</span></code> for event notification. In this example, each channel endpoint on
the host is monitored for <code class="docutils literal notranslate"><span class="pre">EPOLLIN</span></code> events using <code class="docutils literal notranslate"><span class="pre">epoll</span></code>. Each channel
is specified as <code class="docutils literal notranslate"><span class="pre">qemu-kvm</span></code> arguments or as <code class="docutils literal notranslate"><span class="pre">libvirt</span></code> XML for each VM,
where each VM can have several channels up to a maximum of 64 per VM. In this
example, each DPDK lcore on a VM has exclusive access to a channel.</p>
<p>To enable frequency changes from within a VM, the VM forwards a
<code class="docutils literal notranslate"><span class="pre">librte_power</span></code> request over the <code class="docutils literal notranslate"><span class="pre">virtio-serial</span></code> channel to the host. Each
request contains the vCPU and power command (scale up/down/min/max). The
API for the host <code class="docutils literal notranslate"><span class="pre">librte_power</span></code> and guest <code class="docutils literal notranslate"><span class="pre">librte_power</span></code> is consistent
across environments, with the selection of VM or host implementation
determined automatically at runtime based on the environment. On
receiving a request, the host translates the vCPU to a pCPU using the
libvirt API before forwarding it to the host <code class="docutils literal notranslate"><span class="pre">librte_power</span></code>.</p>
<div class="figure align-default" id="figure-vm-power-mgr-vm-request-seq">
<img alt="../_images/vm_power_mgr_vm_request_seq.svg" src="../_images/vm_power_mgr_vm_request_seq.svg" /></div>
<p>In addition to the ability to send power management requests to the
host, a VM can send a power management policy to the host. In some
cases, using a power management policy is a preferred option because it
can eliminate possible latency issues that can occur when sending power
management requests. Once the VM sends the policy to the host, the VM no
longer needs to worry about power management, because the host now
manages the power for the VM based on the policy. The policy can specify
power behavior that is based on incoming traffic rates or time-of-day
power adjustment (busy/quiet hour power adjustment for example). See
<a class="reference internal" href="#sending-policy"><span class="std std-ref">Command Line Options Available When Sending a Policy to the Host</span></a> for more information.</p>
<p>One method of power management is to sense how busy a core is when
processing packets and adjusting power accordingly. One technique for
doing this is to monitor the ratio of the branch miss to branch hits
counters and scale the core power accordingly. This technique is based
on the premise that when a core is not processing packets, the ratio of
branch misses to branch hits is very low, but when the core is
processing packets, it is measurably higher. The implementation of this
capability is as a policy of type <code class="docutils literal notranslate"><span class="pre">BRANCH_RATIO</span></code>.
See <a class="reference internal" href="#sending-policy"><span class="std std-ref">Command Line Options Available When Sending a Policy to the Host</span></a> for more information on using the
BRANCH_RATIO policy option.</p>
<p>A JSON interface enables the specification of power management requests
and policies in JSON format. The JSON interfaces provide a more
convenient and more easily interpreted interface for the specification
of requests and policies. See <a class="reference internal" href="#power-man-requests"><span class="std std-ref">JSON Interface for Power Management Requests and Policies</span></a> for more information.</p>
<div class="section" id="performance-considerations">
<h3><span class="section-number">44.1.1. </span>Performance Considerations</h3>
<p>While the Haswell microarchitecture allows for independent power control
for each core, earlier microarchitectures do not offer such fine-grained
control. When deploying on pre-Haswell platforms, greater care must be
taken when selecting which cores are assigned to a VM, for example, a
core does not scale down in frequency until all of its siblings are
similarly scaled down.</p>
</div>
</div>
<div class="section" id="configuration">
<h2><span class="section-number">44.2. </span>Configuration</h2>
<div class="section" id="bios">
<h3><span class="section-number">44.2.1. </span>BIOS</h3>
<p>To use the power management features of the DPDK, you must enable
Enhanced Intel SpeedStepÂ® Technology in the platform BIOS. Otherwise,
the <code class="docutils literal notranslate"><span class="pre">sys</span></code> file folder <code class="docutils literal notranslate"><span class="pre">/sys/devices/system/cpu/cpu0/cpufreq</span></code> does not
exist, and you cannot use CPU frequency-based power management. Refer to the
relevant BIOS documentation to determine how to access these settings.</p>
</div>
<div class="section" id="host-operating-system">
<h3><span class="section-number">44.2.2. </span>Host Operating System</h3>
<p>The DPDK Power Management library can use either the <code class="docutils literal notranslate"><span class="pre">acpi_cpufreq</span></code> or
the <code class="docutils literal notranslate"><span class="pre">intel_pstate</span></code> kernel driver for the management of core frequencies. In
many cases, the <code class="docutils literal notranslate"><span class="pre">intel_pstate</span></code> driver is the default power management
environment.</p>
<p>Should the <code class="docutils literal notranslate"><span class="pre">acpi-cpufreq</span> <span class="pre">driver</span></code> be required, the <code class="docutils literal notranslate"><span class="pre">intel_pstate</span></code>
module must be disabled, and the <code class="docutils literal notranslate"><span class="pre">acpi-cpufreq</span></code> module loaded in its place.</p>
<p>To disable the <code class="docutils literal notranslate"><span class="pre">intel_pstate</span></code> driver, add the following to the <code class="docutils literal notranslate"><span class="pre">grub</span></code>
Linux command line:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">intel_pstate=disable</span></code></p>
</div></blockquote>
<p>On reboot, load the <code class="docutils literal notranslate"><span class="pre">acpi_cpufreq</span></code> module:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">modprobe</span> <span class="pre">acpi_cpufreq</span></code></p>
</div></blockquote>
</div>
<div class="section" id="hypervisor-channel-configuration">
<h3><span class="section-number">44.2.3. </span>Hypervisor Channel Configuration</h3>
<p>Configure <code class="docutils literal notranslate"><span class="pre">virtio-serial</span></code> channels using <code class="docutils literal notranslate"><span class="pre">libvirt</span></code> XML.
The XML structure is as follows:</p>
<div class="highlight-XML notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;name&gt;</span>{vm_name}<span class="nt">&lt;/name&gt;</span>
<span class="nt">&lt;controller</span> <span class="na">type=</span><span class="s">&#39;virtio-serial&#39;</span> <span class="na">index=</span><span class="s">&#39;0&#39;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x00&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x06&#39;</span> <span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/controller&gt;</span>
<span class="nt">&lt;channel</span> <span class="na">type=</span><span class="s">&#39;unix&#39;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;source</span> <span class="na">mode=</span><span class="s">&#39;bind&#39;</span> <span class="na">path=</span><span class="s">&#39;/tmp/powermonitor/{vm_name}.{channel_num}&#39;</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;target</span> <span class="na">type=</span><span class="s">&#39;virtio&#39;</span> <span class="na">name=</span><span class="s">&#39;virtio.serial.port.poweragent.{vm_channel_num}&#39;</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;virtio-serial&#39;</span> <span class="na">controller=</span><span class="s">&#39;0&#39;</span> <span class="na">bus=</span><span class="s">&#39;0&#39;</span> <span class="na">port=</span><span class="s">&#39;{N}&#39;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/channel&gt;</span>
</pre></div>
</div>
<p>Where a single controller of type <code class="docutils literal notranslate"><span class="pre">virtio-serial</span></code> is created, up to 32
channels can be associated with a single controller, and multiple
controllers can be specified. The convention is to use the name of the
VM in the host path <code class="docutils literal notranslate"><span class="pre">{vm_name}</span></code> and to increment <code class="docutils literal notranslate"><span class="pre">{channel_num}</span></code> for each
channel. Likewise, the port value <code class="docutils literal notranslate"><span class="pre">{N}</span></code> must be incremented for each
channel.</p>
<p>On the host, for each channel to appear in the path, ensure the creation
of the <code class="docutils literal notranslate"><span class="pre">/tmp/powermonitor/</span></code> directory and the assignment of <code class="docutils literal notranslate"><span class="pre">qemu</span></code>
permissions:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mkdir /tmp/powermonitor/</span>
<span class="go">chown qemu:qemu /tmp/powermonitor</span>
</pre></div>
</div>
<p>Note that files and directories in <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> are generally removed when
rebooting the host and you may need to perform the previous steps after
each reboot.</p>
<p>The serial device as it appears on a VM is configured with the target
element attribute name and must be in the form:
<code class="docutils literal notranslate"><span class="pre">virtio.serial.port.poweragent.{vm_channel_num}</span></code>, where
<code class="docutils literal notranslate"><span class="pre">vm_channel_num</span></code> is typically the lcore channel to be used in
DPDK VM applications.</p>
<p>Each channel on a VM is present at:</p>
<p><code class="docutils literal notranslate"><span class="pre">/dev/virtio-ports/virtio.serial.port.poweragent.{vm_channel_num}</span></code></p>
</div>
</div>
<div class="section" id="compiling-and-running-the-host-application">
<h2><span class="section-number">44.3. </span>Compiling and Running the Host Application</h2>
<div class="section" id="compiling-the-host-application">
<h3><span class="section-number">44.3.1. </span>Compiling the Host Application</h3>
<p>For information on compiling the DPDK and sample applications, see
see <a class="reference internal" href="compiling.html"><span class="doc">Compiling the Sample Applications</span></a>.</p>
<p>The application is located in the <code class="docutils literal notranslate"><span class="pre">vm_power_manager</span></code> subdirectory.</p>
<p>To build just the <code class="docutils literal notranslate"><span class="pre">vm_power_manager</span></code> application using <code class="docutils literal notranslate"><span class="pre">make</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cd dpdk/examples/vm_power_manager/</span>
<span class="go">make</span>
</pre></div>
</div>
<p>The resulting binary is <code class="docutils literal notranslate"><span class="pre">dpdk/build/examples/vm_power_manager</span></code>.</p>
<p>To build just the <code class="docutils literal notranslate"><span class="pre">vm_power_manager</span></code> application using <code class="docutils literal notranslate"><span class="pre">meson</span></code>/<code class="docutils literal notranslate"><span class="pre">ninja</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cd dpdk</span>
<span class="go">meson build</span>
<span class="go">cd build</span>
<span class="go">ninja</span>
<span class="go">meson configure -Dexamples=vm_power_manager</span>
<span class="go">ninja</span>
</pre></div>
</div>
<p>The resulting binary is <code class="docutils literal notranslate"><span class="pre">dpdk/build/examples/dpdk-vm_power_manager</span></code>.</p>
</div>
<div class="section" id="running-the-host-application">
<h3><span class="section-number">44.3.2. </span>Running the Host Application</h3>
<p>The application does not have any specific command line options other
than the EAL options:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">./&lt;build_dir&gt;/examples/dpdk-vm_power_mgr [EAL options]</span>
</pre></div>
</div>
<p>The application requires exactly two cores to run. One core for the CLI
and the other for the channel endpoint monitor. For example, to run on
cores 0 and 1 on a system with four memory channels, issue the command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">./&lt;build_dir&gt;/examples/dpdk-vm_power_mgr -l 0-1 -n 4</span>
</pre></div>
</div>
<p>After successful initialization, the VM Power Manager CLI prompt appears:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">vm_power&gt;</span>
</pre></div>
</div>
<p>Now, it is possible to add virtual machines to the VM Power Manager:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">vm_power&gt; add_vm {vm_name}</span>
</pre></div>
</div>
<p>When a <code class="docutils literal notranslate"><span class="pre">{vm_name}</span></code> is specified with the <code class="docutils literal notranslate"><span class="pre">add_vm</span></code> command, a lookup is
performed with <code class="docutils literal notranslate"><span class="pre">libvirt</span></code> to ensure that the VM exists. <code class="docutils literal notranslate"><span class="pre">{vm_name}</span></code> is a
unique identifier to associate channels with a particular VM and for
executing operations on a VM within the CLI. VMs do not have to be
running to add them.</p>
<p>It is possible to issue several commands from the CLI to manage VMs.</p>
<p>Remove the virtual machine identified by <code class="docutils literal notranslate"><span class="pre">{vm_name}</span></code> from the VM Power
Manager using the command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">rm_vm {vm_name}</span>
</pre></div>
</div>
<p>Add communication channels for the specified VM using the following
command. The <code class="docutils literal notranslate"><span class="pre">virtio</span></code> channels must be enabled in the VM configuration
(<code class="docutils literal notranslate"><span class="pre">qemu/libvirt</span></code>) and the associated VM must be active. <code class="docutils literal notranslate"><span class="pre">{list}</span></code> is a
comma-separated list of channel numbers to add. Specifying the keyword
<code class="docutils literal notranslate"><span class="pre">all</span></code> attempts to add all channels for the VM:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go"> set_pcpu {vm_name} {vcpu} {pcpu}</span>

<span class="go">Enable query of physical core information from a VM:</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">set_query {vm_name} enable|disable</span>
</pre></div>
</div>
<p>Manual control and inspection can also be carried in relation CPU frequency scaling:</p>
<blockquote>
<div><p>Get the current frequency for each core specified in the mask:</p>
</div></blockquote>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go"> show_cpu_freq_mask {mask}</span>

<span class="go">Set the current frequency for the cores specified in {core_mask} by scaling each up/down/min/max:</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">add_channels {vm_name} {list}|all</span>
</pre></div>
</div>
<p>Enable or disable the communication channels in <code class="docutils literal notranslate"><span class="pre">{list}</span></code> (comma-separated)
for the specified VM. Alternatively, replace <code class="docutils literal notranslate"><span class="pre">list</span></code> with the keyword
<code class="docutils literal notranslate"><span class="pre">all</span></code>. Disabled channels receive packets on the host. However, the commands
they specify are ignored. Set the status to enabled to begin processing
requests again:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">set_channel_status {vm_name} {list}|all enabled|disabled</span>
</pre></div>
</div>
<p>Print to the CLI information on the specified VM. The information lists
the number of vCPUs, the pinning to pCPU(s) as a bit mask, along with
any communication channels associated with each VM, and the status of
each channel:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">show_vm {vm_name}</span>
</pre></div>
</div>
<p>Set the binding of a virtual CPU on a VM with name <code class="docutils literal notranslate"><span class="pre">{vm_name}</span></code> to the
physical CPU mask:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">set_pcpu_mask {vm_name} {vcpu} {pcpu}</span>
</pre></div>
</div>
<p>Set the binding of the virtual CPU on the VM to the physical CPU:</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">set_pcpu {vm_name} {vcpu} {pcpu}</span>
</pre></div>
</div>
</div></blockquote>
<p>It is also possible to perform manual control and inspection in relation
to CPU frequency scaling.</p>
<p>Get the current frequency for each core specified in the mask:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">show_cpu_freq_mask {mask}</span>
</pre></div>
</div>
<p>Set the current frequency for the cores specified in <code class="docutils literal notranslate"><span class="pre">{core_mask}</span></code> by
scaling each up/down/min/max:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">set_cpu_freq {core_mask} up|down|min|max</span>
</pre></div>
</div>
<p>Get the current frequency for the specified core:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">show_cpu_freq {core_num}</span>
</pre></div>
</div>
<p>Set the current frequency for the specified core by scaling up/down/min/max:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">set_cpu_freq {core_num} up|down|min|max</span>
</pre></div>
</div>
</div>
<div class="section" id="command-line-options-for-enabling-out-of-band-branch-ratio-monitoring">
<span id="enabling-out-of-band"></span><h3><span class="section-number">44.3.3. </span>Command Line Options for Enabling Out-of-band Branch Ratio Monitoring</h3>
<p>There are a couple of command line parameters for enabling the out-of-band
monitoring of branch ratios on cores doing busy polling using PMDs as
described below:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">--core-branch-ratio</span> <span class="pre">{list</span> <span class="pre">of</span> <span class="pre">cores}:{branch</span> <span class="pre">ratio</span> <span class="pre">for</span> <span class="pre">listed</span> <span class="pre">cores}</span></code></dt><dd><p>Specify the list of cores to monitor the ratio of branch misses
to branch hits.  A tightly-polling PMD thread has a very low
branch ratio, therefore the core frequency scales down to the
minimum allowed value. On receiving packets, the code path changes,
causing the branch ratio to increase. When the ratio goes above
the ratio threshold, the core frequency scales up to the maximum
allowed value. The specified branch-ratio is a floating point number
that identifies the threshold at which to scale up or down for the
elements of the core-list. If not included the default branch ratio of
0.01 but will need adjustment for different workloads</p>
<p>This parameter can be used multiple times for different sets of cores.
The branch ratio mechanism can also be useful for non-PMD cores and
hyper-threaded environments where C-States are disabled.</p>
</dd>
</dl>
</div>
</div>
<div class="section" id="compiling-and-running-the-guest-applications">
<h2><span class="section-number">44.4. </span>Compiling and Running the Guest Applications</h2>
<p>It is possible to use the <code class="docutils literal notranslate"><span class="pre">l3fwd-power</span></code> application (for example) with the
<code class="docutils literal notranslate"><span class="pre">vm_power_manager</span></code>.</p>
<p>The distribution also provides a guest CLI for validating the setup.</p>
<p>For both <code class="docutils literal notranslate"><span class="pre">l3fwd-power</span></code> and the guest CLI, the host application must use
the <code class="docutils literal notranslate"><span class="pre">add_channels</span></code> command to monitor the channels for the VM. To do this,
issue the following commands in the host application:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">vm_power&gt; add_vm vmname</span>
<span class="go">vm_power&gt; add_channels vmname all</span>
<span class="go">vm_power&gt; set_channel_status vmname all enabled</span>
<span class="go">vm_power&gt; show_vm vmname</span>
</pre></div>
</div>
<div class="section" id="compiling-the-guest-application">
<h3><span class="section-number">44.4.1. </span>Compiling the Guest Application</h3>
<p>For information on compiling DPDK and the sample applications in general,
see <a class="reference internal" href="compiling.html"><span class="doc">Compiling the Sample Applications</span></a>.</p>
<p>For compiling and running the <code class="docutils literal notranslate"><span class="pre">l3fwd-power</span></code> sample application, see
<a class="reference internal" href="l3_forward_power_man.html"><span class="doc">L3 Forwarding with Power Management Sample Application</span></a>.</p>
<p>The application is in the <code class="docutils literal notranslate"><span class="pre">guest_cli</span></code> subdirectory under <code class="docutils literal notranslate"><span class="pre">vm_power_manager</span></code>.</p>
<p>To build just the <code class="docutils literal notranslate"><span class="pre">guest_vm_power_manager</span></code> application using <code class="docutils literal notranslate"><span class="pre">make</span></code>, issue
the following commands:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cd dpdk/examples/vm_power_manager/guest_cli/</span>
<span class="go">make</span>
</pre></div>
</div>
<p>The resulting binary is <code class="docutils literal notranslate"><span class="pre">dpdk/build/examples/guest_cli</span></code>.</p>
<p><strong>Note</strong>: This sample application conditionally links in the Jansson JSON
library. Consequently, if you are using a multilib or cross-compile
environment, you may need to set the <code class="docutils literal notranslate"><span class="pre">PKG_CONFIG_LIBDIR</span></code> environmental
variable to point to the relevant <code class="docutils literal notranslate"><span class="pre">pkgconfig</span></code> folder so that the correct
library is linked in.</p>
<p>For example, if you are building for a 32-bit target, you could find the
correct directory using the following find command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> find /usr -type d -name pkgconfig
<span class="go">/usr/lib/i386-linux-gnu/pkgconfig</span>
<span class="go">/usr/lib/x86_64-linux-gnu/pkgconfig</span>
</pre></div>
</div>
<p>Then use:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export PKG_CONFIG_LIBDIR=/usr/lib/i386-linux-gnu/pkgconfig</span>
</pre></div>
</div>
<p>You then use the <code class="docutils literal notranslate"><span class="pre">make</span></code> command as normal, which should find the 32-bit
version of the library, if it installed. If not, the application builds
without the JSON interface functionality.</p>
<p>To build just the <code class="docutils literal notranslate"><span class="pre">vm_power_manager</span></code> application using <code class="docutils literal notranslate"><span class="pre">meson</span></code>/<code class="docutils literal notranslate"><span class="pre">ninja</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cd dpdk</span>
<span class="go">meson build</span>
<span class="go">cd build</span>
<span class="go">ninja</span>
<span class="go">meson configure -Dexamples=vm_power_manager/guest_cli</span>
<span class="go">ninja</span>
</pre></div>
</div>
<p>The resulting binary is <code class="docutils literal notranslate"><span class="pre">dpdk/build/examples/guest_cli</span></code>.</p>
</div>
<div class="section" id="running-the-guest-application">
<h3><span class="section-number">44.4.2. </span>Running the Guest Application</h3>
<p>The standard EAL command line parameters are necessary:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">./&lt;build_dir&gt;/examples/dpdk-vm_power_mgr [EAL options] -- [guest options]</span>
</pre></div>
</div>
<p>The guest example uses a channel for each lcore enabled. For example, to
run on cores 0, 1, 2 and 3:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">./&lt;build_dir&gt;/examples/dpdk-guest_vm_power_mgr -l 0-3</span>
</pre></div>
</div>
</div>
<div class="section" id="command-line-options-available-when-sending-a-policy-to-the-host">
<span id="sending-policy"></span><h3><span class="section-number">44.4.3. </span>Command Line Options Available When Sending a Policy to the Host</h3>
<p>Optionally, there are several command line options for a user who needs
to send a power policy to the host application:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">--vm-name</span> <span class="pre">{name</span> <span class="pre">of</span> <span class="pre">guest</span> <span class="pre">vm}</span></code></dt><dd><p>Allows the user to change the virtual machine name
passed down to the host application using the power policy.
The default is ubuntu2.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">--vcpu-list</span> <span class="pre">{list</span> <span class="pre">vm</span> <span class="pre">cores}</span></code></dt><dd><p>A comma-separated list of cores in the VM that the user
wants the host application to monitor.
The list of cores in any VM starts at zero,
and the host application maps these to the physical cores
once the policy passes down to the host.
Valid syntax includes individual cores 2,3,4,
a range of cores 2-4, or a combination of both 1,3,5-7.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">--busy-hours</span> <span class="pre">{list</span> <span class="pre">of</span> <span class="pre">busy</span> <span class="pre">hours}</span></code></dt><dd><p>A comma-separated list of hours in which to set the core
frequency to the maximum.
Valid syntax includes individual hours 2,3,4,
a range of hours 2-4, or a combination of both 1,3,5-7.
Valid hour values are 0 to 23.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">--quiet-hours</span> <span class="pre">{list</span> <span class="pre">of</span> <span class="pre">quiet</span> <span class="pre">hours}</span></code></dt><dd><p>A comma-separated list of hours in which to set the core frequency
to minimum. Valid syntax includes individual hours 2,3,4,
a range of hours 2-4, or a combination of both 1,3,5-7.
Valid hour values are 0 to 23.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">--policy</span> <span class="pre">{policy</span> <span class="pre">type}</span></code></dt><dd><p>The type of policy. This can be one of the following values:</p>
<ul class="simple">
<li><p>TRAFFIC - Based on incoming traffic rates on the NIC.</p></li>
<li><p>TIME - Uses a busy/quiet hours policy.</p></li>
<li><p>BRANCH_RATIO - Uses branch ratio counters to determine core busyness.</p></li>
<li><p>WORKLOAD - Sets the frequency to low, medium or high
based on the received policy setting.</p></li>
</ul>
<p><strong>Note</strong>: Not all policy types need all parameters.
For example, BRANCH_RATIO only needs the vcpu-list parameter.</p>
</dd>
</dl>
<p>After successful initialization, the VM Power Manager Guest CLI prompt
appears:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">vm_power(guest)&gt;</span>
</pre></div>
</div>
<p>To change the frequency of an lcore, use a <code class="docutils literal notranslate"><span class="pre">set_cpu_freq</span></code> command similar
to the following:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">set_cpu_freq {core_num} up|down|min|max</span>
</pre></div>
</div>
<p>where, <code class="docutils literal notranslate"><span class="pre">{core_num}</span></code> is the lcore and channel to change frequency by
scaling up/down/min/max.</p>
<p>To start an application, configure the power policy, and send it to the
host, use a command like the following:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">./&lt;build_dir&gt;/examples/dpdk-guest_vm_power_mgr -l 0-3 -n 4 -- --vm-name=ubuntu --policy=BRANCH_RATIO --vcpu-list=2-4</span>
</pre></div>
</div>
<p>Once the VM Power Manager Guest CLI appears, issuing the âsend_policy nowâ command
will send the policy to the host:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">send_policy now</span>
</pre></div>
</div>
<p>Once the policy is sent to the host, the host application takes over the power monitoring
of the specified cores in the policy.</p>
</div>
</div>
<div class="section" id="json-interface-for-power-management-requests-and-policies">
<span id="power-man-requests"></span><h2><span class="section-number">44.5. </span>JSON Interface for Power Management Requests and Policies</h2>
<p>In addition to the command line interface for the host command, and a
<code class="docutils literal notranslate"><span class="pre">virtio-serial</span></code> interface for VM power policies, there is also a JSON
interface through which power commands and policies can be sent.</p>
<p><strong>Note</strong>: This functionality adds a dependency on the Jansson library.
Install the Jansson development package on the system to avail of the
JSON parsing functionality in the app. Issue the <code class="docutils literal notranslate"><span class="pre">apt-get</span> <span class="pre">install</span>
<span class="pre">libjansson-dev</span></code> command to install the development package. The command
and package name may be different depending on your operating system. It
is worth noting that the app builds successfully if this package is not
present, but a warning displays during compilation, and the JSON parsing
functionality is not present in the app.</p>
<p>Send a request or policy to the VM Power Manager by simply opening a
fifo file at <code class="docutils literal notranslate"><span class="pre">/tmp/powermonitor/fifo</span></code>, writing a JSON string to that file,
and closing the file.</p>
<p>The JSON string can be a power management request or a policy, and takes
the following format:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;packet_type&quot;</span><span class="o">:</span> <span class="p">{</span>
<span class="s2">&quot;pair_1&quot;</span><span class="o">:</span> <span class="nx">value</span><span class="p">,</span>
<span class="s2">&quot;pair_2&quot;</span><span class="o">:</span> <span class="nx">value</span>
<span class="p">}}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">packet_type</span></code> header can contain one of two values, depending on
whether a power management request or policy is being sent. The two
possible values are <code class="docutils literal notranslate"><span class="pre">instruction</span></code> and <code class="docutils literal notranslate"><span class="pre">policy</span></code> and the expected name-value
pairs are different depending on which type is sent.</p>
<p>The pairs are in the format of standard JSON name-value pairs. The value
type varies between the different name-value pairs, and may be integers,
strings, arrays, and so on. See <a class="reference internal" href="#json-interface-ex"><span class="std std-ref">JSON Interface Examples</span></a>
for examples of policies and instructions and
<a class="reference internal" href="#json-name-value-pair"><span class="std std-ref">JSON Name-value Pairs</span></a> for the supported names and value types.</p>
<div class="section" id="json-interface-examples">
<span id="json-interface-ex"></span><h3><span class="section-number">44.5.1. </span>JSON Interface Examples</h3>
<p>The following is an example JSON string that creates a time-profile
policy.</p>
<div class="highlight-JSON notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;policy&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ubuntu&quot;</span><span class="p">,</span>
<span class="nt">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;create&quot;</span><span class="p">,</span>
<span class="nt">&quot;policy_type&quot;</span><span class="p">:</span> <span class="s2">&quot;TIME&quot;</span><span class="p">,</span>
<span class="nt">&quot;busy_hours&quot;</span><span class="p">:[</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span> <span class="p">],</span>
<span class="nt">&quot;quiet_hours&quot;</span><span class="p">:[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span> <span class="p">],</span>
<span class="nt">&quot;core_list&quot;</span><span class="p">:[</span> <span class="mi">11</span> <span class="p">]</span>
<span class="p">}}</span>
</pre></div>
</div>
<p>The following is an example JSON string that removes the named policy.</p>
<div class="highlight-JSON notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;policy&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ubuntu&quot;</span><span class="p">,</span>
<span class="nt">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;destroy&quot;</span><span class="p">,</span>
<span class="p">}}</span>
</pre></div>
</div>
<p>The following is an example JSON string for a power management request.</p>
<div class="highlight-JSON notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;instruction&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ubuntu&quot;</span><span class="p">,</span>
<span class="nt">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;power&quot;</span><span class="p">,</span>
<span class="nt">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;SCALE_MAX&quot;</span><span class="p">,</span>
<span class="nt">&quot;resource_id&quot;</span><span class="p">:</span> <span class="mi">10</span>
<span class="p">}}</span>
</pre></div>
</div>
<p>To query the available frequences of an lcore, use the query_cpu_freq command.
Where {core_num} is the lcore to query.
Before using this command, please enable responses via the set_query command on the host.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">query_cpu_freq {core_num}|all</span>
</pre></div>
</div>
<p>To query the capabilities of an lcore, use the query_cpu_caps command.
Where {core_num} is the lcore to query.
Before using this command, please enable responses via the set_query command on the host.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">query_cpu_caps {core_num}|all</span>
</pre></div>
</div>
<p>To start the application and configure the power policy, and send it to the host:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">./&lt;build_dir&gt;/examples/dpdk-guest_vm_power_mgr -l 0-3 -n 4 -- --vm-name=ubuntu --policy=BRANCH_RATIO --vcpu-list=2-4</span>
</pre></div>
</div>
<p>Once the VM Power Manager Guest CLI appears, issuing the âsend_policy nowâ command
will send the policy to the host:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">send_policy now</span>
</pre></div>
</div>
<p>Once the policy is sent to the host, the host application takes over the power monitoring
of the specified cores in the policy.</p>
</div>
<div class="section" id="json-name-value-pairs">
<span id="json-name-value-pair"></span><h3><span class="section-number">44.5.2. </span>JSON Name-value Pairs</h3>
<p>The following are the name-value pairs supported by the JSON interface:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#avg-packet-thresh">avg_packet_thresh</a></p></li>
<li><p><a class="reference internal" href="#busy-hours">busy_hours</a></p></li>
<li><p><a class="reference internal" href="#command">command</a></p></li>
<li><p><a class="reference internal" href="#core-list">core_list</a></p></li>
<li><p><a class="reference internal" href="#mac-list">mac_list</a></p></li>
<li><p><a class="reference internal" href="#max-packet-thresh">max_packet_thresh</a></p></li>
<li><p><a class="reference internal" href="#name">name</a></p></li>
<li><p><a class="reference internal" href="#policy-type">policy_type</a></p></li>
<li><p><a class="reference internal" href="#quiet-hours">quiet_hours</a></p></li>
<li><p><a class="reference internal" href="#resource-id">resource_id</a></p></li>
<li><p><a class="reference internal" href="#unit">unit</a></p></li>
<li><p><a class="reference internal" href="#workload">workload</a></p></li>
</ul>
<div class="section" id="avg-packet-thresh">
<h4><span class="section-number">44.5.2.1. </span>avg_packet_thresh</h4>
<dl class="simple">
<dt>Description</dt><dd><p>The threshold below which the frequency is set to the minimum value
for the TRAFFIC policy.
If the traffic rate is above this value and below the maximum value,
the frequency is set to medium.</p>
</dd>
<dt>Type</dt><dd><p>integer</p>
</dd>
<dt>Values</dt><dd><p>The number of packets below which the TRAFFIC policy applies
the minimum frequency, or the medium frequency
if between the average and maximum thresholds.</p>
</dd>
<dt>Required</dt><dd><p>Yes</p>
</dd>
<dt>Example</dt><dd><p><code class="docutils literal notranslate"><span class="pre">&quot;avg_packet_thresh&quot;:</span> <span class="pre">100000</span></code></p>
</dd>
</dl>
</div>
<div class="section" id="busy-hours">
<h4><span class="section-number">44.5.2.2. </span>busy_hours</h4>
<dl class="simple">
<dt>Description</dt><dd><p>The hours of the day in which we scale up the cores for busy times.</p>
</dd>
<dt>Type</dt><dd><p>array of integers</p>
</dd>
<dt>Values</dt><dd><p>An array with a list of hour values (0-23).</p>
</dd>
<dt>Required</dt><dd><p>For the TIME policy only.</p>
</dd>
<dt>Example</dt><dd><p><code class="docutils literal notranslate"><span class="pre">&quot;busy_hours&quot;:[</span> <span class="pre">17,</span> <span class="pre">18,</span> <span class="pre">19,</span> <span class="pre">20,</span> <span class="pre">21,</span> <span class="pre">22,</span> <span class="pre">23</span> <span class="pre">]</span></code></p>
</dd>
</dl>
</div>
<div class="section" id="command">
<h4><span class="section-number">44.5.2.3. </span>command</h4>
<dl class="simple">
<dt>Description</dt><dd><p>The type of packet to send to the VM Power Manager.
It is possible to create or destroy a policy or send a direct command
to adjust the frequency of a core,
as is possible on the command line interface.</p>
</dd>
<dt>Type</dt><dd><p>string</p>
</dd>
<dt>Values</dt><dd><p>Possible values are:
- CREATE: Create a new policy.
- DESTROY: Remove an existing policy.
- POWER: Send an immediate command, max, min, and so on.</p>
</dd>
<dt>Required</dt><dd><p>Yes</p>
</dd>
<dt>Example</dt><dd><p><code class="docutils literal notranslate"><span class="pre">&quot;command&quot;:</span> <span class="pre">&quot;CREATE&quot;</span></code></p>
</dd>
</dl>
</div>
<div class="section" id="core-list">
<h4><span class="section-number">44.5.2.4. </span>core_list</h4>
<dl class="simple">
<dt>Description</dt><dd><p>The cores to which to apply a policy.</p>
</dd>
<dt>Type</dt><dd><p>array of integers</p>
</dd>
<dt>Values</dt><dd><p>An array with a list of virtual CPUs.</p>
</dd>
<dt>Required</dt><dd><p>For CREATE/DESTROY policy requests only.</p>
</dd>
<dt>Example</dt><dd><p><code class="docutils literal notranslate"><span class="pre">&quot;core_list&quot;:[</span> <span class="pre">10,</span> <span class="pre">11</span> <span class="pre">]</span></code></p>
</dd>
</dl>
</div>
<div class="section" id="mac-list">
<h4><span class="section-number">44.5.2.5. </span>mac_list</h4>
<dl class="simple">
<dt>Description</dt><dd><p>When the policy is of type TRAFFIC,
it is necessary to specify the MAC addresses that the host must monitor.</p>
</dd>
<dt>Type</dt><dd><p>array of strings</p>
</dd>
<dt>Values</dt><dd><p>An array with a list of MAC address strings.</p>
</dd>
<dt>Required</dt><dd><p>For TRAFFIC policy types only.</p>
</dd>
<dt>Example</dt><dd><p><code class="docutils literal notranslate"><span class="pre">&quot;mac_list&quot;:[</span> <span class="pre">&quot;de:ad:be:ef:01:01&quot;,&quot;de:ad:be:ef:01:02&quot;</span> <span class="pre">]</span></code></p>
</dd>
</dl>
</div>
<div class="section" id="max-packet-thresh">
<h4><span class="section-number">44.5.2.6. </span>max_packet_thresh</h4>
<dl class="simple">
<dt>Description</dt><dd><p>In a policy of type TRAFFIC,
the threshold value above which the frequency is set to a maximum.</p>
</dd>
<dt>Type</dt><dd><p>integer</p>
</dd>
<dt>Values</dt><dd><p>The number of packets per interval above which
the TRAFFIC policy applies the maximum frequency.</p>
</dd>
<dt>Required</dt><dd><p>For the TRAFFIC policy only.</p>
</dd>
<dt>Example</dt><dd><p><code class="docutils literal notranslate"><span class="pre">&quot;max_packet_thresh&quot;:</span> <span class="pre">500000</span></code></p>
</dd>
</dl>
</div>
<div class="section" id="name">
<h4><span class="section-number">44.5.2.7. </span>name</h4>
<dl class="simple">
<dt>Description</dt><dd><p>The name of the VM or host.
Allows the parser to associate the policy with the relevant VM or host OS.</p>
</dd>
<dt>Type</dt><dd><p>string</p>
</dd>
<dt>Values</dt><dd><p>Any valid string.</p>
</dd>
<dt>Required</dt><dd><p>Yes</p>
</dd>
<dt>Example</dt><dd><p><code class="docutils literal notranslate"><span class="pre">&quot;name&quot;:</span> <span class="pre">&quot;ubuntu2&quot;</span></code></p>
</dd>
</dl>
</div>
<div class="section" id="policy-type">
<h4><span class="section-number">44.5.2.8. </span>policy_type</h4>
<dl class="simple">
<dt>Description</dt><dd><p>The type of policy to apply.
See the <code class="docutils literal notranslate"><span class="pre">--policy</span></code> option description for more information.</p>
</dd>
<dt>Type</dt><dd><p>string</p>
</dd>
<dt>Values</dt><dd><p>Possible values are:</p>
<ul class="simple">
<li><p>TIME: Time-of-day policy.
Scale the frequencies of the relevant cores up/down
depending on busy and quiet hours.</p></li>
<li><p>TRAFFIC: Use statistics from the NIC and scale up and down accordingly.</p></li>
<li><p>WORKLOAD: Determine how heavily loaded the cores are
and scale up and down accordingly.</p></li>
<li><p>BRANCH_RATIO: An out-of-band policy that looks at the ratio
between branch hits and misses on a core
and uses that information to determine how much packet processing
a core is doing.</p></li>
</ul>
</dd>
<dt>Required</dt><dd><p>For <code class="docutils literal notranslate"><span class="pre">CREATE</span></code> and <code class="docutils literal notranslate"><span class="pre">DESTROY</span></code> policy requests only.</p>
</dd>
<dt>Example</dt><dd><p><code class="docutils literal notranslate"><span class="pre">&quot;policy_type&quot;:</span> <span class="pre">&quot;TIME&quot;</span></code></p>
</dd>
</dl>
</div>
<div class="section" id="quiet-hours">
<h4><span class="section-number">44.5.2.9. </span>quiet_hours</h4>
<dl class="simple">
<dt>Description</dt><dd><p>The hours of the day to scale down the cores for quiet times.</p>
</dd>
<dt>Type</dt><dd><p>array of integers</p>
</dd>
<dt>Values</dt><dd><p>An array with a list of hour numbers with values in the range 0 to 23.</p>
</dd>
<dt>Required</dt><dd><p>For the TIME policy only.</p>
</dd>
<dt>Example</dt><dd><p><code class="docutils literal notranslate"><span class="pre">&quot;quiet_hours&quot;:[</span> <span class="pre">2,</span> <span class="pre">3,</span> <span class="pre">4,</span> <span class="pre">5,</span> <span class="pre">6</span> <span class="pre">]</span></code></p>
</dd>
</dl>
</div>
<div class="section" id="resource-id">
<h4><span class="section-number">44.5.2.10. </span>resource_id</h4>
<dl class="simple">
<dt>Description</dt><dd><p>The core to which to apply a power command.</p>
</dd>
<dt>Type</dt><dd><p>integer</p>
</dd>
<dt>Values</dt><dd><p>A valid core ID for the VM or host OS.</p>
</dd>
<dt>Required</dt><dd><p>For the <code class="docutils literal notranslate"><span class="pre">POWER</span></code> instruction only.</p>
</dd>
<dt>Example</dt><dd><p><code class="docutils literal notranslate"><span class="pre">&quot;resource_id&quot;:</span> <span class="pre">10</span></code></p>
</dd>
</dl>
</div>
<div class="section" id="unit">
<h4><span class="section-number">44.5.2.11. </span>unit</h4>
<dl class="simple">
<dt>Description</dt><dd><p>The type of power operation to apply in the command.</p>
</dd>
<dt>Type</dt><dd><p>string</p>
</dd>
<dt>Values</dt><dd><ul class="simple">
<li><p>SCALE_MAX: Scale the frequency of this core to the maximum.</p></li>
<li><p>SCALE_MIN: Scale the frequency of this core to the minimum.</p></li>
<li><p>SCALE_UP: Scale up the frequency of this core.</p></li>
<li><p>SCALE_DOWN: Scale down the frequency of this core.</p></li>
<li><p>ENABLE_TURBO: Enable IntelÂ® Turbo Boost Technology for this core.</p></li>
<li><p>DISABLE_TURBO: Disable IntelÂ® Turbo Boost Technology for this core.</p></li>
</ul>
</dd>
<dt>Required</dt><dd><p>For the <code class="docutils literal notranslate"><span class="pre">POWER</span></code> instruction only.</p>
</dd>
<dt>Example</dt><dd><p><code class="docutils literal notranslate"><span class="pre">&quot;unit&quot;:</span> <span class="pre">&quot;SCALE_MAX&quot;</span></code></p>
</dd>
</dl>
</div>
<div class="section" id="workload">
<h4><span class="section-number">44.5.2.12. </span>workload</h4>
<dl class="simple">
<dt>Description</dt><dd><p>In a policy of type WORKLOAD,
it is necessary to specify how heavy the workload is.</p>
</dd>
<dt>Type</dt><dd><p>string</p>
</dd>
<dt>Values</dt><dd><ul class="simple">
<li><p>HIGH: Scale the frequency of this core to maximum.</p></li>
<li><p>MEDIUM: Scale the frequency of this core to minimum.</p></li>
<li><p>LOW: Scale up the frequency of this core.</p></li>
</ul>
</dd>
<dt>Required</dt><dd><p>For the <code class="docutils literal notranslate"><span class="pre">WORKLOAD</span></code> policy only.</p>
</dd>
<dt>Example</dt><dd><p><code class="docutils literal notranslate"><span class="pre">&quot;workload&quot;:</span> <span class="pre">&quot;MEDIUM&quot;</span></code></p>
</dd>
</dl>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="ptpclient.html" class="btn btn-neutral float-right" title="45. PTP Client Sample Application" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="dist_app.html" class="btn btn-neutral float-left" title="43. Distributor Sample Application" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>