

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>9. Basic RTE Flow Filtering Sample Application &mdash; Data Plane Development Kit 20.11.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="10. IP Fragmentation Sample Application" href="ip_frag.html" />
    <link rel="prev" title="8. Flow Classify Sample Application" href="flow_classify.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Data Plane Development Kit
          

          
            
            <img src="../_static/DPDK_logo_vertical_rev_small.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                20.11.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../linux_gsg/index.html">Getting Started Guide for Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../freebsd_gsg/index.html">Getting Started Guide for FreeBSD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../windows_gsg/index.html">Getting Started Guide for Windows</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Sample Applications User Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">1. Introduction to the DPDK Sample Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="compiling.html">2. Compiling the Sample Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="cmd_line.html">3. Command Line Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="ethtool.html">4. Ethtool Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world.html">5. Hello World Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="skeleton.html">6. Basic Forwarding Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="rxtx_callbacks.html">7. RX/TX Callbacks Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="flow_classify.html">8. Flow Classify Sample Application</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">9. Basic RTE Flow Filtering Sample Application</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#compiling-the-application">9.1. Compiling the Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-the-application">9.2. Running the Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="#explanation">9.3. Explanation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-main-function">9.3.1. The Main Function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-port-initialization-function">9.3.2. The Port Initialization  Function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-main-loop-function">9.3.3. The main_loop function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-generate-ipv4-flow-function">9.3.4. The generate_ipv4_flow function</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="ip_frag.html">10. IP Fragmentation Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipv4_multicast.html">11. IPv4 Multicast Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="ip_reassembly.html">12. IP Reassembly Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="kernel_nic_interface.html">13. Kernel NIC Interface Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="keep_alive.html">14. Keep Alive Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="ioat.html">15. Packet copying using Intel® QuickData Technology</a></li>
<li class="toctree-l2"><a class="reference internal" href="l2_forward_crypto.html">16. L2 Forwarding with Crypto Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="l2_forward_job_stats.html">17. L2 Forwarding Sample Application (in Real and Virtualized Environments) with core load statistics.</a></li>
<li class="toctree-l2"><a class="reference internal" href="l2_forward_real_virtual.html">18. L2 Forwarding Sample Application (in Real and Virtualized Environments)</a></li>
<li class="toctree-l2"><a class="reference internal" href="l2_forward_event.html">19. L2 Forwarding Eventdev Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="l2_forward_cat.html">20. L2 Forwarding Sample Application with Cache Allocation Technology (CAT)</a></li>
<li class="toctree-l2"><a class="reference internal" href="l3_forward.html">21. L3 Forwarding Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="l3_forward_graph.html">22. L3 Forwarding Graph Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="l3_forward_power_man.html">23. L3 Forwarding with Power Management Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="l3_forward_access_ctrl.html">24. L3 Forwarding with Access Control Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_status_intr.html">25. Link Status Interrupt Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="server_node_efd.html">26. Server-Node EFD Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="service_cores.html">27. Service Cores Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi_process.html">28. Multi-process Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="qos_metering.html">29. QoS Metering Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="qos_scheduler.html">30. QoS Scheduler Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="timer.html">31. Timer Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="packet_ordering.html">32. Packet Ordering Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="vmdq_dcb_forwarding.html">33. VMDQ and DCB Forwarding Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="vmdq_forwarding.html">34. VMDq Forwarding Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="vhost.html">35. Vhost Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="vhost_blk.html">36. Vhost_blk Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="vhost_crypto.html">37. Vhost_Crypto Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="vdpa.html">38. Vdpa Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="ip_pipeline.html">39. Internet Protocol (IP) Pipeline Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="test_pipeline.html">40. Test Pipeline Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="pipeline.html">41. Pipeline Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="eventdev_pipeline.html">42. Eventdev Pipeline Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="dist_app.html">43. Distributor Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="vm_power_management.html">44. Virtual Machine Power Management Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="ptpclient.html">45. PTP Client Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="performance_thread.html">46. Performance Thread Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="fips_validation.html">47. Federal Information Processing Standards (FIPS) CryptoDev Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipsec_secgw.html">48. IPsec Security Gateway Sample Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="bbdev_app.html">49. Loop-back Sample Application using Baseband Device (bbdev)</a></li>
<li class="toctree-l2"><a class="reference internal" href="ntb.html">50. NTB Sample Application</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../prog_guide/index.html">Programmer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../howto/index.html">HowTo Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">DPDK Tools User Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testpmd_app_ug/index.html">Testpmd Application User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nics/index.html">Network Interface Controller Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bbdevs/index.html">Baseband Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cryptodevs/index.html">Crypto Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compressdevs/index.html">Compression Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vdpadevs/index.html">vDPA Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../regexdevs/index.html">REGEX Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../eventdevs/index.html">Event Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rawdevs/index.html">Rawdev Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mempool/index.html">Mempool Device Driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../platform/index.html">Platform Specific Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Contributor’s Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rel_notes/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">FAQ</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Data Plane Development Kit</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Sample Applications User Guides</a> &raquo;</li>
        
      <li><span class="section-number">9. </span>Basic RTE Flow Filtering Sample Application</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/sample_app_ug/flow_filtering.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="basic-rte-flow-filtering-sample-application">
<h1><span class="section-number">9. </span>Basic RTE Flow Filtering Sample Application</h1>
<p>The Basic RTE flow filtering sample application is a simple example of a
creating a RTE flow rule.</p>
<p>It is intended as a demonstration of the basic components RTE flow rules.</p>
<div class="section" id="compiling-the-application">
<h2><span class="section-number">9.1. </span>Compiling the Application</h2>
<p>To compile the sample application see <a class="reference internal" href="compiling.html"><span class="doc">Compiling the Sample Applications</span></a>.</p>
</div>
<div class="section" id="running-the-application">
<h2><span class="section-number">9.2. </span>Running the Application</h2>
<p>To run the example in a <code class="docutils literal notranslate"><span class="pre">linux</span></code> environment:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">./&lt;build_dir&gt;/examples/dpdk-flow_filtering -l 1 -n 1</span>
</pre></div>
</div>
<p>Refer to <em>DPDK Getting Started Guide</em> for general information on running
applications and the Environment Abstraction Layer (EAL) options.</p>
</div>
<div class="section" id="explanation">
<h2><span class="section-number">9.3. </span>Explanation</h2>
<p>The example is built from 2 files,
<code class="docutils literal notranslate"><span class="pre">main.c</span></code> which holds the example logic and <code class="docutils literal notranslate"><span class="pre">flow_blocks.c</span></code> that holds the
implementation for building the flow rule.</p>
<p>The following sections provide an explanation of the main components of the
code.</p>
<p>All DPDK library functions used in the sample code are prefixed with <code class="docutils literal notranslate"><span class="pre">rte_</span></code>
and are explained in detail in the <em>DPDK API Documentation</em>.</p>
<div class="section" id="the-main-function">
<h3><span class="section-number">9.3.1. </span>The Main Function</h3>
<p>The <code class="docutils literal notranslate"><span class="pre">main()</span></code> function located in <code class="docutils literal notranslate"><span class="pre">main.c</span></code> file performs the initialization
and runs the main loop function.</p>
<p>The first task is to initialize the Environment Abstraction Layer (EAL).  The
<code class="docutils literal notranslate"><span class="pre">argc</span></code> and <code class="docutils literal notranslate"><span class="pre">argv</span></code> arguments are provided to the <code class="docutils literal notranslate"><span class="pre">rte_eal_init()</span></code>
function. The value returned is the number of parsed arguments:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">rte_eal_init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">rte_exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span> <span class="s">&quot;Error with EAL initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">main()</span></code> also allocates a mempool to hold the mbufs (Message Buffers)
used by the application:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">mbuf_pool</span> <span class="o">=</span> <span class="n">rte_pktmbuf_pool_create</span><span class="p">(</span><span class="s">&quot;mbuf_pool&quot;</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                         <span class="n">RTE_MBUF_DEFAULT_BUF_SIZE</span><span class="p">,</span>
                                         <span class="n">rte_socket_id</span><span class="p">());</span>
</pre></div>
</div>
<p>Mbufs are the packet buffer structure used by DPDK. They are explained in
detail in the “Mbuf Library” section of the <em>DPDK Programmer’s Guide</em>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">main()</span></code> function also initializes all the ports using the user defined
<code class="docutils literal notranslate"><span class="pre">init_port()</span></code> function which is explained in the next section:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">init_port</span><span class="p">();</span>
</pre></div>
</div>
<p>Once the initialization is complete, we set the flow rule using the
following code:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* create flow for send packet with */</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">generate_ipv4_flow</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span> <span class="n">selected_queue</span><span class="p">,</span>
                             <span class="n">SRC_IP</span><span class="p">,</span> <span class="n">EMPTY_MASK</span><span class="p">,</span>
                             <span class="n">DEST_IP</span><span class="p">,</span> <span class="n">FULL_MASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flow</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Flow can&#39;t be created %d message: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">error</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
                    <span class="n">error</span><span class="p">.</span><span class="n">message</span> <span class="o">?</span> <span class="n">error</span><span class="p">.</span><span class="nl">message</span> <span class="p">:</span> <span class="s">&quot;(no stated reason)&quot;</span><span class="p">);</span>
       <span class="n">rte_exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span> <span class="s">&quot;error in creating flow&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the last part the application is ready to launch the
<code class="docutils literal notranslate"><span class="pre">main_loop()</span></code> function. Which is explained below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">main_loop</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="the-port-initialization-function">
<h3><span class="section-number">9.3.2. </span>The Port Initialization  Function</h3>
<p>The main functional part of the port initialization used in the flow filtering
application is shown below:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">init_port</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
        <span class="kt">uint16_t</span> <span class="n">i</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">rte_eth_conf</span> <span class="n">port_conf</span> <span class="o">=</span> <span class="p">{</span>
                <span class="p">.</span><span class="n">rxmode</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="p">.</span><span class="n">split_hdr_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">},</span>
                <span class="p">.</span><span class="n">txmode</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="p">.</span><span class="n">offloads</span> <span class="o">=</span>
                                <span class="n">DEV_TX_OFFLOAD_VLAN_INSERT</span> <span class="o">|</span>
                                <span class="n">DEV_TX_OFFLOAD_IPV4_CKSUM</span>  <span class="o">|</span>
                                <span class="n">DEV_TX_OFFLOAD_UDP_CKSUM</span>   <span class="o">|</span>
                                <span class="n">DEV_TX_OFFLOAD_TCP_CKSUM</span>   <span class="o">|</span>
                                <span class="n">DEV_TX_OFFLOAD_SCTP_CKSUM</span>  <span class="o">|</span>
                                <span class="n">DEV_TX_OFFLOAD_TCP_TSO</span><span class="p">,</span>
                <span class="p">},</span>
        <span class="p">};</span>
        <span class="k">struct</span> <span class="n">rte_eth_txconf</span> <span class="n">txq_conf</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">rte_eth_rxconf</span> <span class="n">rxq_conf</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">rte_eth_dev_info</span> <span class="n">dev_info</span><span class="p">;</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;:: initializing port: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port_id</span><span class="p">);</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">rte_eth_dev_configure</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span>
                <span class="n">nr_queues</span><span class="p">,</span> <span class="n">nr_queues</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_conf</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">rte_exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span>
                        <span class="s">&quot;:: cannot configure device: err=%d, port=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">ret</span><span class="p">,</span> <span class="n">port_id</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">rte_eth_dev_info_get</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_info</span><span class="p">);</span>
        <span class="n">rxq_conf</span> <span class="o">=</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">default_rxconf</span><span class="p">;</span>
        <span class="n">rxq_conf</span><span class="p">.</span><span class="n">offloads</span> <span class="o">=</span> <span class="n">port_conf</span><span class="p">.</span><span class="n">rxmode</span><span class="p">.</span><span class="n">offloads</span><span class="p">;</span>
        <span class="cm">/* only set Rx queues: something we care only so far */</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">rte_eth_rx_queue_setup</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span>
                        <span class="n">rte_eth_dev_socket_id</span><span class="p">(</span><span class="n">port_id</span><span class="p">),</span>
                        <span class="o">&amp;</span><span class="n">rxq_conf</span><span class="p">,</span>
                        <span class="n">mbuf_pool</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                         <span class="n">rte_exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span>
                                 <span class="s">&quot;:: Rx queue setup failed: err=%d, port=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                 <span class="n">ret</span><span class="p">,</span> <span class="n">port_id</span><span class="p">);</span>
                <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">txq_conf</span> <span class="o">=</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">default_txconf</span><span class="p">;</span>
        <span class="n">txq_conf</span><span class="p">.</span><span class="n">offloads</span> <span class="o">=</span> <span class="n">port_conf</span><span class="p">.</span><span class="n">txmode</span><span class="p">.</span><span class="n">offloads</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">rte_eth_tx_queue_setup</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span>
                        <span class="n">rte_eth_dev_socket_id</span><span class="p">(</span><span class="n">port_id</span><span class="p">),</span>
                        <span class="o">&amp;</span><span class="n">txq_conf</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">rte_exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span>
                                <span class="s">&quot;:: Tx queue setup failed: err=%d, port=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                <span class="n">ret</span><span class="p">,</span> <span class="n">port_id</span><span class="p">);</span>
                <span class="p">}</span>
       <span class="p">}</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">rte_eth_promiscuous_enable</span><span class="p">(</span><span class="n">port_id</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">rte_exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span>
                        <span class="s">&quot;:: cannot enable promiscuous mode: err=%d, port=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">ret</span><span class="p">,</span> <span class="n">port_id</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">rte_eth_dev_start</span><span class="p">(</span><span class="n">port_id</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">rte_exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span>
                        <span class="s">&quot;rte_eth_dev_start:err=%d, port=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">ret</span><span class="p">,</span> <span class="n">port_id</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">assert_link_status</span><span class="p">();</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;:: initializing port: %d done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port_id</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The Ethernet port is configured with default settings using the
<code class="docutils literal notranslate"><span class="pre">rte_eth_dev_configure()</span></code> function and the <code class="docutils literal notranslate"><span class="pre">port_conf_default</span></code> struct:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">rte_eth_conf</span> <span class="n">port_conf</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">rxmode</span> <span class="o">=</span> <span class="p">{</span>
                <span class="p">.</span><span class="n">split_hdr_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="p">},</span>
        <span class="p">.</span><span class="n">txmode</span> <span class="o">=</span> <span class="p">{</span>
                <span class="p">.</span><span class="n">offloads</span> <span class="o">=</span>
                        <span class="n">DEV_TX_OFFLOAD_VLAN_INSERT</span> <span class="o">|</span>
                        <span class="n">DEV_TX_OFFLOAD_IPV4_CKSUM</span>  <span class="o">|</span>
                        <span class="n">DEV_TX_OFFLOAD_UDP_CKSUM</span>   <span class="o">|</span>
                        <span class="n">DEV_TX_OFFLOAD_TCP_CKSUM</span>   <span class="o">|</span>
                        <span class="n">DEV_TX_OFFLOAD_SCTP_CKSUM</span>  <span class="o">|</span>
                        <span class="n">DEV_TX_OFFLOAD_TCP_TSO</span><span class="p">,</span>
                <span class="p">},</span>
        <span class="p">};</span>

<span class="n">ret</span> <span class="o">=</span> <span class="n">rte_eth_dev_configure</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span> <span class="n">nr_queues</span><span class="p">,</span> <span class="n">nr_queues</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_conf</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">rte_exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span>
              <span class="s">&quot;:: cannot configure device: err=%d, port=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
              <span class="n">ret</span><span class="p">,</span> <span class="n">port_id</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">rte_eth_dev_info_get</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_info</span><span class="p">);</span>
<span class="n">rxq_conf</span> <span class="o">=</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">default_rxconf</span><span class="p">;</span>
<span class="n">rxq_conf</span><span class="p">.</span><span class="n">offloads</span> <span class="o">=</span> <span class="n">port_conf</span><span class="p">.</span><span class="n">rxmode</span><span class="p">.</span><span class="n">offloads</span><span class="p">;</span>
</pre></div>
</div>
<p>For this example we are configuring number of rx and tx queues that are connected
to a single port.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">ret</span> <span class="o">=</span> <span class="n">rte_eth_rx_queue_setup</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span>
                                    <span class="n">rte_eth_dev_socket_id</span><span class="p">(</span><span class="n">port_id</span><span class="p">),</span>
                                    <span class="o">&amp;</span><span class="n">rxq_conf</span><span class="p">,</span>
                                    <span class="n">mbuf_pool</span><span class="p">);</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">rte_exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span>
                       <span class="s">&quot;:: Rx queue setup failed: err=%d, port=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                       <span class="n">ret</span><span class="p">,</span> <span class="n">port_id</span><span class="p">);</span>
       <span class="p">}</span>
<span class="p">}</span>

<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">ret</span> <span class="o">=</span> <span class="n">rte_eth_tx_queue_setup</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span>
                                    <span class="n">rte_eth_dev_socket_id</span><span class="p">(</span><span class="n">port_id</span><span class="p">),</span>
                                    <span class="o">&amp;</span><span class="n">txq_conf</span><span class="p">);</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">rte_exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span>
                        <span class="s">&quot;:: Tx queue setup failed: err=%d, port=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">ret</span><span class="p">,</span> <span class="n">port_id</span><span class="p">);</span>
       <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the next step we create and apply the flow rule. which is to send packets
with destination ip equals to 192.168.1.1 to queue number 1. The detail
explanation of the <code class="docutils literal notranslate"><span class="pre">generate_ipv4_flow()</span></code> appears later in this document:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">flow</span> <span class="o">=</span> <span class="n">generate_ipv4_flow</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span> <span class="n">selected_queue</span><span class="p">,</span>
                          <span class="n">SRC_IP</span><span class="p">,</span> <span class="n">EMPTY_MASK</span><span class="p">,</span>
                          <span class="n">DEST_IP</span><span class="p">,</span> <span class="n">FULL_MASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
</pre></div>
</div>
<p>We are setting the RX port to promiscuous mode:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">ret</span> <span class="o">=</span> <span class="n">rte_eth_promiscuous_enable</span><span class="p">(</span><span class="n">port_id</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">rte_exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span>
              <span class="s">&quot;:: cannot enable promiscuous mode: err=%d, port=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
              <span class="n">ret</span><span class="p">,</span> <span class="n">port_id</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The last step is to start the port.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">ret</span> <span class="o">=</span> <span class="n">rte_eth_dev_start</span><span class="p">(</span><span class="n">port_id</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="p">{</span>
     <span class="n">rte_exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span> <span class="s">&quot;rte_eth_dev_start:err%d, port=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                     <span class="n">ret</span><span class="p">,</span> <span class="n">port_id</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="the-main-loop-function">
<h3><span class="section-number">9.3.3. </span>The main_loop function</h3>
<p>As we saw above the <code class="docutils literal notranslate"><span class="pre">main()</span></code> function calls an application function to handle
the main loop. For the flow filtering application the main_loop function
looks like the following:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span>
<span class="nf">main_loop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">rte_mbuf</span> <span class="o">*</span><span class="n">mbufs</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
        <span class="k">struct</span> <span class="n">rte_ether_hdr</span> <span class="o">*</span><span class="n">eth_hdr</span><span class="p">;</span>
        <span class="kt">uint16_t</span> <span class="n">nb_rx</span><span class="p">;</span>
        <span class="kt">uint16_t</span> <span class="n">i</span><span class="p">;</span>
        <span class="kt">uint16_t</span> <span class="n">j</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">force_quit</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">nb_rx</span> <span class="o">=</span> <span class="n">rte_eth_rx_burst</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span>
                                                <span class="n">i</span><span class="p">,</span> <span class="n">mbufs</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">nb_rx</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nb_rx</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="k">struct</span> <span class="n">rte_mbuf</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">mbufs</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

                                        <span class="n">eth_hdr</span> <span class="o">=</span> <span class="n">rte_pktmbuf_mtod</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
                                                     <span class="k">struct</span> <span class="n">rte_ether_hdr</span> <span class="o">*</span><span class="p">);</span>
                                        <span class="n">print_ether_addr</span><span class="p">(</span><span class="s">&quot;src=&quot;</span><span class="p">,</span>
                                                     <span class="o">&amp;</span><span class="n">eth_hdr</span><span class="o">-&gt;</span><span class="n">s_addr</span><span class="p">);</span>
                                        <span class="n">print_ether_addr</span><span class="p">(</span><span class="s">&quot; - dst=&quot;</span><span class="p">,</span>
                                                     <span class="o">&amp;</span><span class="n">eth_hdr</span><span class="o">-&gt;</span><span class="n">d_addr</span><span class="p">);</span>
                                        <span class="n">printf</span><span class="p">(</span><span class="s">&quot; - queue=0x%x&quot;</span><span class="p">,</span>
                                                        <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">i</span><span class="p">);</span>
                                        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                                        <span class="n">rte_pktmbuf_free</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
                                <span class="p">}</span>
                        <span class="p">}</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="cm">/* closing and releasing resources */</span>
        <span class="n">rte_flow_flush</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
        <span class="n">rte_eth_dev_stop</span><span class="p">(</span><span class="n">port_id</span><span class="p">);</span>
        <span class="n">rte_eth_dev_close</span><span class="p">(</span><span class="n">port_id</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The main work of the application is reading the packets from all
queues and printing for each packet the destination queue:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">force_quit</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">nb_rx</span> <span class="o">=</span> <span class="n">rte_eth_rx_burst</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mbufs</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nb_rx</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nb_rx</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                         <span class="k">struct</span> <span class="n">rte_mbuf</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">mbufs</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
                         <span class="n">eth_hdr</span> <span class="o">=</span> <span class="n">rte_pktmbuf_mtod</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rte_ether_hdr</span> <span class="o">*</span><span class="p">);</span>
                         <span class="n">print_ether_addr</span><span class="p">(</span><span class="s">&quot;src=&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eth_hdr</span><span class="o">-&gt;</span><span class="n">s_addr</span><span class="p">);</span>
                         <span class="n">print_ether_addr</span><span class="p">(</span><span class="s">&quot; - dst=&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eth_hdr</span><span class="o">-&gt;</span><span class="n">d_addr</span><span class="p">);</span>
                         <span class="n">printf</span><span class="p">(</span><span class="s">&quot; - queue=0x%x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">i</span><span class="p">);</span>
                         <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                         <span class="n">rte_pktmbuf_free</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
                    <span class="p">}</span>
            <span class="p">}</span>
       <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The forwarding loop can be interrupted and the application closed using
<code class="docutils literal notranslate"><span class="pre">Ctrl-C</span></code>. Which results in closing the port and the device using
<code class="docutils literal notranslate"><span class="pre">rte_eth_dev_stop</span></code> and <code class="docutils literal notranslate"><span class="pre">rte_eth_dev_close</span></code></p>
</div>
<div class="section" id="the-generate-ipv4-flow-function">
<h3><span class="section-number">9.3.4. </span>The generate_ipv4_flow function</h3>
<p>The generate_ipv4_flow function is responsible for creating the flow rule.
This function is located in the <code class="docutils literal notranslate"><span class="pre">flow_blocks.c</span></code> file.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="k">struct</span> <span class="n">rte_flow</span> <span class="o">*</span>
<span class="nf">generate_ipv4_flow</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">port_id</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">rx_q</span><span class="p">,</span>
                <span class="kt">uint32_t</span> <span class="n">src_ip</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">src_mask</span><span class="p">,</span>
                <span class="kt">uint32_t</span> <span class="n">dest_ip</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">dest_mask</span><span class="p">,</span>
                <span class="k">struct</span> <span class="n">rte_flow_error</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">rte_flow_attr</span> <span class="n">attr</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">rte_flow_item</span> <span class="n">pattern</span><span class="p">[</span><span class="n">MAX_PATTERN_NUM</span><span class="p">];</span>
        <span class="k">struct</span> <span class="n">rte_flow_action</span> <span class="n">action</span><span class="p">[</span><span class="n">MAX_ACTION_NUM</span><span class="p">];</span>
        <span class="k">struct</span> <span class="n">rte_flow</span> <span class="o">*</span><span class="n">flow</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">rte_flow_action_queue</span> <span class="n">queue</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">rx_q</span> <span class="p">};</span>
        <span class="k">struct</span> <span class="n">rte_flow_item_ipv4</span> <span class="n">ip_spec</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">rte_flow_item_ipv4</span> <span class="n">ip_mask</span><span class="p">;</span>

        <span class="n">memset</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pattern</span><span class="p">));</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">action</span><span class="p">));</span>

        <span class="cm">/*</span>
<span class="cm">         * set the rule attribute.</span>
<span class="cm">         * in this case only ingress packets will be checked.</span>
<span class="cm">         */</span>
        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rte_flow_attr</span><span class="p">));</span>
        <span class="n">attr</span><span class="p">.</span><span class="n">ingress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="cm">/*</span>
<span class="cm">         * create the action sequence.</span>
<span class="cm">         * one action only,  move packet to queue</span>
<span class="cm">         */</span>
        <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">RTE_FLOW_ACTION_TYPE_QUEUE</span><span class="p">;</span>
        <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">queue</span><span class="p">;</span>
        <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">RTE_FLOW_ACTION_TYPE_END</span><span class="p">;</span>

        <span class="cm">/*</span>
<span class="cm">         * set the first level of the pattern (ETH).</span>
<span class="cm">         * since in this example we just want to get the</span>
<span class="cm">         * ipv4 we set this level to allow all.</span>
<span class="cm">         */</span>
        <span class="n">pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">RTE_FLOW_ITEM_TYPE_ETH</span><span class="p">;</span>

        <span class="cm">/*</span>
<span class="cm">         * setting the second level of the pattern (IP).</span>
<span class="cm">         * in this example this is the level we care about</span>
<span class="cm">         * so we set it according to the parameters.</span>
<span class="cm">         */</span>
        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip_spec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rte_flow_item_ipv4</span><span class="p">));</span>
        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rte_flow_item_ipv4</span><span class="p">));</span>
        <span class="n">ip_spec</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">dst_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">dest_ip</span><span class="p">);</span>
        <span class="n">ip_mask</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">dst_addr</span> <span class="o">=</span> <span class="n">dest_mask</span><span class="p">;</span>
        <span class="n">ip_spec</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">src_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">src_ip</span><span class="p">);</span>
        <span class="n">ip_mask</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">src_addr</span> <span class="o">=</span> <span class="n">src_mask</span><span class="p">;</span>
        <span class="n">pattern</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">RTE_FLOW_ITEM_TYPE_IPV4</span><span class="p">;</span>
        <span class="n">pattern</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">spec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ip_spec</span><span class="p">;</span>
        <span class="n">pattern</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">mask</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ip_mask</span><span class="p">;</span>

        <span class="cm">/* the final level must be always type end */</span>
        <span class="n">pattern</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">RTE_FLOW_ITEM_TYPE_END</span><span class="p">;</span>

        <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">rte_flow_validate</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">rte_flow_create</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">flow</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The first part of the function is declaring the structures that will be used.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">rte_flow_attr</span> <span class="n">attr</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">rte_flow_item</span> <span class="n">pattern</span><span class="p">[</span><span class="n">MAX_PATTERN_NUM</span><span class="p">];</span>
<span class="k">struct</span> <span class="n">rte_flow_action</span> <span class="n">action</span><span class="p">[</span><span class="n">MAX_ACTION_NUM</span><span class="p">];</span>
<span class="k">struct</span> <span class="n">rte_flow</span> <span class="o">*</span><span class="n">flow</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">rte_flow_error</span> <span class="n">error</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">rte_flow_action_queue</span> <span class="n">queue</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">rx_q</span> <span class="p">};</span>
<span class="k">struct</span> <span class="n">rte_flow_item_ipv4</span> <span class="n">ip_spec</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">rte_flow_item_ipv4</span> <span class="n">ip_mask</span><span class="p">;</span>
</pre></div>
</div>
<p>The following part create the flow attributes, in our case ingress.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rte_flow_attr</span><span class="p">));</span>
<span class="n">attr</span><span class="p">.</span><span class="n">ingress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
<p>The third part defines the action to be taken when a packet matches
the rule. In this case send the packet to queue.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">RTE_FLOW_ACTION_TYPE_QUEUE</span><span class="p">;</span>
<span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">queue</span><span class="p">;</span>
<span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">RTE_FLOW_ACTION_TYPE_END</span><span class="p">;</span>
</pre></div>
</div>
<p>The fourth part is responsible for creating the pattern and is built from
number of steps. In each step we build one level of the pattern starting with
the lowest one.</p>
<p>Setting the first level of the pattern ETH:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">RTE_FLOW_ITEM_TYPE_ETH</span><span class="p">;</span>
</pre></div>
</div>
<p>Setting the second level of the pattern IP:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip_spec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rte_flow_item_ipv4</span><span class="p">));</span>
<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rte_flow_item_ipv4</span><span class="p">));</span>
<span class="n">ip_spec</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">dst_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">dest_ip</span><span class="p">);</span>
<span class="n">ip_mask</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">dst_addr</span> <span class="o">=</span> <span class="n">dest_mask</span><span class="p">;</span>
<span class="n">ip_spec</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">src_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">src_ip</span><span class="p">);</span>
<span class="n">ip_mask</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">src_addr</span> <span class="o">=</span> <span class="n">src_mask</span><span class="p">;</span>
<span class="n">pattern</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">RTE_FLOW_ITEM_TYPE_IPV4</span><span class="p">;</span>
<span class="n">pattern</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">spec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ip_spec</span><span class="p">;</span>
<span class="n">pattern</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">mask</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ip_mask</span><span class="p">;</span>
</pre></div>
</div>
<p>Closing the pattern part.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">pattern</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">RTE_FLOW_ITEM_TYPE_END</span><span class="p">;</span>
</pre></div>
</div>
<p>The last part of the function is to validate the rule and create it.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">rte_flow_validate</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
     <span class="n">flow</span> <span class="o">=</span> <span class="n">rte_flow_create</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="ip_frag.html" class="btn btn-neutral float-right" title="10. IP Fragmentation Sample Application" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="flow_classify.html" class="btn btn-neutral float-left" title="8. Flow Classify Sample Application" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>