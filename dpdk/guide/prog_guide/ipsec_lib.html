

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>52. IPsec Packet Processing Library &mdash; Data Plane Development Kit 20.11.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="53. Graph Library and Inbuilt Nodes" href="graph_lib.html" />
    <link rel="prev" title="51. Berkeley Packet Filter Library" href="bpf_lib.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Data Plane Development Kit
          

          
            
            <img src="../_static/DPDK_logo_vertical_rev_small.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                20.11.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../linux_gsg/index.html">Getting Started Guide for Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../freebsd_gsg/index.html">Getting Started Guide for FreeBSD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../windows_gsg/index.html">Getting Started Guide for Windows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sample_app_ug/index.html">Sample Applications User Guides</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Programmer’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">1. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html">2. Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="env_abstraction_layer.html">3. Environment Abstraction Layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="service_cores.html">4. Service Cores</a></li>
<li class="toctree-l2"><a class="reference internal" href="trace_lib.html">5. Trace Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="rcu_lib.html">6. RCU Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="ring_lib.html">7. Ring Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="stack_lib.html">8. Stack Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="mempool_lib.html">9. Mempool Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="mbuf_lib.html">10. Mbuf Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="poll_mode_drv.html">11. Poll Mode Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="rte_flow.html">12. Generic flow API (rte_flow)</a></li>
<li class="toctree-l2"><a class="reference internal" href="switch_representation.html">13. Switch Representation within DPDK Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="traffic_metering_and_policing.html">14. Traffic Metering and Policing API</a></li>
<li class="toctree-l2"><a class="reference internal" href="traffic_management.html">15. Traffic Management API</a></li>
<li class="toctree-l2"><a class="reference internal" href="bbdev.html">16. Wireless Baseband Device Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="cryptodev_lib.html">17. Cryptography Device Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="compressdev.html">18. Compression Device Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="regexdev.html">19. RegEx Device Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="rte_security.html">20. Security Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="rawdev.html">21. Rawdevice Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_bonding_poll_mode_drv_lib.html">22. Link Bonding Poll Mode Driver Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="timer_lib.html">23. Timer Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="hash_lib.html">24. Hash Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="efd_lib.html">25. Elastic Flow Distributor Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="member_lib.html">26. Membership Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="lpm_lib.html">27. LPM Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="lpm6_lib.html">28. LPM6 Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="flow_classify_lib.html">29. Flow Classification Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="packet_distrib_lib.html">30. Packet Distributor Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="reorder_lib.html">31. Reorder Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="ip_fragment_reassembly_lib.html">32. IP Fragmentation and Reassembly Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="generic_receive_offload_lib.html">33. Generic Receive Offload Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="generic_segmentation_offload_lib.html">34. Generic Segmentation Offload Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="pdump_lib.html">35. The librte_pdump Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi_proc_support.html">36. Multi-process Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="kernel_nic_interface.html">37. Kernel NIC Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="thread_safety_dpdk_functions.html">38. Thread Safety of DPDK Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="eventdev.html">39. Event Device Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_ethernet_rx_adapter.html">40. Event Ethernet Rx Adapter Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_ethernet_tx_adapter.html">41. Event Ethernet Tx Adapter Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_timer_adapter.html">42. Event Timer Adapter Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_crypto_adapter.html">43. Event Crypto Adapter Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="qos_framework.html">44. Quality of Service (QoS) Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="power_man.html">45. Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="packet_classif_access_ctrl.html">46. Packet Classification and Access Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="packet_framework.html">47. Packet Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="vhost_lib.html">48. Vhost Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="metrics_lib.html">49. Metrics Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="telemetry_lib.html">50. Telemetry Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="bpf_lib.html">51. Berkeley Packet Filter Library</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">52. IPsec Packet Processing Library</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sa-level-api">52.1. SA level API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#rte-security-action-type-none">52.1.1. RTE_SECURITY_ACTION_TYPE_NONE</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rte-security-action-type-cpu-crypto">52.1.2. RTE_SECURITY_ACTION_TYPE_CPU_CRYPTO</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rte-security-action-type-inline-crypto">52.1.3. RTE_SECURITY_ACTION_TYPE_INLINE_CRYPTO</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rte-security-action-type-inline-protocol">52.1.4. RTE_SECURITY_ACTION_TYPE_INLINE_PROTOCOL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rte-security-action-type-lookaside-protocol">52.1.5. RTE_SECURITY_ACTION_TYPE_LOOKASIDE_PROTOCOL</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sa-database-api">52.2. SA database API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#create-destroy">52.2.1. Create/destroy</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-delete-rules">52.2.2. Add/delete rules</a></li>
<li class="toctree-l4"><a class="reference internal" href="#lookup">52.2.3. Lookup</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#supported-features">52.3. Supported features</a></li>
<li class="toctree-l3"><a class="reference internal" href="#limitations">52.4. Limitations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="graph_lib.html">53. Graph Library and Inbuilt Nodes</a></li>
<li class="toctree-l2"><a class="reference internal" href="source_org.html">54. Source Organization</a></li>
<li class="toctree-l2"><a class="reference internal" href="build-sdk-meson.html">55. Installing DPDK Using the meson build system</a></li>
<li class="toctree-l2"><a class="reference internal" href="meson_ut.html">56. Running DPDK Unit Tests with Meson</a></li>
<li class="toctree-l2"><a class="reference internal" href="build_app.html">57. Building Your Own Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="perf_opt_guidelines.html">58. Performance Optimization Guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="writing_efficient_code.html">59. Writing Efficient Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="lto.html">60. Link Time Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="profile_app.html">61. Profile Your Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="glossary.html">62. Glossary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../howto/index.html">HowTo Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">DPDK Tools User Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testpmd_app_ug/index.html">Testpmd Application User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nics/index.html">Network Interface Controller Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bbdevs/index.html">Baseband Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cryptodevs/index.html">Crypto Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compressdevs/index.html">Compression Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vdpadevs/index.html">vDPA Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../regexdevs/index.html">REGEX Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../eventdevs/index.html">Event Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rawdevs/index.html">Rawdev Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mempool/index.html">Mempool Device Driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../platform/index.html">Platform Specific Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Contributor’s Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rel_notes/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">FAQ</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Data Plane Development Kit</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Programmer’s Guide</a> &raquo;</li>
        
      <li><span class="section-number">52. </span>IPsec Packet Processing Library</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/prog_guide/ipsec_lib.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="ipsec-packet-processing-library">
<h1><span class="section-number">52. </span>IPsec Packet Processing Library</h1>
<p>DPDK provides a library for IPsec data-path processing.
The library utilizes the existing DPDK crypto-dev and
security API to provide the application with a transparent and
high performant IPsec packet processing API.
The library is concentrated on data-path protocols processing
(ESP and AH), IKE protocol(s) implementation is out of scope
for this library.</p>
<div class="section" id="sa-level-api">
<h2><span class="section-number">52.1. </span>SA level API</h2>
<p>This API operates on the IPsec Security Association (SA) level.
It provides functionality that allows user for given SA to process
inbound and outbound IPsec packets.</p>
<p>To be more specific:</p>
<ul class="simple">
<li><p>for inbound ESP/AH packets perform decryption, authentication, integrity checking, remove ESP/AH related headers</p></li>
<li><p>for outbound packets perform payload encryption, attach ICV, update/add IP headers, add ESP/AH headers/trailers,</p></li>
<li><p>setup related mbuf fields (ol_flags, tx_offloads, etc.).</p></li>
<li><p>initialize/un-initialize given SA based on user provided parameters.</p></li>
</ul>
<p>The SA level API is based on top of crypto-dev/security API and relies on
them to perform actual cipher and integrity checking.</p>
<p>Due to the nature of the crypto-dev API (enqueue/dequeue model) the library
introduces an asynchronous API for IPsec packets destined to be processed by
the crypto-device.</p>
<p>The expected API call sequence for data-path processing would be:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* enqueue for processing by crypto-device */</span>
<span class="n">rte_ipsec_pkt_crypto_prepare</span><span class="p">(...);</span>
<span class="n">rte_cryptodev_enqueue_burst</span><span class="p">(...);</span>
<span class="cm">/* dequeue from crypto-device and do final processing (if any) */</span>
<span class="n">rte_cryptodev_dequeue_burst</span><span class="p">(...);</span>
<span class="n">rte_ipsec_pkt_crypto_group</span><span class="p">(...);</span> <span class="cm">/* optional */</span>
<span class="n">rte_ipsec_pkt_process</span><span class="p">(...);</span>
</pre></div>
</div>
<p>For packets destined for inline processing no extra overhead
is required and the synchronous API call: rte_ipsec_pkt_process()
is sufficient for that case.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For more details about the IPsec API, please refer to the <em>DPDK API Reference</em>.</p>
</div>
<p>The current implementation supports all four currently defined
rte_security types:</p>
<div class="section" id="rte-security-action-type-none">
<h3><span class="section-number">52.1.1. </span>RTE_SECURITY_ACTION_TYPE_NONE</h3>
<p>In that mode the library functions perform</p>
<ul class="simple">
<li><p>for inbound packets:</p>
<ul>
<li><p>check SQN</p></li>
<li><p>prepare <em>rte_crypto_op</em> structure for each input packet</p></li>
<li><p>verify that integrity check and decryption performed by crypto device
completed successfully</p></li>
<li><p>check padding data</p></li>
<li><p>remove outer IP header (tunnel mode) / update IP header (transport mode)</p></li>
<li><p>remove ESP header and trailer, padding, IV and ICV data</p></li>
<li><p>update SA replay window</p></li>
</ul>
</li>
<li><p>for outbound packets:</p>
<ul>
<li><p>generate SQN and IV</p></li>
<li><p>add outer IP header (tunnel mode) / update IP header (transport mode)</p></li>
<li><p>add ESP header and trailer, padding and IV data</p></li>
<li><p>prepare <em>rte_crypto_op</em> structure for each input packet</p></li>
<li><p>verify that crypto device operations (encryption, ICV generation)
were completed successfully</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="rte-security-action-type-cpu-crypto">
<h3><span class="section-number">52.1.2. </span>RTE_SECURITY_ACTION_TYPE_CPU_CRYPTO</h3>
<p>In that mode the library functions perform same operations as in
<code class="docutils literal notranslate"><span class="pre">RTE_SECURITY_ACTION_TYPE_NONE</span></code>. The only difference is that crypto operations
are performed with CPU crypto synchronous API.</p>
</div>
<div class="section" id="rte-security-action-type-inline-crypto">
<h3><span class="section-number">52.1.3. </span>RTE_SECURITY_ACTION_TYPE_INLINE_CRYPTO</h3>
<p>In that mode the library functions perform</p>
<ul class="simple">
<li><p>for inbound packets:</p>
<ul>
<li><p>verify that integrity check and decryption performed by <em>rte_security</em>
device completed successfully</p></li>
<li><p>check SQN</p></li>
<li><p>check padding data</p></li>
<li><p>remove outer IP header (tunnel mode) / update IP header (transport mode)</p></li>
<li><p>remove ESP header and trailer, padding, IV and ICV data</p></li>
<li><p>update SA replay window</p></li>
</ul>
</li>
<li><p>for outbound packets:</p>
<ul>
<li><p>generate SQN and IV</p></li>
<li><p>add outer IP header (tunnel mode) / update IP header (transport mode)</p></li>
<li><p>add ESP header and trailer, padding and IV data</p></li>
<li><p>update <em>ol_flags</em> inside <em>struct  rte_mbuf</em> to indicate that
inline-crypto processing has to be performed by HW on this packet</p></li>
<li><p>invoke <em>rte_security</em> device specific <em>set_pkt_metadata()</em> to associate
security device specific data with the packet</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="rte-security-action-type-inline-protocol">
<h3><span class="section-number">52.1.4. </span>RTE_SECURITY_ACTION_TYPE_INLINE_PROTOCOL</h3>
<p>In that mode the library functions perform</p>
<ul class="simple">
<li><p>for inbound packets:</p>
<ul>
<li><p>verify that integrity check and decryption performed by <em>rte_security</em>
device completed successfully</p></li>
</ul>
</li>
<li><p>for outbound packets:</p>
<ul>
<li><p>update <em>ol_flags</em> inside <em>struct  rte_mbuf</em> to indicate that
inline-crypto processing has to be performed by HW on this packet</p></li>
<li><p>invoke <em>rte_security</em> device specific <em>set_pkt_metadata()</em> to associate
security device specific data with the packet</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="rte-security-action-type-lookaside-protocol">
<h3><span class="section-number">52.1.5. </span>RTE_SECURITY_ACTION_TYPE_LOOKASIDE_PROTOCOL</h3>
<p>In that mode the library functions perform</p>
<ul class="simple">
<li><p>for inbound packets:</p>
<ul>
<li><p>prepare <em>rte_crypto_op</em> structure for each input packet</p></li>
<li><p>verify that integrity check and decryption performed by crypto device
completed successfully</p></li>
</ul>
</li>
<li><p>for outbound packets:</p>
<ul>
<li><p>prepare <em>rte_crypto_op</em> structure for each input packet</p></li>
<li><p>verify that crypto device operations (encryption, ICV generation)
were completed successfully</p></li>
</ul>
</li>
</ul>
<p>To accommodate future custom implementations function pointers
model is used for both <em>crypto_prepare</em> and <em>process</em> implementations.</p>
</div>
</div>
<div class="section" id="sa-database-api">
<h2><span class="section-number">52.2. </span>SA database API</h2>
<p>SA database(SAD) is a table with &lt;key, value&gt; pairs.</p>
<p>Value is an opaque user provided pointer to the user defined SA data structure.</p>
<p>According to RFC4301 each SA can be uniquely identified by a key
which is either:</p>
<blockquote>
<div><ul class="simple">
<li><p>security parameter index(SPI)</p></li>
<li><p>or SPI and destination IP(DIP)</p></li>
<li><p>or SPI, DIP and source IP(SIP)</p></li>
</ul>
</div></blockquote>
<p>In case of multiple matches, longest matching key will be returned.</p>
<div class="section" id="create-destroy">
<h3><span class="section-number">52.2.1. </span>Create/destroy</h3>
<p>librte_ipsec SAD implementation provides ability to create/destroy SAD tables.</p>
<p>To create SAD table user has to specify how many entries of each key type is
required and IP protocol type (IPv4/IPv6).
As an example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">rte_ipsec_sad</span> <span class="o">*</span><span class="n">sad</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">rte_ipsec_sad_conf</span> <span class="n">conf</span><span class="p">;</span>

<span class="n">conf</span><span class="p">.</span><span class="n">socket_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">conf</span><span class="p">.</span><span class="n">max_sa</span><span class="p">[</span><span class="n">RTE_IPSEC_SAD_SPI_ONLY</span><span class="p">]</span> <span class="o">=</span> <span class="n">some_nb_rules_spi_only</span><span class="p">;</span>
<span class="n">conf</span><span class="p">.</span><span class="n">max_sa</span><span class="p">[</span><span class="n">RTE_IPSEC_SAD_SPI_DIP</span><span class="p">]</span> <span class="o">=</span> <span class="n">some_nb_rules_spi_dip</span><span class="p">;</span>
<span class="n">conf</span><span class="p">.</span><span class="n">max_sa</span><span class="p">[</span><span class="n">RTE_IPSEC_SAD_SPI_DIP_SIP</span><span class="p">]</span> <span class="o">=</span> <span class="n">some_nb_rules_spi_dip_sip</span><span class="p">;</span>
<span class="n">conf</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RTE_IPSEC_SAD_FLAG_RW_CONCURRENCY</span><span class="p">;</span>

<span class="n">sad</span> <span class="o">=</span> <span class="n">rte_ipsec_sad_create</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>for more information please refer to ipsec library API reference</p>
</div>
</div>
<div class="section" id="add-delete-rules">
<h3><span class="section-number">52.2.2. </span>Add/delete rules</h3>
<p>Library also provides methods to add or delete key/value pairs from the SAD.
To add user has to specify key, key type and a value which is an opaque pointer to SA.
The key type reflects a set of tuple fields that will be used for lookup of the SA.
As mentioned above there are 3 types of a key and the representation of a key type is:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">RTE_IPSEC_SAD_SPI_ONLY</span><span class="p">,</span>
<span class="n">RTE_IPSEC_SAD_SPI_DIP</span><span class="p">,</span>
<span class="n">RTE_IPSEC_SAD_SPI_DIP_SIP</span><span class="p">,</span>
</pre></div>
</div>
<p>As an example, to add new entry into the SAD for IPv4 addresses:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">rte_ipsec_sa</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>
<span class="k">union</span> <span class="n">rte_ipsec_sad_key</span> <span class="n">key</span><span class="p">;</span>

<span class="n">key</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">spi</span> <span class="o">=</span> <span class="n">rte_cpu_to_be_32</span><span class="p">(</span><span class="n">spi_val</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">key_type</span> <span class="o">&gt;=</span> <span class="n">RTE_IPSEC_SAD_SPI_DIP</span><span class="p">)</span> <span class="cm">/* DIP is optional*/</span>
    <span class="n">key</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">dip</span> <span class="o">=</span> <span class="n">rte_cpu_to_be_32</span><span class="p">(</span><span class="n">dip_val</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">RTE_IPSEC_SAD_SPI_DIP_SIP</span><span class="p">)</span> <span class="cm">/* SIP is optional*/</span>
    <span class="n">key</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">sip</span> <span class="o">=</span> <span class="n">rte_cpu_to_be_32</span><span class="p">(</span><span class="n">sip_val</span><span class="p">);</span>

<span class="n">rte_ipsec_sad_add</span><span class="p">(</span><span class="n">sad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">key_type</span><span class="p">,</span> <span class="n">sa</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>By performance reason it is better to keep spi/dip/sip in net byte order
to eliminate byteswap on lookup</p>
</div>
<p>To delete user has to specify key and key type.</p>
<p>Delete code would look like:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">union</span> <span class="n">rte_ipsec_sad_key</span> <span class="n">key</span><span class="p">;</span>

<span class="n">key</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">spi</span> <span class="o">=</span> <span class="n">rte_cpu_to_be_32</span><span class="p">(</span><span class="n">necessary_spi</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">key_type</span> <span class="o">&gt;=</span> <span class="n">RTE_IPSEC_SAD_SPI_DIP</span><span class="p">)</span> <span class="cm">/* DIP is optional*/</span>
    <span class="n">key</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">dip</span> <span class="o">=</span> <span class="n">rte_cpu_to_be_32</span><span class="p">(</span><span class="n">necessary_dip</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">RTE_IPSEC_SAD_SPI_DIP_SIP</span><span class="p">)</span> <span class="cm">/* SIP is optional*/</span>
    <span class="n">key</span><span class="p">.</span><span class="n">v4</span><span class="p">.</span><span class="n">sip</span> <span class="o">=</span> <span class="n">rte_cpu_to_be_32</span><span class="p">(</span><span class="n">necessary_sip</span><span class="p">);</span>

<span class="n">rte_ipsec_sad_del</span><span class="p">(</span><span class="n">sad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">key_type</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="lookup">
<h3><span class="section-number">52.2.3. </span>Lookup</h3>
<p>Library provides lookup by the given {SPI,DIP,SIP} tuple of
inbound ipsec packet as a key.</p>
<p>The search key is represented by:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">union</span> <span class="n">rte_ipsec_sad_key</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">rte_ipsec_sadv4_key</span>  <span class="n">v4</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">rte_ipsec_sadv6_key</span>  <span class="n">v6</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>where v4 is a tuple for IPv4:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">rte_ipsec_sadv4_key</span> <span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">spi</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">dip</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">sip</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>and v6 is a tuple for IPv6:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">rte_ipsec_sadv6_key</span> <span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">spi</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">dip</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="kt">uint8_t</span> <span class="n">sip</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">};</span>
</pre></div>
</div>
<p>As an example, lookup related code could look like that:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="k">union</span> <span class="n">rte_ipsec_sad_key</span> <span class="n">keys</span><span class="p">[</span><span class="n">BURST_SZ</span><span class="p">];</span>
<span class="k">const</span> <span class="k">union</span> <span class="n">rte_ipsec_sad_key</span> <span class="o">*</span><span class="n">keys_p</span><span class="p">[</span><span class="n">BURST_SZ</span><span class="p">];</span>
<span class="kt">void</span> <span class="o">*</span><span class="n">vals</span><span class="p">[</span><span class="n">BURST_SZ</span><span class="p">];</span>

<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BURST_SZ_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v4</span><span class="p">.</span><span class="n">spi</span> <span class="o">=</span> <span class="n">esp_hdr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">;</span>
    <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v4</span><span class="p">.</span><span class="n">dip</span> <span class="o">=</span> <span class="n">ipv4_hdr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">;</span>
    <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v4</span><span class="p">.</span><span class="n">sip</span> <span class="o">=</span> <span class="n">ipv4_hdr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">;</span>
    <span class="n">keys_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>
<span class="n">rte_ipsec_sad_lookup</span><span class="p">(</span><span class="n">sad</span><span class="p">,</span> <span class="n">keys_p</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">BURST_SZ</span><span class="p">);</span>

<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BURST_SZ_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;SA not found for key index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="nf">printf</span><span class="p">(</span><span class="s">&quot;SA pointer is %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="supported-features">
<h2><span class="section-number">52.3. </span>Supported features</h2>
<ul class="simple">
<li><p>ESP protocol tunnel mode both IPv4/IPv6.</p></li>
<li><p>ESP protocol transport mode both IPv4/IPv6.</p></li>
<li><p>ESN and replay window.</p></li>
<li><p>algorithms: 3DES-CBC, AES-CBC, AES-CTR, AES-GCM, HMAC-SHA1, NULL.</p></li>
</ul>
</div>
<div class="section" id="limitations">
<h2><span class="section-number">52.4. </span>Limitations</h2>
<p>The following features are not properly supported in the current version:</p>
<ul class="simple">
<li><p>Hard/soft limit for SA lifetime (time interval/byte count).</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="graph_lib.html" class="btn btn-neutral float-right" title="53. Graph Library and Inbuilt Nodes" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="bpf_lib.html" class="btn btn-neutral float-left" title="51. Berkeley Packet Filter Library" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>